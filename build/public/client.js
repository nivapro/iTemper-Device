var sensors = [];
function setPage(name) {
    var page = document.getElementById('page');
    page.innerHTML = name;
}
setPage('Sensors');
function sensorName(descr) {
    return descr.SN + ', port ' + descr.port;
}
function sensorId(descr) {
    var sn = descr.SN.replace(' ', descr.SN);
    var id = descr.SN.replace(' ', descr.SN) + '-' + descr.port;
    return id;
}
function listSensors(sensors) {
    for (var _i = 0, sensors_1 = sensors; _i < sensors_1.length; _i++) {
        var sensor = sensors_1[_i];
        var article = document.createElement('article');
        var heading = document.createElement('h3');
        heading.id = sensorId(sensor.descr) + '-value';
        article.appendChild(heading);
        var descr = document.createElement('p');
        descr.id = sensorId(sensor.descr);
        article.appendChild(descr);
        var section = document.getElementById('app');
        section.appendChild(article);
    }
    log(sensors);
}
var isMonitoring = false;
function setMonitoringButton() {
    var button = document.getElementById('monitor');
    if (isMonitoring) {
        button.innerHTML = 'Stop monitor';
    }
    else {
        button.innerHTML = 'Start Monitor';
    }
}
function startMonitor(sensors) {
    isMonitoring = true;
    setMonitoringButton();
    var descr = 'startMonitor';
    var data = [];
    for (var _i = 0, sensors_2 = sensors; _i < sensors_2.length; _i++) {
        var sensor = sensors_2[_i];
        data.push(sensor.descr);
    }
    socket.send(JSON.stringify({ descr: descr, data: data }));
}
function stopMonitor(sensors) {
    isMonitoring = false;
    setMonitoringButton();
    var descr = 'stopMonitor';
    var data = [];
    for (var _i = 0, sensors_3 = sensors; _i < sensors_3.length; _i++) {
        var sensor = sensors_3[_i];
        data.push(sensor.descr);
    }
    socket.send(JSON.stringify({ descr: descr, data: data }));
}
var logTimer;
function log(sensorData) {
    for (var _i = 0, sensorData_1 = sensorData; _i < sensorData_1.length; _i++) {
        var sensor = sensorData_1[_i];
        var log_1 = document.getElementById(sensorId(sensor.descr) + '-value');
        if (log_1) {
            var date = new Date(sensor.samples[0].date);
            var value = sensor.samples[0].value;
            log_1.innerHTML = value + ' Â°C';
        }
        var descr = document.getElementById(sensorId(sensor.descr));
        if (descr) {
            var date = new Date(sensor.samples[0].date);
            var value = sensor.samples[0].value;
            descr.innerHTML = 'by ' + sensorName(sensor.descr) + ': ' +
                date.toLocaleDateString() + ', ' + date.toLocaleTimeString();
        }
        clearTimeout(logTimer);
        logTimer = setInterval(clearSensorValue, 5000);
    }
}
function settings(allSettings) {
    // TODO
}
function setConnectionStatus(connected) {
    var status = document.getElementById('connection');
    isMonitoring = connected && isMonitoring;
    setMonitoringButton();
    if (connected && isMonitoring) {
        status.innerHTML = ' (live)';
    }
    else if (connected) {
        status.innerHTML = ' (Connected)';
    }
    else {
        status.innerHTML = ' (Disconnected)';
    }
}
var url = 'ws://' + document.domain;
var socket = new WebSocket(url);
socket.onopen = function (e) {
    setConnectionStatus(true);
    socket.send(JSON.stringify({ descr: 'getSensors' }));
    socket.send(JSON.stringify({ descr: 'getSettings' }));
};
socket.onmessage = function (event) {
    setConnectionStatus(true);
    var msg = JSON.parse(event.data);
    switch (msg.descr) {
        case 'sensors':
            listSensors(msg.data);
            if (!isMonitoring) {
                startMonitor(sensors);
            }
            break;
        case 'settings':
            settings(msg.data);
            break;
        case 'log':
            log(msg.data);
            break;
    }
};
socket.onclose = function (event) {
    setConnectionStatus(false);
    clearTimeout(logTimer);
    logTimer = setInterval(clearSensorValue, 5000);
};
socket.onerror = function (error) {
    setConnectionStatus(false);
    clearTimeout(logTimer);
    logTimer = setInterval(clearSensorValue, 5000);
};
function monitor() {
    if (isMonitoring) {
        stopMonitor(sensors);
    }
    else {
        startMonitor(sensors);
    }
}
function clearSensorValue() {
    for (var _i = 0, sensors_4 = sensors; _i < sensors_4.length; _i++) {
        var sensor = sensors_4[_i];
        var sampleDate = sensor.samples[0].date;
        if (Date.now() - sampleDate > 60000) {
            var sensorValue = document.getElementById(sensorId(sensor));
            sensorValue.innerHTML = 'No sensor data received last 60 seconds';
        }
    }
    setConnectionStatus(socket.readyState === socket.OPEN);
    if (socket.readyState === socket.CLOSED) {
        socket = new WebSocket(url);
    }
}
function round(value, precision) {
    //    precision || (precision = 1);
    var inverse = 1.0 / precision;
    return Math.round(value * inverse) / inverse;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9icm93c2VyL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFFakIsaUJBQWlCLElBQUk7SUFDakIsSUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUMxQixDQUFDO0FBRUQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRW5CLG9CQUFvQixLQUFLO0lBQ3JCLE9BQU8sS0FBSyxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztBQUM3QyxDQUFDO0FBRUQsa0JBQWtCLEtBQUs7SUFDbkIsSUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzQyxJQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQzlELE9BQU8sRUFBRSxDQUFDO0FBQ2QsQ0FBQztBQUVELHFCQUFxQixPQUFPO0lBQ3hCLEtBQXFCLFVBQU8sRUFBUCxtQkFBTyxFQUFQLHFCQUFPLEVBQVAsSUFBTyxFQUFFO1FBQXpCLElBQU0sTUFBTSxnQkFBQTtRQUNiLElBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEQsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QyxPQUFPLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQy9DLE9BQU8sQ0FBQyxXQUFXLENBQUMs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b3JzID0gW107XHJcblxyXG5mdW5jdGlvbiBzZXRQYWdlKG5hbWUpIHtcclxuICAgIGNvbnN0IHBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFnZScpO1xyXG4gICAgcGFnZS5pbm5lckhUTUwgPSBuYW1lO1xyXG59XHJcblxyXG5zZXRQYWdlKCdTZW5zb3JzJyk7XHJcblxyXG5mdW5jdGlvbiBzZW5zb3JOYW1lKGRlc2NyKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBkZXNjci5TTiArICcsIHBvcnQgJyArIGRlc2NyLnBvcnQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNlbnNvcklkKGRlc2NyKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHNuID0gZGVzY3IuU04ucmVwbGFjZSgnICcsIGRlc2NyLlNOKTtcclxuICAgIGNvbnN0IGlkID0gZGVzY3IuU04ucmVwbGFjZSgnICcsIGRlc2NyLlNOKSArICctJyArIGRlc2NyLnBvcnQ7XHJcbiAgICByZXR1cm4gaWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxpc3RTZW5zb3JzKHNlbnNvcnMpIHtcclxuICAgIGZvciAoY29uc3Qgc2Vuc29yIG9mIHNlbnNvcnMpIHtcclxuICAgICAgICBjb25zdCBhcnRpY2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXJ0aWNsZScpO1xyXG4gICAgICAgIGNvbnN0IGhlYWRpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoMycpO1xyXG5cclxuICAgICAgICBoZWFkaW5nLmlkID0gc2Vuc29ySWQoc2Vuc29yLmRlc2NyKSArICctdmFsdWUnO1xyXG4gICAgICAgIGFydGljbGUuYXBwZW5kQ2hpbGQoaGVhZGluZyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRlc2NyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgIGRlc2NyLmlkID0gc2Vuc29ySWQoc2Vuc29yLmRlc2NyKTtcclxuICAgICAgICBhcnRpY2xlLmFwcGVuZENoaWxkKGRlc2NyKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2VjdGlvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHAnKTtcclxuICAgICAgICBzZWN0aW9uLmFwcGVuZENoaWxkKGFydGljbGUpO1xyXG4gICAgfVxyXG4gICAgbG9nKHNlbnNvcnMpO1xyXG59XHJcbmxldCBpc01vbml0b3JpbmcgPSBmYWxzZTtcclxuZnVuY3Rpb24gc2V0TW9uaXRvcmluZ0J1dHRvbigpIHtcclxuICAgIGNvbnN0IGJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb25pdG9yJyk7XHJcbiAgICBpZiAoaXNNb25pdG9yaW5nKSB7XHJcbiAgICAgICAgYnV0dG9uLmlubmVySFRNTCA9ICdTdG9wIG1vbml0b3InO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBidXR0b24uaW5uZXJIVE1MID0gJ1N0YXJ0IE1vbml0b3InO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzdGFydE1vbml0b3Ioc2Vuc29ycykge1xyXG4gICAgaXNNb25pdG9yaW5nID0gdHJ1ZTtcclxuICAgIHNldE1vbml0b3JpbmdCdXR0b24oKTtcclxuICAgIGNvbnN0IGRlc2NyID0gJ3N0YXJ0TW9uaXRvcic7XHJcbiAgICBjb25zdCBkYXRhOiBhbnkgPSBbXTtcclxuICAgIGZvciAoY29uc3Qgc2Vuc29yIG9mIHNlbnNvcnMpIHtcclxuICAgICAgICBkYXRhLnB1c2goc2Vuc29yLmRlc2NyKTtcclxuICAgIH1cclxuICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHtkZXNjciwgZGF0YX0pKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3RvcE1vbml0b3Ioc2Vuc29ycykge1xyXG4gICAgaXNNb25pdG9yaW5nID0gZmFsc2U7XHJcbiAgICBzZXRNb25pdG9yaW5nQnV0dG9uKCk7XHJcbiAgICBjb25zdCBkZXNjciA9ICdzdG9wTW9uaXRvcic7XHJcbiAgICBjb25zdCBkYXRhOiBhbnkgPSBbXTtcclxuICAgIGZvciAoY29uc3Qgc2Vuc29yIG9mIHNlbnNvcnMpIHtcclxuICAgICAgICBkYXRhLnB1c2goc2Vuc29yLmRlc2NyKTtcclxuICAgIH1cclxuICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHtkZXNjciwgZGF0YX0pKTtcclxufVxyXG5sZXQgbG9nVGltZXI7XHJcbmZ1bmN0aW9uIGxvZyhzZW5zb3JEYXRhKSB7XHJcbiAgICBmb3IgKGNvbnN0IHNlbnNvciBvZiBzZW5zb3JEYXRhKSB7XHJcbiAgICAgICAgY29uc3QgbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2Vuc29ySWQoc2Vuc29yLmRlc2NyKSArICctdmFsdWUnKTtcclxuICAgICAgICBpZiAobG9nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShzZW5zb3Iuc2FtcGxlc1swXS5kYXRlKTtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzZW5zb3Iuc2FtcGxlc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgbG9nLmlubmVySFRNTCA9IHZhbHVlICsgJyDCsEMnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkZXNjciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlbnNvcklkKHNlbnNvci5kZXNjcikpO1xyXG4gICAgICAgIGlmIChkZXNjcikge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoc2Vuc29yLnNhbXBsZXNbMF0uZGF0ZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gc2Vuc29yLnNhbXBsZXNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgIGRlc2NyLmlubmVySFRNTCA9ICdieSAnICsgc2Vuc29yTmFtZShzZW5zb3IuZGVzY3IpICArICc6ICcgK1xyXG4gICAgICAgICAgICAgICAgZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcoKSArICcsICcgKyBkYXRlLnRvTG9jYWxlVGltZVN0cmluZygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjbGVhclRpbWVvdXQobG9nVGltZXIpO1xyXG4gICAgICAgIGxvZ1RpbWVyID0gc2V0SW50ZXJ2YWwoY2xlYXJTZW5zb3JWYWx1ZSwgNTAwMCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldHRpbmdzKGFsbFNldHRpbmdzKSB7XHJcbiAgICAvLyBUT0RPXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldENvbm5lY3Rpb25TdGF0dXMoY29ubmVjdGVkOiBib29sZWFuKSB7XHJcbiAgICBjb25zdCBzdGF0dXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29ubmVjdGlvbicpO1xyXG4gICAgaXNNb25pdG9yaW5nID0gY29ubmVjdGVkICYmIGlzTW9uaXRvcmluZztcclxuICAgIHNldE1vbml0b3JpbmdCdXR0b24oKTtcclxuICAgIGlmIChjb25uZWN0ZWQgJiYgaXNNb25pdG9yaW5nKSB7XHJcbiAgICAgICAgc3RhdHVzLmlubmVySFRNTCA9ICcgKGxpdmUpJztcclxuICAgIH0gZWxzZSBpZiAoY29ubmVjdGVkKSB7XHJcbiAgICAgICAgc3RhdHVzLmlubmVySFRNTCA9ICcgKENvbm5lY3RlZCknO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBzdGF0dXMuaW5uZXJIVE1MID0gJyAoRGlzY29ubmVjdGVkKSc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IHVybCA9ICd3czovLycgKyBkb2N1bWVudC5kb21haW47XHJcbmxldCBzb2NrZXQgPSBuZXcgV2ViU29ja2V0KHVybCk7XHJcbnNvY2tldC5vbm9wZW4gPSBmdW5jdGlvbihlKSB7XHJcbiAgICBzZXRDb25uZWN0aW9uU3RhdHVzKHRydWUpO1xyXG4gICAgc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoe2Rlc2NyOiAnZ2V0U2Vuc29ycyd9KSk7XHJcbiAgICBzb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeSh7ZGVzY3I6ICdnZXRTZXR0aW5ncyd9KSk7XHJcbn07XHJcblxyXG5zb2NrZXQub25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgIHNldENvbm5lY3Rpb25TdGF0dXModHJ1ZSk7XHJcbiAgICBjb25zdCBtc2cgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xyXG4gICAgc3dpdGNoKG1zZy5kZXNjcikge1xyXG4gICAgICAgIGNhc2UgJ3NlbnNvcnMnOlxyXG4gICAgICAgICAgICBsaXN0U2Vuc29ycyhtc2cuZGF0YSk7XHJcbiAgICAgICAgICAgIGlmICghaXNNb25pdG9yaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBzdGFydE1vbml0b3Ioc2Vuc29ycyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnc2V0dGluZ3MnOlxyXG4gICAgICAgICAgICBzZXR0aW5ncyhtc2cuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2xvZyc6XHJcbiAgICAgICAgICAgIGxvZyhtc2cuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbn07XHJcblxyXG5zb2NrZXQub25jbG9zZSA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICBzZXRDb25uZWN0aW9uU3RhdHVzKGZhbHNlKTtcclxuICAgIGNsZWFyVGltZW91dChsb2dUaW1lcik7XHJcbiAgICBsb2dUaW1lciA9IHNldEludGVydmFsKGNsZWFyU2Vuc29yVmFsdWUsIDUwMDApO1xyXG59O1xyXG5cclxuc29ja2V0Lm9uZXJyb3IgPSBmdW5jdGlvbihlcnJvcikge1xyXG4gICAgc2V0Q29ubmVjdGlvblN0YXR1cyhmYWxzZSk7XHJcbiAgICBjbGVhclRpbWVvdXQobG9nVGltZXIpO1xyXG4gICAgbG9nVGltZXIgPSBzZXRJbnRlcnZhbChjbGVhclNlbnNvclZhbHVlLCA1MDAwKTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIG1vbml0b3IoKSB7XHJcbiAgICBpZiAoaXNNb25pdG9yaW5nKSB7XHJcbiAgICAgICAgc3RvcE1vbml0b3Ioc2Vuc29ycyk7XHJcblxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBzdGFydE1vbml0b3Ioc2Vuc29ycyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsZWFyU2Vuc29yVmFsdWUoKSB7XHJcbiAgICBmb3IgKGNvbnN0IHNlbnNvciBvZiBzZW5zb3JzKSB7XHJcbiAgICAgICAgY29uc3Qgc2FtcGxlRGF0ZSA9IHNlbnNvci5zYW1wbGVzWzBdLmRhdGU7XHJcbiAgICAgICAgaWYgKERhdGUubm93KCkgLSBzYW1wbGVEYXRlID4gNjBfMDAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbnNvclZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2Vuc29ySWQoc2Vuc29yKSk7XHJcbiAgICAgICAgICAgIHNlbnNvclZhbHVlLmlubmVySFRNTCA9ICdObyBzZW5zb3IgZGF0YSByZWNlaXZlZCBsYXN0IDYwIHNlY29uZHMnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXRDb25uZWN0aW9uU3RhdHVzKHNvY2tldC5yZWFkeVN0YXRlID09PSBzb2NrZXQuT1BFTik7XHJcbiAgICBpZiAoc29ja2V0LnJlYWR5U3RhdGUgPT09IHNvY2tldC5DTE9TRUQpIHtcclxuICAgICAgICBzb2NrZXQgPSBuZXcgV2ViU29ja2V0KHVybCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJvdW5kKHZhbHVlLCBwcmVjaXNpb24pIHtcclxuICAgIC8vICAgIHByZWNpc2lvbiB8fCAocHJlY2lzaW9uID0gMSk7XHJcbiAgICBjb25zdCBpbnZlcnNlID0gMS4wIC8gcHJlY2lzaW9uO1xyXG4gICAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiBpbnZlcnNlKSAvIGludmVyc2U7XHJcbn1cclxuIl19
