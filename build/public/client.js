var sensors = [];
function setPage(name) {
    var page = document.getElementById('page');
    page.innerHTML = name;
}
setPage('Sensors');
function sensorName(descr) {
    return descr.SN + ', port ' + descr.port;
}
function sensorId(descr) {
    var sn = descr.SN.replace(' ', descr.SN);
    console.log(sn);
    var id = descr.SN.replace(' ', descr.SN) + '-' + descr.port;
    return id;
}
function listSensors(sensors) {
    for (var _i = 0, sensors_1 = sensors; _i < sensors_1.length; _i++) {
        var sensor = sensors_1[_i];
        var article = document.createElement('article');
        var heading = document.createElement('h3');
        heading.id = sensorId(sensor.descr) + '-value';
        article.appendChild(heading);
        var descr = document.createElement('p');
        descr.id = sensorId(sensor.descr);
        article.appendChild(descr);
        var section = document.getElementById('app');
        section.appendChild(article);
    }
    log(sensors);
}
var isMonitoring = false;
function setMonitoringButton() {
    var button = document.getElementById('monitor');
    if (isMonitoring) {
        button.innerHTML = 'Stop monitor';
    }
    else {
        button.innerHTML = 'Start Monitor';
    }
}
function startMonitor(sensors) {
    isMonitoring = true;
    setMonitoringButton();
    var descr = 'startMonitor';
    var data = [];
    for (var _i = 0, sensors_2 = sensors; _i < sensors_2.length; _i++) {
        var sensor = sensors_2[_i];
        data.push(sensor.descr);
    }
    socket.send(JSON.stringify({ descr: descr, data: data }));
}
function stopMonitor(sensors) {
    isMonitoring = false;
    setMonitoringButton();
    var descr = 'stopMonitor';
    var data = [];
    for (var _i = 0, sensors_3 = sensors; _i < sensors_3.length; _i++) {
        var sensor = sensors_3[_i];
        data.push(sensor.descr);
    }
    socket.send(JSON.stringify({ descr: descr, data: data }));
}
var logTimer;
function log(sensorData) {
    for (var _i = 0, sensorData_1 = sensorData; _i < sensorData_1.length; _i++) {
        var sensor = sensorData_1[_i];
        var log_1 = document.getElementById(sensorId(sensor.descr) + '-value');
        if (log_1) {
            var date = new Date(sensor.samples[0].date);
            var value = sensor.samples[0].value;
            log_1.innerHTML = value + ' Â°C';
        }
        var descr = document.getElementById(sensorId(sensor.descr));
        if (descr) {
            var date = new Date(sensor.samples[0].date);
            var value = sensor.samples[0].value;
            descr.innerHTML = 'by ' + sensorName(sensor.descr) + ': ' +
                date.toLocaleDateString() + ', ' + date.toLocaleTimeString();
        }
        clearTimeout(logTimer);
        logTimer = setInterval(clearSensorValue, 5000);
    }
}
function settings(allSettings) {
    // TODO
}
function setConnectionStatus(connected) {
    var status = document.getElementById('connection');
    isMonitoring = connected && isMonitoring;
    setMonitoringButton();
    if (connected && isMonitoring) {
        status.innerHTML = ' (live)';
    }
    else if (connected) {
        status.innerHTML = ' (Connected)';
    }
    else {
        status.innerHTML = ' (Disconnected)';
    }
}
var url = 'ws://precision.vading.lan';
var socket = new WebSocket(url);
socket.onopen = function (e) {
    setConnectionStatus(true);
    socket.send(JSON.stringify({ descr: 'getSensors' }));
    socket.send(JSON.stringify({ descr: 'getSettings' }));
};
socket.onmessage = function (event) {
    setConnectionStatus(true);
    var msg = JSON.parse(event.data);
    switch (msg.descr) {
        case 'sensors':
            listSensors(msg.data);
            if (!isMonitoring) {
                startMonitor(sensors);
            }
            break;
        case 'settings':
            settings(msg.data);
            break;
        case 'log':
            log(msg.data);
            break;
    }
};
socket.onclose = function (event) {
    setConnectionStatus(false);
    clearTimeout(logTimer);
    logTimer = setInterval(clearSensorValue, 5000);
};
socket.onerror = function (error) {
    setConnectionStatus(false);
    clearTimeout(logTimer);
    logTimer = setInterval(clearSensorValue, 5000);
};
function monitor() {
    if (isMonitoring) {
        stopMonitor(sensors);
    }
    else {
        startMonitor(sensors);
    }
}
function clearSensorValue() {
    for (var _i = 0, sensors_4 = sensors; _i < sensors_4.length; _i++) {
        var sensor = sensors_4[_i];
        var sampleDate = sensor.samples[0].date;
        if (Date.now() - sampleDate > 60000) {
            var sensorValue = document.getElementById(sensorId(sensor));
            sensorValue.innerHTML = 'No sensor data received last 60 seconds';
        }
    }
    setConnectionStatus(socket.readyState === socket.OPEN);
    if (socket.readyState === socket.CLOSED) {
        socket = new WebSocket(url);
    }
}
function round(value, precision) {
    //    precision || (precision = 1);
    var inverse = 1.0 / precision;
    return Math.round(value * inverse) / inverse;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9icm93c2VyL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFFakIsaUJBQWlCLElBQUk7SUFDakIsSUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUMxQixDQUFDO0FBRUQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRW5CLG9CQUFvQixLQUFLO0lBQ3JCLE9BQU8sS0FBSyxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztBQUM3QyxDQUFDO0FBRUQsa0JBQWtCLEtBQUs7SUFDbkIsSUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2hCLElBQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDOUQsT0FBTyxFQUFFLENBQUM7QUFDZCxDQUFDO0FBRUQscUJBQXFCLE9BQU87SUFDeEIsS0FBcUIsVUFBTyxFQUFQLG1CQUFPLEVBQVAscUJBQU8sRUFBUCxJQUFPLEVBQUU7UUFBekIsSUFBTSxNQUFNLGdCQUFBO1FBQ2IsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNsRCxJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTdDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMs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cmNlc0NvbnRlbnQiOlsibGV0IHNlbnNvcnMgPSBbXTtcclxuXHJcbmZ1bmN0aW9uIHNldFBhZ2UobmFtZSkge1xyXG4gICAgY29uc3QgcGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWdlJyk7XHJcbiAgICBwYWdlLmlubmVySFRNTCA9IG5hbWU7XHJcbn1cclxuXHJcbnNldFBhZ2UoJ1NlbnNvcnMnKTtcclxuXHJcbmZ1bmN0aW9uIHNlbnNvck5hbWUoZGVzY3IpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGRlc2NyLlNOICsgJywgcG9ydCAnICsgZGVzY3IucG9ydDtcclxufVxyXG5cclxuZnVuY3Rpb24gc2Vuc29ySWQoZGVzY3IpOiBzdHJpbmcge1xyXG4gICAgY29uc3Qgc24gPSBkZXNjci5TTi5yZXBsYWNlKCcgJywgZGVzY3IuU04pO1xyXG4gICAgY29uc29sZS5sb2coc24pO1xyXG4gICAgY29uc3QgaWQgPSBkZXNjci5TTi5yZXBsYWNlKCcgJywgZGVzY3IuU04pICsgJy0nICsgZGVzY3IucG9ydDtcclxuICAgIHJldHVybiBpZDtcclxufVxyXG5cclxuZnVuY3Rpb24gbGlzdFNlbnNvcnMoc2Vuc29ycykge1xyXG4gICAgZm9yIChjb25zdCBzZW5zb3Igb2Ygc2Vuc29ycykge1xyXG4gICAgICAgIGNvbnN0IGFydGljbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhcnRpY2xlJyk7XHJcbiAgICAgICAgY29uc3QgaGVhZGluZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gzJyk7XHJcblxyXG4gICAgICAgIGhlYWRpbmcuaWQgPSBzZW5zb3JJZChzZW5zb3IuZGVzY3IpICsgJy12YWx1ZSc7XHJcbiAgICAgICAgYXJ0aWNsZS5hcHBlbmRDaGlsZChoZWFkaW5nKTtcclxuXHJcbiAgICAgICAgY29uc3QgZGVzY3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgZGVzY3IuaWQgPSBzZW5zb3JJZChzZW5zb3IuZGVzY3IpO1xyXG4gICAgICAgIGFydGljbGUuYXBwZW5kQ2hpbGQoZGVzY3IpO1xyXG5cclxuICAgICAgICBjb25zdCBzZWN0aW9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcCcpO1xyXG4gICAgICAgIHNlY3Rpb24uYXBwZW5kQ2hpbGQoYXJ0aWNsZSk7XHJcbiAgICB9XHJcbiAgICBsb2coc2Vuc29ycyk7XHJcbn1cclxubGV0IGlzTW9uaXRvcmluZyA9IGZhbHNlO1xyXG5mdW5jdGlvbiBzZXRNb25pdG9yaW5nQnV0dG9uKCkge1xyXG4gICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vbml0b3InKTtcclxuICAgIGlmIChpc01vbml0b3JpbmcpIHtcclxuICAgICAgICBidXR0b24uaW5uZXJIVE1MID0gJ1N0b3AgbW9uaXRvcic7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGJ1dHRvbi5pbm5lckhUTUwgPSAnU3RhcnQgTW9uaXRvcic7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHN0YXJ0TW9uaXRvcihzZW5zb3JzKSB7XHJcbiAgICBpc01vbml0b3JpbmcgPSB0cnVlO1xyXG4gICAgc2V0TW9uaXRvcmluZ0J1dHRvbigpO1xyXG4gICAgY29uc3QgZGVzY3IgPSAnc3RhcnRNb25pdG9yJztcclxuICAgIGNvbnN0IGRhdGE6IGFueSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBzZW5zb3Igb2Ygc2Vuc29ycykge1xyXG4gICAgICAgIGRhdGEucHVzaChzZW5zb3IuZGVzY3IpO1xyXG4gICAgfVxyXG4gICAgc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoe2Rlc2NyLCBkYXRhfSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzdG9wTW9uaXRvcihzZW5zb3JzKSB7XHJcbiAgICBpc01vbml0b3JpbmcgPSBmYWxzZTtcclxuICAgIHNldE1vbml0b3JpbmdCdXR0b24oKTtcclxuICAgIGNvbnN0IGRlc2NyID0gJ3N0b3BNb25pdG9yJztcclxuICAgIGNvbnN0IGRhdGE6IGFueSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBzZW5zb3Igb2Ygc2Vuc29ycykge1xyXG4gICAgICAgIGRhdGEucHVzaChzZW5zb3IuZGVzY3IpO1xyXG4gICAgfVxyXG4gICAgc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoe2Rlc2NyLCBkYXRhfSkpO1xyXG59XHJcbmxldCBsb2dUaW1lcjtcclxuZnVuY3Rpb24gbG9nKHNlbnNvckRhdGEpIHtcclxuICAgIGZvciAoY29uc3Qgc2Vuc29yIG9mIHNlbnNvckRhdGEpIHtcclxuICAgICAgICBjb25zdCBsb2cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChzZW5zb3JJZChzZW5zb3IuZGVzY3IpICsgJy12YWx1ZScpO1xyXG4gICAgICAgIGlmIChsb2cpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHNlbnNvci5zYW1wbGVzWzBdLmRhdGUpO1xyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHNlbnNvci5zYW1wbGVzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICBsb2cuaW5uZXJIVE1MID0gdmFsdWUgKyAnIMKwQyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRlc2NyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2Vuc29ySWQoc2Vuc29yLmRlc2NyKSk7XHJcbiAgICAgICAgaWYgKGRlc2NyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShzZW5zb3Iuc2FtcGxlc1swXS5kYXRlKTtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzZW5zb3Iuc2FtcGxlc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgZGVzY3IuaW5uZXJIVE1MID0gJ2J5ICcgKyBzZW5zb3JOYW1lKHNlbnNvci5kZXNjcikgICsgJzogJyArXHJcbiAgICAgICAgICAgICAgICBkYXRlLnRvTG9jYWxlRGF0ZVN0cmluZygpICsgJywgJyArIGRhdGUudG9Mb2NhbGVUaW1lU3RyaW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNsZWFyVGltZW91dChsb2dUaW1lcik7XHJcbiAgICAgICAgbG9nVGltZXIgPSBzZXRJbnRlcnZhbChjbGVhclNlbnNvclZhbHVlLCA1MDAwKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gc2V0dGluZ3MoYWxsU2V0dGluZ3MpIHtcclxuICAgIC8vIFRPRE9cclxufVxyXG5cclxuZnVuY3Rpb24gc2V0Q29ubmVjdGlvblN0YXR1cyhjb25uZWN0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIGNvbnN0IHN0YXR1cyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25uZWN0aW9uJyk7XHJcbiAgICBpc01vbml0b3JpbmcgPSBjb25uZWN0ZWQgJiYgaXNNb25pdG9yaW5nO1xyXG4gICAgc2V0TW9uaXRvcmluZ0J1dHRvbigpO1xyXG4gICAgaWYgKGNvbm5lY3RlZCAmJiBpc01vbml0b3JpbmcpIHtcclxuICAgICAgICBzdGF0dXMuaW5uZXJIVE1MID0gJyAobGl2ZSknO1xyXG4gICAgfSBlbHNlIGlmIChjb25uZWN0ZWQpIHtcclxuICAgICAgICBzdGF0dXMuaW5uZXJIVE1MID0gJyAoQ29ubmVjdGVkKSc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHN0YXR1cy5pbm5lckhUTUwgPSAnIChEaXNjb25uZWN0ZWQpJztcclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgdXJsID0gJ3dzOi8vcHJlY2lzaW9uLnZhZGluZy5sYW4nO1xyXG5sZXQgc29ja2V0ID0gbmV3IFdlYlNvY2tldCh1cmwpO1xyXG5zb2NrZXQub25vcGVuID0gZnVuY3Rpb24oZSkge1xyXG4gICAgc2V0Q29ubmVjdGlvblN0YXR1cyh0cnVlKTtcclxuICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHtkZXNjcjogJ2dldFNlbnNvcnMnfSkpO1xyXG4gICAgc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoe2Rlc2NyOiAnZ2V0U2V0dGluZ3MnfSkpO1xyXG59O1xyXG5cclxuc29ja2V0Lm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICBzZXRDb25uZWN0aW9uU3RhdHVzKHRydWUpO1xyXG4gICAgY29uc3QgbXNnID0gSlNPTi5wYXJzZShldmVudC5kYXRhKTtcclxuICAgIHN3aXRjaChtc2cuZGVzY3IpIHtcclxuICAgICAgICBjYXNlICdzZW5zb3JzJzpcclxuICAgICAgICAgICAgbGlzdFNlbnNvcnMobXNnLmRhdGEpO1xyXG4gICAgICAgICAgICBpZiAoIWlzTW9uaXRvcmluZykge1xyXG4gICAgICAgICAgICAgICAgc3RhcnRNb25pdG9yKHNlbnNvcnMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3NldHRpbmdzJzpcclxuICAgICAgICAgICAgc2V0dGluZ3MobXNnLmRhdGEpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdsb2cnOlxyXG4gICAgICAgICAgICBsb2cobXNnLmRhdGEpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG59O1xyXG5cclxuc29ja2V0Lm9uY2xvc2UgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgc2V0Q29ubmVjdGlvblN0YXR1cyhmYWxzZSk7XHJcbiAgICBjbGVhclRpbWVvdXQobG9nVGltZXIpO1xyXG4gICAgbG9nVGltZXIgPSBzZXRJbnRlcnZhbChjbGVhclNlbnNvclZhbHVlLCA1MDAwKTtcclxufTtcclxuXHJcbnNvY2tldC5vbmVycm9yID0gZnVuY3Rpb24oZXJyb3IpIHtcclxuICAgIHNldENvbm5lY3Rpb25TdGF0dXMoZmFsc2UpO1xyXG4gICAgY2xlYXJUaW1lb3V0KGxvZ1RpbWVyKTtcclxuICAgIGxvZ1RpbWVyID0gc2V0SW50ZXJ2YWwoY2xlYXJTZW5zb3JWYWx1ZSwgNTAwMCk7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBtb25pdG9yKCkge1xyXG4gICAgaWYgKGlzTW9uaXRvcmluZykge1xyXG4gICAgICAgIHN0b3BNb25pdG9yKHNlbnNvcnMpO1xyXG5cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc3RhcnRNb25pdG9yKHNlbnNvcnMpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjbGVhclNlbnNvclZhbHVlKCkge1xyXG4gICAgZm9yIChjb25zdCBzZW5zb3Igb2Ygc2Vuc29ycykge1xyXG4gICAgICAgIGNvbnN0IHNhbXBsZURhdGUgPSBzZW5zb3Iuc2FtcGxlc1swXS5kYXRlO1xyXG4gICAgICAgIGlmIChEYXRlLm5vdygpIC0gc2FtcGxlRGF0ZSA+IDYwXzAwMCkge1xyXG4gICAgICAgICAgICBjb25zdCBzZW5zb3JWYWx1ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlbnNvcklkKHNlbnNvcikpO1xyXG4gICAgICAgICAgICBzZW5zb3JWYWx1ZS5pbm5lckhUTUwgPSAnTm8gc2Vuc29yIGRhdGEgcmVjZWl2ZWQgbGFzdCA2MCBzZWNvbmRzJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2V0Q29ubmVjdGlvblN0YXR1cyhzb2NrZXQucmVhZHlTdGF0ZSA9PT0gc29ja2V0Lk9QRU4pO1xyXG4gICAgaWYgKHNvY2tldC5yZWFkeVN0YXRlID09PSBzb2NrZXQuQ0xPU0VEKSB7XHJcbiAgICAgICAgc29ja2V0ID0gbmV3IFdlYlNvY2tldCh1cmwpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByb3VuZCh2YWx1ZSwgcHJlY2lzaW9uKSB7XHJcbiAgICAvLyAgICBwcmVjaXNpb24gfHwgKHByZWNpc2lvbiA9IDEpO1xyXG4gICAgY29uc3QgaW52ZXJzZSA9IDEuMCAvIHByZWNpc2lvbjtcclxuICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogaW52ZXJzZSkgLyBpbnZlcnNlO1xyXG59XHJcbiJdfQ==
