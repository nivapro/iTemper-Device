"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
var express_1 = __importDefault(require("express"));
var http_1 = __importDefault(require("http"));
var path = require("path");
var ws_1 = __importDefault(require("ws"));
var api_1 = __importDefault(require("./routes/api"));
var index_1 = __importDefault(require("./routes/index"));
var settings_1 = __importDefault(require("./routes/settings"));
var BrowserService = __importStar(require("./models/browser-service"));
var usb_controller_1 = require("./models/usb-controller");
var logger_1 = require("./logger");
var app = express_1.default();
usb_controller_1.USBController.initializeDevices();
app.use(express_1.default.static(path.join(__dirname, 'public')));
app.use('/', index_1.default);
app.use('/api', api_1.default);
app.use('/settings', settings_1.default);
var httpServer = http_1.default.createServer(app);
var wss = new ws_1.default.Server({ server: httpServer });
wss.on('connection', function (ws, request) {
    logger_1.log.info('app.ws: new connection url/headers: ' + ws.url + '/' + JSON.stringify(request.headers));
    ws.on('close', function (ws, code, reason) {
        logger_1.log.info('ws.on: Websocket: ' + ws.url + ' + code: ' + code + 'reason: ' + reason);
    });
    ws.on('message', function (data) {
        logger_1.log.debug('ws.on: received message: ' + data.toString());
        BrowserService.parseInboundMessage(ws, data);
    });
    ws.on('error', function () {
        logger_1.log.debug('ws.on: Error: ');
    });
});
var server = httpServer.listen(process.env.PORT || 80, function () {
    logger_1.log.info('iTemper device listening on port ' + server.address().port);
});
exports.default = server;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBSUEsb0RBQThCO0FBRTlCLDhDQUF3QjtBQUN4QiwyQkFBOEI7QUFDOUIsMENBQTJCO0FBRTNCLHFEQUFxQztBQUNyQyx5REFBeUM7QUFDekMsK0RBQStDO0FBRS9DLHVFQUEyRDtBQUUzRCwwREFBd0Q7QUFFeEQsbUNBQStCO0FBQy9CLElBQU0sR0FBRyxHQUFHLGlCQUFPLEVBQUUsQ0FBQztBQVd0Qiw4QkFBYSxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFNbEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFeEQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsZUFBVyxDQUFDLENBQUM7QUFDMUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsYUFBUyxDQUFDLENBQUM7QUFDM0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsa0JBQWMsQ0FBQyxDQUFDO0FBOEVyQyxJQUFNLFVBQVUsR0FBRyxjQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFDLElBQU0sR0FBRyxHQUFHLElBQUksWUFBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQ3pELEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLFVBQUMsRUFBYSxFQUFFLE9BQTZCO0lBQzlELFlBQUcsQ0FBQyxJQUFJLENBQUMsc0NBQXNDLEdBQUcsRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUdsRyxFQUFFLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFDLEVBQWEsRUFBRSxJQUFZLEVBQUUsTUFBYztRQUN6RCxZQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsV0FBVyxHQUFHLElBQUksR0FBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLENBQUM7SUFDckYsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFDLElBQVk7UUFDNUIsWUFBRyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUV6RCxjQUFjLENBQUMsbUJBQW1CLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRS9DLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUU7UUFDWCxZQUFHLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7QUFDVCxDQUFDLENBQUUsQ0FBQztBQUNKLElBQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxFQUFFO0lBQ3JELFlBQUcsQ0FBQyxJQUFJLENBQUMsbUNBQW1DLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFFLENBQUMsQ0FBQyxDQUFDO0FBRUgsa0JBQWUsTUFBTSxDQUFDIiwiZmlsZSI6ImFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCB7IFdTX09SSUdJTiB9IGZyb20gJy4vY29uZmlnJztcclxuXHJcblxyXG4vLyBpbXBvcnQgY29ycyBmcm9tICdjb3JzJztcclxuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XHJcbi8vIGltcG9ydCBleHByZXNzV3MgZnJvbSAnZXhwcmVzcy13cyc7XHJcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XHJcblxyXG5pbXBvcnQgcm91dGVfYXBpIGZyb20gJy4vcm91dGVzL2FwaSc7XHJcbmltcG9ydCByb3V0ZV9pbmRleCBmcm9tICcuL3JvdXRlcy9pbmRleCc7XHJcbmltcG9ydCByb3V0ZV9zZXR0aW5ncyBmcm9tICcuL3JvdXRlcy9zZXR0aW5ncyc7XHJcblxyXG5pbXBvcnQgKiBhcyBCcm93c2VyU2VydmljZSBmcm9tICcuL21vZGVscy9icm93c2VyLXNlcnZpY2UnO1xyXG5cclxuaW1wb3J0IHsgVVNCQ29udHJvbGxlciB9IGZyb20gJy4vbW9kZWxzL3VzYi1jb250cm9sbGVyJztcclxuXHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vbG9nZ2VyJztcclxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xyXG4vLyBjb25zdCBhcHAgPSBleHByZXNzV3MoZXhwcmVzcygpKS5hcHA7XHJcbi8vIGNvbnN0IGFwcDogZXhwcmVzcy5FeHByZXNzID0gZXhwcmVzcygpO1xyXG4vLyBUT0RPOiBDT1JTIGhhcmRlbmluZ1xyXG4vLyBjb25zdCBjb3JzT3B0aW9uczogY29ycy5Db3JzT3B0aW9ucyA9IHtcclxuLy8gICAgIG9yaWdpbjogV1NfT1JJR0lOLFxyXG4vLyB9O1xyXG5cclxuLy8gYXBwLnVzZShjb3JzKGNvcnNPcHRpb25zKSk7XHJcbi8vIGFwcC5kaXNhYmxlKCdldGFnJyk7XHJcblxyXG5VU0JDb250cm9sbGVyLmluaXRpYWxpemVEZXZpY2VzKCk7XHJcblxyXG4vLyB2aWV3IGVuZ2luZSBzZXR1cFxyXG4vLyBhcHAuc2V0KCd2aWV3cycsIHBhdGguam9pbihfX2Rpcm5hbWUsICd2aWV3cycpKTtcclxuLy8gYXBwLnNldCgndmlldyBlbmdpbmUnLCAncHVnJyk7XHJcblxyXG5hcHAudXNlKGV4cHJlc3Muc3RhdGljKHBhdGguam9pbihfX2Rpcm5hbWUsICdwdWJsaWMnKSkpO1xyXG5cclxuYXBwLnVzZSgnLycsIHJvdXRlX2luZGV4KTtcclxuYXBwLnVzZSgnL2FwaScsIHJvdXRlX2FwaSk7XHJcbmFwcC51c2UoJy9zZXR0aW5ncycsIHJvdXRlX3NldHRpbmdzKTtcclxuXHJcbi8vIGNhdGNoIDQwNCBhbmQgZm9yd2FyZCB0byBlcnJvciBoYW5kbGVyXHJcbi8vIGFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbi8vICAgICBpZiAocmVxKSB7XHJcbi8vICAgICAgICAgLy8gVG8gYmUgaW1wbGVtZW50ZWRcclxuLy8gICAgIH1cclxuLy8gICAgIGlmIChyZXMpIHtcclxuLy8gICAgICAgICAvLyBUbyBiZSBpbXBsZW1lbnRlZFxyXG4vLyAgICAgfVxyXG4vLyAgICAgY29uc3QgZXJyOiBhbnkgPSBuZXcgRXJyb3IoJ05vdCBGb3VuZCBhdCBzZXJ2ZXInKTtcclxuLy8gICAgIGVyclsnc3RhdHVzJ10gPSA0MDQ7XHJcbi8vICAgICBuZXh0KGVycik7XHJcbi8vIH0pO1xyXG5cclxuXHJcbi8vIGVycm9yIGhhbmRsZXJzXHJcblxyXG4vLyBkZXZlbG9wbWVudCBlcnJvciBoYW5kbGVyXHJcbi8vIHdpbGwgcHJpbnQgc3RhY2t0cmFjZVxyXG4vLyBpZiAoYXBwLmdldCgnZW52JykgPT09ICdkZXZlbG9wbWVudCcpIHtcclxuLy8gICAgIGFwcC51c2UoKGVycjogYW55LCByZXE6IGFueSwgcmVzOiBhbnksIG5leHQ6IGFueSkgPT4ge1xyXG4vLyAgICAgICAgIHJlcy5zdGF0dXMoZXJyWydzdGF0dXMnXSB8fCA1MDApO1xyXG4vLyAgICAgICAgIHJlcy5yZW5kZXIoJ2Vycm9yJywge1xyXG4vLyAgICAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcclxuLy8gICAgICAgICAgICAgZXJyb3I6IGVycn0pO1xyXG4vLyAgICAgICAgIGlmIChuZXh0KSB7XHJcbi8vICAgICAgICAgICAgIC8vIHRvIGJlIGltcGxlbWVudGVkXHJcbi8vICAgICAgICAgfVxyXG4vLyAgICAgICAgIGlmIChyZXEpIHtcclxuLy8gICAgICAgICAgICAgLy8gdG8gYmUgaW1wbGVtZW50ZWRcclxuLy8gICAgICAgICB9XHJcbi8vICAgICB9KTtcclxuLy8gfVxyXG5cclxuLy8gcHJvZHVjdGlvbiBlcnJvciBoYW5kbGVyXHJcbi8vIG5vIHN0YWNrIHRyYWNlcyBsZWFrZWQgdG8gdXNlclxyXG4vLyBhcHAudXNlKChlcnI6IGFueSwgcmVxOiBhbnksIHJlczogYW55LCBuZXh0OiBhbnkpID0+IHtcclxuLy8gICAgIHJlcy5zdGF0dXMoZXJyLnN0YXR1cyB8fCA1MDApO1xyXG4vLyAgICAgcmVzLnJlbmRlcignZXJyb3InLCB7XHJcbi8vICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXHJcbi8vICAgICAgICAgZXJyb3I6IHt9fSk7XHJcbi8vICAgICBpZiAobmV4dCkge1xyXG4vLyAgICAgICAgIC8vIHRvIGJlIGltcGxlbWVudGVkXHJcbi8vICAgICB9XHJcbi8vICAgICBpZiAocmVxKSB7XHJcbi8vICAgICAgICAgLy8gdG8gYmUgaW1wbGVtZW50ZWRcclxuLy8gICAgIH1cclxuLy8gfSk7XHJcblxyXG5cclxuLy8gZXhwb3J0IGNvbnN0IGh0dHBTZXJ2ZXI6IGh0dHAuU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKTtcclxuXHJcbi8vIGV4cG9ydCBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcigge3NlcnZlcjogaHR0cFNlcnZlciwgY2xpZW50VHJhY2tpbmc6IHRydWV9ICk7XHJcblxyXG4vLyB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3M6IFdlYlNvY2tldCwgcmVxdWVzdDogaHR0cC5JbmNvbWluZ01lc3NhZ2UpOiB2b2lkICA9PiB7XHJcbi8vICAgICBjb25zdCBpcCA9IHJlcXVlc3QuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ107XHJcbi8vICAgICBsb2cuaW5mbygnd3NzLm9uOiBuZXcgd2Vic29ja2V0IGNvbm5lY3Rpb24gZnJvbSBjbGllbnQ6ICcgKyBKU09OLnN0cmluZ2lmeShpcCkpO1xyXG4vLyAgICAgLy8gd3Muc2VuZCh7ZGVzY3I6ICdoZWxsbycsIGRhdGE6ICdIZWxsbyB3b3JsZCBmcm9tIGRldmljZSd9KTtcclxuXHJcbi8vICAgICB3cy5vbignY2xvc2UnLCAod3M6IFdlYlNvY2tldCwgY29kZTogbnVtYmVyLCByZWFzb246IHN0cmluZyk6IHZvaWQgPT4ge1xyXG4vLyAgICAgICBsb2cuaW5mbygnd3Mub246IFdlYnNvY2tldDogJysgd3MudXJsICsgJyArIGNvZGU6ICcgKyBjb2RlICsgICdyZWFzb246ICcgKyByZWFzb24pO1xyXG4vLyAgICAgfSk7XHJcblxyXG4vLyAgICAgd3Mub24oJ21lc3NhZ2UnLCAoZGF0YTogQnVmZmVyKTogdm9pZCA9PiB7XHJcbi8vICAgICAgIGxvZy5kZWJ1Zygnd3Mub246IHJlY2VpdmVkIG1lc3NhZ2U6ICcgKyBkYXRhLnRvU3RyaW5nKCkpO1xyXG4vLyAgICAgfSk7XHJcblxyXG4vLyAgICAgd3Mub24oJ2Vycm9yJywgKCk6IHZvaWQgPT4ge1xyXG4vLyAgICAgICAgIGxvZy5kZWJ1Zygnd3Mub246IEVycm9yOiAnKTtcclxuLy8gICAgICAgfSk7XHJcbi8vICAgfSk7XHJcblxyXG5cclxuLy8gd3NzLm9uKCdlcnJvcicsICgpOiB2b2lkICA9PiB7XHJcbi8vICAgICBsb2cuZXJyb3IoJ3dzcy5vbjogZXJyb3IgcmVjZWl2ZWQnKTtcclxuLy8gfSk7XHJcblxyXG5jb25zdCBodHRwU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKTtcclxuY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoeyBzZXJ2ZXI6IGh0dHBTZXJ2ZXIgfSk7XHJcbndzcy5vbignY29ubmVjdGlvbicsICh3czogV2ViU29ja2V0LCByZXF1ZXN0OiBodHRwLkluY29taW5nTWVzc2FnZSk6IHZvaWQgID0+IHtcclxuICAgIGxvZy5pbmZvKCdhcHAud3M6IG5ldyBjb25uZWN0aW9uIHVybC9oZWFkZXJzOiAnICsgd3MudXJsICsgJy8nICsgSlNPTi5zdHJpbmdpZnkocmVxdWVzdC5oZWFkZXJzKSk7XHJcblxyXG5cclxuICAgIHdzLm9uKCdjbG9zZScsICh3czogV2ViU29ja2V0LCBjb2RlOiBudW1iZXIsIHJlYXNvbjogc3RyaW5nKTogdm9pZCA9PiB7XHJcbiAgICAgIGxvZy5pbmZvKCd3cy5vbjogV2Vic29ja2V0OiAnKyB3cy51cmwgKyAnICsgY29kZTogJyArIGNvZGUgKyAgJ3JlYXNvbjogJyArIHJlYXNvbik7XHJcbiAgICB9KTtcclxuXHJcbiAgICB3cy5vbignbWVzc2FnZScsIChkYXRhOiBCdWZmZXIpOiB2b2lkID0+IHtcclxuICAgICAgbG9nLmRlYnVnKCd3cy5vbjogcmVjZWl2ZWQgbWVzc2FnZTogJyArIGRhdGEudG9TdHJpbmcoKSk7XHJcblxyXG4gICAgICBCcm93c2VyU2VydmljZS5wYXJzZUluYm91bmRNZXNzYWdlKHdzLCBkYXRhKTtcclxuXHJcbiAgICB9KTtcclxuXHJcbiAgICB3cy5vbignZXJyb3InLCAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCd3cy5vbjogRXJyb3I6ICcpO1xyXG4gICAgICB9KTtcclxufSApO1xyXG5jb25zdCBzZXJ2ZXIgPSBodHRwU2VydmVyLmxpc3Rlbihwcm9jZXNzLmVudi5QT1JUIHx8IDgwLCAoKSA9PiB7XHJcbiAgICBsb2cuaW5mbygnaVRlbXBlciBkZXZpY2UgbGlzdGVuaW5nIG9uIHBvcnQgJyArIHNlcnZlci5hZGRyZXNzKCkucG9ydCk7XHJcbn0pO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgc2VydmVyO1xyXG4iXX0=
