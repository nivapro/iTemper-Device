"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
var express_1 = __importDefault(require("express"));
var http_1 = __importDefault(require("http"));
var path = require("path");
var ws_1 = __importDefault(require("ws"));
var api_1 = __importDefault(require("./routes/api"));
var index_1 = __importDefault(require("./routes/index"));
var settings_1 = __importDefault(require("./routes/settings"));
var BrowserService = __importStar(require("./models/browser-service"));
var usb_controller_1 = require("./models/usb-controller");
var settings_2 = require("./models/settings");
var logger_1 = require("./logger");
var app = express_1.default();
usb_controller_1.USBController.initializeDevices();
settings_2.Settings.initializeSettings();
app.use(express_1.default.static(path.join(__dirname, 'public')));
app.use('/', index_1.default);
app.use('/api', api_1.default);
app.use('/settings', settings_1.default);
var httpServer = http_1.default.createServer(app);
var wss = new ws_1.default.Server({ server: httpServer });
wss.on('connection', function (ws, request) {
    logger_1.log.info('app.ws: new connection url/headers: ' + ws.url + '/' + JSON.stringify(request.headers));
    ws.on('close', function (ws, code, reason) {
        logger_1.log.info('ws.on: Websocket: ' + ws.url + ' + code: ' + code + 'reason: ' + reason);
    });
    ws.on('message', function (data) {
        logger_1.log.debug('ws.on: received message: ' + data.toString());
        BrowserService.parseInboundMessage(ws, data);
    });
    ws.on('error', function () {
        logger_1.log.debug('ws.on: Error: ');
    });
});
var server = httpServer.listen(process.env.PORT || 80, function () {
    logger_1.log.info('iTemper device listening on port ' + server.address().port);
});
exports.default = server;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBSUEsb0RBQThCO0FBRTlCLDhDQUF3QjtBQUN4QiwyQkFBOEI7QUFDOUIsMENBQTJCO0FBRTNCLHFEQUFxQztBQUNyQyx5REFBeUM7QUFDekMsK0RBQStDO0FBRS9DLHVFQUEyRDtBQUUzRCwwREFBd0Q7QUFFeEQsOENBQTZDO0FBRTdDLG1DQUErQjtBQUMvQixJQUFNLEdBQUcsR0FBRyxpQkFBTyxFQUFFLENBQUM7QUFXdEIsOEJBQWEsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0FBQ2xDLG1CQUFRLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztBQU05QixHQUFHLENBQUMsR0FBRyxDQUFDLGlCQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUV4RCxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxlQUFXLENBQUMsQ0FBQztBQUMxQixHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxhQUFTLENBQUMsQ0FBQztBQUMzQixHQUFHLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxrQkFBYyxDQUFDLENBQUM7QUE4RXJDLElBQU0sVUFBVSxHQUFHLGNBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDMUMsSUFBTSxHQUFHLEdBQUcsSUFBSSxZQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7QUFDekQsR0FBRyxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsVUFBQyxFQUFhLEVBQUUsT0FBNkI7SUFDOUQsWUFBRyxDQUFDLElBQUksQ0FBQyxzQ0FBc0MsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBR2xHLEVBQUUsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQUMsRUFBYSxFQUFFLElBQVksRUFBRSxNQUFjO1FBQ3pELFlBQUcsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEdBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxXQUFXLEdBQUcsSUFBSSxHQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsQ0FBQztJQUNyRixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLFVBQUMsSUFBWTtRQUM1QixZQUFHLENBQUMsS0FBSyxDQUFDLDJCQUEyQixHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBRXpELGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFL0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRTtRQUNYLFlBQUcsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUM5QixDQUFDLENBQUMsQ0FBQztBQUNULENBQUMsQ0FBRSxDQUFDO0FBQ0osSUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLEVBQUU7SUFDckQsWUFBRyxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDMUUsQ0FBQyxDQUFDLENBQUM7QUFFSCxrQkFBZSxNQUFNLENBQUMiLCJmaWxlIjoiYXBwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0IHsgV1NfT1JJR0lOIH0gZnJvbSAnLi9jb25maWcnO1xyXG5cclxuXHJcbi8vIGltcG9ydCBjb3JzIGZyb20gJ2NvcnMnO1xyXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuLy8gaW1wb3J0IGV4cHJlc3NXcyBmcm9tICdleHByZXNzLXdzJztcclxuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XHJcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcclxuXHJcbmltcG9ydCByb3V0ZV9hcGkgZnJvbSAnLi9yb3V0ZXMvYXBpJztcclxuaW1wb3J0IHJvdXRlX2luZGV4IGZyb20gJy4vcm91dGVzL2luZGV4JztcclxuaW1wb3J0IHJvdXRlX3NldHRpbmdzIGZyb20gJy4vcm91dGVzL3NldHRpbmdzJztcclxuXHJcbmltcG9ydCAqIGFzIEJyb3dzZXJTZXJ2aWNlIGZyb20gJy4vbW9kZWxzL2Jyb3dzZXItc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBVU0JDb250cm9sbGVyIH0gZnJvbSAnLi9tb2RlbHMvdXNiLWNvbnRyb2xsZXInO1xyXG5cclxuaW1wb3J0IHsgU2V0dGluZ3MgfSBmcm9tICcuL21vZGVscy9zZXR0aW5ncyc7XHJcblxyXG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuL2xvZ2dlcic7XHJcbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcclxuLy8gY29uc3QgYXBwID0gZXhwcmVzc1dzKGV4cHJlc3MoKSkuYXBwO1xyXG4vLyBjb25zdCBhcHA6IGV4cHJlc3MuRXhwcmVzcyA9IGV4cHJlc3MoKTtcclxuLy8gVE9ETzogQ09SUyBoYXJkZW5pbmdcclxuLy8gY29uc3QgY29yc09wdGlvbnM6IGNvcnMuQ29yc09wdGlvbnMgPSB7XHJcbi8vICAgICBvcmlnaW46IFdTX09SSUdJTixcclxuLy8gfTtcclxuXHJcbi8vIGFwcC51c2UoY29ycyhjb3JzT3B0aW9ucykpO1xyXG4vLyBhcHAuZGlzYWJsZSgnZXRhZycpO1xyXG5cclxuVVNCQ29udHJvbGxlci5pbml0aWFsaXplRGV2aWNlcygpO1xyXG5TZXR0aW5ncy5pbml0aWFsaXplU2V0dGluZ3MoKTtcclxuXHJcbi8vIHZpZXcgZW5naW5lIHNldHVwXHJcbi8vIGFwcC5zZXQoJ3ZpZXdzJywgcGF0aC5qb2luKF9fZGlybmFtZSwgJ3ZpZXdzJykpO1xyXG4vLyBhcHAuc2V0KCd2aWV3IGVuZ2luZScsICdwdWcnKTtcclxuXHJcbmFwcC51c2UoZXhwcmVzcy5zdGF0aWMocGF0aC5qb2luKF9fZGlybmFtZSwgJ3B1YmxpYycpKSk7XHJcblxyXG5hcHAudXNlKCcvJywgcm91dGVfaW5kZXgpO1xyXG5hcHAudXNlKCcvYXBpJywgcm91dGVfYXBpKTtcclxuYXBwLnVzZSgnL3NldHRpbmdzJywgcm91dGVfc2V0dGluZ3MpO1xyXG5cclxuLy8gY2F0Y2ggNDA0IGFuZCBmb3J3YXJkIHRvIGVycm9yIGhhbmRsZXJcclxuLy8gYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcclxuLy8gICAgIGlmIChyZXEpIHtcclxuLy8gICAgICAgICAvLyBUbyBiZSBpbXBsZW1lbnRlZFxyXG4vLyAgICAgfVxyXG4vLyAgICAgaWYgKHJlcykge1xyXG4vLyAgICAgICAgIC8vIFRvIGJlIGltcGxlbWVudGVkXHJcbi8vICAgICB9XHJcbi8vICAgICBjb25zdCBlcnI6IGFueSA9IG5ldyBFcnJvcignTm90IEZvdW5kIGF0IHNlcnZlcicpO1xyXG4vLyAgICAgZXJyWydzdGF0dXMnXSA9IDQwNDtcclxuLy8gICAgIG5leHQoZXJyKTtcclxuLy8gfSk7XHJcblxyXG5cclxuLy8gZXJyb3IgaGFuZGxlcnNcclxuXHJcbi8vIGRldmVsb3BtZW50IGVycm9yIGhhbmRsZXJcclxuLy8gd2lsbCBwcmludCBzdGFja3RyYWNlXHJcbi8vIGlmIChhcHAuZ2V0KCdlbnYnKSA9PT0gJ2RldmVsb3BtZW50Jykge1xyXG4vLyAgICAgYXBwLnVzZSgoZXJyOiBhbnksIHJlcTogYW55LCByZXM6IGFueSwgbmV4dDogYW55KSA9PiB7XHJcbi8vICAgICAgICAgcmVzLnN0YXR1cyhlcnJbJ3N0YXR1cyddIHx8IDUwMCk7XHJcbi8vICAgICAgICAgcmVzLnJlbmRlcignZXJyb3InLCB7XHJcbi8vICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxyXG4vLyAgICAgICAgICAgICBlcnJvcjogZXJyfSk7XHJcbi8vICAgICAgICAgaWYgKG5leHQpIHtcclxuLy8gICAgICAgICAgICAgLy8gdG8gYmUgaW1wbGVtZW50ZWRcclxuLy8gICAgICAgICB9XHJcbi8vICAgICAgICAgaWYgKHJlcSkge1xyXG4vLyAgICAgICAgICAgICAvLyB0byBiZSBpbXBsZW1lbnRlZFxyXG4vLyAgICAgICAgIH1cclxuLy8gICAgIH0pO1xyXG4vLyB9XHJcblxyXG4vLyBwcm9kdWN0aW9uIGVycm9yIGhhbmRsZXJcclxuLy8gbm8gc3RhY2sgdHJhY2VzIGxlYWtlZCB0byB1c2VyXHJcbi8vIGFwcC51c2UoKGVycjogYW55LCByZXE6IGFueSwgcmVzOiBhbnksIG5leHQ6IGFueSkgPT4ge1xyXG4vLyAgICAgcmVzLnN0YXR1cyhlcnIuc3RhdHVzIHx8IDUwMCk7XHJcbi8vICAgICByZXMucmVuZGVyKCdlcnJvcicsIHtcclxuLy8gICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcclxuLy8gICAgICAgICBlcnJvcjoge319KTtcclxuLy8gICAgIGlmIChuZXh0KSB7XHJcbi8vICAgICAgICAgLy8gdG8gYmUgaW1wbGVtZW50ZWRcclxuLy8gICAgIH1cclxuLy8gICAgIGlmIChyZXEpIHtcclxuLy8gICAgICAgICAvLyB0byBiZSBpbXBsZW1lbnRlZFxyXG4vLyAgICAgfVxyXG4vLyB9KTtcclxuXHJcblxyXG4vLyBleHBvcnQgY29uc3QgaHR0cFNlcnZlcjogaHR0cC5TZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xyXG5cclxuLy8gZXhwb3J0IGNvbnN0IHdzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKCB7c2VydmVyOiBodHRwU2VydmVyLCBjbGllbnRUcmFja2luZzogdHJ1ZX0gKTtcclxuXHJcbi8vIHdzcy5vbignY29ubmVjdGlvbicsICh3czogV2ViU29ja2V0LCByZXF1ZXN0OiBodHRwLkluY29taW5nTWVzc2FnZSk6IHZvaWQgID0+IHtcclxuLy8gICAgIGNvbnN0IGlwID0gcmVxdWVzdC5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXTtcclxuLy8gICAgIGxvZy5pbmZvKCd3c3Mub246IG5ldyB3ZWJzb2NrZXQgY29ubmVjdGlvbiBmcm9tIGNsaWVudDogJyArIEpTT04uc3RyaW5naWZ5KGlwKSk7XHJcbi8vICAgICAvLyB3cy5zZW5kKHtkZXNjcjogJ2hlbGxvJywgZGF0YTogJ0hlbGxvIHdvcmxkIGZyb20gZGV2aWNlJ30pO1xyXG5cclxuLy8gICAgIHdzLm9uKCdjbG9zZScsICh3czogV2ViU29ja2V0LCBjb2RlOiBudW1iZXIsIHJlYXNvbjogc3RyaW5nKTogdm9pZCA9PiB7XHJcbi8vICAgICAgIGxvZy5pbmZvKCd3cy5vbjogV2Vic29ja2V0OiAnKyB3cy51cmwgKyAnICsgY29kZTogJyArIGNvZGUgKyAgJ3JlYXNvbjogJyArIHJlYXNvbik7XHJcbi8vICAgICB9KTtcclxuXHJcbi8vICAgICB3cy5vbignbWVzc2FnZScsIChkYXRhOiBCdWZmZXIpOiB2b2lkID0+IHtcclxuLy8gICAgICAgbG9nLmRlYnVnKCd3cy5vbjogcmVjZWl2ZWQgbWVzc2FnZTogJyArIGRhdGEudG9TdHJpbmcoKSk7XHJcbi8vICAgICB9KTtcclxuXHJcbi8vICAgICB3cy5vbignZXJyb3InLCAoKTogdm9pZCA9PiB7XHJcbi8vICAgICAgICAgbG9nLmRlYnVnKCd3cy5vbjogRXJyb3I6ICcpO1xyXG4vLyAgICAgICB9KTtcclxuLy8gICB9KTtcclxuXHJcblxyXG4vLyB3c3Mub24oJ2Vycm9yJywgKCk6IHZvaWQgID0+IHtcclxuLy8gICAgIGxvZy5lcnJvcignd3NzLm9uOiBlcnJvciByZWNlaXZlZCcpO1xyXG4vLyB9KTtcclxuXHJcbmNvbnN0IGh0dHBTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xyXG5jb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7IHNlcnZlcjogaHR0cFNlcnZlciB9KTtcclxud3NzLm9uKCdjb25uZWN0aW9uJywgKHdzOiBXZWJTb2NrZXQsIHJlcXVlc3Q6IGh0dHAuSW5jb21pbmdNZXNzYWdlKTogdm9pZCAgPT4ge1xyXG4gICAgbG9nLmluZm8oJ2FwcC53czogbmV3IGNvbm5lY3Rpb24gdXJsL2hlYWRlcnM6ICcgKyB3cy51cmwgKyAnLycgKyBKU09OLnN0cmluZ2lmeShyZXF1ZXN0LmhlYWRlcnMpKTtcclxuXHJcblxyXG4gICAgd3Mub24oJ2Nsb3NlJywgKHdzOiBXZWJTb2NrZXQsIGNvZGU6IG51bWJlciwgcmVhc29uOiBzdHJpbmcpOiB2b2lkID0+IHtcclxuICAgICAgbG9nLmluZm8oJ3dzLm9uOiBXZWJzb2NrZXQ6ICcrIHdzLnVybCArICcgKyBjb2RlOiAnICsgY29kZSArICAncmVhc29uOiAnICsgcmVhc29uKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHdzLm9uKCdtZXNzYWdlJywgKGRhdGE6IEJ1ZmZlcik6IHZvaWQgPT4ge1xyXG4gICAgICBsb2cuZGVidWcoJ3dzLm9uOiByZWNlaXZlZCBtZXNzYWdlOiAnICsgZGF0YS50b1N0cmluZygpKTtcclxuXHJcbiAgICAgIEJyb3dzZXJTZXJ2aWNlLnBhcnNlSW5ib3VuZE1lc3NhZ2Uod3MsIGRhdGEpO1xyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIHdzLm9uKCdlcnJvcicsICgpOiB2b2lkID0+IHtcclxuICAgICAgICBsb2cuZGVidWcoJ3dzLm9uOiBFcnJvcjogJyk7XHJcbiAgICAgIH0pO1xyXG59ICk7XHJcbmNvbnN0IHNlcnZlciA9IGh0dHBTZXJ2ZXIubGlzdGVuKHByb2Nlc3MuZW52LlBPUlQgfHwgODAsICgpID0+IHtcclxuICAgIGxvZy5pbmZvKCdpVGVtcGVyIGRldmljZSBsaXN0ZW5pbmcgb24gcG9ydCAnICsgc2VydmVyLmFkZHJlc3MoKS5wb3J0KTtcclxufSk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBzZXJ2ZXI7XHJcbiJdfQ==
