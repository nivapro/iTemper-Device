"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = require("axios");
var logger_1 = require("./../logger");
var Primus = require("primus");
var azure_iot_device_1 = require("azure-iot-device");
var azure_iot_device_mqtt_1 = require("azure-iot-device-mqtt");
var Socket = Primus.createSocket({ transformer: 'uws' });
var SensorLog = (function () {
    function SensorLog(attr, state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 5 * 60000;
        this.open = false;
        this.connectionString = '';
        logger_1.log.debug('--- SensorStateLogger:', state);
        this.timestamp = Date.now();
        this.logging = false;
        this.attr = attr;
        this.state = state;
        if (this.open) {
            this.open = true;
        }
        var dataFilter = {
            resolution: this.attr.resolution,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this), undefined);
        this.axios = axios_1.default.create({
            baseURL: 'https://test.itemper.io/api/v1/sensors',
            headers: { 'Content-Type': 'application/json' },
        });
        var wsTestUrl = 'ws://itemper.vading.lan:3000/primus';
        this.socket = new Socket(wsTestUrl);
        var self = this;
        this.socket.on('open', function () {
            self.open = true;
            logger_1.log.info('Device.SensorLog connected to backend!');
        });
        this.socket.on('data', function (data) {
            logger_1.log.info('Data received from back-end: ' + data);
        });
        this.connectionString = 'HostName=iothubiotlabs.azure-devices.net;DeviceId=twilight-sound-798cd80;' +
            'SharedAccessKey=7jobimPqYZEFvfsjSYZMmRjkk7xIs6cs721AIRYHpMU=';
        this.client = azure_iot_device_1.Client.fromConnectionString(this.connectionString, azure_iot_device_mqtt_1.Mqtt);
    }
    SensorLog.prototype.getAttr = function () {
        return this.attr;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.startLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.printResultFor = function (op) {
        return function printResult(err, res) {
            if (err) {
                logger_1.log.error(op + ' AZURE IOT error: ' + err.toString());
            }
            if (res) {
                logger_1.log.info(op + ' AZURE IOT status: ' + res.constructor.name);
            }
        };
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.attr.SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ', url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toLocaleString());
            })
                .catch(function (e) {
                logger_1.log.error('catch error', e);
            });
            var message = new azure_iot_device_1.Message(JSON.stringify(sensorLog_1));
            message.properties.add('Delta time', diff_1.toString());
            this.client.sendEvent(message, this.printResultFor('send'));
        }
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var descr = { SN: this.attr.SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { descr: descr, samples: samples };
        this.socket.write(sensorLog);
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvaXRlbXBlci1sb2dnaW5nLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBNkM7QUFLN0Msc0NBQWtDO0FBRWxDLCtCQUFpQztBQUlqQyxxREFBbUQ7QUFDbkQsK0RBQTZDO0FBRTdDLElBQU0sTUFBTSxHQUFRLE1BQU0sQ0FBQyxZQUFZLENBQUcsRUFBQyxXQUFXLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztBQUVoRTtJQW1CSSxtQkFBWSxJQUFzQixFQUFFLEtBQWtCO1FBakI5QyxjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBR3RCLFlBQU8sR0FBWSxLQUFLLENBQUM7UUFDekIsa0JBQWEsR0FBRyxDQUFDLEdBQUMsS0FBTSxDQUFDO1FBR3pCLFNBQUksR0FBWSxLQUFLLENBQUM7UUFJdEIscUJBQWdCLEdBQVcsRUFBRSxDQUFDO1FBT2xDLFlBQUcsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1gsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDcEI7UUFDRCxJQUFNLFVBQVUsR0FBRztZQUNmLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVU7WUFDaEMsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFD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QUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2pDLElBQU0sS0FBSyxHQUFHLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUMsQ0FBQztRQUN4RCxJQUFNLE9BQU8sR0FBRyxDQUFDLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFDLENBQUMsQ0FBQztRQUNuRSxJQUFNLFNBQVMsR0FBRyxFQUFFLEtBQUssT0FBQSxFQUFFLE9BQU8sU0FBQSxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0ExSEEsQUEwSEMsSUFBQTtBQTFIWSw4QkFBUyIsImZpbGUiOiJtb2RlbHMvaXRlbXBlci1sb2dnaW5nLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MsIHsgQXhpb3NJbnN0YW5jZSB9IGZyb20gJ2F4aW9zJztcclxuaW1wb3J0IHsgU2Vuc29yQXR0cmlidXRlcyB9IGZyb20gJy4uL21vZGVscy9zZW5zb3ItYXR0cmlidXRlcyc7XHJcbmltcG9ydCB7IFNlbnNvckRhdGEgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLWRhdGEnO1xyXG5pbXBvcnQgeyBTZW5zb3JTdGF0ZSB9IGZyb20gJy4uL21vZGVscy9zZW5zb3Itc3RhdGUnO1xyXG5cclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi8uLi9sb2dnZXInO1xyXG5cclxuaW1wb3J0ICogYXMgUHJpbXVzIGZyb20gJ3ByaW11cyc7XHJcblxyXG4vLyBJbXBvcnQgQXp1cmVcclxuXHJcbmltcG9ydCB7IENsaWVudCwgTWVzc2FnZSB9IGZyb20gJ2F6dXJlLWlvdC1kZXZpY2UnO1xyXG5pbXBvcnQgeyBNcXR0IH0gZnJvbSAnYXp1cmUtaW90LWRldmljZS1tcXR0JztcclxuXHJcbmNvbnN0IFNvY2tldDogYW55ID0gUHJpbXVzLmNyZWF0ZVNvY2tldCAoIHt0cmFuc2Zvcm1lcjogJ3V3cyd9KTtcclxuXHJcbmV4cG9ydCBjbGFzcyBTZW5zb3JMb2cge1xyXG4gICAgcHJpdmF0ZSBhdHRyOiBTZW5zb3JBdHRyaWJ1dGVzO1xyXG4gICAgcHJpdmF0ZSB0aW1lc3RhbXA6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIHN0YXRlOiBTZW5zb3JTdGF0ZTtcclxuXHJcbiAgICBwcml2YXRlIGxvZ2dpbmc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgTUFYX1RJTUVfRElGRiA9IDUqNjBfMDAwO1xyXG4gICAgcHJpdmF0ZSBheGlvczogQXhpb3NJbnN0YW5jZTtcclxuICAgIHByaXZhdGUgc29ja2V0OiBhbnk7XHJcbiAgICBwcml2YXRlIG9wZW46IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAvLyBBenVyZSBJT1RcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcclxuICAgIHByaXZhdGUgY29ubmVjdGlvblN0cmluZzogc3RyaW5nID0gJyc7XHJcblxyXG5cclxuICAgIHByaXZhdGUgY2xpZW50OiBDbGllbnQ7XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKGF0dHI6IFNlbnNvckF0dHJpYnV0ZXMsIHN0YXRlOiBTZW5zb3JTdGF0ZSkge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyOicsIHN0YXRlKTtcclxuICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5hdHRyID0gYXR0cjtcclxuICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGU7XHJcbiAgICAgICAgaWYgKHRoaXMub3Blbikge1xyXG4gICAgICAgICAgICB0aGlzLm9wZW4gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkYXRhRmlsdGVyID0ge1xyXG4gICAgICAgICAgICByZXNvbHV0aW9uOiB0aGlzLmF0dHIucmVzb2x1dGlvbixcclxuICAgICAgICAgICAgbWF4VGltZURpZmY6IHRoaXMuTUFYX1RJTUVfRElGRn07XHJcblxyXG4gICAgICAgIHRoaXMuc3RhdGUuYWRkU2Vuc29yRGF0YUxpc3RlbmVyKHRoaXMub25TZW5zb3JEYXRhUmVjZWl2ZWQuYmluZCh0aGlzKSwgZGF0YUZpbHRlcik7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5hZGRTZW5zb3JEYXRhTGlzdGVuZXIodGhpcy5vbk1vbml0b3IuYmluZCh0aGlzKSwgdW5kZWZpbmVkKTtcclxuXHJcbiAgICAgICAgdGhpcy5heGlvcyA9IGF4aW9zLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIGJhc2VVUkw6ICdodHRwczovL3Rlc3QuaXRlbXBlci5pby9hcGkvdjEvc2Vuc29ycycsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfSxcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgIC8vIFdlYiBzb2NrZXRzXHJcbiAgICAgICAgY29uc3Qgd3NUZXN0VXJsID0gJ3dzOi8vaXRlbXBlci52YWRpbmcubGFuOjMwMDAvcHJpbXVzJztcclxuICAgICAgICAvLyBjb25zdCB3c0RldlVybCA9ICd3czovL2xvY2FsaG9zdDozMDAwL3ByaW11cyc7XHJcblxyXG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV3IFNvY2tldCAod3NUZXN0VXJsKTtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgICAgICB0aGlzLnNvY2tldC5vbignb3BlbicsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBzZWxmLm9wZW4gPSB0cnVlO1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnRGV2aWNlLlNlbnNvckxvZyBjb25uZWN0ZWQgdG8gYmFja2VuZCEnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIGZ1bmN0aW9uKGRhdGE6IGFueSkge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnRGF0YSByZWNlaXZlZCBmcm9tIGJhY2stZW5kOiAnICsgZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIEFaVVJFIElPVFxyXG5cclxuICAgICAgICB0aGlzLmNvbm5lY3Rpb25TdHJpbmcgPSAnSG9zdE5hbWU9aW90aHViaW90bGFicy5henVyZS1kZXZpY2VzLm5ldDtEZXZpY2VJZD10d2lsaWdodC1zb3VuZC03OThjZDgwOycgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTaGFyZWRBY2Nlc3NLZXk9N2pvYmltUHFZWkVGdmZzalNZWk1tUmprazd4SXM2Y3M3MjFBSVJZSHBNVT0nO1xyXG4gICAgICAgIHRoaXMuY2xpZW50ID0gQ2xpZW50LmZyb21Db25uZWN0aW9uU3RyaW5nKHRoaXMuY29ubmVjdGlvblN0cmluZywgTXF0dCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEF0dHIoKTogU2Vuc29yQXR0cmlidXRlcyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0cjtcclxuICAgIH1cclxuICAgIHB1YmxpYyBnZXRTdGF0ZSgpOiBTZW5zb3JTdGF0ZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGU7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc3RhcnRMb2dnaW5nKCk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLnN0YXJ0TG9nZ2luZycpO1xyXG4gICAgICAgIHRoaXMubG9nZ2luZyA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0b3BMb2dnaW5nKCk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLnN0b3BMb2dnaW5nJyk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUHJpbnQgQVpVUkUgSU9UIHJlc3VsdHMuXHJcbiAgICBwcml2YXRlIHByaW50UmVzdWx0Rm9yKG9wOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiBwcmludFJlc3VsdChlcnI6IGFueSwgcmVzOiBhbnkpIHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGxvZy5lcnJvcihvcCArICcgQVpVUkUgSU9UIGVycm9yOiAnICsgZXJyLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKG9wICsgJyBBWlVSRSBJT1Qgc3RhdHVzOiAnICsgcmVzLmNvbnN0cnVjdG9yLm5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG4gICAgcHJpdmF0ZSBvblNlbnNvckRhdGFSZWNlaXZlZChkYXRhOiBTZW5zb3JEYXRhKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMubG9nZ2luZykge1xyXG4gICAgICAgICAgICBjb25zdCBkZXNjciA9IHsgU046IHRoaXMuYXR0ci5TTiwgcG9ydDogZGF0YS5nZXRQb3J0KCl9O1xyXG4gICAgICAgICAgICBjb25zdCBzYW1wbGVzID0gW3tkYXRlOiBkYXRhLnRpbWVzdGFtcCgpLCB2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpfV07XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbnNvckxvZyA9IHsgZGVzY3IsIHNhbXBsZXMgfTtcclxuICAgICAgICAgICAgY29uc3QgZGlmZiA9IGRhdGEudGltZXN0YW1wKCkgLSB0aGlzLnRpbWVzdGFtcDtcclxuICAgICAgICAgICAgdGhpcy50aW1lc3RhbXAgPSBkYXRhLnRpbWVzdGFtcCgpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdXJsID0gJy8nICsgZGVzY3IuU04gKyAnLycrIGRlc2NyLnBvcnQ7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnVVJMOiAnLCB1cmwpO1xyXG4gICAgICAgICAgICB0aGlzLmF4aW9zLnBvc3QodXJsLCBzZW5zb3JMb2cpXHJcbiAgICAgICAgICAgIC50aGVuIChmdW5jdGlvbihyZXMpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTZW5zb3JMb2dnZXIgYXhpb3MucG9zdCAnICsgdXJsICsgJyAnICsgcmVzLnN0YXR1c1RleHQgK1xyXG4gICAgICAgICAgICAgICAgICAgICcgcmVzLmRhdGE6ICcgKyBKU09OLnN0cmluZ2lmeShzZW5zb3JMb2cpICsgJyBtczogJyArIGRpZmYgK1xyXG4gICAgICAgICAgICAgICAgICAgICcgZGF0ZTogJyArIG5ldyBEYXRlKGRhdGEudGltZXN0YW1wKCkpLnRvTG9jYWxlU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKCdjYXRjaCBlcnJvcicsIGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIEFaVVJFIElPVFxyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gbmV3IE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoc2Vuc29yTG9nKSk7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UucHJvcGVydGllcy5hZGQoJ0RlbHRhIHRpbWUnLCBkaWZmLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICB0aGlzLmNsaWVudC5zZW5kRXZlbnQobWVzc2FnZSwgdGhpcy5wcmludFJlc3VsdEZvcignc2VuZCcpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbk1vbml0b3IoZGF0YTogU2Vuc29yRGF0YSk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnU2Vuc29yTG9nLm9uTW9uaXRvcicpO1xyXG4gICAgICAgIGNvbnN0IGRlc2NyID0geyBTTjogdGhpcy5hdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgY29uc3Qgc2FtcGxlcyA9IFt7ZGF0ZTogZGF0YS50aW1lc3RhbXAoKSwgdmFsdWU6IGRhdGEuZ2V0VmFsdWUoKX1dO1xyXG4gICAgICAgIGNvbnN0IHNlbnNvckxvZyA9IHsgZGVzY3IsIHNhbXBsZXMgfTtcclxuICAgICAgICB0aGlzLnNvY2tldC53cml0ZShzZW5zb3JMb2cpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
