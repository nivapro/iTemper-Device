"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = require("axios");
var logger_1 = require("./../logger");
var azure_iot_device_1 = require("azure-iot-device");
var azure_iot_device_mqtt_1 = require("azure-iot-device-mqtt");
var Websocket = require("isomorphic-ws");
var SensorLog = (function () {
    function SensorLog(attr, state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 20 * 60000;
        this.open = false;
        this.connectionString = '';
        logger_1.log.debug('--- SensorStateLogger:', state);
        this.timestamp = Date.now();
        this.logging = false;
        this.attr = attr;
        this.state = state;
        if (this.open) {
            this.open = true;
        }
        var dataFilter = {
            resolution: this.attr.resolution,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this), undefined);
        this.axios = axios_1.default.create({
            baseURL: 'https://test.itemper.io/api/v1/sensors',
            headers: { 'Content-Type': 'application/json' },
        });
        var wsTestUrl = 'wss://test.itemper.io/ws';
        this.socket = new Websocket(wsTestUrl);
        var self = this;
        this.socket.on('open', function () {
            self.open = true;
            logger_1.log.info('Device.SensorLog connected to backend!');
        });
        this.socket.on('data', function (data) {
            logger_1.log.info('Data received from back-end: ' + data);
        });
        this.socket.on('error', function (ws, err) {
            logger_1.log.error('--- socket.on: error' + JSON.stringify(err));
            ws.close();
        });
        this.connectionString = 'HostName=iothubiotlabs.azure-devices.net;DeviceId=twilight-sound-798cd80;' +
            'SharedAccessKey=7jobimPqYZEFvfsjSYZMmRjkk7xIs6cs721AIRYHpMU=';
        this.client = azure_iot_device_1.Client.fromConnectionString(this.connectionString, azure_iot_device_mqtt_1.Mqtt);
    }
    SensorLog.prototype.getAttr = function () {
        return this.attr;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.startLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.printResultFor = function (op) {
        return function printResult(err, res) {
            if (err) {
                logger_1.log.error(op + ' AZURE IOT error: ' + err.toString());
            }
            if (res) {
                logger_1.log.info(op + ' AZURE IOT status: ' + res.constructor.name);
            }
        };
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.attr.SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ', url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toISOString());
            })
                .catch(function (e) {
                logger_1.log.error('catch error: ', JSON.stringify(e));
            });
            var message = new azure_iot_device_1.Message(JSON.stringify(sensorLog_1));
            message.properties.add('Delta time', diff_1.toString());
            this.client.sendEvent(message, this.printResultFor('send'));
        }
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var descr = { SN: this.attr.SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { descr: descr, samples: samples };
        if (this.socket) {
            this.socket.send(sensorLog);
        }
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvaXRlbXBlci1sb2dnaW5nLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBNkM7QUFLN0Msc0NBQWtDO0FBSWxDLHFEQUFtRDtBQUNuRCwrREFBNkM7QUFJN0MseUNBQTJDO0FBRTNDO0lBbUJJLG1CQUFZLElBQXNCLEVBQUUsS0FBa0I7UUFqQjlDLGNBQVMsR0FBVyxDQUFDLENBQUM7UUFHdEIsWUFBTyxHQUFZLEtBQUssQ0FBQztRQUN6QixrQkFBYSxHQUFHLEVBQUUsR0FBQyxLQUFNLENBQUM7UUFHMUIsU0FBSSxHQUFZLEtBQUssQ0FBQztRQUl0QixxQkFBZ0IsR0FBVyxFQUFFLENBQUM7UUFPbEMsWUFBRyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDWCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNwQjtRQUNELElBQU0sVUFBVSxHQUFHO1lBQ2YsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVTtZQUNoQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGFBQWE7U0FBQyxDQUFDO1FBRXJDLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNuRixJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXZFLElBQUksQ0FBQyxLQUFLLEdBQUcsZUFBSyxDQUFDLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVBQUUsd0NBQXdDO1lBQ2pELE9BQU8sRUFBRSxFQUFDLGNBQWMsRUFBRSxrQkFBa0IsRUFBQztTQUM5QyxDQUFDLENBQUM7UUFHTCxJQUFNLFNBQVMsR0FBRywwQkFBMEIsQ0FBQztRQUc3QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksU0FBUyxDQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7WUFDbkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7WUFDakIsWUFBRyxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQVMsSUFBUztZQUNyQyxZQUFHLENBQUMsSUFBSSxDQUFDLCtCQUErQixHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3JELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQUMsRUFBYSxFQUFFLEdBQVU7WUFDOUMsWUFBRyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDeEQsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFHSCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsMkVBQTJFO1lBQzNFLDhEQUE4RCxDQUFDO1FBQ3ZGLElBQUksQ0FBQyxNQUFNLEdBQUcseUJBQU0sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsNEJBQUksQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFFTSwyQkFBTyxHQUFkO1FBQ0ksT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFDTSw0QkFBUSxHQUFmO1FBQ0ksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3RCLENBQUM7SUFDTSxnQ0FBWSxHQUFuQjtRQUNJLFlBQUcsQ0FBQyxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDO0lBRU0sK0JBQVcsR0FBbEI7UUFDSSxZQUFHLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDekIsQ0FBQztJQUdPLGtDQUFjLEdBQXRCLFVBQXVCLEVBQVU7UUFDN0IsT0FBTyxxQkFBcUIsR0FBUSxFQUFFLEdBQVE7WUFDOUMsSUFBSSxHQUFHLEVBQUU7Z0JBQ0wsWUFBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsb0JBQW9CLEdBQUcsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7YUFDekQ7WUFDRCxJQUFJLEdBQUcsRUFBRTtnQkFDTCxZQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxxQkFBcUIsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQy9EO1FBQ0wsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUNTLHdDQUFvQixHQUE1QixVQUE2QixJQUFnQjtRQUN6QyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDZCxJQUFNLEtBQUssR0FBRyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFDLENBQUM7WUFDeEQsSUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBQyxDQUFDLENBQUM7WUFDbkUsSUFBTSxXQUFTLEdBQUcsRUFBRSxLQUFLLE9BQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxDQUFDO1lBQ3JDLElBQU0sTUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRWxDLElBQU0sS0FBRyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRSxLQUFLLENBQUMsSUFBSSxDQUFDO1lBQzdDLFlBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEtBQUcsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUcsRUFBRSxXQUFTLENBQUM7aUJBQzlCLElBQUksQ0FBRSxVQUFTLEdBQUc7Z0JBQ2YsWUFBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsR0FBRyxLQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxVQUFVO29CQUM1RCxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFTLENBQUMsR0FBRyxPQUFPLEdBQUcsTUFBSTtvQkFDMUQsU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDOUQsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxVQUFTLENBQUM7Z0JBQ2IsWUFBRyxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xELENBQUMsQ0FBQyxDQUFDO1lBR0gsSUFBTSxPQUFPLEdBQUcsSUFBSSwwQkFBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBUyxDQUFDLENBQUMsQ0FBQztZQUN2RCxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsTUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUMvRDtJQUNMLENBQUM7SUFFTyw2QkFBUyxHQUFqQixVQUFrQixJQUFnQjtRQUM5QixZQUFHLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDakMsSUFBTSxLQUFLLEdBQUcsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBQyxDQUFDO1FBQ3hELElBQU0sT0FBTyxHQUFHLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUMsQ0FBQyxDQUFDO1FBQ25FLElBQU0sU0FBUyxHQUFHLEVBQUUsS0FBSyxPQUFBLEVBQUUsT0FBTyxTQUFBLEVBQUUsQ0FBQztRQUNyQyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDYixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMvQjtJQUVMLENBQUM7SUFDTCxnQkFBQztBQUFELENBaklBLEFBaUlDLElBQUE7QUFqSVksOEJBQVMiLCJmaWxlIjoibW9kZWxzL2l0ZW1wZXItbG9nZ2luZy1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zLCB7IEF4aW9zSW5zdGFuY2UgfSBmcm9tICdheGlvcyc7XHJcbmltcG9ydCB7IFNlbnNvckF0dHJpYnV0ZXMgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLWF0dHJpYnV0ZXMnO1xyXG5pbXBvcnQgeyBTZW5zb3JEYXRhIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1kYXRhJztcclxuaW1wb3J0IHsgU2Vuc29yU3RhdGUgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLXN0YXRlJztcclxuXHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vLi4vbG9nZ2VyJztcclxuXHJcbi8vIEltcG9ydCBBenVyZVxyXG5cclxuaW1wb3J0IHsgQ2xpZW50LCBNZXNzYWdlIH0gZnJvbSAnYXp1cmUtaW90LWRldmljZSc7XHJcbmltcG9ydCB7IE1xdHQgfSBmcm9tICdhenVyZS1pb3QtZGV2aWNlLW1xdHQnO1xyXG5cclxuXHJcbi8vIFdlYnNvY2tldFxyXG5pbXBvcnQgKiBhcyBXZWJzb2NrZXQgZnJvbSAnaXNvbW9ycGhpYy13cyc7XHJcblxyXG5leHBvcnQgY2xhc3MgU2Vuc29yTG9nIHtcclxuICAgIHByaXZhdGUgYXR0cjogU2Vuc29yQXR0cmlidXRlcztcclxuICAgIHByaXZhdGUgdGltZXN0YW1wOiBudW1iZXIgPSAwO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU2Vuc29yU3RhdGU7XHJcblxyXG4gICAgcHJpdmF0ZSBsb2dnaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIE1BWF9USU1FX0RJRkYgPSAyMCo2MF8wMDA7XHJcbiAgICBwcml2YXRlIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xyXG4gICAgcHJpdmF0ZSBzb2NrZXQ6IGFueTtcclxuICAgIHByaXZhdGUgb3BlbjogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIC8vIEF6dXJlIElPVFxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxyXG4gICAgcHJpdmF0ZSBjb25uZWN0aW9uU3RyaW5nOiBzdHJpbmcgPSAnJztcclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjbGllbnQ6IENsaWVudDtcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IoYXR0cjogU2Vuc29yQXR0cmlidXRlcywgc3RhdGU6IFNlbnNvclN0YXRlKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXI6Jywgc3RhdGUpO1xyXG4gICAgICAgIHRoaXMudGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmF0dHIgPSBhdHRyO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcclxuICAgICAgICBpZiAodGhpcy5vcGVuKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3BlbiA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRhdGFGaWx0ZXIgPSB7XHJcbiAgICAgICAgICAgIHJlc29sdXRpb246IHRoaXMuYXR0ci5yZXNvbHV0aW9uLFxyXG4gICAgICAgICAgICBtYXhUaW1lRGlmZjogdGhpcy5NQVhfVElNRV9ESUZGfTtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0ZS5hZGRTZW5zb3JEYXRhTGlzdGVuZXIodGhpcy5vblNlbnNvckRhdGFSZWNlaXZlZC5iaW5kKHRoaXMpLCBkYXRhRmlsdGVyKTtcclxuICAgICAgICB0aGlzLnN0YXRlLmFkZFNlbnNvckRhdGFMaXN0ZW5lcih0aGlzLm9uTW9uaXRvci5iaW5kKHRoaXMpLCB1bmRlZmluZWQpO1xyXG5cclxuICAgICAgICB0aGlzLmF4aW9zID0gYXhpb3MuY3JlYXRlKHtcclxuICAgICAgICAgICAgYmFzZVVSTDogJ2h0dHBzOi8vdGVzdC5pdGVtcGVyLmlvL2FwaS92MS9zZW5zb3JzJyxcclxuICAgICAgICAgICAgaGVhZGVyczogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9LFxyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgLy8gV2ViIHNvY2tldHNcclxuICAgICAgICBjb25zdCB3c1Rlc3RVcmwgPSAnd3NzOi8vdGVzdC5pdGVtcGVyLmlvL3dzJztcclxuICAgICAgICAvLyBjb25zdCB3c0RldlVybCA9ICd3czovL2xvY2FsaG9zdDozMDAwL3dzJztcclxuXHJcbiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgV2Vic29ja2V0ICh3c1Rlc3RVcmwpO1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCdvcGVuJywgKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBzZWxmLm9wZW4gPSB0cnVlO1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnRGV2aWNlLlNlbnNvckxvZyBjb25uZWN0ZWQgdG8gYmFja2VuZCEnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIGZ1bmN0aW9uKGRhdGE6IGFueSkge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnRGF0YSByZWNlaXZlZCBmcm9tIGJhY2stZW5kOiAnICsgZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsICh3czogV2ViU29ja2V0LCBlcnI6IEVycm9yKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5lcnJvcignLS0tIHNvY2tldC5vbjogZXJyb3InICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XHJcbiAgICAgICAgICAgIHdzLmNsb3NlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gQVpVUkUgSU9UXHJcblxyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvblN0cmluZyA9ICdIb3N0TmFtZT1pb3RodWJpb3RsYWJzLmF6dXJlLWRldmljZXMubmV0O0RldmljZUlkPXR3aWxpZ2h0LXNvdW5kLTc5OGNkODA7JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1NoYXJlZEFjY2Vzc0tleT03am9iaW1QcVlaRUZ2ZnNqU1laTW1SamtrN3hJczZjczcyMUFJUllIcE1VPSc7XHJcbiAgICAgICAgdGhpcy5jbGllbnQgPSBDbGllbnQuZnJvbUNvbm5lY3Rpb25TdHJpbmcodGhpcy5jb25uZWN0aW9uU3RyaW5nLCBNcXR0KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXR0cigpOiBTZW5zb3JBdHRyaWJ1dGVzIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hdHRyO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGdldFN0YXRlKCk6IFNlbnNvclN0YXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBzdGFydExvZ2dpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RhcnRMb2dnaW5nJyk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RvcExvZ2dpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RvcExvZ2dpbmcnKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQcmludCBBWlVSRSBJT1QgcmVzdWx0cy5cclxuICAgIHByaXZhdGUgcHJpbnRSZXN1bHRGb3Iob3A6IHN0cmluZyk6IGFueSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHByaW50UmVzdWx0KGVycjogYW55LCByZXM6IGFueSkge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgbG9nLmVycm9yKG9wICsgJyBBWlVSRSBJT1QgZXJyb3I6ICcgKyBlcnIudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgbG9nLmluZm8ob3AgKyAnIEFaVVJFIElPVCBzdGF0dXM6ICcgKyByZXMuY29uc3RydWN0b3IubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICB9XHJcbiAgICBwcml2YXRlIG9uU2Vuc29yRGF0YVJlY2VpdmVkKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2dnaW5nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlc2NyID0geyBTTjogdGhpcy5hdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gZGF0YS50aW1lc3RhbXAoKSAtIHRoaXMudGltZXN0YW1wO1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IGRhdGEudGltZXN0YW1wKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSAnLycgKyBkZXNjci5TTiArICcvJysgZGVzY3IucG9ydDtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdVUkw6ICcsIHVybCk7XHJcbiAgICAgICAgICAgIHRoaXMuYXhpb3MucG9zdCh1cmwsIHNlbnNvckxvZylcclxuICAgICAgICAgICAgLnRoZW4gKGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZ2dlciBheGlvcy5wb3N0ICcgKyB1cmwgKyAnICcgKyByZXMuc3RhdHVzVGV4dCArXHJcbiAgICAgICAgICAgICAgICAgICAgJyByZXMuZGF0YTogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykgKyAnIG1zOiAnICsgZGlmZiArXHJcbiAgICAgICAgICAgICAgICAgICAgJyBkYXRlOiAnICsgbmV3IERhdGUoZGF0YS50aW1lc3RhbXAoKSkudG9JU09TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJ2NhdGNoIGVycm9yOiAnLCBKU09OLnN0cmluZ2lmeShlKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gQVpVUkUgSU9UXHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBuZXcgTWVzc2FnZShKU09OLnN0cmluZ2lmeShzZW5zb3JMb2cpKTtcclxuICAgICAgICAgICAgbWVzc2FnZS5wcm9wZXJ0aWVzLmFkZCgnRGVsdGEgdGltZScsIGRpZmYudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xpZW50LnNlbmRFdmVudChtZXNzYWdlLCB0aGlzLnByaW50UmVzdWx0Rm9yKCdzZW5kJykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uTW9uaXRvcihkYXRhOiBTZW5zb3JEYXRhKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cub25Nb25pdG9yJyk7XHJcbiAgICAgICAgY29uc3QgZGVzY3IgPSB7IFNOOiB0aGlzLmF0dHIuU04sIHBvcnQ6IGRhdGEuZ2V0UG9ydCgpfTtcclxuICAgICAgICBjb25zdCBzYW1wbGVzID0gW3tkYXRlOiBkYXRhLnRpbWVzdGFtcCgpLCB2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpfV07XHJcbiAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgIGlmICh0aGlzLnNvY2tldCkge1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldC5zZW5kKHNlbnNvckxvZyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxufVxyXG4iXX0=
