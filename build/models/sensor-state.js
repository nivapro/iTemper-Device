"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var logger_1 = require("./../logger");
var sensor_data_1 = require("./sensor-data");
var Sensor = (function () {
    function Sensor() {
    }
    return Sensor;
}());
exports.Sensor = Sensor;
var SensorState = (function () {
    function SensorState() {
        this.sensors = [];
        this.sensorDataListeners = [];
    }
    SensorState.prototype.getSensorData = function () {
        var sensorData = [];
        for (var _i = 0, _a = this.sensors; _i < _a.length; _i++) {
            var sensor = _a[_i];
            sensorData.push(sensor.s);
        }
        return sensorData.slice();
    };
    SensorState.prototype.addSensorDataListener = function (onSensorDataReceived, filter) {
        if (filter === void 0) { filter = {}; }
        this.sensorDataListeners.push({ listener: onSensorDataReceived, filter: filter });
    };
    SensorState.prototype.round = function (data, resolution) {
        var multiplier = Math.pow(10, resolution || 0);
        return Math.round(data.getValue() * multiplier) / multiplier;
    };
    SensorState.prototype.valueDiff = function (sensorData, previousData, resolution) {
        var valueDiff = Math.abs(this.round(sensorData, resolution) - this.round(previousData, resolution));
        logger_1.log.debug('value diff', valueDiff);
        return valueDiff > 0;
    };
    SensorState.prototype.timeDiff = function (sensorData, previousData, maxTimeDiff) {
        var timeDiff = sensorData.timestamp() - previousData.timestamp();
        logger_1.log.info('Time diff: ', timeDiff);
        return timeDiff > maxTimeDiff;
    };
    SensorState.prototype.updateSensorDataListeners = function (sensorData, previousData) {
        logger_1.log.debug('updateSensorDataListeners');
        for (var _i = 0, _a = this.sensorDataListeners; _i < _a.length; _i++) {
            var publish = _a[_i];
            logger_1.log.debug('updateSensorDataListeners, filter:', publish.filter);
            if (!publish.filter) {
                logger_1.log.debug('updateSensorDataListeners, no filter found');
                publish.listener(sensorData);
                Object.assign(previousData, sensorData);
            }
            else if (publish.filter.resolution &&
                this.valueDiff(sensorData, previousData, publish.filter.resolution) && sensorData.valid()) {
                logger_1.log.debug('updateSensorDataListeners, publish.filter.resolution');
                publish.listener(sensorData);
                Object.assign(previousData, sensorData);
            }
            else if (publish.filter.maxTimeDiff && sensorData.valid() &&
                this.timeDiff(sensorData, previousData, publish.filter.maxTimeDiff)) {
                logger_1.log.debug('updateSensorDataListeners, publish.filter.maxTimeDiff');
                publish.listener(sensorData);
                Object.assign(previousData, sensorData);
            }
            else {
                logger_1.log.debug('updateSensorDataListeners, else');
                publish.listener(sensorData);
            }
        }
    };
    SensorState.prototype.updateSensor = function (port, temperature) {
        if (this.sensors !== null) {
            var sensor = this.sensors.find(function (s) { return s.s.getPort() === port; });
            if (sensor) {
                sensor.s.setValue(temperature);
                this.updateSensorDataListeners(sensor.s, sensor.p);
                logger_1.log.debug('SensorState.updateSensor, port: %d, temperature %d', port, temperature);
            }
            else {
                logger_1.log.error('*** SensorState.updateSensor, undefined, port: %d, temperature %d', port, temperature);
            }
        }
        else {
            logger_1.log.error('*** SensorState.updateSensor, no sensors, port: %d, temperature %d', port, temperature);
        }
    };
    SensorState.prototype.connectSensors = function (total, used) {
        logger_1.log.debug('--- connectSensors, total:%d', total);
        if (this.sensors.length === 0) {
            this.sensors = new Array(total);
            logger_1.log.debug('connectSensors, this.sensors.length: ', this.sensors.length);
            var bits = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80];
            var sensorIndex = 0;
            for (var bit = 0; bit < bits.length; bit++) {
                if ((used & bits[bit]) === bits[bit]) {
                    var port = bit;
                    logger_1.log.debug('--- connectSensors, port: ', port);
                    this.sensors[sensorIndex] = { p: new sensor_data_1.SensorData(port), s: new sensor_data_1.SensorData(port) };
                    logger_1.log.debug('+++ connectSensors, port: %d', port);
                    sensorIndex += 1;
                }
            }
            if (sensorIndex !== total) {
                logger_1.log.error('*** connectSensors, #sensors: %d !== total: %d', sensorIndex, total);
                return;
            }
        }
    };
    return SensorState;
}());
exports.SensorState = SensorState;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLXN0YXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWtDO0FBQ2xDLDZDQUEyQztBQVUzQztJQUFBO0lBQWlFLENBQUM7SUFBRCxhQUFDO0FBQUQsQ0FBakUsQUFBa0UsSUFBQTtBQUFyRCx3QkFBTTtBQUNuQjtJQUFBO1FBR2MsWUFBTyxHQUFhLEVBQUUsQ0FBQztRQUV2Qix3QkFBbUIsR0FBeUIsRUFBRSxDQUFDO0lBOEY3RCxDQUFDO0lBNUZVLG1DQUFhLEdBQXBCO1FBQ0ksSUFBTSxVQUFVLEdBQWlCLEVBQUUsQ0FBQztRQUNwQyxHQUFHLENBQUMsQ0FBaUIsVUFBWSxFQUFaLEtBQUEsSUFBSSxDQUFDLE9BQU8sRUFBWixjQUFZLEVBQVosSUFBWTtZQUE1QixJQUFNLE1BQU0sU0FBQTtZQUNiLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzdCO1FBQ0QsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBQ00sMkNBQXFCLEdBQTVCLFVBQTZCLG9CQUFrRCxFQUFFLE1BQXlCO1FBQXpCLHVCQUFBLEVBQUEsV0FBeUI7UUFDdEcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBRSxFQUFDLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLFFBQUEsRUFBQyxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUNPLDJCQUFLLEdBQWIsVUFBYyxJQUFnQixFQUFFLFVBQWtCO1FBQzlDLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFVBQVUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsVUFBVSxDQUFDLEdBQUcsVUFBVSxDQUFDO0lBQ2pFLENBQUM7SUFDTywrQkFBUyxHQUFqQixVQUFrQixV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aW1wb3J0IHsgbG9nIH0gZnJvbSAnLi8uLi9sb2dnZXInO1xyXG5pbXBvcnQgeyBTZW5zb3JEYXRhIH0gZnJvbSAnLi9zZW5zb3ItZGF0YSc7ZXhwb3J0IGludGVyZmFjZSBGaWx0ZXJDb25maWcge1xyXG4gICAgcmVzb2x1dGlvbj86IG51bWJlcjtcclxuICAgIG1heFRpbWVEaWZmPzogbnVtYmVyO1xyXG4gICAgcG9ydHM/OiBudW1iZXJbXTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTZW5zb3JEYXRhTGlzdGVuZXIge1xyXG4gICAgbGlzdGVuZXI6IChzZW5zb3I6IFNlbnNvckRhdGEpID0+IHZvaWQ7XHJcbiAgICBmaWx0ZXI/OiBGaWx0ZXJDb25maWc7XHJcbn1cclxuZXhwb3J0IGNsYXNzIFNlbnNvciB7IHB1YmxpYyBwOiBTZW5zb3JEYXRhOyBwdWJsaWMgczogU2Vuc29yRGF0YTt9XHJcbmV4cG9ydCBjbGFzcyBTZW5zb3JTdGF0ZSB7XHJcblxyXG4gICAgLy8gb3IgYSBodW1pZGl0eSBzZW5zb3IsIGJ1dCB0aGUgbGF0dGVyIGlzIG91dCBvZiBzY29wZS5cclxuICAgIHByb3RlY3RlZCBzZW5zb3JzOiBTZW5zb3JbXSA9IFtdO1xyXG4gICAgLy8gcHJpdmF0ZSAgdXNlZFBvcnRzOiBudW1iZXJbXTtcclxuICAgIHByb3RlY3RlZCBzZW5zb3JEYXRhTGlzdGVuZXJzOiBTZW5zb3JEYXRhTGlzdGVuZXJbXSA9IFtdO1xyXG5cclxuICAgIHB1YmxpYyBnZXRTZW5zb3JEYXRhKCk6IFNlbnNvckRhdGFbXSB7XHJcbiAgICAgICAgY29uc3Qgc2Vuc29yRGF0YTogU2Vuc29yRGF0YVtdID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBzZW5zb3Igb2YgdGhpcy5zZW5zb3JzKSB7XHJcbiAgICAgICAgICAgIHNlbnNvckRhdGEucHVzaChzZW5zb3Iucyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzZW5zb3JEYXRhLnNsaWNlKCk7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgYWRkU2Vuc29yRGF0YUxpc3RlbmVyKG9uU2Vuc29yRGF0YVJlY2VpdmVkOiAoc2Vuc29yOiBTZW5zb3JEYXRhKSA9PiB2b2lkLCBmaWx0ZXI6IEZpbHRlckNvbmZpZyA9IHt9KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zZW5zb3JEYXRhTGlzdGVuZXJzLnB1c2ggKHtsaXN0ZW5lcjogb25TZW5zb3JEYXRhUmVjZWl2ZWQsIGZpbHRlcn0pO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSByb3VuZChkYXRhOiBTZW5zb3JEYXRhLCByZXNvbHV0aW9uOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIGNvbnN0IG11bHRpcGxpZXIgPSBNYXRoLnBvdygxMCwgcmVzb2x1dGlvbiB8fCAwKTtcclxuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChkYXRhLmdldFZhbHVlKCkgKiBtdWx0aXBsaWVyKSAvIG11bHRpcGxpZXI7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHZhbHVlRGlmZihzZW5zb3JEYXRhOiBTZW5zb3JEYXRhLCBwcmV2aW91c0RhdGE6IFNlbnNvckRhdGEsIHJlc29sdXRpb246IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlRGlmZiA9ICBNYXRoLmFicyh0aGlzLnJvdW5kKHNlbnNvckRhdGEsIHJlc29sdXRpb24pIC0gdGhpcy5yb3VuZChwcmV2aW91c0RhdGEsIHJlc29sdXRpb24pKTtcclxuICAgICAgICBsb2cuZGVidWcoJ3ZhbHVlIGRpZmYnLCB2YWx1ZURpZmYpO1xyXG4gICAgICAgIHJldHVybiB2YWx1ZURpZmYgPiAwO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdGltZURpZmYoc2Vuc29yRGF0YTogU2Vuc29yRGF0YSwgcHJldmlvdXNEYXRhOiBTZW5zb3JEYXRhLCBtYXhUaW1lRGlmZjogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3QgdGltZURpZmYgPSBzZW5zb3JEYXRhLnRpbWVzdGFtcCgpIC0gcHJldmlvdXNEYXRhLnRpbWVzdGFtcCgpO1xyXG4gICAgICAgIGxvZy5pbmZvKCdUaW1lIGRpZmY6ICcsIHRpbWVEaWZmKTtcclxuICAgICAgICByZXR1cm4gdGltZURpZmYgPiBtYXhUaW1lRGlmZjtcclxuICAgIH1cclxuICAgIHByaXZhdGUgdXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycyhzZW5zb3JEYXRhOiBTZW5zb3JEYXRhLCBwcmV2aW91c0RhdGE6IFNlbnNvckRhdGEpIHtcclxuICAgICAgICBsb2cuZGVidWcoJ3VwZGF0ZVNlbnNvckRhdGFMaXN0ZW5lcnMnKTtcclxuICAgICAgICBmb3IgKGNvbnN0IHB1Ymxpc2ggb2YgdGhpcy5zZW5zb3JEYXRhTGlzdGVuZXJzKSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygndXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycywgZmlsdGVyOicsIHB1Ymxpc2guZmlsdGVyKTtcclxuICAgICAgICAgICAgaWYgKCFwdWJsaXNoLmZpbHRlcikge1xyXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCd1cGRhdGVTZW5zb3JEYXRhTGlzdGVuZXJzLCBubyBmaWx0ZXIgZm91bmQnKTtcclxuICAgICAgICAgICAgICAgIHB1Ymxpc2gubGlzdGVuZXIoc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHByZXZpb3VzRGF0YSwgc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocHVibGlzaC5maWx0ZXIucmVzb2x1dGlvbiAmJlxyXG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZURpZmYoc2Vuc29yRGF0YSwgcHJldmlvdXNEYXRhLCBwdWJsaXNoLmZpbHRlci5yZXNvbHV0aW9uKSAmJiBzZW5zb3JEYXRhLnZhbGlkKCkpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygndXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycywgcHVibGlzaC5maWx0ZXIucmVzb2x1dGlvbicpO1xyXG4gICAgICAgICAgICAgICAgcHVibGlzaC5saXN0ZW5lcihzZW5zb3JEYXRhKTtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocHJldmlvdXNEYXRhLCBzZW5zb3JEYXRhKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChwdWJsaXNoLmZpbHRlci5tYXhUaW1lRGlmZiAmJiBzZW5zb3JEYXRhLnZhbGlkKCkgJiZcclxuICAgICAgICAgICAgICAgIHRoaXMudGltZURpZmYoc2Vuc29yRGF0YSwgcHJldmlvdXNEYXRhLCBwdWJsaXNoLmZpbHRlci5tYXhUaW1lRGlmZikpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygndXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycywgcHVibGlzaC5maWx0ZXIubWF4VGltZURpZmYnKTtcclxuICAgICAgICAgICAgICAgIHB1Ymxpc2gubGlzdGVuZXIoc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHByZXZpb3VzRGF0YSwgc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ3VwZGF0ZVNlbnNvckRhdGFMaXN0ZW5lcnMsIGVsc2UnKTtcclxuICAgICAgICAgICAgICAgIHB1Ymxpc2gubGlzdGVuZXIoc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcm90ZWN0ZWQgdXBkYXRlU2Vuc29yKHBvcnQ6IG51bWJlciwgdGVtcGVyYXR1cmU6IG51bWJlcikge1xyXG4gICAgICAgIGlmICh0aGlzLnNlbnNvcnMgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yOiBTZW5zb3IgfCB1bmRlZmluZWQgPSB0aGlzLnNlbnNvcnMuZmluZChzID0+IHMucy5nZXRQb3J0KCkgPT09IHBvcnQpO1xyXG4gICAgICAgICAgICBpZiAoc2Vuc29yKSB7XHJcbiAgICAgICAgICAgICAgICBzZW5zb3Iucy5zZXRWYWx1ZSh0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbnNvckRhdGFMaXN0ZW5lcnMoc2Vuc29yLnMsIHNlbnNvci5wKTtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnU2Vuc29yU3RhdGUudXBkYXRlU2Vuc29yLCBwb3J0OiAlZCwgdGVtcGVyYXR1cmUgJWQnLCBwb3J0LCB0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBTZW5zb3JTdGF0ZS51cGRhdGVTZW5zb3IsIHVuZGVmaW5lZCwgcG9ydDogJWQsIHRlbXBlcmF0dXJlICVkJywgcG9ydCwgdGVtcGVyYXR1cmUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbG9nLmVycm9yKCcqKiogU2Vuc29yU3RhdGUudXBkYXRlU2Vuc29yLCBubyBzZW5zb3JzLCBwb3J0OiAlZCwgdGVtcGVyYXR1cmUgJWQnLCBwb3J0LCB0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJvdGVjdGVkIGNvbm5lY3RTZW5zb3JzKHRvdGFsOiBudW1iZXIsIHVzZWQ6IG51bWJlcikge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIGNvbm5lY3RTZW5zb3JzLCB0b3RhbDolZCcsIHRvdGFsKTtcclxuICAgICAgICBpZiAodGhpcy5zZW5zb3JzLmxlbmd0aCA9PT0gMCkge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZW5zb3JzID0gbmV3IEFycmF5PFNlbnNvcj4odG90YWwpO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ2Nvbm5lY3RTZW5zb3JzLCB0aGlzLnNlbnNvcnMubGVuZ3RoOiAnLCB0aGlzLnNlbnNvcnMubGVuZ3RoKTtcclxuICAgICAgICAgICAgY29uc3QgYml0czogbnVtYmVyW10gPSBbMHgwMSwgMHgwMiwgMHgwNCwgMHgwOCwgMHgxMCwgMHgyMCwgMHg0MCwgMHg4MF07XHJcbiAgICAgICAgICAgIGxldCBzZW5zb3JJbmRleDogbnVtYmVyID0gMDtcclxuXHJcbiAgICAgICAgICAgIC8vIENoZWNrIHRoZSBiaXQgYXJyYXkgZm9yIHVzZWQgcG9ydHMsIG9uZSBiaXQgYXQgYSB0aW1lXHJcbiAgICAgICAgICAgIGZvciAobGV0IGJpdCA9IDA7IGJpdCA8IGJpdHMubGVuZ3RoOyBiaXQrKykge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICgodXNlZCAmIGJpdHNbYml0XSkgPT09IGJpdHNbYml0XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcnQgPSBiaXQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nLmRlYnVnKCctLS0gY29ubmVjdFNlbnNvcnMsIHBvcnQ6ICcsIHBvcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2Vuc29yc1tzZW5zb3JJbmRleF0gPSB7IHA6IG5ldyBTZW5zb3JEYXRhKHBvcnQpLCBzOiBuZXcgU2Vuc29yRGF0YShwb3J0KSB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnKysrIGNvbm5lY3RTZW5zb3JzLCBwb3J0OiAlZCcsIHBvcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbnNvckluZGV4ICs9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzZW5zb3JJbmRleCAhPT0gdG90YWwpIHtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IEVycm9yIGhhbmRsaW5nXHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBjb25uZWN0U2Vuc29ycywgI3NlbnNvcnM6ICVkICE9PSB0b3RhbDogJWQnLCBzZW5zb3JJbmRleCwgdG90YWwpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxufVxyXG4iXX0=
