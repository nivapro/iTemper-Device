"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var logger_1 = require("./../logger");
var sensor_data_1 = require("./sensor-data");
var Sensor = (function () {
    function Sensor() {
    }
    return Sensor;
}());
exports.Sensor = Sensor;
var SensorState = (function () {
    function SensorState() {
        this.sensors = [];
        this.sensorDataListeners = [];
    }
    SensorState.prototype.getSensorData = function () {
        var sensorData = [];
        for (var _i = 0, _a = this.sensors; _i < _a.length; _i++) {
            var sensor = _a[_i];
            sensorData.push(sensor.s);
        }
        return sensorData.slice();
    };
    SensorState.prototype.addSensorDataListener = function (onSensorDataReceived, filter) {
        if (filter === void 0) { filter = {}; }
        this.sensorDataListeners.push({ listener: onSensorDataReceived, filter: filter });
    };
    SensorState.prototype.round = function (data, resolution) {
        var multiplier = Math.pow(10, resolution || 0);
        return Math.round(data.getValue() * multiplier) / multiplier;
    };
    SensorState.prototype.valueDiff = function (sensorData, previousData, resolution) {
        var valueDiff = Math.abs(this.round(sensorData, resolution) - this.round(previousData, resolution));
        logger_1.log.debug('value diff', valueDiff);
        return valueDiff > 0;
    };
    SensorState.prototype.timeDiff = function (sensorData, previousData, maxTimeDiff) {
        var timeDiff = sensorData.timestamp() - previousData.timestamp();
        logger_1.log.info('Time diff: ', timeDiff);
        return timeDiff > maxTimeDiff;
    };
    SensorState.prototype.updateSensorDataListeners = function (sensorData, previousData) {
        logger_1.log.debug('updateSensorDataListeners');
        for (var _i = 0, _a = this.sensorDataListeners; _i < _a.length; _i++) {
            var publish = _a[_i];
            logger_1.log.debug('updateSensorDataListeners, filter:', JSON.stringify(publish.filter));
            if (!publish.filter) {
                logger_1.log.info('updateSensorDataListeners, no filter found');
                publish.listener(sensorData);
                Object.assign(previousData, sensorData);
            }
            else if (publish.filter.resolution &&
                this.valueDiff(sensorData, previousData, publish.filter.resolution) && sensorData.valid()) {
                logger_1.log.info('updateSensorDataListeners, publish.filter.resolution');
                publish.listener(sensorData);
                Object.assign(previousData, sensorData);
            }
            else if (publish.filter.maxTimeDiff && sensorData.valid() &&
                this.timeDiff(sensorData, previousData, publish.filter.maxTimeDiff)) {
                logger_1.log.info('updateSensorDataListeners, publish.filter.maxTimeDiff');
                publish.listener(sensorData);
                Object.assign(previousData, sensorData);
            }
        }
    };
    SensorState.prototype.updateSensor = function (port, temperature) {
        if (this.sensors !== null) {
            var sensor = this.sensors.find(function (s) { return s.s.getPort() === port; });
            if (sensor) {
                sensor.s.setValue(temperature);
                this.updateSensorDataListeners(sensor.s, sensor.p);
                logger_1.log.info('SensorState.updateSensor, port: %d, temperature %d', port, temperature);
            }
            else {
                logger_1.log.error('*** SensorState.updateSensor, undefined, port: %d, temperature %d', port, temperature);
            }
        }
        else {
            logger_1.log.error('*** SensorState.updateSensor, no sensors, port: %d, temperature %d', port, temperature);
        }
    };
    SensorState.prototype.connectSensors = function (total, used) {
        logger_1.log.debug('--- connectSensors, total:%d', total);
        if (this.sensors.length === 0) {
            this.sensors = new Array(total);
            logger_1.log.debug('connectSensors, this.sensors.length: ', this.sensors.length);
            var bits = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80];
            var sensorIndex = 0;
            for (var bit = 0; bit < bits.length; bit++) {
                if ((used & bits[bit]) === bits[bit]) {
                    var port = bit;
                    logger_1.log.debug('--- connectSensors, port: ', port);
                    this.sensors[sensorIndex] = { p: new sensor_data_1.SensorData(port), s: new sensor_data_1.SensorData(port) };
                    logger_1.log.debug('+++ connectSensors, port: %d', port);
                    sensorIndex += 1;
                }
            }
            if (sensorIndex !== total) {
                logger_1.log.error('*** connectSensors, #sensors: %d !== total: %d', sensorIndex, total);
                return;
            }
        }
    };
    return SensorState;
}());
exports.SensorState = SensorState;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLXN0YXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWtDO0FBQ2xDLDZDQUEyQztBQVUzQztJQUFBO0lBQWlFLENBQUM7SUFBRCxhQUFDO0FBQUQsQ0FBakUsQUFBa0UsSUFBQTtBQUFyRCx3QkFBTTtBQUNuQjtJQUFBO1FBR2MsWUFBTyxHQUFhLEVBQUUsQ0FBQztRQUV2Qix3QkFBbUIsR0FBeUIsRUFBRSxDQUFDO0lBMkY3RCxDQUFDO0lBekZVLG1DQUFhLEdBQXBCO1FBQ0ksSUFBTSxVQUFVLEdBQWlCLEVBQUUsQ0FBQztRQUNwQyxHQUFHLENBQUMsQ0FBaUIsVUFBWSxFQUFaLEtBQUEsSUFBSSxDQUFDLE9BQU8sRUFBWixjQUFZLEVBQVosSUFBWTtZQUE1QixJQUFNLE1BQU0sU0FBQTtZQUNiLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzdCO1FBQ0QsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBQ00sMkNBQXFCLEdBQTVCLFVBQTZCLG9CQUFrRCxFQUFFLE1BQXlCO1FBQXpCLHVCQUFBLEVBQUEsV0FBeUI7UUFDdEcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBRSxFQUFDLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLFFBQUEsRUFBQyxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUNPLDJCQUFLLEdBQWIsVUFBYyxJQUFnQixFQUFFLFVBQWtCO1FBQzlDLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFVBQVUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsVUFBVSxDQUFDLEdBQUcsVUFBVSxDQUFDO0lBQ2pFLENBQUM7SUFDTywrQkFBUyxHQUFqQixVQUFrQixV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QUN4RSxJQUFJLFdBQVcsR0FBVyxDQUFDLENBQUM7WUFHNUIsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUM7Z0JBRXpDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ25DLElBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQztvQkFDakIsWUFBRyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDOUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxJQUFJLHdCQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksd0JBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO29CQUNqRixZQUFHLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLElBQUksQ0FBQyxDQUFDO29CQUNoRCxXQUFXLElBQUksQ0FBQyxDQUFDO2dCQUNyQixDQUFDO1lBQ0wsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUV4QixZQUFHLENBQUMsS0FBSyxDQUFDLGdEQUFnRCxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDaEYsTUFBTSxDQUFDO1lBQ1gsQ0FBQztRQUNMLENBQUM7SUFFTCxDQUFDO0lBQ0wsa0JBQUM7QUFBRCxDQWhHQSxBQWdHQyxJQUFBO0FBaEdZLGtDQUFXIiwiZmlsZSI6Im1vZGVscy9zZW5zb3Itc3RhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2cgfSBmcm9tICcuLy4uL2xvZ2dlcic7XHJcbmltcG9ydCB7IFNlbnNvckRhdGEgfSBmcm9tICcuL3NlbnNvci1kYXRhJztleHBvcnQgaW50ZXJmYWNlIEZpbHRlckNvbmZpZyB7XHJcbiAgICByZXNvbHV0aW9uPzogbnVtYmVyO1xyXG4gICAgbWF4VGltZURpZmY/OiBudW1iZXI7XHJcbiAgICBwb3J0cz86IG51bWJlcltdO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFNlbnNvckRhdGFMaXN0ZW5lciB7XHJcbiAgICBsaXN0ZW5lcjogKHNlbnNvcjogU2Vuc29yRGF0YSkgPT4gdm9pZDtcclxuICAgIGZpbHRlcj86IEZpbHRlckNvbmZpZztcclxufVxyXG5leHBvcnQgY2xhc3MgU2Vuc29yIHsgcHVibGljIHA6IFNlbnNvckRhdGE7IHB1YmxpYyBzOiBTZW5zb3JEYXRhO31cclxuZXhwb3J0IGNsYXNzIFNlbnNvclN0YXRlIHtcclxuXHJcbiAgICAvLyBvciBhIGh1bWlkaXR5IHNlbnNvciwgYnV0IHRoZSBsYXR0ZXIgaXMgb3V0IG9mIHNjb3BlLlxyXG4gICAgcHJvdGVjdGVkIHNlbnNvcnM6IFNlbnNvcltdID0gW107XHJcbiAgICAvLyBwcml2YXRlICB1c2VkUG9ydHM6IG51bWJlcltdO1xyXG4gICAgcHJvdGVjdGVkIHNlbnNvckRhdGFMaXN0ZW5lcnM6IFNlbnNvckRhdGFMaXN0ZW5lcltdID0gW107XHJcblxyXG4gICAgcHVibGljIGdldFNlbnNvckRhdGEoKTogU2Vuc29yRGF0YVtdIHtcclxuICAgICAgICBjb25zdCBzZW5zb3JEYXRhOiBTZW5zb3JEYXRhW10gPSBbXTtcclxuICAgICAgICBmb3IgKGNvbnN0IHNlbnNvciBvZiB0aGlzLnNlbnNvcnMpIHtcclxuICAgICAgICAgICAgc2Vuc29yRGF0YS5wdXNoKHNlbnNvci5zKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHNlbnNvckRhdGEuc2xpY2UoKTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBhZGRTZW5zb3JEYXRhTGlzdGVuZXIob25TZW5zb3JEYXRhUmVjZWl2ZWQ6IChzZW5zb3I6IFNlbnNvckRhdGEpID0+IHZvaWQsIGZpbHRlcjogRmlsdGVyQ29uZmlnID0ge30pOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNlbnNvckRhdGFMaXN0ZW5lcnMucHVzaCAoe2xpc3RlbmVyOiBvblNlbnNvckRhdGFSZWNlaXZlZCwgZmlsdGVyfSk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHJvdW5kKGRhdGE6IFNlbnNvckRhdGEsIHJlc29sdXRpb246IG51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IE1hdGgucG93KDEwLCByZXNvbHV0aW9uIHx8IDApO1xyXG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKGRhdGEuZ2V0VmFsdWUoKSAqIG11bHRpcGxpZXIpIC8gbXVsdGlwbGllcjtcclxuICAgIH1cclxuICAgIHByaXZhdGUgdmFsdWVEaWZmKHNlbnNvckRhdGE6IFNlbnNvckRhdGEsIHByZXZpb3VzRGF0YTogU2Vuc29yRGF0YSwgcmVzb2x1dGlvbjogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3QgdmFsdWVEaWZmID0gIE1hdGguYWJzKHRoaXMucm91bmQoc2Vuc29yRGF0YSwgcmVzb2x1dGlvbikgLSB0aGlzLnJvdW5kKHByZXZpb3VzRGF0YSwgcmVzb2x1dGlvbikpO1xyXG4gICAgICAgIGxvZy5kZWJ1ZygndmFsdWUgZGlmZicsIHZhbHVlRGlmZik7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlRGlmZiA+IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0aW1lRGlmZihzZW5zb3JEYXRhOiBTZW5zb3JEYXRhLCBwcmV2aW91c0RhdGE6IFNlbnNvckRhdGEsIG1heFRpbWVEaWZmOiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCB0aW1lRGlmZiA9IHNlbnNvckRhdGEudGltZXN0YW1wKCkgLSBwcmV2aW91c0RhdGEudGltZXN0YW1wKCk7XHJcbiAgICAgICAgbG9nLmluZm8oJ1RpbWUgZGlmZjogJywgdGltZURpZmYpO1xyXG4gICAgICAgIHJldHVybiB0aW1lRGlmZiA+IG1heFRpbWVEaWZmO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSB1cGRhdGVTZW5zb3JEYXRhTGlzdGVuZXJzKHNlbnNvckRhdGE6IFNlbnNvckRhdGEsIHByZXZpb3VzRGF0YTogU2Vuc29yRGF0YSkge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygndXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycycpO1xyXG4gICAgICAgIGZvciAoY29uc3QgcHVibGlzaCBvZiB0aGlzLnNlbnNvckRhdGFMaXN0ZW5lcnMpIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCd1cGRhdGVTZW5zb3JEYXRhTGlzdGVuZXJzLCBmaWx0ZXI6JywgSlNPTi5zdHJpbmdpZnkocHVibGlzaC5maWx0ZXIpKTtcclxuICAgICAgICAgICAgaWYgKCFwdWJsaXNoLmZpbHRlcikge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ3VwZGF0ZVNlbnNvckRhdGFMaXN0ZW5lcnMsIG5vIGZpbHRlciBmb3VuZCcpO1xyXG4gICAgICAgICAgICAgICAgcHVibGlzaC5saXN0ZW5lcihzZW5zb3JEYXRhKTtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocHJldmlvdXNEYXRhLCBzZW5zb3JEYXRhKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChwdWJsaXNoLmZpbHRlci5yZXNvbHV0aW9uICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLnZhbHVlRGlmZihzZW5zb3JEYXRhLCBwcmV2aW91c0RhdGEsIHB1Ymxpc2guZmlsdGVyLnJlc29sdXRpb24pICYmIHNlbnNvckRhdGEudmFsaWQoKSkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ3VwZGF0ZVNlbnNvckRhdGFMaXN0ZW5lcnMsIHB1Ymxpc2guZmlsdGVyLnJlc29sdXRpb24nKTtcclxuICAgICAgICAgICAgICAgIHB1Ymxpc2gubGlzdGVuZXIoc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHByZXZpb3VzRGF0YSwgc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocHVibGlzaC5maWx0ZXIubWF4VGltZURpZmYgJiYgc2Vuc29yRGF0YS52YWxpZCgpICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpbWVEaWZmKHNlbnNvckRhdGEsIHByZXZpb3VzRGF0YSwgcHVibGlzaC5maWx0ZXIubWF4VGltZURpZmYpKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuaW5mbygndXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycywgcHVibGlzaC5maWx0ZXIubWF4VGltZURpZmYnKTtcclxuICAgICAgICAgICAgICAgIHB1Ymxpc2gubGlzdGVuZXIoc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHByZXZpb3VzRGF0YSwgc2Vuc29yRGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcm90ZWN0ZWQgdXBkYXRlU2Vuc29yKHBvcnQ6IG51bWJlciwgdGVtcGVyYXR1cmU6IG51bWJlcikge1xyXG4gICAgICAgIGlmICh0aGlzLnNlbnNvcnMgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yOiBTZW5zb3IgfCB1bmRlZmluZWQgPSB0aGlzLnNlbnNvcnMuZmluZChzID0+IHMucy5nZXRQb3J0KCkgPT09IHBvcnQpO1xyXG4gICAgICAgICAgICBpZiAoc2Vuc29yKSB7XHJcbiAgICAgICAgICAgICAgICBzZW5zb3Iucy5zZXRWYWx1ZSh0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbnNvckRhdGFMaXN0ZW5lcnMoc2Vuc29yLnMsIHNlbnNvci5wKTtcclxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTZW5zb3JTdGF0ZS51cGRhdGVTZW5zb3IsIHBvcnQ6ICVkLCB0ZW1wZXJhdHVyZSAlZCcsIHBvcnQsIHRlbXBlcmF0dXJlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxvZy5lcnJvcignKioqIFNlbnNvclN0YXRlLnVwZGF0ZVNlbnNvciwgdW5kZWZpbmVkLCBwb3J0OiAlZCwgdGVtcGVyYXR1cmUgJWQnLCBwb3J0LCB0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBTZW5zb3JTdGF0ZS51cGRhdGVTZW5zb3IsIG5vIHNlbnNvcnMsIHBvcnQ6ICVkLCB0ZW1wZXJhdHVyZSAlZCcsIHBvcnQsIHRlbXBlcmF0dXJlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcm90ZWN0ZWQgY29ubmVjdFNlbnNvcnModG90YWw6IG51bWJlciwgdXNlZDogbnVtYmVyKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gY29ubmVjdFNlbnNvcnMsIHRvdGFsOiVkJywgdG90YWwpO1xyXG4gICAgICAgIGlmICh0aGlzLnNlbnNvcnMubGVuZ3RoID09PSAwKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNlbnNvcnMgPSBuZXcgQXJyYXk8U2Vuc29yPih0b3RhbCk7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnY29ubmVjdFNlbnNvcnMsIHRoaXMuc2Vuc29ycy5sZW5ndGg6ICcsIHRoaXMuc2Vuc29ycy5sZW5ndGgpO1xyXG4gICAgICAgICAgICBjb25zdCBiaXRzOiBudW1iZXJbXSA9IFsweDAxLCAweDAyLCAweDA0LCAweDA4LCAweDEwLCAweDIwLCAweDQwLCAweDgwXTtcclxuICAgICAgICAgICAgbGV0IHNlbnNvckluZGV4OiBudW1iZXIgPSAwO1xyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgdGhlIGJpdCBhcnJheSBmb3IgdXNlZCBwb3J0cywgb25lIGJpdCBhdCBhIHRpbWVcclxuICAgICAgICAgICAgZm9yIChsZXQgYml0ID0gMDsgYml0IDwgYml0cy5sZW5ndGg7IGJpdCsrKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCh1c2VkICYgYml0c1tiaXRdKSA9PT0gYml0c1tiaXRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9ydCA9IGJpdDtcclxuICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoJy0tLSBjb25uZWN0U2Vuc29ycywgcG9ydDogJywgcG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5zb3JzW3NlbnNvckluZGV4XSA9IHsgcDogbmV3IFNlbnNvckRhdGEocG9ydCksIHM6IG5ldyBTZW5zb3JEYXRhKHBvcnQpIH07XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nLmRlYnVnKCcrKysgY29ubmVjdFNlbnNvcnMsIHBvcnQ6ICVkJywgcG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2Vuc29ySW5kZXggKz0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHNlbnNvckluZGV4ICE9PSB0b3RhbCkge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogRXJyb3IgaGFuZGxpbmdcclxuICAgICAgICAgICAgICAgIGxvZy5lcnJvcignKioqIGNvbm5lY3RTZW5zb3JzLCAjc2Vuc29yczogJWQgIT09IHRvdGFsOiAlZCcsIHNlbnNvckluZGV4LCB0b3RhbCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG59XHJcbiJdfQ==
