"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var os = require("os");
var logger_1 = require("./../logger");
var USBController = (function () {
    function USBController(hid, parser) {
        this.POLL_INTERVAL = 5000;
        this.deviceInitialized = false;
        this.hid = hid;
        this.reportParser = parser;
        this.initializeDevice();
        this.pollSensors();
    }
    USBController.prototype.initializeDevice = function () {
        if (!this.deviceInitialized) {
            this.hid.on('data', this.parseInput.bind(this));
            this.hid.on('error', this.parseError.bind(this));
            this.setPollingInterval(this.POLL_INTERVAL);
            this.deviceInitialized = true;
            logger_1.log.info('USBController.initializeDevice done');
        }
    };
    USBController.prototype.close = function () {
        this.deviceInitialized = false;
        try {
            this.hid.pause();
            this.hid.close();
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.setPollingInterval = function (ms) {
        this.POLL_INTERVAL = ms;
        clearInterval(this.interval);
        this.interval = setInterval(this.pollSensors.bind(this), this.POLL_INTERVAL);
        logger_1.log.info('USB Controller.setPollingInterval: %d', ms);
    };
    USBController.prototype.pollSensors = function () {
        if (!this.deviceInitialized) {
            this.initializeDevice();
        }
        else {
            logger_1.log.debug('+++ USBController.pollSensors');
            var initCommands = this.reportParser.initReport();
            for (var _i = 0, initCommands_1 = initCommands; _i < initCommands_1.length; _i++) {
                var command = initCommands_1[_i];
                this.writeReport(command);
            }
        }
    };
    USBController.prototype.parseInput = function (data) {
        try {
            var response = this.reportParser.parseInput(data);
            if (response.length > 0) {
                this.writeReport(response);
            }
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.parseError = function (_error) {
        logger_1.log.error('parseError: ', _error);
    };
    USBController.prototype.writeReport = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                this.hid.write(data);
                logger_1.log.debug('+++ USBController.writeReport', data);
            }
            catch (e) {
                logger_1.log.error('*** USBController.writeReport hid.write catch:&d', data);
                this.close();
            }
        }
    };
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSx1QkFBMEI7QUFFMUIsc0NBQWtDO0FBU2xDO0lBV0ksdUJBQVksR0FBWSxFQUFFLE1BQW9CO1FBTnRDLGtCQUFhLEdBQUcsSUFBSyxDQUFDO1FBRXRCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUs5QixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDO1FBQzNCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU0sd0NBQWdCLEdBQXZCO1FBQ0ksSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNqRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzVDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7WUFDOUIsWUFBRyxDQUFDLElBQUksQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1NBQ25EO0lBQ0wsQ0FBQztJQUVNLDZCQUFLLEdBQVo7UUFDSSxJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDO1FBQy9CLElBQUk7WUFDQSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDcEI7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE9BQU87U0FDVjtJQUNMLENBQUM7SUFFTSwwQ0FBa0IsR0FBekIsVUFBMEIsRUFBVTtRQUNoQyxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUN4QixhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM3RSxZQUFHLENBQUMsSUFBSSxDQUFDLHVDQUF1QyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFJTyxtQ0FBVyxHQUFuQjtRQUNJLElBQUksQ0FBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7U0FDM0I7YUFBTTtZQUNILFlBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztZQUMzQyxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3BELEtBQXNCLFVBQVksRUFBWiw2QkFBWSxFQUFaLDBCQUFZLEVBQVosSUFBWSxFQUFFO2dCQUEvQixJQUFNLE9BQU8scUJBQUE7Z0JBQ2QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM3QjtTQUNKO0lBQ0wsQ0FBQztJQUdPLGtDQUFVLEdBQWxCLFVBQW1CLElBQWM7UUFDN0IsSUFBSTtZQUNBLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BELElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDOUI7U0FDSjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBRVIsT0FBTztTQUNWO0lBQ0wsQ0FBQztJQUNPLGtDQUFVLEdBQWxCLFVBQW1CLE1BQVc7UUFDMUIsWUFBRyxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUdPLG1DQUFXLEdBQW5CLFVBQW9CLElBQWM7UUFFOUIsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLEtBQUssT0FBTyxFQUFFO1lBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkI7UUFHRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3hCLElBQUk7Z0JBQ0EsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3JCLFlBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEQ7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDUixZQUFHLENBQUMsS0FBSyxDQUFDLGtEQUFrRCxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNwRSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDaEI7U0FFSjtJQUNMLENBQUM7SUFDTCxvQkFBQztBQUFELENBOUZBLEFBOEZDLElBQUE7QUE5Rlksc0NBQWEiLCJmaWxlIjoibW9kZWxzL3VzYi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCBISUQgPSByZXF1aXJlKCdub2RlLWhpZCcpO1xyXG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpO1xyXG5cclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi8uLi9sb2dnZXInO1xyXG5cclxuLy8gUmVwb3J0UGFyc2VyIGFsbG93IFVTQkNvbnRyb2xsZXIgdG8gYmUgaW5kZXBlbmRlbnQgb24gdGhlIHNwZWNpZmljXHJcbi8vIFRlbXBlciBkZXZpY2UgY29ubmVjdGVkLlxyXG5leHBvcnQgaW50ZXJmYWNlIFJlcG9ydFBhcnNlciB7XHJcbiAgICBpbml0UmVwb3J0KCk6IG51bWJlcltdW107XHJcbiAgICBwYXJzZUlucHV0KGRhdGE6IG51bWJlcltdKTogbnVtYmVyW107XHJcbn1cclxuLy8gSGFuZGxlIGEgc2Vuc29yIGRldmljZSBvbiB0aGUgVVNCIGh1Yi5cclxuZXhwb3J0IGNsYXNzIFVTQkNvbnRyb2xsZXIge1xyXG4gICAgcHJpdmF0ZSAgaGlkOiBISUQuSElEO1xyXG5cclxuICAgIHByaXZhdGUgcmVwb3J0UGFyc2VyOiBSZXBvcnRQYXJzZXI7XHJcblxyXG4gICAgcHJpdmF0ZSBQT0xMX0lOVEVSVkFMID0gNV8wMDA7XHJcblxyXG4gICAgcHJpdmF0ZSBkZXZpY2VJbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICAgIHByaXZhdGUgaW50ZXJ2YWw6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihoaWQ6IEhJRC5ISUQsIHBhcnNlcjogUmVwb3J0UGFyc2VyKSB7XHJcbiAgICAgICAgdGhpcy5oaWQgPSBoaWQ7XHJcbiAgICAgICAgdGhpcy5yZXBvcnRQYXJzZXIgPSBwYXJzZXI7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsaXplRGV2aWNlKCk7XHJcbiAgICAgICAgdGhpcy5wb2xsU2Vuc29ycygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpbml0aWFsaXplRGV2aWNlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5kZXZpY2VJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5vbignZGF0YScsIHRoaXMucGFyc2VJbnB1dC5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgdGhpcy5oaWQub24oJ2Vycm9yJywgdGhpcy5wYXJzZUVycm9yLmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICB0aGlzLnNldFBvbGxpbmdJbnRlcnZhbCh0aGlzLlBPTExfSU5URVJWQUwpO1xyXG4gICAgICAgICAgICB0aGlzLmRldmljZUluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ1VTQkNvbnRyb2xsZXIuaW5pdGlhbGl6ZURldmljZSBkb25lJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbG9zZSgpIHtcclxuICAgICAgICB0aGlzLmRldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5oaWQucGF1c2UoKTtcclxuICAgICAgICAgICAgdGhpcy5oaWQuY2xvc2UoKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldFBvbGxpbmdJbnRlcnZhbChtczogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5QT0xMX0lOVEVSVkFMID0gbXM7XHJcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsKTtcclxuICAgICAgICB0aGlzLmludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5wb2xsU2Vuc29ycy5iaW5kKHRoaXMpLCB0aGlzLlBPTExfSU5URVJWQUwpO1xyXG4gICAgICAgIGxvZy5pbmZvKCdVU0IgQ29udHJvbGxlci5zZXRQb2xsaW5nSW50ZXJ2YWw6ICVkJywgbXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRoaXMgaXMgd2VyZSBhbGwgc3RhcnRzIHdoZW4gc2V0IGludGVydmFsIHRpbWUgZXhwaXJlc1xyXG5cclxuICAgIHByaXZhdGUgcG9sbFNlbnNvcnMoKSB7XHJcbiAgICAgICAgaWYgKCEgdGhpcy5kZXZpY2VJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVEZXZpY2UoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJysrKyBVU0JDb250cm9sbGVyLnBvbGxTZW5zb3JzJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGluaXRDb21tYW5kcyA9IHRoaXMucmVwb3J0UGFyc2VyLmluaXRSZXBvcnQoKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBjb21tYW5kIG9mIGluaXRDb21tYW5kcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53cml0ZVJlcG9ydChjb21tYW5kKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIENhbGxlZCBmcm9tIEhJRCwgUGFyc2VzIGlucHV0IGZyb20gSElEIGFuZCB3cml0ZXMgYW55IHJlc3BvbnNlIG1lc3NhZ2VzXHJcbiAgICAvLyBiYWNrIHRvIHRoZSBkZXZpY2VcclxuICAgIHByaXZhdGUgcGFyc2VJbnB1dChkYXRhOiBudW1iZXJbXSk6IHZvaWQgIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMucmVwb3J0UGFyc2VyLnBhcnNlSW5wdXQoZGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLndyaXRlUmVwb3J0KHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgLy8gVE9ETyBlcnJvciBoYW5kbGluZyBpZiBwYXJzZSBpbnB1dCBlcnJvclxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBwYXJzZUVycm9yKF9lcnJvcjogYW55KSB7XHJcbiAgICAgICAgbG9nLmVycm9yKCdwYXJzZUVycm9yOiAnLCBfZXJyb3IpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEhlbHBlciBmdW5jdGlvbnMgdG8gd3JpdGUgcmVwb3J0cyB0byB0aGUgZGV2aWNlXHJcbiAgICBwcml2YXRlIHdyaXRlUmVwb3J0KGRhdGE6IG51bWJlcltdKTogdm9pZCB7XHJcblxyXG4gICAgICAgIGlmIChvcy5wbGF0Zm9ybSgpID09PSAnd2luMzInKSB7XHJcbiAgICAgICAgICAgIGRhdGEudW5zaGlmdCgwKTsgIC8vIHByZXBlbmQgYSB0aHJvd2F3YXkgYnl0ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gT3V0cHV0IHJlcG9ydFxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZC53cml0ZShkYXRhKTtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnKysrIFVTQkNvbnRyb2xsZXIud3JpdGVSZXBvcnQnLCBkYXRhKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKCcqKiogVVNCQ29udHJvbGxlci53cml0ZVJlcG9ydCBoaWQud3JpdGUgY2F0Y2g6JmQnLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19
