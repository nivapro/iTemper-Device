"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var HID = require("node-hid");
var temper_8_1 = require("./temper-8");
var temper_gold_1 = require("./temper-gold");
var usb_device_1 = require("./usb-device");
var sensor_log_1 = require("./sensor-log");
var logger_1 = require("../logger");
var VID = 0x0C45;
var PID = 0x7401;
var TEMPER_GOLD = 'TEMPerV1.4';
var TEMPER_8 = 'TEMPer8_V1.5';
var INTERFACE = 1;
function isTemperGold(device) {
    return (device.vendorId === VID &&
        device.productId === PID &&
        device.product === TEMPER_GOLD &&
        device.interface === INTERFACE);
}
exports.isTemperGold = isTemperGold;
function isTemper8(device) {
    return (device.vendorId === VID &&
        device.productId === PID &&
        device.product === TEMPER_8 &&
        device.interface === INTERFACE);
}
exports.isTemper8 = isTemper8;
var USBController = (function () {
    function USBController() {
    }
    USBController.getLoggers = function () {
        return USBController.loggers;
    };
    USBController.createSensorLog = function (sensorState) {
        var sensorLog = new sensor_log_1.SensorLog(sensorState);
        USBController.loggers.push(sensorLog);
        sensorLog.startLogging();
    };
    USBController.createUSBDevice = function (path, reporter) {
        var hid = new HID.HID(path);
        var usbDevice = new usb_device_1.USBDevice(hid, reporter);
        USBController.devices.push(usbDevice);
    };
    USBController.initializeDevices = function () {
        logger_1.log.info('USBController.initializeDevices: start time=' + new Date().toISOString());
        HID.devices().find(function (device) {
            var deviceStr = JSON.stringify(device);
            if (isTemperGold(device) && device.path !== undefined) {
                logger_1.log.info('USBController.initializeDevices: TEMPer Gold found: ' + deviceStr);
                var sensorState = new temper_gold_1.TemperGold(device);
                USBController.createUSBDevice(device.path, sensorState);
                USBController.createSensorLog(sensorState);
            }
            else if (isTemper8(device) && device.path !== undefined) {
                logger_1.log.info('USBController sensor TEMPer 8 found: ' + deviceStr);
                var sensorState = new temper_8_1.Temper8(device);
                USBController.createUSBDevice(device.path, sensorState);
                USBController.createSensorLog(sensorState);
            }
            else {
                logger_1.log.debug('USBController.initializeDevices: unsupported USB device found=' + deviceStr);
            }
            return false;
        });
        logger_1.log.info('USBController.initializeDevices: Found ' + USBController.devices.length + ' HID device(s)');
    };
    USBController.setPollingInterval = function (ms) {
        logger_1.log.debug('USBController.setPollingInterval: ms=' + ms);
        for (var _i = 0, _a = USBController.devices; _i < _a.length; _i++) {
            var device = _a[_i];
            device.setPollingInterval(ms);
        }
    };
    USBController.getPollingInterval = function () {
        for (var _i = 0, _a = USBController.devices; _i < _a.length; _i++) {
            var device = _a[_i];
            return device.getPollingInterval();
        }
        return 0;
    };
    USBController.devices = [];
    USBController.loggers = [];
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4QkFBaUM7QUFFakMsdUNBQXFDO0FBQ3JDLDZDQUEyQztBQUMzQywyQ0FBc0Q7QUFFdEQsMkNBQXlDO0FBRXpDLG9DQUFnQztBQUVoQyxJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUM7QUFDbkIsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDO0FBQ25CLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQztBQUNqQyxJQUFNLFFBQVEsR0FBRyxjQUFjLENBQUM7QUFDaEMsSUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBR3BCLHNCQUE2QixNQUFrQjtJQUMzQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsS0FBSyxHQUFHO1FBQzNCLE1BQU0sQ0FBQyxTQUFTLEtBQUssR0FBRztRQUN4QixNQUFNLENBQUMsT0FBTyxLQUFLLFdBQVc7UUFDOUIsTUFBTSxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBTEQsb0NBS0M7QUFFRCxtQkFBMEIsTUFBa0I7SUFDeEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEtBQUssR0FBRztRQUMzQixNQUFNLENBQUMsU0FBUyxLQUFLLEdBQUc7UUFDeEIsTUFBTSxDQUFDLE9BQU8sS0FBSyxRQUFRO1FBQzNCLE1BQU0sQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUM7QUFDeEMsQ0FBQztBQUxELDhCQUtDO0FBQ0Q7SUFBQTtJQTZEQSxDQUFDO0lBekRpQix3QkFBVSxHQUF4QjtRQUNJLE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQztJQUNqQyxDQUFDO0lBQ2MsNkJBQWUsR0FBOUIsVUFBK0IsV0FBd0I7UUFDbkQsSUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBQ2MsNkJBQWUsR0FBOUIsVUFBK0IsSUFBWSxFQUFFLFFBQXFCO1FBQzlELElBQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixJQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUUsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2hELGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFYSwrQkFBaUIsR0FBL0I7UUFDSSxZQUFHLENBQUMsSUFBSSxDQUFFLDhDQUE4QyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNyRixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTTtZQUNyQixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3pDLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFO2dCQUNuRCxZQUFHLENBQUMsSUFBSSxDQUFDLHNEQUFzRCxHQUFJLFNBQVMsQ0FBQyxDQUFDO2dCQUU5RSxJQUFNLFdBQVcsR0FBRyxJQUFJLHdCQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQzNDLGFBQWEsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDeEQsYUFBYSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUc5QztpQkFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRTtnQkFDdkQsWUFBRyxDQUFDLElBQUksQ0FBQyx1Q0FBdUMsR0FBSSxTQUFTLENBQUMsQ0FBQztnQkFFL0QsSUFBTSxXQUFXLEdBQUcsSUFBSSxrQkFBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN4QyxhQUFhLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQ3hELGFBQWEsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7YUFHOUM7aUJBQU07Z0JBQ0gsWUFBRyxDQUFDLEtBQUssQ0FBQyxnRUFBZ0UsR0FBRyxTQUFTLENBQUMsQ0FBQzthQUMzRjtZQUVELE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsWUFBRyxDQUFDLElBQUksQ0FBQyx5Q0FBeUMsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDO0lBRTFHLENBQUM7SUFFYSxnQ0FBa0IsR0FBaEMsVUFBaUMsRUFBVTtRQUN2QyxZQUFHLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELEtBQXFCLFVBQXFCLEVBQXJCLEtBQUEsYUFBYSxDQUFDLE9BQU8sRUFBckIsY0FBcUIsRUFBckIsSUFBcUIsRUFBRTtZQUF2QyxJQUFNLE1BQU0sU0FBQTtZQUNiLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNqQztJQUNMLENBQUM7SUFFYSxnQ0FBa0IsR0FBaEM7UUFDSSxLQUFxQixVQUFxQixFQUFyQixLQUFBLGFBQWEsQ0FBQyxPQUFPLEVBQXJCLGNBQXFCLEVBQXJCLElBQXFCLEVBQUU7WUFBdkMsSUFBTSxNQUFNLFNBQUE7WUFDZCxPQUFPLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1NBQ3JDO1FBQ0QsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDO0lBM0RjLHFCQUFPLEdBQWdCLEVBQUUsQ0FBQztJQUMxQixxQkFBTyxHQUFnQixFQUFFLENBQUM7SUEyRDdDLG9CQUFDO0NBN0RELEFBNkRDLElBQUE7QUE3RFksc0NBQWEiLCJmaWxlIjoibW9kZWxzL3VzYi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEhJRCA9IHJlcXVpcmUoJ25vZGUtaGlkJyk7XHJcbmltcG9ydCB7IFNlbnNvclN0YXRlIH0gZnJvbSAnLi9zZW5zb3Itc3RhdGUnO1xyXG5pbXBvcnQgeyBUZW1wZXI4IH0gZnJvbSAnLi90ZW1wZXItOCc7XHJcbmltcG9ydCB7IFRlbXBlckdvbGQgfSBmcm9tICcuL3RlbXBlci1nb2xkJztcclxuaW1wb3J0IHsgVVNCRGV2aWNlLCBVU0JSZXBvcnRlciB9IGZyb20gJy4vdXNiLWRldmljZSc7XHJcblxyXG5pbXBvcnQgeyBTZW5zb3JMb2cgfSBmcm9tICcuL3NlbnNvci1sb2cnO1xyXG5cclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vbG9nZ2VyJztcclxuXHJcbmNvbnN0IFZJRCA9IDB4MEM0NTtcclxuY29uc3QgUElEID0gMHg3NDAxO1xyXG5jb25zdCBURU1QRVJfR09MRCA9ICdURU1QZXJWMS40JztcclxuY29uc3QgVEVNUEVSXzggPSAnVEVNUGVyOF9WMS41JztcclxuY29uc3QgSU5URVJGQUNFID0gMTtcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNUZW1wZXJHb2xkKGRldmljZTogSElELkRldmljZSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIChkZXZpY2UudmVuZG9ySWQgPT09IFZJRCAmJlxyXG4gICAgICAgIGRldmljZS5wcm9kdWN0SWQgPT09IFBJRCAmJlxyXG4gICAgICAgIGRldmljZS5wcm9kdWN0ID09PSBURU1QRVJfR09MRCAmJlxyXG4gICAgICAgIGRldmljZS5pbnRlcmZhY2UgPT09IElOVEVSRkFDRSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1RlbXBlcjgoZGV2aWNlOiBISUQuRGV2aWNlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gKGRldmljZS52ZW5kb3JJZCA9PT0gVklEICYmXHJcbiAgICAgICAgZGV2aWNlLnByb2R1Y3RJZCA9PT0gUElEICYmXHJcbiAgICAgICAgZGV2aWNlLnByb2R1Y3QgPT09IFRFTVBFUl84ICYmXHJcbiAgICAgICAgZGV2aWNlLmludGVyZmFjZSA9PT0gSU5URVJGQUNFKTtcclxufVxyXG5leHBvcnQgY2xhc3MgVVNCQ29udHJvbGxlciB7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBkZXZpY2VzOiBVU0JEZXZpY2VbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgbG9nZ2VyczogU2Vuc29yTG9nW10gPSBbXTtcclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldExvZ2dlcnMoKTogU2Vuc29yTG9nW10ge1xyXG4gICAgICAgIHJldHVybiBVU0JDb250cm9sbGVyLmxvZ2dlcnM7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHN0YXRpYyBjcmVhdGVTZW5zb3JMb2coc2Vuc29yU3RhdGU6IFNlbnNvclN0YXRlKSB7XHJcbiAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0gbmV3IFNlbnNvckxvZyhzZW5zb3JTdGF0ZSk7XHJcbiAgICAgICAgVVNCQ29udHJvbGxlci5sb2dnZXJzLnB1c2goc2Vuc29yTG9nKTtcclxuICAgICAgICBzZW5zb3JMb2cuc3RhcnRMb2dnaW5nKCk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHN0YXRpYyBjcmVhdGVVU0JEZXZpY2UocGF0aDogc3RyaW5nLCByZXBvcnRlcjogVVNCUmVwb3J0ZXIpIHtcclxuICAgICAgICBjb25zdCBoaWQgPSBuZXcgSElELkhJRChwYXRoKTtcclxuICAgICAgICBjb25zdCB1c2JEZXZpY2UgPSBuZXcgVVNCRGV2aWNlIChoaWQsIHJlcG9ydGVyKTtcclxuICAgICAgICBVU0JDb250cm9sbGVyLmRldmljZXMucHVzaCh1c2JEZXZpY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdGlhbGl6ZURldmljZXMoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmluZm8gKCdVU0JDb250cm9sbGVyLmluaXRpYWxpemVEZXZpY2VzOiBzdGFydCB0aW1lPScgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkpO1xyXG4gICAgICAgIEhJRC5kZXZpY2VzKCkuZmluZChkZXZpY2UgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkZXZpY2VTdHIgPSBKU09OLnN0cmluZ2lmeShkZXZpY2UpO1xyXG4gICAgICAgICAgICBpZiAoaXNUZW1wZXJHb2xkKGRldmljZSkgJiYgZGV2aWNlLnBhdGggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1VTQkNvbnRyb2xsZXIuaW5pdGlhbGl6ZURldmljZXM6IFRFTVBlciBHb2xkIGZvdW5kOiAnICsgIGRldmljZVN0cik7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2Vuc29yU3RhdGUgPSBuZXcgVGVtcGVyR29sZChkZXZpY2UpO1xyXG4gICAgICAgICAgICAgICAgVVNCQ29udHJvbGxlci5jcmVhdGVVU0JEZXZpY2UoZGV2aWNlLnBhdGgsIHNlbnNvclN0YXRlKTtcclxuICAgICAgICAgICAgICAgIFVTQkNvbnRyb2xsZXIuY3JlYXRlU2Vuc29yTG9nKHNlbnNvclN0YXRlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChpc1RlbXBlcjgoZGV2aWNlKSAmJiBkZXZpY2UucGF0aCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuaW5mbygnVVNCQ29udHJvbGxlciBzZW5zb3IgVEVNUGVyIDggZm91bmQ6ICcgKyAgZGV2aWNlU3RyKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZW5zb3JTdGF0ZSA9IG5ldyBUZW1wZXI4KGRldmljZSk7XHJcbiAgICAgICAgICAgICAgICBVU0JDb250cm9sbGVyLmNyZWF0ZVVTQkRldmljZShkZXZpY2UucGF0aCwgc2Vuc29yU3RhdGUpO1xyXG4gICAgICAgICAgICAgICAgVVNCQ29udHJvbGxlci5jcmVhdGVTZW5zb3JMb2coc2Vuc29yU3RhdGUpO1xyXG5cclxuICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ1VTQkNvbnRyb2xsZXIuaW5pdGlhbGl6ZURldmljZXM6IHVuc3VwcG9ydGVkIFVTQiBkZXZpY2UgZm91bmQ9JyArIGRldmljZVN0cik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsb2cuaW5mbygnVVNCQ29udHJvbGxlci5pbml0aWFsaXplRGV2aWNlczogRm91bmQgJyArIFVTQkNvbnRyb2xsZXIuZGV2aWNlcy5sZW5ndGggKyAnIEhJRCBkZXZpY2UocyknKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBzZXRQb2xsaW5nSW50ZXJ2YWwobXM6IG51bWJlcikge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnVVNCQ29udHJvbGxlci5zZXRQb2xsaW5nSW50ZXJ2YWw6IG1zPScgKyBtcyk7XHJcbiAgICAgICAgZm9yIChjb25zdCBkZXZpY2Ugb2YgVVNCQ29udHJvbGxlci5kZXZpY2VzKSB7XHJcbiAgICAgICAgICAgIGRldmljZS5zZXRQb2xsaW5nSW50ZXJ2YWwobXMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldFBvbGxpbmdJbnRlcnZhbCgpOiBudW1iZXIge1xyXG4gICAgICAgIGZvciAoY29uc3QgZGV2aWNlIG9mIFVTQkNvbnRyb2xsZXIuZGV2aWNlcykge1xyXG4gICAgICAgICAgIHJldHVybiBkZXZpY2UuZ2V0UG9sbGluZ0ludGVydmFsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
