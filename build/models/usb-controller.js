"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var os = require("os");
var logger_1 = require("./../logger");
var USBController = (function () {
    function USBController(hid, parser) {
        this.POLL_INTERVAL = 5000;
        this.deviceInitialized = false;
        this.hid = hid;
        this.reportParser = parser;
        this.initializeDevice();
        this.pollSensors();
    }
    USBController.prototype.initializeDevice = function () {
        if (!this.deviceInitialized) {
            this.hid.on('data', this.parseInput.bind(this));
            this.hid.on('error', this.parseError.bind(this));
            this.setPollingInterval(this.POLL_INTERVAL);
            this.deviceInitialized = true;
            logger_1.log.debug('+++ USBController.initializeDevice');
        }
    };
    USBController.prototype.close = function () {
        this.deviceInitialized = false;
        try {
            this.hid.pause();
            this.hid.close();
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.setPollingInterval = function (ms) {
        this.POLL_INTERVAL = ms;
        clearInterval(this.interval);
        this.interval = setInterval(this.pollSensors.bind(this), this.POLL_INTERVAL);
    };
    USBController.prototype.pollSensors = function () {
        if (!this.deviceInitialized) {
            this.initializeDevice();
        }
        else {
            logger_1.log.debug('+++ USBController.pollSensors');
            var initCommands = this.reportParser.initReport();
            for (var _i = 0, initCommands_1 = initCommands; _i < initCommands_1.length; _i++) {
                var command = initCommands_1[_i];
                this.writeReport(command);
            }
        }
    };
    USBController.prototype.parseInput = function (data) {
        try {
            var response = this.reportParser.parseInput(data);
            if (response.length > 0) {
                this.writeReport(response);
            }
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.parseError = function (_error) {
        logger_1.log.error('parseError: ', JSON.stringify(_error));
    };
    USBController.prototype.writeReport = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                this.hid.write(data);
                logger_1.log.debug('+++ USBController.writeReport', JSON.stringify(data));
            }
            catch (e) {
                logger_1.log.error('*** USBController.writeReport hid.write catch:&d', JSON.stringify(data));
                this.close();
            }
        }
    };
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSx1QkFBMEI7QUFFMUIsc0NBQWtDO0FBU2xDO0lBV0ksdUJBQVksR0FBWSxFQUFFLE1BQW9CO1FBTnRDLGtCQUFhLEdBQUcsSUFBSyxDQUFDO1FBRXRCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUs5QixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDO1FBQzNCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU0sd0NBQWdCLEdBQXZCO1FBQ0ksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztZQUM5QixZQUFHLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztJQUNMLENBQUM7SUFFTSw2QkFBSyxHQUFaO1FBQ0ksSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztRQUMvQixJQUFJLENBQUM7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMs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XHJcbmltcG9ydCBISUQgPSByZXF1aXJlKCdub2RlLWhpZCcpO1xyXG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpO1xyXG5cclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi8uLi9sb2dnZXInO1xyXG5cclxuLy8gUmVwb3J0UGFyc2VyIGFsbG93IFNlbnNvckRldmljZSB0byBiZSBpbmRlcGVuZGVudCBvbiB0aGUgc3BlY2lmaWNcclxuLy8gVGVtcGVyIGRldmljZSBjb25uZWN0ZWQuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVwb3J0UGFyc2VyIHtcclxuICAgIGluaXRSZXBvcnQoKTogbnVtYmVyW11bXTtcclxuICAgIHBhcnNlSW5wdXQoZGF0YTogbnVtYmVyW10pOiBudW1iZXJbXTtcclxufVxyXG4vLyBIYW5kbGUgYSBzZW5zb3IgZGV2aWNlIG9uIHRoZSBVU0IgaHViLlxyXG5leHBvcnQgY2xhc3MgVVNCQ29udHJvbGxlciB7XHJcbiAgICBwcml2YXRlICBoaWQ6IEhJRC5ISUQ7XHJcblxyXG4gICAgcHJpdmF0ZSByZXBvcnRQYXJzZXI6IFJlcG9ydFBhcnNlcjtcclxuXHJcbiAgICBwcml2YXRlIFBPTExfSU5URVJWQUwgPSA1XzAwMDtcclxuXHJcbiAgICBwcml2YXRlIGRldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcblxyXG4gICAgcHJpdmF0ZSBpbnRlcnZhbDogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGhpZDogSElELkhJRCwgcGFyc2VyOiBSZXBvcnRQYXJzZXIpIHtcclxuICAgICAgICB0aGlzLmhpZCA9IGhpZDtcclxuICAgICAgICB0aGlzLnJlcG9ydFBhcnNlciA9IHBhcnNlcjtcclxuICAgICAgICB0aGlzLmluaXRpYWxpemVEZXZpY2UoKTtcclxuICAgICAgICB0aGlzLnBvbGxTZW5zb3JzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGluaXRpYWxpemVEZXZpY2UoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRldmljZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkLm9uKCdkYXRhJywgdGhpcy5wYXJzZUlucHV0LmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5vbignZXJyb3InLCB0aGlzLnBhcnNlRXJyb3IuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UG9sbGluZ0ludGVydmFsKHRoaXMuUE9MTF9JTlRFUlZBTCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJysrKyBVU0JDb250cm9sbGVyLmluaXRpYWxpemVEZXZpY2UnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsb3NlKCkge1xyXG4gICAgICAgIHRoaXMuZGV2aWNlSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5wYXVzZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5jbG9zZSgpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0UG9sbGluZ0ludGVydmFsKG1zOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLlBPTExfSU5URVJWQUwgPSBtcztcclxuICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpO1xyXG4gICAgICAgIHRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLnBvbGxTZW5zb3JzLmJpbmQodGhpcyksIHRoaXMuUE9MTF9JTlRFUlZBTCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVGhpcyBpcyB3ZXJlIGFsbCBzdGFydHMgd2hlbiBzZXQgaW50ZXJ2YWwgdGltZSBleHBpcmVzXHJcblxyXG4gICAgcHJpdmF0ZSBwb2xsU2Vuc29ycygpIHtcclxuICAgICAgICBpZiAoISB0aGlzLmRldmljZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZURldmljZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnKysrIFVTQkNvbnRyb2xsZXIucG9sbFNlbnNvcnMnKTtcclxuICAgICAgICAgICAgY29uc3QgaW5pdENvbW1hbmRzID0gdGhpcy5yZXBvcnRQYXJzZXIuaW5pdFJlcG9ydCgpO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGNvbW1hbmQgb2YgaW5pdENvbW1hbmRzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLndyaXRlUmVwb3J0KGNvbW1hbmQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gQ2FsbGVkIGZyb20gSElELCBQYXJzZXMgaW5wdXQgZnJvbSBISUQgYW5kIHdyaXRlcyBhbnkgcmVzcG9uc2UgbWVzc2FnZXNcclxuICAgIC8vIGJhY2sgdG8gdGhlIGRldmljZVxyXG4gICAgcHJpdmF0ZSBwYXJzZUlucHV0KGRhdGE6IG51bWJlcltdKTogdm9pZCAge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gdGhpcy5yZXBvcnRQYXJzZXIucGFyc2VJbnB1dChkYXRhKTtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMud3JpdGVSZXBvcnQocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAvLyBUT0RPIGVycm9yIGhhbmRsaW5nIGlmIHBhcnNlIGlucHV0IGVycm9yXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHBhcnNlRXJyb3IoX2Vycm9yOiBhbnkpIHtcclxuICAgICAgICBsb2cuZXJyb3IoJ3BhcnNlRXJyb3I6ICcsIEpTT04uc3RyaW5naWZ5KF9lcnJvcikpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEhlbHBlciBmdW5jdGlvbnMgdG8gd3JpdGUgcmVwb3J0cyB0byB0aGUgZGV2aWNlXHJcbiAgICBwcml2YXRlIHdyaXRlUmVwb3J0KGRhdGE6IG51bWJlcltdKTogdm9pZCB7XHJcblxyXG4gICAgICAgIGlmIChvcy5wbGF0Zm9ybSgpID09PSAnd2luMzInKSB7XHJcbiAgICAgICAgICAgIGRhdGEudW5zaGlmdCgwKTsgIC8vIHByZXBlbmQgYSB0aHJvd2F3YXkgYnl0ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gT3V0cHV0IHJlcG9ydFxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZC53cml0ZShkYXRhKTtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnKysrIFVTQkNvbnRyb2xsZXIud3JpdGVSZXBvcnQnLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5lcnJvcignKioqIFVTQkNvbnRyb2xsZXIud3JpdGVSZXBvcnQgaGlkLndyaXRlIGNhdGNoOiZkJywgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=
