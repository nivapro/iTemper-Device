"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var HID = require("node-hid");
var temper_8_1 = require("./temper-8");
var temper_gold_1 = require("./temper-gold");
var usb_device_1 = require("./usb-device");
var sensor_log_1 = require("./sensor-log");
var logger_1 = require("../logger");
var USBDeviceConfig = (function () {
    function USBDeviceConfig() {
    }
    return USBDeviceConfig;
}());
exports.USBDeviceConfig = USBDeviceConfig;
var VID = 0x0C45;
var PID = 0x7401;
var TEMPER_GOLD = 'TEMPerV1.4';
var TEMPER_8 = 'TEMPer8_V1.5';
var INTERFACE = 1;
function isTemperGold(device) {
    return (device.vendorId === VID &&
        device.productId === PID &&
        device.product === TEMPER_GOLD &&
        device.interface === INTERFACE);
}
exports.isTemperGold = isTemperGold;
function isTemper8(device) {
    return (device.vendorId === VID &&
        device.productId === PID &&
        device.product === TEMPER_8 &&
        device.interface === INTERFACE);
}
exports.isTemper8 = isTemper8;
var USBController = (function () {
    function USBController() {
    }
    USBController.getLoggers = function () {
        return USBController.loggers;
    };
    USBController.initializeLogger = function (sensorState) {
        var sensorlogger = new sensor_log_1.SensorLog(sensorState);
        USBController.loggers.push(sensorlogger);
        sensorlogger.startLogging();
    };
    USBController.initializeDevice = function (path, reporter) {
        var hid = new HID.HID(path);
        var device = new usb_device_1.USBDevice(hid, reporter);
        USBController.devices.push(device);
    };
    USBController.initializeDevices = function () {
        logger_1.log.info('Application started: ' + new Date().toISOString());
        HID.devices().find(function (device) {
            logger_1.log.debug('USBController find device: ' + device);
            if (isTemperGold(device) && device.path !== undefined) {
                logger_1.log.debug('USBController sensor TEMPer Gold found: ' + JSON.stringify(device));
                var sensor = new temper_gold_1.TemperGold();
                USBController.initializeLogger(sensor);
                USBController.initializeDevice(device.path, sensor);
            }
            else if (isTemper8(device) && device.path !== undefined) {
                logger_1.log.debug('USBController sensor TEMPer 8 found: ' + JSON.stringify(device));
                var sensor = new temper_8_1.Temper8();
                USBController.initializeLogger(sensor);
                USBController.initializeDevice(device.path, sensor);
            }
            return false;
        });
        logger_1.log.info('Found ' + USBController.devices.length + ' HID device(s)');
    };
    USBController.setPollingInterval = function (ms) {
        logger_1.log.debug('USBController.setPollingInterval: ' + ms);
        for (var _i = 0, _a = USBController.devices; _i < _a.length; _i++) {
            var device = _a[_i];
            device.setPollingInterval(ms);
        }
    };
    USBController.getPollingInterval = function () {
        for (var _i = 0, _a = USBController.devices; _i < _a.length; _i++) {
            var device = _a[_i];
            return device.getPollingInterval();
        }
        return 0;
    };
    USBController.devices = [];
    USBController.loggers = [];
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4QkFBaUM7QUFFakMsdUNBQXFDO0FBQ3JDLDZDQUEyQztBQUMzQywyQ0FBc0Q7QUFFdEQsMkNBQXlDO0FBRXpDLG9DQUFnQztBQUVoQztJQUFBO0lBS0ksQ0FBQztJQUFELHNCQUFDO0FBQUQsQ0FMSixBQUtLLElBQUE7QUFMUSwwQ0FBZTtBQU81QixJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUM7QUFDbkIsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDO0FBQ25CLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQztBQUNqQyxJQUFNLFFBQVEsR0FBRyxjQUFjLENBQUM7QUFDaEMsSUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBR3BCLHNCQUE2QixNQUFrQjtJQUMzQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsS0FBSyxHQUFHO1FBQzNCLE1BQU0sQ0FBQyxTQUFTLEtBQUssR0FBRztRQUN4QixNQUFNLENBQUMsT0FBTyxLQUFLLFdBQVc7UUFDOUIsTUFBTSxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBTEQsb0NBS0M7QUFFRCxtQkFBMEIsTUFBa0I7SUFDeEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEtBQUssR0FBRztRQUMzQixNQUFNLENBQUMsU0FBUyxLQUFLLEdBQUc7UUFDeEIsTUFBTSxDQUFDLE9BQU8sS0FBSyxRQUFRO1FBQzNCLE1BQU0sQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUM7QUFDeEMsQ0FBQztBQUxELDhCQUtDO0FBQ0Q7SUFBQTtJQTBEQSxDQUFDO0lBdERpQix3QkFBVSxHQUF4QjtRQUNJLE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQztJQUNqQyxDQUFDO0lBQ2MsOEJBQWdCLEdBQS9CLFVBQWdDLFdBQXdCO1FBQ3BELElBQU0sWUFBWSxHQUFHLElBQUksc0JBQVMsQ0FBQyxXQUFX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Yi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEhJRCA9IHJlcXVpcmUoJ25vZGUtaGlkJyk7XHJcbmltcG9ydCB7IFNlbnNvclN0YXRlIH0gZnJvbSAnLi9zZW5zb3Itc3RhdGUnO1xyXG5pbXBvcnQgeyBUZW1wZXI4IH0gZnJvbSAnLi90ZW1wZXItOCc7XHJcbmltcG9ydCB7IFRlbXBlckdvbGQgfSBmcm9tICcuL3RlbXBlci1nb2xkJztcclxuaW1wb3J0IHsgVVNCRGV2aWNlLCBVU0JSZXBvcnRlciB9IGZyb20gJy4vdXNiLWRldmljZSc7XHJcblxyXG5pbXBvcnQgeyBTZW5zb3JMb2cgfSBmcm9tICcuL3NlbnNvci1sb2cnO1xyXG5cclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vbG9nZ2VyJztcclxuXHJcbmV4cG9ydCBjbGFzcyBVU0JEZXZpY2VDb25maWcge1xyXG4gICAgICAgIHZlbmRvcklkOiBudW1iZXI7XHJcbiAgICAgICAgcHJvZHVjdElkOiBudW1iZXI7XHJcbiAgICAgICAgcHJvZHVjdDogc3RyaW5nO1xyXG4gICAgICAgIGludGVyZmFjZTogbnVtYmVyO1xyXG4gICAgfVxyXG5cclxuY29uc3QgVklEID0gMHgwQzQ1O1xyXG5jb25zdCBQSUQgPSAweDc0MDE7XHJcbmNvbnN0IFRFTVBFUl9HT0xEID0gJ1RFTVBlclYxLjQnO1xyXG5jb25zdCBURU1QRVJfOCA9ICdURU1QZXI4X1YxLjUnO1xyXG5jb25zdCBJTlRFUkZBQ0UgPSAxO1xyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1RlbXBlckdvbGQoZGV2aWNlOiBISUQuRGV2aWNlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gKGRldmljZS52ZW5kb3JJZCA9PT0gVklEICYmXHJcbiAgICAgICAgZGV2aWNlLnByb2R1Y3RJZCA9PT0gUElEICYmXHJcbiAgICAgICAgZGV2aWNlLnByb2R1Y3QgPT09IFRFTVBFUl9HT0xEICYmXHJcbiAgICAgICAgZGV2aWNlLmludGVyZmFjZSA9PT0gSU5URVJGQUNFKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzVGVtcGVyOChkZXZpY2U6IEhJRC5EZXZpY2UpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoZGV2aWNlLnZlbmRvcklkID09PSBWSUQgJiZcclxuICAgICAgICBkZXZpY2UucHJvZHVjdElkID09PSBQSUQgJiZcclxuICAgICAgICBkZXZpY2UucHJvZHVjdCA9PT0gVEVNUEVSXzggJiZcclxuICAgICAgICBkZXZpY2UuaW50ZXJmYWNlID09PSBJTlRFUkZBQ0UpO1xyXG59XHJcbmV4cG9ydCBjbGFzcyBVU0JDb250cm9sbGVyIHtcclxuICAgIHByaXZhdGUgc3RhdGljIGRldmljZXM6IFVTQkRldmljZVtdID0gW107XHJcbiAgICBwcml2YXRlIHN0YXRpYyBsb2dnZXJzOiBTZW5zb3JMb2dbXSA9IFtdO1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0TG9nZ2VycygpOiBTZW5zb3JMb2dbXSB7XHJcbiAgICAgICAgcmV0dXJuIFVTQkNvbnRyb2xsZXIubG9nZ2VycztcclxuICAgIH1cclxuICAgIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVMb2dnZXIoc2Vuc29yU3RhdGU6IFNlbnNvclN0YXRlKSB7XHJcbiAgICAgICAgY29uc3Qgc2Vuc29ybG9nZ2VyID0gbmV3IFNlbnNvckxvZyhzZW5zb3JTdGF0ZSk7XHJcbiAgICAgICAgVVNCQ29udHJvbGxlci5sb2dnZXJzLnB1c2goc2Vuc29ybG9nZ2VyKTtcclxuICAgICAgICBzZW5zb3Jsb2dnZXIuc3RhcnRMb2dnaW5nKCk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHN0YXRpYyBpbml0aWFsaXplRGV2aWNlKHBhdGg6IHN0cmluZywgcmVwb3J0ZXI6IFVTQlJlcG9ydGVyKSB7XHJcbiAgICAgICAgY29uc3QgaGlkID0gbmV3IEhJRC5ISUQocGF0aCk7XHJcbiAgICAgICAgY29uc3QgZGV2aWNlID0gbmV3IFVTQkRldmljZSAoaGlkLCByZXBvcnRlcik7XHJcbiAgICAgICAgVVNCQ29udHJvbGxlci5kZXZpY2VzLnB1c2goZGV2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGluaXRpYWxpemVEZXZpY2VzKCk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5pbmZvICgnQXBwbGljYXRpb24gc3RhcnRlZDogJyArIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSk7XHJcbiAgICAgICAgSElELmRldmljZXMoKS5maW5kKGRldmljZSA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnVVNCQ29udHJvbGxlciBmaW5kIGRldmljZTogJyArIGRldmljZSk7XHJcbiAgICAgICAgICAgIGlmIChpc1RlbXBlckdvbGQoZGV2aWNlKSAmJiBkZXZpY2UucGF0aCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ1VTQkNvbnRyb2xsZXIgc2Vuc29yIFRFTVBlciBHb2xkIGZvdW5kOiAnICsgIEpTT04uc3RyaW5naWZ5KGRldmljZSkpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbnNvciA9IG5ldyBUZW1wZXJHb2xkKCk7XHJcbiAgICAgICAgICAgICAgICBVU0JDb250cm9sbGVyLmluaXRpYWxpemVMb2dnZXIoc2Vuc29yKTtcclxuICAgICAgICAgICAgICAgIFVTQkNvbnRyb2xsZXIuaW5pdGlhbGl6ZURldmljZShkZXZpY2UucGF0aCwgc2Vuc29yKTtcclxuICAgICAgICAgICAgICAgIC8vIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzVGVtcGVyOChkZXZpY2UpICYmIGRldmljZS5wYXRoICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnVVNCQ29udHJvbGxlciBzZW5zb3IgVEVNUGVyIDggZm91bmQ6ICcgKyAgSlNPTi5zdHJpbmdpZnkoZGV2aWNlKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2Vuc29yID0gbmV3IFRlbXBlcjgoKTtcclxuXHJcbiAgICAgICAgICAgICAgICBVU0JDb250cm9sbGVyLmluaXRpYWxpemVMb2dnZXIoc2Vuc29yKTtcclxuICAgICAgICAgICAgICAgIFVTQkNvbnRyb2xsZXIuaW5pdGlhbGl6ZURldmljZShkZXZpY2UucGF0aCwgc2Vuc29yKTtcclxuICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsb2cuaW5mbygnRm91bmQgJyArIFVTQkNvbnRyb2xsZXIuZGV2aWNlcy5sZW5ndGggKyAnIEhJRCBkZXZpY2UocyknKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBzZXRQb2xsaW5nSW50ZXJ2YWwobXM6IG51bWJlcikge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnVVNCQ29udHJvbGxlci5zZXRQb2xsaW5nSW50ZXJ2YWw6ICcgKyBtcyk7XHJcbiAgICAgICAgZm9yIChjb25zdCBkZXZpY2Ugb2YgVVNCQ29udHJvbGxlci5kZXZpY2VzKSB7XHJcbiAgICAgICAgICAgIGRldmljZS5zZXRQb2xsaW5nSW50ZXJ2YWwobXMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldFBvbGxpbmdJbnRlcnZhbCgpOiBudW1iZXIge1xyXG4gICAgICAgIGZvciAoY29uc3QgZGV2aWNlIG9mIFVTQkNvbnRyb2xsZXIuZGV2aWNlcykge1xyXG4gICAgICAgICAgIHJldHVybiBkZXZpY2UuZ2V0UG9sbGluZ0ludGVydmFsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
