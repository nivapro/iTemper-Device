"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var HID = require("node-hid");
var temper_8_1 = require("./temper-8");
var temper_gold_1 = require("./temper-gold");
var usb_device_1 = require("./usb-device");
var sensor_log_1 = require("./sensor-log");
var logger_1 = require("../logger");
var VID = 0x0C45;
var PID = 0x7401;
var TEMPER_GOLD = 'TEMPerV1.4';
var TEMPER_8 = 'TEMPer8_V1.5';
var INTERFACE = 1;
function isTemperGold(device) {
    return (device.vendorId === VID &&
        device.productId === PID &&
        device.product === TEMPER_GOLD &&
        device.interface === INTERFACE);
}
exports.isTemperGold = isTemperGold;
function isTemper8(device) {
    return (device.vendorId === VID &&
        device.productId === PID &&
        device.product === TEMPER_8 &&
        device.interface === INTERFACE);
}
exports.isTemper8 = isTemper8;
var USBController = (function () {
    function USBController() {
    }
    USBController.getLoggers = function () {
        return USBController.loggers;
    };
    USBController.createSensorLog = function (sensorState) {
        var sensorLog = new sensor_log_1.SensorLog(sensorState);
        USBController.loggers.push(sensorLog);
        sensorLog.startLogging();
    };
    USBController.createUSBDevice = function (path, reporter) {
        var hid = new HID.HID(path);
        var usbDevice = new usb_device_1.USBDevice(hid, reporter);
        USBController.devices.push(usbDevice);
    };
    USBController.initialize = function () {
        logger_1.log.info('USBController.initialize: start time=' + new Date().toISOString());
        HID.devices().find(function (device) {
            var deviceStr = JSON.stringify(device);
            if (isTemperGold(device) && device.path !== undefined) {
                logger_1.log.info('USBController.initialize: TEMPer Gold found: ' + deviceStr);
                var sensorState = new temper_gold_1.TemperGold(device);
                USBController.createUSBDevice(device.path, sensorState);
                USBController.createSensorLog(sensorState);
            }
            else if (isTemper8(device) && device.path !== undefined) {
                logger_1.log.info('USBController.initialize sensor TEMPer 8 found: ' + deviceStr);
                var sensorState = new temper_8_1.Temper8(device);
                USBController.createUSBDevice(device.path, sensorState);
                USBController.createSensorLog(sensorState);
            }
            else {
                logger_1.log.debug('USBController.initialize: unsupported USB device found=' + deviceStr);
            }
            return false;
        });
        logger_1.log.info('USBController.initialize: Found ' + USBController.devices.length + ' HID device(s)');
    };
    USBController.setPollingInterval = function (ms) {
        logger_1.log.debug('USBController.setPollingInterval: ms=' + ms);
        for (var _i = 0, _a = USBController.devices; _i < _a.length; _i++) {
            var device = _a[_i];
            device.setPollingInterval(ms);
        }
    };
    USBController.getPollingInterval = function () {
        for (var _i = 0, _a = USBController.devices; _i < _a.length; _i++) {
            var device = _a[_i];
            return device.getPollingInterval();
        }
        return 0;
    };
    USBController.devices = [];
    USBController.loggers = [];
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4QkFBaUM7QUFFakMsdUNBQXFDO0FBQ3JDLDZDQUEyQztBQUMzQywyQ0FBc0Q7QUFFdEQsMkNBQXlDO0FBRXpDLG9DQUFnQztBQUVoQyxJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUM7QUFDbkIsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDO0FBQ25CLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQztBQUNqQyxJQUFNLFFBQVEsR0FBRyxjQUFjLENBQUM7QUFDaEMsSUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBR3BCLFNBQWdCLFlBQVksQ0FBQyxNQUFrQjtJQUMzQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsS0FBSyxHQUFHO1FBQzNCLE1BQU0sQ0FBQyxTQUFTLEtBQUssR0FBRztRQUN4QixNQUFNLENBQUMsT0FBTyxLQUFLLFdBQVc7UUFDOUIsTUFBTSxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBTEQsb0NBS0M7QUFFRCxTQUFnQixTQUFTLENBQUMsTUFBa0I7SUFDeEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEtBQUssR0FBRztRQUMzQixNQUFNLENBQUMsU0FBUyxLQUFLLEdBQUc7UUFDeEIsTUFBTSxDQUFDLE9BQU8sS0FBSyxRQUFRO1FBQzNCLE1BQU0sQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUM7QUFDeEMsQ0FBQztBQUxELDhCQUtDO0FBQ0Q7SUFBQTtJQTZEQSxDQUFDO0lBekRpQix3QkFBVSxHQUF4QjtRQUNJLE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQztJQUNqQyxDQUFDO0lBQ2MsNkJBQWUsR0FBOUIsVUFBK0IsV0FBd0I7UUFDbkQsSUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFD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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSElEID0gcmVxdWlyZSgnbm9kZS1oaWQnKTtcclxuaW1wb3J0IHsgU2Vuc29yU3RhdGUgfSBmcm9tICcuL3NlbnNvci1zdGF0ZSc7XHJcbmltcG9ydCB7IFRlbXBlcjggfSBmcm9tICcuL3RlbXBlci04JztcclxuaW1wb3J0IHsgVGVtcGVyR29sZCB9IGZyb20gJy4vdGVtcGVyLWdvbGQnO1xyXG5pbXBvcnQgeyBVU0JEZXZpY2UsIFVTQlJlcG9ydGVyIH0gZnJvbSAnLi91c2ItZGV2aWNlJztcclxuXHJcbmltcG9ydCB7IFNlbnNvckxvZyB9IGZyb20gJy4vc2Vuc29yLWxvZyc7XHJcblxyXG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi9sb2dnZXInO1xyXG5cclxuY29uc3QgVklEID0gMHgwQzQ1O1xyXG5jb25zdCBQSUQgPSAweDc0MDE7XHJcbmNvbnN0IFRFTVBFUl9HT0xEID0gJ1RFTVBlclYxLjQnO1xyXG5jb25zdCBURU1QRVJfOCA9ICdURU1QZXI4X1YxLjUnO1xyXG5jb25zdCBJTlRFUkZBQ0UgPSAxO1xyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1RlbXBlckdvbGQoZGV2aWNlOiBISUQuRGV2aWNlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gKGRldmljZS52ZW5kb3JJZCA9PT0gVklEICYmXHJcbiAgICAgICAgZGV2aWNlLnByb2R1Y3RJZCA9PT0gUElEICYmXHJcbiAgICAgICAgZGV2aWNlLnByb2R1Y3QgPT09IFRFTVBFUl9HT0xEICYmXHJcbiAgICAgICAgZGV2aWNlLmludGVyZmFjZSA9PT0gSU5URVJGQUNFKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzVGVtcGVyOChkZXZpY2U6IEhJRC5EZXZpY2UpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoZGV2aWNlLnZlbmRvcklkID09PSBWSUQgJiZcclxuICAgICAgICBkZXZpY2UucHJvZHVjdElkID09PSBQSUQgJiZcclxuICAgICAgICBkZXZpY2UucHJvZHVjdCA9PT0gVEVNUEVSXzggJiZcclxuICAgICAgICBkZXZpY2UuaW50ZXJmYWNlID09PSBJTlRFUkZBQ0UpO1xyXG59XHJcbmV4cG9ydCBjbGFzcyBVU0JDb250cm9sbGVyIHtcclxuICAgIHByaXZhdGUgc3RhdGljIGRldmljZXM6IFVTQkRldmljZVtdID0gW107XHJcbiAgICBwcml2YXRlIHN0YXRpYyBsb2dnZXJzOiBTZW5zb3JMb2dbXSA9IFtdO1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0TG9nZ2VycygpOiBTZW5zb3JMb2dbXSB7XHJcbiAgICAgICAgcmV0dXJuIFVTQkNvbnRyb2xsZXIubG9nZ2VycztcclxuICAgIH1cclxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZVNlbnNvckxvZyhzZW5zb3JTdGF0ZTogU2Vuc29yU3RhdGUpIHtcclxuICAgICAgICBjb25zdCBzZW5zb3JMb2cgPSBuZXcgU2Vuc29yTG9nKHNlbnNvclN0YXRlKTtcclxuICAgICAgICBVU0JDb250cm9sbGVyLmxvZ2dlcnMucHVzaChzZW5zb3JMb2cpO1xyXG4gICAgICAgIHNlbnNvckxvZy5zdGFydExvZ2dpbmcoKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZVVTQkRldmljZShwYXRoOiBzdHJpbmcsIHJlcG9ydGVyOiBVU0JSZXBvcnRlcikge1xyXG4gICAgICAgIGNvbnN0IGhpZCA9IG5ldyBISUQuSElEKHBhdGgpO1xyXG4gICAgICAgIGNvbnN0IHVzYkRldmljZSA9IG5ldyBVU0JEZXZpY2UgKGhpZCwgcmVwb3J0ZXIpO1xyXG4gICAgICAgIFVTQkNvbnRyb2xsZXIuZGV2aWNlcy5wdXNoKHVzYkRldmljZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBpbml0aWFsaXplKCk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5pbmZvICgnVVNCQ29udHJvbGxlci5pbml0aWFsaXplOiBzdGFydCB0aW1lPScgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkpO1xyXG4gICAgICAgIEhJRC5kZXZpY2VzKCkuZmluZChkZXZpY2UgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkZXZpY2VTdHIgPSBKU09OLnN0cmluZ2lmeShkZXZpY2UpO1xyXG4gICAgICAgICAgICBpZiAoaXNUZW1wZXJHb2xkKGRldmljZSkgJiYgZGV2aWNlLnBhdGggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1VTQkNvbnRyb2xsZXIuaW5pdGlhbGl6ZTogVEVNUGVyIEdvbGQgZm91bmQ6ICcgKyAgZGV2aWNlU3RyKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZW5zb3JTdGF0ZSA9IG5ldyBUZW1wZXJHb2xkKGRldmljZSk7XHJcbiAgICAgICAgICAgICAgICBVU0JDb250cm9sbGVyLmNyZWF0ZVVTQkRldmljZShkZXZpY2UucGF0aCwgc2Vuc29yU3RhdGUpO1xyXG4gICAgICAgICAgICAgICAgVVNCQ29udHJvbGxlci5jcmVhdGVTZW5zb3JMb2coc2Vuc29yU3RhdGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzVGVtcGVyOChkZXZpY2UpICYmIGRldmljZS5wYXRoICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdVU0JDb250cm9sbGVyLmluaXRpYWxpemUgc2Vuc29yIFRFTVBlciA4IGZvdW5kOiAnICsgIGRldmljZVN0cik7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2Vuc29yU3RhdGUgPSBuZXcgVGVtcGVyOChkZXZpY2UpO1xyXG4gICAgICAgICAgICAgICAgVVNCQ29udHJvbGxlci5jcmVhdGVVU0JEZXZpY2UoZGV2aWNlLnBhdGgsIHNlbnNvclN0YXRlKTtcclxuICAgICAgICAgICAgICAgIFVTQkNvbnRyb2xsZXIuY3JlYXRlU2Vuc29yTG9nKHNlbnNvclN0YXRlKTtcclxuXHJcbiAgICAgICAgICAgICAgIC8vIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdVU0JDb250cm9sbGVyLmluaXRpYWxpemU6IHVuc3VwcG9ydGVkIFVTQiBkZXZpY2UgZm91bmQ9JyArIGRldmljZVN0cik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsb2cuaW5mbygnVVNCQ29udHJvbGxlci5pbml0aWFsaXplOiBGb3VuZCAnICsgVVNCQ29udHJvbGxlci5kZXZpY2VzLmxlbmd0aCArICcgSElEIGRldmljZShzKScpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIHNldFBvbGxpbmdJbnRlcnZhbChtczogbnVtYmVyKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCdVU0JDb250cm9sbGVyLnNldFBvbGxpbmdJbnRlcnZhbDogbXM9JyArIG1zKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGRldmljZSBvZiBVU0JDb250cm9sbGVyLmRldmljZXMpIHtcclxuICAgICAgICAgICAgZGV2aWNlLnNldFBvbGxpbmdJbnRlcnZhbChtcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0UG9sbGluZ0ludGVydmFsKCk6IG51bWJlciB7XHJcbiAgICAgICAgZm9yIChjb25zdCBkZXZpY2Ugb2YgVVNCQ29udHJvbGxlci5kZXZpY2VzKSB7XHJcbiAgICAgICAgICAgcmV0dXJuIGRldmljZS5nZXRQb2xsaW5nSW50ZXJ2YWwoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbn1cclxuIl19
