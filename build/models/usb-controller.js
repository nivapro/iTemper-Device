"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var os = require("os");
var logger_1 = require("./../logger");
var USBController = (function () {
    function USBController(hid, parser) {
        this.POLL_INTERVAL = 5000;
        this.deviceInitialized = false;
        this.hid = hid;
        this.reportParser = parser;
        this.initializeDevice();
        this.pollSensors();
    }
    USBController.prototype.initializeDevice = function () {
        if (!this.deviceInitialized) {
            this.hid.on('data', this.parseInput.bind(this));
            this.hid.on('error', this.parseError.bind(this));
            this.setPollingInterval(this.POLL_INTERVAL);
            this.deviceInitialized = true;
            logger_1.log.debug('+++ USBController.initializeDevice');
        }
    };
    USBController.prototype.close = function () {
        this.deviceInitialized = false;
        try {
            this.hid.pause();
            this.hid.close();
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.setPollingInterval = function (ms) {
        this.POLL_INTERVAL = ms;
        clearInterval(this.interval);
        this.interval = setInterval(this.pollSensors.bind(this), this.POLL_INTERVAL);
    };
    USBController.prototype.pollSensors = function () {
        if (!this.deviceInitialized) {
            this.initializeDevice();
        }
        else {
            logger_1.log.debug('+++ USBController.pollSensors');
            var initCommands = this.reportParser.initReport();
            for (var _i = 0, initCommands_1 = initCommands; _i < initCommands_1.length; _i++) {
                var command = initCommands_1[_i];
                this.writeReport(command);
            }
        }
    };
    USBController.prototype.parseInput = function (data) {
        try {
            var response = this.reportParser.parseInput(data);
            if (response.length > 0) {
                this.writeReport(response);
            }
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.parseError = function (_error) {
        logger_1.log.error('parseError: ', JSON.stringify(_error));
    };
    USBController.prototype.writeReport = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                this.hid.write(data);
                logger_1.log.debug('+++ USBController.writeReport', JSON.stringify(data));
            }
            catch (e) {
                logger_1.log.error('*** USBController.writeReport hid.write catch:&d', JSON.stringify(data));
                this.close();
            }
        }
    };
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSx1QkFBMEI7QUFFMUIsc0NBQWtDO0FBU2xDO0lBV0ksdUJBQVksR0FBWSxFQUFFLE1BQW9CO1FBTnRDLGtCQUFhLEdBQUcsSUFBSyxDQUFDO1FBRXRCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUs5QixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDO1FBQzNCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU0sd0NBQWdCLEdBQXZCO1FBQ0ksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztZQUM5QixZQUFHLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztJQUNMLENBQUM7SUFFTSw2QkFBSyxHQUFaO1FBQ0ksSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztRQUMvQixJQUFJLENBQUM7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMs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XHJcbmltcG9ydCBISUQgPSByZXF1aXJlKCdub2RlLWhpZCcpO1xyXG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpO1xyXG5cclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi8uLi9sb2dnZXInO1xyXG5cclxuLy8gUmVwb3J0UGFyc2VyIGFsbG93IFVTQkNvbnRyb2xsZXIgdG8gYmUgaW5kZXBlbmRlbnQgb24gdGhlIHNwZWNpZmljXHJcbi8vIFRlbXBlciBkZXZpY2UgY29ubmVjdGVkLlxyXG5leHBvcnQgaW50ZXJmYWNlIFJlcG9ydFBhcnNlciB7XHJcbiAgICBpbml0UmVwb3J0KCk6IG51bWJlcltdW107XHJcbiAgICBwYXJzZUlucHV0KGRhdGE6IG51bWJlcltdKTogbnVtYmVyW107XHJcbn1cclxuLy8gSGFuZGxlIGEgc2Vuc29yIGRldmljZSBvbiB0aGUgVVNCIGh1Yi5cclxuZXhwb3J0IGNsYXNzIFVTQkNvbnRyb2xsZXIge1xyXG4gICAgcHJpdmF0ZSAgaGlkOiBISUQuSElEO1xyXG5cclxuICAgIHByaXZhdGUgcmVwb3J0UGFyc2VyOiBSZXBvcnRQYXJzZXI7XHJcblxyXG4gICAgcHJpdmF0ZSBQT0xMX0lOVEVSVkFMID0gNV8wMDA7XHJcblxyXG4gICAgcHJpdmF0ZSBkZXZpY2VJbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICAgIHByaXZhdGUgaW50ZXJ2YWw6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihoaWQ6IEhJRC5ISUQsIHBhcnNlcjogUmVwb3J0UGFyc2VyKSB7XHJcbiAgICAgICAgdGhpcy5oaWQgPSBoaWQ7XHJcbiAgICAgICAgdGhpcy5yZXBvcnRQYXJzZXIgPSBwYXJzZXI7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsaXplRGV2aWNlKCk7XHJcbiAgICAgICAgdGhpcy5wb2xsU2Vuc29ycygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpbml0aWFsaXplRGV2aWNlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5kZXZpY2VJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5vbignZGF0YScsIHRoaXMucGFyc2VJbnB1dC5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgdGhpcy5oaWQub24oJ2Vycm9yJywgdGhpcy5wYXJzZUVycm9yLmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICB0aGlzLnNldFBvbGxpbmdJbnRlcnZhbCh0aGlzLlBPTExfSU5URVJWQUwpO1xyXG4gICAgICAgICAgICB0aGlzLmRldmljZUluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCcrKysgVVNCQ29udHJvbGxlci5pbml0aWFsaXplRGV2aWNlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbG9zZSgpIHtcclxuICAgICAgICB0aGlzLmRldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5oaWQucGF1c2UoKTtcclxuICAgICAgICAgICAgdGhpcy5oaWQuY2xvc2UoKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldFBvbGxpbmdJbnRlcnZhbChtczogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5QT0xMX0lOVEVSVkFMID0gbXM7XHJcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsKTtcclxuICAgICAgICB0aGlzLmludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5wb2xsU2Vuc29ycy5iaW5kKHRoaXMpLCB0aGlzLlBPTExfSU5URVJWQUwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRoaXMgaXMgd2VyZSBhbGwgc3RhcnRzIHdoZW4gc2V0IGludGVydmFsIHRpbWUgZXhwaXJlc1xyXG5cclxuICAgIHByaXZhdGUgcG9sbFNlbnNvcnMoKSB7XHJcbiAgICAgICAgaWYgKCEgdGhpcy5kZXZpY2VJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVEZXZpY2UoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJysrKyBVU0JDb250cm9sbGVyLnBvbGxTZW5zb3JzJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGluaXRDb21tYW5kcyA9IHRoaXMucmVwb3J0UGFyc2VyLmluaXRSZXBvcnQoKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBjb21tYW5kIG9mIGluaXRDb21tYW5kcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53cml0ZVJlcG9ydChjb21tYW5kKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIENhbGxlZCBmcm9tIEhJRCwgUGFyc2VzIGlucHV0IGZyb20gSElEIGFuZCB3cml0ZXMgYW55IHJlc3BvbnNlIG1lc3NhZ2VzXHJcbiAgICAvLyBiYWNrIHRvIHRoZSBkZXZpY2VcclxuICAgIHByaXZhdGUgcGFyc2VJbnB1dChkYXRhOiBudW1iZXJbXSk6IHZvaWQgIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMucmVwb3J0UGFyc2VyLnBhcnNlSW5wdXQoZGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLndyaXRlUmVwb3J0KHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgLy8gVE9ETyBlcnJvciBoYW5kbGluZyBpZiBwYXJzZSBpbnB1dCBlcnJvclxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBwYXJzZUVycm9yKF9lcnJvcjogYW55KSB7XHJcbiAgICAgICAgbG9nLmVycm9yKCdwYXJzZUVycm9yOiAnLCBKU09OLnN0cmluZ2lmeShfZXJyb3IpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBIZWxwZXIgZnVuY3Rpb25zIHRvIHdyaXRlIHJlcG9ydHMgdG8gdGhlIGRldmljZVxyXG4gICAgcHJpdmF0ZSB3cml0ZVJlcG9ydChkYXRhOiBudW1iZXJbXSk6IHZvaWQge1xyXG5cclxuICAgICAgICBpZiAob3MucGxhdGZvcm0oKSA9PT0gJ3dpbjMyJykge1xyXG4gICAgICAgICAgICBkYXRhLnVuc2hpZnQoMCk7ICAvLyBwcmVwZW5kIGEgdGhyb3dhd2F5IGJ5dGVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIE91dHB1dCByZXBvcnRcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE7IGkrKykge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWQud3JpdGUoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJysrKyBVU0JDb250cm9sbGVyLndyaXRlUmVwb3J0JywgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBVU0JDb250cm9sbGVyLndyaXRlUmVwb3J0IGhpZC53cml0ZSBjYXRjaDomZCcsIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19
