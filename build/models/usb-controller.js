"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var os = require("os");
var logger_1 = require("./../logger");
var USBController = (function () {
    function USBController(hid, parser) {
        this.POLL_INTERVAL = 5000;
        this.deviceInitialized = false;
        this.hid = hid;
        this.reportParser = parser;
        this.initializeDevice();
        this.pollSensors();
    }
    USBController.prototype.initializeDevice = function () {
        if (!this.deviceInitialized) {
            this.hid.on('data', this.parseInput.bind(this));
            this.hid.on('error', this.parseError.bind(this));
            this.setPollingInterval(this.POLL_INTERVAL);
            this.deviceInitialized = true;
            logger_1.log.info('USBController.initializeDevice done');
        }
    };
    USBController.prototype.close = function () {
        this.deviceInitialized = false;
        try {
            this.hid.pause();
            this.hid.close();
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.setPollingInterval = function (ms) {
        this.POLL_INTERVAL = ms;
        clearInterval(this.interval);
        this.interval = setInterval(this.pollSensors.bind(this), this.POLL_INTERVAL);
        logger_1.log.info('USB Controller.setPollingInterval: %d', ms);
    };
    USBController.prototype.pollSensors = function () {
        if (!this.deviceInitialized) {
            this.initializeDevice();
        }
        else {
            logger_1.log.debug('+++ USBController.pollSensors');
            var initCommands = this.reportParser.initReport();
            for (var _i = 0, initCommands_1 = initCommands; _i < initCommands_1.length; _i++) {
                var command = initCommands_1[_i];
                this.writeReport(command);
            }
        }
    };
    USBController.prototype.parseInput = function (data) {
        try {
            var response = this.reportParser.parseInput(data);
            if (response.length > 0) {
                this.writeReport(response);
            }
        }
        catch (e) {
            return;
        }
    };
    USBController.prototype.parseError = function (_error) {
        logger_1.log.error('parseError: ', _error);
    };
    USBController.prototype.writeReport = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                this.hid.write(data);
                logger_1.log.debug('+++ USBController.writeReport', data);
            }
            catch (e) {
                logger_1.log.error('*** USBController.writeReport hid.write catch:&d', data);
                this.close();
            }
        }
    };
    return USBController;
}());
exports.USBController = USBController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSx1QkFBMEI7QUFFMUIsc0NBQWtDO0FBU2xDO0lBV0ksdUJBQVksR0FBWSxFQUFFLE1BQW9CO1FBTnRDLGtCQUFhLEdBQUcsSUFBSyxDQUFDO1FBRXRCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUs5QixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDO1FBQzNCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU0sd0NBQWdCLEdBQXZCO1FBQ0ksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztZQUM5QixZQUFHLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztJQUNMLENBQUM7SUFFTSw2QkFBSyxHQUFaO1FBQ0ksSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztRQUMvQixJQUFJLENBQUM7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDckIsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDVCxNQUFNLENBQUM7UUFDWCxDQUFDO0lBQ0wsQ0FBQztJQUVNLDBDQUFrQixHQUF6QixVQUEwQixFQUFVO1FBQ2hDLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzdFLFlBQUcsQ0FBQyxJQUFJLENBQUMsdUNBQXVDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUlPLG1DQUFXLEdBQW5CO1FBQ0ksRUFBRSxDQUFDLENBQUMsQ0FBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzVCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLFlBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztZQUMzQyxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3BELEdBQUcsQ0FBQyxDQUFrQixVQUFZLEVBQVosNkJBQVksRUFBWiwwQkFBWSxFQUFaLElBQVk7Z0JBQTdCLElBQU0sT0FBTyxxQkFBQTtnQkFDZCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzdCO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFHTyxrQ0FBVSxHQUFsQixVQUFtQixJQUFjO1FBQzdCLElBQUksQ0FBQztZQUNELElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BELEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMvQixDQUFDO1FBQ0wsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFVCxNQUFNLENBQUM7UUFDWCxDQUFDO0lBQ0wsQ0FBQztJQUNPLGtDQUFVLEdBQWxCLFVBQW1CLE1BQVc7UUFDMUIsWUFBRyxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUdPLG1DQUFXLEdBQW5CLFVBQW9CLElBQWM7UUFFOUIsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixDQUFDO1FBR0QsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUM7Z0JBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3JCLFlBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDckQsQ0FBQztZQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1QsWUFBRyxDQUFDLEtBQUssQ0FBQyxrREFBa0QsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDcEUsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pCLENBQUM7UUFFTCxDQUFDO0lBQ0wsQ0FBQztJQUNMLG9CQUFDO0FBQUQsQ0E5RkEsQUE4RkMsSUFBQTtBQTlGWSxzQ0FBYSIsImZpbGUiOiJtb2RlbHMvdXNiLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IEhJRCA9IHJlcXVpcmUoJ25vZGUtaGlkJyk7XHJcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJyk7XHJcblxyXG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLy4uL2xvZ2dlcic7XHJcblxyXG4vLyBSZXBvcnRQYXJzZXIgYWxsb3cgVVNCQ29udHJvbGxlciB0byBiZSBpbmRlcGVuZGVudCBvbiB0aGUgc3BlY2lmaWNcclxuLy8gVGVtcGVyIGRldmljZSBjb25uZWN0ZWQuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVwb3J0UGFyc2VyIHtcclxuICAgIGluaXRSZXBvcnQoKTogbnVtYmVyW11bXTtcclxuICAgIHBhcnNlSW5wdXQoZGF0YTogbnVtYmVyW10pOiBudW1iZXJbXTtcclxufVxyXG4vLyBIYW5kbGUgYSBzZW5zb3IgZGV2aWNlIG9uIHRoZSBVU0IgaHViLlxyXG5leHBvcnQgY2xhc3MgVVNCQ29udHJvbGxlciB7XHJcbiAgICBwcml2YXRlICBoaWQ6IEhJRC5ISUQ7XHJcblxyXG4gICAgcHJpdmF0ZSByZXBvcnRQYXJzZXI6IFJlcG9ydFBhcnNlcjtcclxuXHJcbiAgICBwcml2YXRlIFBPTExfSU5URVJWQUwgPSA1XzAwMDtcclxuXHJcbiAgICBwcml2YXRlIGRldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcblxyXG4gICAgcHJpdmF0ZSBpbnRlcnZhbDogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGhpZDogSElELkhJRCwgcGFyc2VyOiBSZXBvcnRQYXJzZXIpIHtcclxuICAgICAgICB0aGlzLmhpZCA9IGhpZDtcclxuICAgICAgICB0aGlzLnJlcG9ydFBhcnNlciA9IHBhcnNlcjtcclxuICAgICAgICB0aGlzLmluaXRpYWxpemVEZXZpY2UoKTtcclxuICAgICAgICB0aGlzLnBvbGxTZW5zb3JzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGluaXRpYWxpemVEZXZpY2UoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRldmljZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkLm9uKCdkYXRhJywgdGhpcy5wYXJzZUlucHV0LmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5vbignZXJyb3InLCB0aGlzLnBhcnNlRXJyb3IuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UG9sbGluZ0ludGVydmFsKHRoaXMuUE9MTF9JTlRFUlZBTCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnVVNCQ29udHJvbGxlci5pbml0aWFsaXplRGV2aWNlIGRvbmUnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsb3NlKCkge1xyXG4gICAgICAgIHRoaXMuZGV2aWNlSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5wYXVzZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5jbG9zZSgpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0UG9sbGluZ0ludGVydmFsKG1zOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLlBPTExfSU5URVJWQUwgPSBtcztcclxuICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpO1xyXG4gICAgICAgIHRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLnBvbGxTZW5zb3JzLmJpbmQodGhpcyksIHRoaXMuUE9MTF9JTlRFUlZBTCk7XHJcbiAgICAgICAgbG9nLmluZm8oJ1VTQiBDb250cm9sbGVyLnNldFBvbGxpbmdJbnRlcnZhbDogJWQnLCBtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVGhpcyBpcyB3ZXJlIGFsbCBzdGFydHMgd2hlbiBzZXQgaW50ZXJ2YWwgdGltZSBleHBpcmVzXHJcblxyXG4gICAgcHJpdmF0ZSBwb2xsU2Vuc29ycygpIHtcclxuICAgICAgICBpZiAoISB0aGlzLmRldmljZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZURldmljZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnKysrIFVTQkNvbnRyb2xsZXIucG9sbFNlbnNvcnMnKTtcclxuICAgICAgICAgICAgY29uc3QgaW5pdENvbW1hbmRzID0gdGhpcy5yZXBvcnRQYXJzZXIuaW5pdFJlcG9ydCgpO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGNvbW1hbmQgb2YgaW5pdENvbW1hbmRzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLndyaXRlUmVwb3J0KGNvbW1hbmQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gQ2FsbGVkIGZyb20gSElELCBQYXJzZXMgaW5wdXQgZnJvbSBISUQgYW5kIHdyaXRlcyBhbnkgcmVzcG9uc2UgbWVzc2FnZXNcclxuICAgIC8vIGJhY2sgdG8gdGhlIGRldmljZVxyXG4gICAgcHJpdmF0ZSBwYXJzZUlucHV0KGRhdGE6IG51bWJlcltdKTogdm9pZCAge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gdGhpcy5yZXBvcnRQYXJzZXIucGFyc2VJbnB1dChkYXRhKTtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMud3JpdGVSZXBvcnQocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAvLyBUT0RPIGVycm9yIGhhbmRsaW5nIGlmIHBhcnNlIGlucHV0IGVycm9yXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHBhcnNlRXJyb3IoX2Vycm9yOiBhbnkpIHtcclxuICAgICAgICBsb2cuZXJyb3IoJ3BhcnNlRXJyb3I6ICcsIF9lcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSGVscGVyIGZ1bmN0aW9ucyB0byB3cml0ZSByZXBvcnRzIHRvIHRoZSBkZXZpY2VcclxuICAgIHByaXZhdGUgd3JpdGVSZXBvcnQoZGF0YTogbnVtYmVyW10pOiB2b2lkIHtcclxuXHJcbiAgICAgICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09ICd3aW4zMicpIHtcclxuICAgICAgICAgICAgZGF0YS51bnNoaWZ0KDApOyAgLy8gcHJlcGVuZCBhIHRocm93YXdheSBieXRlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBPdXRwdXQgcmVwb3J0XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxOyBpKyspIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkLndyaXRlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCcrKysgVVNCQ29udHJvbGxlci53cml0ZVJlcG9ydCcsIGRhdGEpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBVU0JDb250cm9sbGVyLndyaXRlUmVwb3J0IGhpZC53cml0ZSBjYXRjaDomZCcsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=
