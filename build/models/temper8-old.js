"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var HID = require("node-hid");
var os = require("os");
var sensor_1 = require("./sensor");
var Device = (function () {
    function Device() {
        Device.initialize();
    }
    Device.initialize = function () {
        if (!Device._deviceInitialized) {
            var _devices = HID.devices();
            var deviceInfo = _devices.find(function (d) {
                var VID = 0x0C45;
                var PID = 0x7401;
                var isTemper = d.vendorId === VID && d.productId === PID;
                return isTemper && d.interface === 1;
            });
            if ((deviceInfo !== undefined) && (deviceInfo.path !== undefined)) {
                Device._hid1 = new HID.HID(deviceInfo.path);
                Device._hid1.on('data', Device.parseInput);
                Device._hid1.on('error', Device.parseError);
                Device._interval = setInterval(Device.pollSensors, Device.POLL_INTERVAL);
                Device._deviceInitialized = true;
                Device.writeUsedPortsRequest();
                Device.WriteTemperatureRequest(0);
                console.log('+initialized');
            }
        }
    };
    Device.close = function () {
        Device._nextSensor = 0;
        Device._deviceInitialized = false;
        try {
            Device._hid1.pause();
            Device._hid1.close();
        }
        catch (e) {
            return;
        }
    };
    Device.pollSensors = function () {
        if (!Device._deviceInitialized) {
            Device.initialize();
        }
        else {
            Device.writeUsedPortsRequest();
            if (Date.now() - Device._lastInputTime > 2 * Device.POLL_INTERVAL) {
                Device.WriteTemperatureRequest(0);
            }
        }
    };
    Device.getSensorData = function () {
        return Device._sensors.slice();
    };
    Device.parseError = function (_error) {
        return;
    };
    Device.parseInput = function (data) {
        Device._lastInputTime = Date.now();
        try {
            if (Device.matchUsedPorts(data)) {
                Device.WriteTemperatureRequest(Device._sensors[Device._nextSensor].port());
                Device._nextSensor += 1;
            }
            else if (Device.matchTemperature(data)) {
                if (Device._nextSensor < Device._sensors.length) {
                    Device.WriteTemperatureRequest(Device._sensors[Device._nextSensor].port());
                    Device._nextSensor += 1;
                }
                else {
                    Device._nextSensor = 0;
                    Device.writeCheck03Request();
                }
            }
            else if (Device.matchCheck03(data)) {
                Device.writeCheck05Request();
            }
            else if (Device.matchCheck05(data)) {
                Device.writeCheck0DRequest();
            }
            else if (Device.matchCheck0D(data)) {
                return;
            }
            else if (Device.matchCheckFF(data)) {
                Device.writeCheckFFRequest();
                console.log('--matchCheckFF: restart');
                return;
            }
        }
        catch (e) {
            console.log(e);
        }
    };
    Device.writeRequest = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                Device._hid1.write(data);
            }
            catch (e) {
                console.log('-_hid1.write catch:&d', JSON.stringify(data));
                Device.close();
            }
        }
    };
    Device.writeUsedPortsRequest = function () {
        var data = [0x01, 0x8A, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00];
        this.writeRequest(data);
    };
    Device.matchUsedPorts = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x01) {
            Device.connectSensors(data[4], data[5]);
            return true;
        }
        else {
            return false;
        }
    };
    Device.connectSensors = function (total, used) {
        console.log('connectSensors, total:%d', total);
        if (Device._sensors.length === 0) {
            Device._sensors = Array(total);
            var bits = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80];
            var sensor = 0;
            for (var port = 0; port < bits.length; port++) {
                if ((used & bits[port]) === bits[port]) {
                    Device._sensors[sensor] = new sensor_1.Sensor(port);
                    console.log('connectSensors, port:%d', port);
                    sensor += 1;
                }
            }
            if (sensor !== total) {
                return;
            }
        }
    };
    Device.WriteTemperatureRequest = function (port) {
        var data = [0x01, 0x80, 0x01, 0x00, 0x00, port, 0x00, 0x00];
        Device.writeRequest(data);
    };
    Device.matchTemperature = function (data) {
        if (data.length === 8
            && data[0] === 0x80
            && data[1] === 0x08
            && data[2] === 0x01) {
            console.log('+matchTemperature, data: %d', JSON.stringify(data));
            var port = data[4];
            var msb = data[5];
            var lsb = data[6];
            var temperatureCelsius = this.GetTemperature(msb, lsb);
            Device.updateSensor(port, temperatureCelsius);
            return true;
        }
        else {
            return false;
        }
    };
    Device.GetTemperature = function (msb, lsb) {
        var temperature = 0.0;
        var reading = (lsb & 0xFF) + (msb << 8);
        var result = 1;
        if ((reading & 0x8000) > 0) {
            reading = (reading ^ 0xffff) + 1;
            result = -1;
        }
        temperature = result * reading / 16.0;
        return temperature;
    };
    Device.updateSensor = function (port, temperature) {
        if (Device._sensors != null) {
            var sensor = Device._sensors.find(function (s) { return s.port() === port; });
            if (sensor) {
                sensor.setValue(temperature);
                console.log('+updateSensor, port: %d, temperature %d', port, temperature);
            }
            else {
                console.error('-updateSensor - sensor undefined, port: %d, temperature %d', port, temperature);
            }
        }
        else {
            console.error('-updateSensor - no sensors, port: %d, temperature %d', port, temperature);
        }
    };
    Device.writeCheck03Request = function () {
        var data = [0x01, 0x8A, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00];
        this.writeRequest(data);
    };
    Device.matchCheck03 = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x03) {
            return true;
        }
        else {
            return false;
        }
    };
    Device.writeCheck05Request = function () {
        var data = [0x01, 0x8A, 0x01, 0x05, 0x00, 0x00, 0x00, 0x00];
        this.writeRequest(data);
    };
    Device.matchCheck05 = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x05) {
            return true;
        }
        else {
            return false;
        }
    };
    Device.writeCheck0DRequest = function () {
        var data = [0x01, 0x8A, 0x01, 0x0D, 0x00, 0x00, 0x00, 0x00];
        this.writeRequest(data);
    };
    Device.matchCheck0D = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x0D) {
            return true;
        }
        else {
            return false;
        }
    };
    Device.writeCheckFFRequest = function () {
        var data = [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF];
        this.writeRequest(data);
    };
    Device.matchCheckFF = function (data) {
        if (data.length === 8
            && data[0] === 0xFF
            && data[1] === 0xFF
            && data[2] === 0xFF
            && data[3] === 0xFF) {
            return true;
        }
        else {
            return false;
        }
    };
    Device.POLL_INTERVAL = 5000;
    Device._sensors = [];
    Device._deviceInitialized = false;
    Device._nextSensor = 0;
    Device._lastInputTime = Date.now();
    return Device;
}());
exports.Device = Device;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdGVtcGVyOC1vbGQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw4QkFBaUM7QUFDakMsdUJBQTBCO0FBQzFCLG1DQUFrQztBQUVsQztJQWdCSTtRQUNJLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRWEsaUJBQVUsR0FBeEI7UUFDSSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7WUFFN0IsSUFBTSxRQUFRLEdBQWlCLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUU3QyxJQUFNLFVBQVUsR0FBMkIsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFBLENBQUM7Z0JBRXRELElBQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQztnQkFDbkIsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDO2dCQUVuQixJQUFNLFFBQVEsR0FBWSxDQUFDLENBQUMsUUFBUSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsU0FBUyxLQUFLLEdBQUcsQ0FBQztnQkFDcEUsTUFBTSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsU0FBUyxLQUFLLENBQUMsQ0FBQztZQUN6QyxDQUFDLENBQUMsQ0FBQztZQUVILEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hFLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDNUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDM0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDNUMsTUFB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QUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBaFV1QixvQkFBYSxHQUFHLElBQUksQ0FBQztJQUM5QixlQUFRLEdBQVksRUFBRSxDQUFDO0lBR3ZCLHlCQUFrQixHQUFHLEtBQUssQ0FBQztJQUMzQixrQkFBVyxHQUFXLENBQUMsQ0FBQztJQUV4QixxQkFBYyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQTJUL0MsYUFBQztDQXhVRCxBQXdVQyxJQUFBO0FBeFVZLHdCQUFNIiwiZmlsZSI6Im1vZGVscy90ZW1wZXI4LW9sZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgSElEID0gcmVxdWlyZSgnbm9kZS1oaWQnKTtcclxuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKTtcclxuaW1wb3J0IHsgU2Vuc29yIH0gZnJvbSAnLi9zZW5zb3InO1xyXG5cclxuZXhwb3J0IGNsYXNzIERldmljZSB7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaGlkMTogSElELkhJRDsgIC8vIHJlcHJlc2VudGluZyBISUQgSW50ZXJmYWNlIDEgb24gRGV2aWNlXHJcblxyXG4gICAgLy8gRGV2aWNlIGhhcyA4IHBvcnRzLCBlYWNoIG9mIHdoaWNoIGNhbiBob2xkIGEgMS13aXJlIHRlbXBlcmF0dXJlIHNlbnNvclxyXG4gICAgLy8gb3IgYSBodW1pZGl0eSBzZW5zb3IsIGJ1dCB0aGUgbGF0dGVyIGlzIG91dCBvZiBzY29wZS5cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBQT0xMX0lOVEVSVkFMID0gNTAwMDtcclxuICAgIHByaXZhdGUgc3RhdGljIF9zZW5zb3JzOiBTZW5zb3JbXT0gW107XHJcblxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIF9kZXZpY2VJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX25leHRTZW5zb3I6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaW50ZXJ2YWw6IE5vZGVKUy5UaW1lcjtcclxuICAgIHByaXZhdGUgc3RhdGljIF9sYXN0SW5wdXRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgRGV2aWNlLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGluaXRpYWxpemUoKSB7XHJcbiAgICAgICAgaWYgKCFEZXZpY2UuX2RldmljZUluaXRpYWxpemVkKSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBfZGV2aWNlczogSElELkRldmljZVtdID0gSElELmRldmljZXMoKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRldmljZUluZm86IEhJRC5EZXZpY2UgfCB1bmRlZmluZWQgPSBfZGV2aWNlcy5maW5kKGQgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IFZJRCA9IDB4MEM0NTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IFBJRCA9IDB4NzQwMTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc1RlbXBlcjogYm9vbGVhbiA9IGQudmVuZG9ySWQgPT09IFZJRCAmJiBkLnByb2R1Y3RJZCA9PT0gUElEO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlzVGVtcGVyICYmIGQuaW50ZXJmYWNlID09PSAxO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICgoZGV2aWNlSW5mbyAhPT0gdW5kZWZpbmVkKSAmJiAoZGV2aWNlSW5mby5wYXRoICE9PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuX2hpZDEgPSBuZXcgSElELkhJRChkZXZpY2VJbmZvLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgRGV2aWNlLl9oaWQxLm9uKCdkYXRhJywgRGV2aWNlLnBhcnNlSW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgRGV2aWNlLl9oaWQxLm9uKCdlcnJvcicsIERldmljZS5wYXJzZUVycm9yKTtcclxuICAgICAgICAgICAgICAgIERldmljZS5faW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChEZXZpY2UucG9sbFNlbnNvcnMsIERldmljZS5QT0xMX0lOVEVSVkFMKTtcclxuICAgICAgICAgICAgICAgIERldmljZS5fZGV2aWNlSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgIERldmljZS53cml0ZVVzZWRQb3J0c1JlcXVlc3QoKTtcclxuICAgICAgICAgICAgICAgIERldmljZS5Xcml0ZVRlbXBlcmF0dXJlUmVxdWVzdCgwKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCcraW5pdGlhbGl6ZWQnKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGNsb3NlKCkge1xyXG4gICAgICAgIERldmljZS5fbmV4dFNlbnNvciA9IDA7XHJcbiAgICAgICAgRGV2aWNlLl9kZXZpY2VJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIERldmljZS5faGlkMS5wYXVzZSgpO1xyXG4gICAgICAgICAgICBEZXZpY2UuX2hpZDEuY2xvc2UoKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUG9sbHMgdGhlIGRldmljZSBieSBkb2luZyB0aGUgZm9sbG93aW5nIHdyaXRlIGFuZCByZWFkcyBjeWNsaWNhbGx5XHJcbiAgICAvLyAxLiBXcml0ZSBhIHJlcXVlc3QgYW5kIHJlYWQgdXNlZCBwb3J0cywgaS5lLiB3aGljaCBwb3J0cyBoYXZlIGEgc2Vuc29yIGNvbm5lY3RlZD9cclxuICAgIC8vIDIuIFdyaXRlIGEgcmVxdWVzdCBhbmQgcmVhZCB0aGUgdGVtcGVyYXR1cmUgZnJvbSBlYWNoIHNlbnNvciBzdGFydGluZyBmcm9tIHBvcnQgMCB1cCB0byA3XHJcbiAgICAvLyA0LiByZXBlYXQgYXQgcmVndWxhciBpbnRlcnZhbHNcclxuICAgIC8vIEEgdGVtcGVyYXR1cmUgcmVhZCBvZiBhIHNlbnNvciB0YWtlcyBhcHByb3ggODIwIG1zLiBpZSB0aGUgbW9yZSBzZW5zb3IgdGhlIGxvbmdlciB0aWVtIGJldHdlZW4gcG9saWluZ1xyXG4gICAgLy8gZWFjaCBpbnRlcnZhbFxyXG5cclxuICAgIC8vIFRoaXMgZnVuY3Rpb24gZHJpdmVzIHRoZSBwb2xsaW5nIGN5Y2xlXHJcbiAgICBwdWJsaWMgc3RhdGljIHBvbGxTZW5zb3JzKCkge1xyXG4gICAgICAgIGlmICghIERldmljZS5fZGV2aWNlSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgICAgRGV2aWNlLmluaXRpYWxpemUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBEZXZpY2Uud3JpdGVVc2VkUG9ydHNSZXF1ZXN0KCk7XHJcbiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gRGV2aWNlLl9sYXN0SW5wdXRUaW1lID4gMiAqIERldmljZS5QT0xMX0lOVEVSVkFMKSB7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuV3JpdGVUZW1wZXJhdHVyZVJlcXVlc3QoMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG4gICAgcHVibGljIHN0YXRpYyBnZXRTZW5zb3JEYXRhKCk6IFNlbnNvcltdIHtcclxuICAgICAgICByZXR1cm4gRGV2aWNlLl9zZW5zb3JzLnNsaWNlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcGFyc2VFcnJvcihfZXJyb3I6IGFueSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIFRoaXMgZnVuY3Rpb24gcGFyc2VzIGFsbCBpbnB1dCByZXBvcnRzIGFuZCBjaGVjayB3aGF0IHRvIGRvXHJcbiAgICAvLyBXZSBhcmUgaW50ZXJlc3RlZCBpbiB0d28gdHlwZXMgb2YgZGF0YSBmcm9tIHRoZSBkZXZpY2U6IHdoaWNoIHBvcnRzIGFyZSB1c2VkIGFuZFxyXG4gICAgLy8gdGhlIHRlbXBlcmF0dXJlIG9mIHRoZSBzZW5zb3JzIGNvbm5lY3RlZC5cclxuICAgIHByaXZhdGUgc3RhdGljIHBhcnNlSW5wdXQoZGF0YTogbnVtYmVyW10pIHtcclxuICAgICAgICBEZXZpY2UuX2xhc3RJbnB1dFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChEZXZpY2UubWF0Y2hVc2VkUG9ydHMoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIERldmljZS5Xcml0ZVRlbXBlcmF0dXJlUmVxdWVzdChEZXZpY2UuX3NlbnNvcnNbRGV2aWNlLl9uZXh0U2Vuc29yXS5wb3J0KCkpO1xyXG4gICAgICAgICAgICAgICAgRGV2aWNlLl9uZXh0U2Vuc29yICs9IDE7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKERldmljZS5tYXRjaFRlbXBlcmF0dXJlKGRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoRGV2aWNlLl9uZXh0U2Vuc29yIDwgRGV2aWNlLl9zZW5zb3JzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIERldmljZS5Xcml0ZVRlbXBlcmF0dXJlUmVxdWVzdChEZXZpY2UuX3NlbnNvcnNbRGV2aWNlLl9uZXh0U2Vuc29yXS5wb3J0KCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIERldmljZS5fbmV4dFNlbnNvciArPSAxO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgRGV2aWNlLl9uZXh0U2Vuc29yID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBEZXZpY2Uud3JpdGVDaGVjazAzUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKERldmljZS5tYXRjaENoZWNrMDMoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIERldmljZS53cml0ZUNoZWNrMDVSZXF1ZXN0KCk7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKERldmljZS5tYXRjaENoZWNrMDUoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIERldmljZS53cml0ZUNoZWNrMERSZXF1ZXN0KCk7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKERldmljZS5tYXRjaENoZWNrMEQoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIC8vIERldmljZS53cml0ZVVzZWRQb3J0c1JlcXVlc3QoKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChEZXZpY2UubWF0Y2hDaGVja0ZGKGRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2Uud3JpdGVDaGVja0ZGUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJy0tbWF0Y2hDaGVja0ZGOiByZXN0YXJ0Jyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBIZWxwZXIgZnVuY3Rpb25zIHRvIHdyaXRlIHJlcG9ydHMgdG8gdGhlIGRldmljZVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgd3JpdGVSZXF1ZXN0KGRhdGE6IG51bWJlcltdKSB7XHJcblxyXG4gICAgICAgIGlmIChvcy5wbGF0Zm9ybSgpID09PSAnd2luMzInKSB7XHJcbiAgICAgICAgICAgIGRhdGEudW5zaGlmdCgwKTsgIC8vIHByZXBlbmQgYSB0aHJvd2F3YXkgYnl0ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gT3V0cHV0IHJlcG9ydFxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuX2hpZDEud3JpdGUoZGF0YSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCctX2hpZDEud3JpdGUgY2F0Y2g6JmQnLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUG9sbCB1c2VkIHBvcnRzXHJcbiAgICBwcml2YXRlIHN0YXRpYyB3cml0ZVVzZWRQb3J0c1JlcXVlc3QoKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YTogbnVtYmVyW10gPSBbMHgwMSwgMHg4QSwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMF07XHJcbiAgICAgICAgdGhpcy53cml0ZVJlcXVlc3QoZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgbWF0Y2hVc2VkUG9ydHMoZGF0YTogbnVtYmVyW10pOiBib29sZWFuIHtcclxuICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIGlucHV0IHJlcG9ydCBzdGF0ZXMgc2Vuc29yc1xyXG4gICAgICAgIC8vIGNvbm5lY3RlZCB0byB0aGUgZGV2aWNlLiBUaGVzZSBoZXggdmFsdWVzIHdlcmUgZm91bmQgYnkgdXNpbmcgdXNpbmcgVVNCbHl6ZXJcclxuICAgICAgICAvLyBJLmUuIHRoZXkgbWlnaHQgYmUgZGlmZmVyZW50IG9uIHlvdXIgRGV2aWNlIGRldmljZVxyXG5cclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDhcclxuICAgICAgICAgICAgJiYgZGF0YVswXSA9PT0gMHg4QVxyXG4gICAgICAgICAgICAmJiBkYXRhWzFdID09PSAweDA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMl0gPT09IDB4MDFcclxuICAgICAgICAgICAgJiYgZGF0YVszXSA9PT0gMHgwMSkge1xyXG4gICAgICAgICAgICAvLyBCeXRlIDQgY29udGFpbnMgbm8gb2Ygc2Vuc29ycyBhbmRcclxuICAgICAgICAgICAgLy8gQnl0ZSA1IGNvbnRhaW5zIGEgYml0IGFycmF5IG9mIGNvbm5lY3RlZCBzZW5zb3JzXHJcbiAgICAgICAgICAgIERldmljZS5jb25uZWN0U2Vuc29ycyhkYXRhWzRdLCBkYXRhWzVdKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBjb25uZWN0U2Vuc29ycyh0b3RhbDogbnVtYmVyLCB1c2VkOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdFNlbnNvcnMsIHRvdGFsOiVkJywgdG90YWwpO1xyXG4gICAgICAgIGlmIChEZXZpY2UuX3NlbnNvcnMubGVuZ3RoID09PSAwKSB7XHJcblxyXG4gICAgICAgICAgICBEZXZpY2UuX3NlbnNvcnMgPSBBcnJheTxTZW5zb3I+KHRvdGFsKTtcclxuICAgICAgICAgICAgY29uc3QgYml0czogbnVtYmVyW10gPSBbMHgwMSwgMHgwMiwgMHgwNCwgMHgwOCwgMHgxMCwgMHgyMCwgMHg0MCwgMHg4MF07XHJcbiAgICAgICAgICAgIGxldCBzZW5zb3I6IG51bWJlciA9IDA7XHJcblxyXG4gICAgICAgICAgICAvLyBDaGVjayB0aGUgYml0IGFycmF5IGZvciB1c2VkIHBvcnRzLCBvbmUgYml0IGF0IGEgdGltZVxyXG4gICAgICAgICAgICBmb3IgKGxldCBwb3J0ID0gMDsgcG9ydCA8IGJpdHMubGVuZ3RoOyBwb3J0KyspIHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoKHVzZWQgJiBiaXRzW3BvcnRdKSA9PT0gYml0c1twb3J0XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIERldmljZS5fc2Vuc29yc1tzZW5zb3JdID0gbmV3IFNlbnNvcihwb3J0KTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdFNlbnNvcnMsIHBvcnQ6JWQnLCBwb3J0KTtcclxuICAgICAgICAgICAgICAgICAgICBzZW5zb3IgKz0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHNlbnNvciAhPT0gdG90YWwpIHtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IEVycm9yIGhhbmRsaW5nXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIFBvbGwgdGVtcGVyYXR1cmUgYW5kIHVwZGF0ZSBzZW5zb3IgZGF0YVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgV3JpdGVUZW1wZXJhdHVyZVJlcXVlc3QocG9ydDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YTogbnVtYmVyW10gPSBbMHgwMSwgMHg4MCwgMHgwMSwgMHgwMCwgMHgwMCwgcG9ydCwgMHgwMCwgMHgwMF07XHJcbiAgICAgICAgRGV2aWNlLndyaXRlUmVxdWVzdChkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBtYXRjaFRlbXBlcmF0dXJlKGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgLy8gZ2V0IHRoZSB0ZW1wZXJhdHVyZSBhbmQgdXBkYXRlIHNlbnNvciB2YWx1ZVxyXG5cclxuICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIEhJRCBpbnB1dCByZXBvcnQgaXMgYSB0ZW1wZXJhdHVyZSByZXBvcnQsXHJcbiAgICAgICAgLy8gVGhlc2UgaGV4IHZhbHVlcyB3ZXJlIGZvdW5kIGJ5IGFuYWx5emluZyBVU0IgdXNpbmcgVVNCbHl6ZXIuXHJcbiAgICAgICAgLy8gSS5lLiB0aGV5IG1pZ2h0IGJlIGRpZmZlcmVudCBvbiB5b3VyIERldmljZSBkZXZpY2VcclxuICAgICAgICAvLyBieXRlIDQgY29udGFpbnMgdGhlIHBvcnQgbnVtYmVyLlxyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweDgwXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4MDhcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHgwMSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnK21hdGNoVGVtcGVyYXR1cmUsIGRhdGE6ICVkJywgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICAgICAgICBjb25zdCBwb3J0OiBudW1iZXIgPSBkYXRhWzRdO1xyXG4gICAgICAgICAgICBjb25zdCBtc2I6IG51bWJlciA9IGRhdGFbNV07XHJcbiAgICAgICAgICAgIGNvbnN0IGxzYjogbnVtYmVyID0gZGF0YVs2XTtcclxuICAgICAgICAgICAgY29uc3QgdGVtcGVyYXR1cmVDZWxzaXVzOiBudW1iZXIgPSB0aGlzLkdldFRlbXBlcmF0dXJlKG1zYiwgbHNiKTtcclxuXHJcbiAgICAgICAgICAgIERldmljZS51cGRhdGVTZW5zb3IocG9ydCwgdGVtcGVyYXR1cmVDZWxzaXVzKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBHZXRUZW1wZXJhdHVyZShtc2I6IG51bWJlciwgbHNiOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCB0ZW1wZXJhdHVyZTogbnVtYmVyID0gMC4wO1xyXG5cclxuICAgICAgICBsZXQgcmVhZGluZzogbnVtYmVyID0gKGxzYiAmIDB4RkYpICsgKG1zYiA8PCA4KTtcclxuXHJcbiAgICAgICAgLy8gQXN1bWUgcG9zaXRpdmUgdGVtcGVyYXR1cmUgdmFsdWVcclxuICAgICAgICBsZXQgcmVzdWx0OiBudW1iZXIgPSAxO1xyXG5cclxuICAgICAgICBpZiAoKHJlYWRpbmcgJiAweDgwMDApID4gMCkge1xyXG4gICAgICAgICAgICAvLyBCZWxvdyB6ZXJvXHJcbiAgICAgICAgICAgIC8vIGdldCB0aGUgYWJzb2x1dGUgdmFsdWUgYnkgY29udmVydGluZyB0d28ncyBjb21wbGVtZW50XHJcbiAgICAgICAgICAgIHJlYWRpbmcgPSAocmVhZGluZyBeIDB4ZmZmZikgKyAxO1xyXG5cclxuICAgICAgICAgICAgLy8gUmVtZW1iZXIgYSBuZWdhdGl2ZSByZXN1bHRcclxuICAgICAgICAgICAgcmVzdWx0ID0gLTE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBUaGUgZWFzdCBzaWduaWZpY2FudCBiaXQgaXMgMl4tNCBzbyB3ZSBuZWVkIHRvIGRldmlkZSBieSAxNiB0byBnZXQgYWJzb2x1dGUgdGVtcGVyYXR1cmUgaW4gQ2Vsc2l1c1xyXG4gICAgICAgIC8vIE11bHRpcGx5IGluIHRoZSByZXN1bHQgdG8gZ2V0IHdoZXRoZXIgdGhlIHRlbXBlcmF0dXJlIGlzIGJlbG93IHplcm8gZGVncmVlcyBhbmQgY29udmVydCB0b1xyXG4gICAgICAgIC8vIGZsb2F0aW5nIHBvaW50XHJcbiAgICAgICAgdGVtcGVyYXR1cmUgPSByZXN1bHQgKiByZWFkaW5nIC8gMTYuMDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRlbXBlcmF0dXJlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIHVwZGF0ZVNlbnNvcihwb3J0OiBudW1iZXIsIHRlbXBlcmF0dXJlOiBudW1iZXIpIHtcclxuICAgICAgICBpZiAoRGV2aWNlLl9zZW5zb3JzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yOiBTZW5zb3IgfCB1bmRlZmluZWQgPSBEZXZpY2UuX3NlbnNvcnMuZmluZChzID0+IHMucG9ydCgpID09PSBwb3J0KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzZW5zb3IpIHtcclxuICAgICAgICAgICAgICAgIHNlbnNvci5zZXRWYWx1ZSh0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnK3VwZGF0ZVNlbnNvciwgcG9ydDogJWQsIHRlbXBlcmF0dXJlICVkJywgcG9ydCwgdGVtcGVyYXR1cmUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignLXVwZGF0ZVNlbnNvciAtIHNlbnNvciB1bmRlZmluZWQsIHBvcnQ6ICVkLCB0ZW1wZXJhdHVyZSAlZCcsIHBvcnQsIHRlbXBlcmF0dXJlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJy11cGRhdGVTZW5zb3IgLSBubyBzZW5zb3JzLCBwb3J0OiAlZCwgdGVtcGVyYXR1cmUgJWQnLCBwb3J0LCB0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFBvbGwgY2hlY2tzXHJcbiAgICBwcml2YXRlIHN0YXRpYyB3cml0ZUNoZWNrMDNSZXF1ZXN0KCkge1xyXG4gICAgICAgIGNvbnN0IGRhdGE6IG51bWJlcltdID0gWzB4MDEsIDB4OEEsIDB4MDEsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdO1xyXG4gICAgICAgIHRoaXMud3JpdGVSZXF1ZXN0KGRhdGEpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgbWF0Y2hDaGVjazAzKGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMF0gPT09IDB4OEFcclxuICAgICAgICAgICAgJiYgZGF0YVsxXSA9PT0gMHgwOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzJdID09PSAweDAxXHJcbiAgICAgICAgICAgICYmIGRhdGFbM10gPT09IDB4MDMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgc3RhdGljIHdyaXRlQ2hlY2swNVJlcXVlc3QoKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YTogbnVtYmVyW10gPSBbMHgwMSwgMHg4QSwgMHgwMSwgMHgwNSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMF07XHJcbiAgICAgICAgdGhpcy53cml0ZVJlcXVlc3QoZGF0YSk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHN0YXRpYyBtYXRjaENoZWNrMDUoZGF0YTogbnVtYmVyW10pIHtcclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDhcclxuICAgICAgICAgICAgJiYgZGF0YVswXSA9PT0gMHg4QVxyXG4gICAgICAgICAgICAmJiBkYXRhWzFdID09PSAweDA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMl0gPT09IDB4MDFcclxuICAgICAgICAgICAgJiYgZGF0YVszXSA9PT0gMHgwNSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgd3JpdGVDaGVjazBEUmVxdWVzdCgpIHtcclxuICAgICAgICBjb25zdCBkYXRhOiBudW1iZXJbXSA9IFsweDAxLCAweDhBLCAweDAxLCAweDBELCAweDAwLCAweDAwLCAweDAwLCAweDAwXTtcclxuICAgICAgICB0aGlzLndyaXRlUmVxdWVzdChkYXRhKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgc3RhdGljIG1hdGNoQ2hlY2swRChkYXRhOiBudW1iZXJbXSkge1xyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweDhBXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4MDhcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHgwMVxyXG4gICAgICAgICAgICAmJiBkYXRhWzNdID09PSAweDBEKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgd3JpdGVDaGVja0ZGUmVxdWVzdCgpIHtcclxuICAgICAgICBjb25zdCBkYXRhOiBudW1iZXJbXSA9IFsweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGXTtcclxuICAgICAgICB0aGlzLndyaXRlUmVxdWVzdChkYXRhKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgc3RhdGljIG1hdGNoQ2hlY2tGRihkYXRhOiBudW1iZXJbXSkge1xyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweEZGXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4RkZcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHhGRlxyXG4gICAgICAgICAgICAmJiBkYXRhWzNdID09PSAweEZGKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==
