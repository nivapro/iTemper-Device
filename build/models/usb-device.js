"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var os = require("os");
var logger_1 = require("../logger");
var settings_1 = require("./settings");
var USBDevice = (function () {
    function USBDevice(hid, reporter) {
        this.POLL_INTERVAL = 5000;
        this.MAX_SAMPLE_RATE = 1 / this.POLL_INTERVAL;
        this.deviceInitialized = false;
        this.hid = hid;
        this.reporter = reporter;
        this.MAX_SAMPLE_RATE = reporter.maxSampleRate();
        if (this.sampleRate() > this.MAX_SAMPLE_RATE) {
            this.POLL_INTERVAL = 1000 * 1 / this.MAX_SAMPLE_RATE;
        }
        settings_1.Settings.onChange(settings_1.Settings.POLL_INTERVAL, this.pollIntervalChanged.bind(this));
        this.initialize();
        this.pollSensors();
    }
    USBDevice.prototype.pollIntervalChanged = function (setting) {
        var pollInterval = setting.value;
        var sampleRate = 1 / (pollInterval / 1000);
        if (sampleRate < this.MAX_SAMPLE_RATE) {
            this.POLL_INTERVAL = pollInterval;
            logger_1.log.info('USBDevice.pollIntervalChanged to' + pollInterval);
        }
    };
    USBDevice.prototype.initialize = function () {
        if (!this.deviceInitialized) {
            this.hid.on('data', this.parseInput.bind(this));
            this.hid.on('error', this.parseError.bind(this));
            this.setPollingInterval(this.POLL_INTERVAL);
            logger_1.log.debug('USBDevice.initializeDevice POLLING INTERVAL=' + this.POLL_INTERVAL);
            this.deviceInitialized = true;
            logger_1.log.info('USBDevice.initializeDevice done');
        }
    };
    USBDevice.prototype.close = function () {
        this.deviceInitialized = false;
        try {
            this.hid.pause();
            this.hid.close();
        }
        catch (e) {
            return;
        }
    };
    USBDevice.prototype.sampleRate = function () {
        return 1 / (this.POLL_INTERVAL / 1000);
    };
    USBDevice.prototype.setPollingInterval = function (ms) {
        this.POLL_INTERVAL = ms;
        if (this.sampleRate() > this.MAX_SAMPLE_RATE) {
            this.POLL_INTERVAL = 1000 * 1 / this.MAX_SAMPLE_RATE;
        }
        clearInterval(this.timer);
        this.timer = setInterval(this.pollSensors.bind(this), this.POLL_INTERVAL);
        logger_1.log.info('USBDevice.setPollingInterval: ' + ms + 'ms');
    };
    USBDevice.prototype.getPollingInterval = function () {
        return this.POLL_INTERVAL;
    };
    USBDevice.prototype.pollSensors = function () {
        if (!this.deviceInitialized) {
            this.initialize();
        }
        else {
            logger_1.log.debug('+++ USBController.pollSensors');
            var initCommands = this.reporter.initWriteReport();
            for (var _i = 0, initCommands_1 = initCommands; _i < initCommands_1.length; _i++) {
                var command = initCommands_1[_i];
                this.writeReport(command);
            }
        }
    };
    USBDevice.prototype.parseInput = function (data) {
        try {
            var response = this.reporter.readReport(data);
            if (response.length > 0) {
                this.writeReport(response);
            }
        }
        catch (e) {
            return;
        }
    };
    USBDevice.prototype.parseError = function (_error) {
        logger_1.log.error('parseError: ', _error);
    };
    USBDevice.prototype.writeReport = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                this.hid.write(data);
                logger_1.log.debug('+++ USBController.writeReport', data);
            }
            catch (e) {
                logger_1.log.error('*** USBController.writeReport hid.write catch:&d', data);
                this.close();
            }
        }
    };
    return USBDevice;
}());
exports.USBDevice = USBDevice;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdXNiLWRldmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLHVCQUEwQjtBQUMxQixvQ0FBZ0M7QUFDaEMsdUNBQWdEO0FBZWhEO0lBY0ksbUJBQVksR0FBWSxFQUFFLFFBQXFCO1FBUnZDLGtCQUFhLEdBQVcsSUFBSyxDQUFDO1FBRzlCLG9CQUFlLEdBQUcsQ0FBQyxHQUFDLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDdkMsc0JBQWlCLEdBQUcsS0FBSyxDQUFDO1FBSzlCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDaEQsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUMxQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUssR0FBRyxDQUFDLEdBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztTQUN2RDtRQUNELG1CQUFRLENBQUMsUUFBUSxDQUFDLG1CQUFRLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyx1Q0FBbUIsR0FBM0IsVUFBNEIsT0FBZ0I7UUFDeEMsSUFBTSxZQUFZLEdBQVUsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUMxQyxJQUFNLFVBQVUsR0FBRyxDQUFDLEdBQUMsQ0FBQyxZQUFZLEdBQUMsSUFBSyxDQUFDLENBQUM7UUFFMUMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLFlBQVksQ0FBQztZQUNsQyxZQUFHLENBQUMs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QUFDLE9BQU8sQ0FBQyxFQUFFO1lBRVIsT0FBTztTQUNWO0lBQ0wsQ0FBQztJQUNPLDhCQUFVLEdBQWxCLFVBQW1CLE1BQVc7UUFDMUIsWUFBRyxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUdPLCtCQUFXLEdBQW5CLFVBQW9CLElBQWM7UUFFOUIsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLEtBQUssT0FBTyxFQUFFO1lBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkI7UUFHRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3hCLElBQUk7Z0JBQ0EsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3JCLFlBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEQ7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDUixZQUFHLENBQUMsS0FBSyxDQUFDLGtEQUFrRCxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNwRSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDaEI7U0FFSjtJQUNMLENBQUM7SUFDTCxnQkFBQztBQUFELENBMUhBLEFBMEhDLElBQUE7QUExSFksOEJBQVMiLCJmaWxlIjoibW9kZWxzL3VzYi1kZXZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IEhJRCA9IHJlcXVpcmUoJ25vZGUtaGlkJyk7XHJcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJyk7XHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4uL2xvZ2dlcic7XHJcbmltcG9ydCB7IFNldHRpbmcsIFNldHRpbmdzICB9IGZyb20gJy4vc2V0dGluZ3MnO1xyXG5cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVVNCQ29uZmlnIGV4dGVuZHMgSElELkRldmljZSB7XHJcblxyXG59XHJcblxyXG4vLyBSZXBvcnRQYXJzZXIgYWxsb3cgVVNCQ29udHJvbGxlciB0byBiZSBpbmRlcGVuZGVudCBvbiB0aGUgc3BlY2lmaWNcclxuLy8gVGVtcGVyIGRldmljZSBjb25uZWN0ZWQuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVVNCUmVwb3J0ZXIge1xyXG4gICAgaW5pdFdyaXRlUmVwb3J0KCk6IG51bWJlcltdW107XHJcbiAgICByZWFkUmVwb3J0KGRhdGE6IG51bWJlcltdKTogbnVtYmVyW107XHJcbiAgICBtYXhTYW1wbGVSYXRlKCk6IG51bWJlcjtcclxufVxyXG4vLyBIYW5kbGUgYSBzZW5zb3IgZGV2aWNlIG9uIHRoZSBVU0IgaHViLlxyXG5leHBvcnQgY2xhc3MgVVNCRGV2aWNlIHtcclxuICAgIHByaXZhdGUgIGhpZDogSElELkhJRDtcclxuXHJcbiAgICBwcml2YXRlIHJlcG9ydGVyOiBVU0JSZXBvcnRlcjtcclxuXHJcblxyXG4gICAgcHJpdmF0ZSBQT0xMX0lOVEVSVkFMOiBudW1iZXIgPSA1XzAwMDtcclxuXHJcbiAgICAvLyBwcml2YXRlIFBPTExfSU5URVJWQUw6IG51bWJlciA9IFNldHRpbmdzLmdldCgnUE9MTF9JTlRFUlZBTCcpLnZhbHVlIHwgNTAwMDtcclxuICAgIHByaXZhdGUgTUFYX1NBTVBMRV9SQVRFID0gMS90aGlzLlBPTExfSU5URVJWQUw7XHJcbiAgICBwcml2YXRlIGRldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcblxyXG4gICAgcHJpdmF0ZSB0aW1lcjogTm9kZUpTLlRpbWVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGhpZDogSElELkhJRCwgcmVwb3J0ZXI6IFVTQlJlcG9ydGVyKSB7XHJcbiAgICAgICAgdGhpcy5oaWQgPSBoaWQ7XHJcbiAgICAgICAgdGhpcy5yZXBvcnRlciA9IHJlcG9ydGVyO1xyXG4gICAgICAgIHRoaXMuTUFYX1NBTVBMRV9SQVRFID0gcmVwb3J0ZXIubWF4U2FtcGxlUmF0ZSgpO1xyXG4gICAgICAgIGlmICh0aGlzLnNhbXBsZVJhdGUoKSA+IHRoaXMuTUFYX1NBTVBMRV9SQVRFKSB7XHJcbiAgICAgICAgICAgIHRoaXMuUE9MTF9JTlRFUlZBTCA9IDFfMDAwICogMS90aGlzLk1BWF9TQU1QTEVfUkFURTtcclxuICAgICAgICB9XHJcbiAgICAgICAgU2V0dGluZ3Mub25DaGFuZ2UoU2V0dGluZ3MuUE9MTF9JTlRFUlZBTCwgdGhpcy5wb2xsSW50ZXJ2YWxDaGFuZ2VkLmJpbmQodGhpcykpO1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xyXG4gICAgICAgIHRoaXMucG9sbFNlbnNvcnMoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHBvbGxJbnRlcnZhbENoYW5nZWQoc2V0dGluZzogU2V0dGluZykge1xyXG4gICAgICAgIGNvbnN0IHBvbGxJbnRlcnZhbCA9PG51bWJlcj5zZXR0aW5nLnZhbHVlO1xyXG4gICAgICAgIGNvbnN0IHNhbXBsZVJhdGUgPSAxLyhwb2xsSW50ZXJ2YWwvMV8wMDApO1xyXG5cclxuICAgICAgICBpZiAoc2FtcGxlUmF0ZSA8IHRoaXMuTUFYX1NBTVBMRV9SQVRFKSB7XHJcbiAgICAgICAgICAgIHRoaXMuUE9MTF9JTlRFUlZBTCA9IHBvbGxJbnRlcnZhbDtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ1VTQkRldmljZS5wb2xsSW50ZXJ2YWxDaGFuZ2VkIHRvJyArIHBvbGxJbnRlcnZhbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHVibGljIGluaXRpYWxpemUoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRldmljZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkLm9uKCdkYXRhJywgdGhpcy5wYXJzZUlucHV0LmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZC5vbignZXJyb3InLCB0aGlzLnBhcnNlRXJyb3IuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UG9sbGluZ0ludGVydmFsKHRoaXMuUE9MTF9JTlRFUlZBTCk7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnVVNCRGV2aWNlLmluaXRpYWxpemVEZXZpY2UgUE9MTElORyBJTlRFUlZBTD0nICsgdGhpcy5QT0xMX0lOVEVSVkFMKTtcclxuICAgICAgICAgICAgdGhpcy5kZXZpY2VJbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKCdVU0JEZXZpY2UuaW5pdGlhbGl6ZURldmljZSBkb25lJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbG9zZSgpIHtcclxuICAgICAgICB0aGlzLmRldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5oaWQucGF1c2UoKTtcclxuICAgICAgICAgICAgdGhpcy5oaWQuY2xvc2UoKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzYW1wbGVSYXRlKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIDEvKHRoaXMuUE9MTF9JTlRFUlZBTC8xXzAwMCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldFBvbGxpbmdJbnRlcnZhbChtczogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5QT0xMX0lOVEVSVkFMID0gbXM7XHJcbiAgICAgICAgaWYgKHRoaXMuc2FtcGxlUmF0ZSgpID4gdGhpcy5NQVhfU0FNUExFX1JBVEUpIHtcclxuICAgICAgICAgICAgdGhpcy5QT0xMX0lOVEVSVkFMID0gMV8wMDAgKiAxL3RoaXMuTUFYX1NBTVBMRV9SQVRFO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjbGVhckludGVydmFsKHRoaXMudGltZXIpO1xyXG4gICAgICAgIHRoaXMudGltZXIgPSBzZXRJbnRlcnZhbCh0aGlzLnBvbGxTZW5zb3JzLmJpbmQodGhpcyksIHRoaXMuUE9MTF9JTlRFUlZBTCk7XHJcbiAgICAgICAgbG9nLmluZm8oJ1VTQkRldmljZS5zZXRQb2xsaW5nSW50ZXJ2YWw6ICcgKyBtcyArICdtcycpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRQb2xsaW5nSW50ZXJ2YWwoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5QT0xMX0lOVEVSVkFMO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRoaXMgaXMgd2VyZSBhbGwgc3RhcnRzIHdoZW4gc2V0IGludGVydmFsIHRpbWUgZXhwaXJlc1xyXG4gICAgcHJpdmF0ZSBwb2xsU2Vuc29ycygpIHtcclxuICAgICAgICBpZiAoISB0aGlzLmRldmljZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnKysrIFVTQkNvbnRyb2xsZXIucG9sbFNlbnNvcnMnKTtcclxuICAgICAgICAgICAgY29uc3QgaW5pdENvbW1hbmRzID0gdGhpcy5yZXBvcnRlci5pbml0V3JpdGVSZXBvcnQoKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBjb21tYW5kIG9mIGluaXRDb21tYW5kcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53cml0ZVJlcG9ydChjb21tYW5kKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIENhbGxlZCBmcm9tIEhJRCwgUGFyc2VzIGlucHV0IGZyb20gSElEIGFuZCB3cml0ZXMgYW55IHJlc3BvbnNlIG1lc3NhZ2VzXHJcbiAgICAvLyBiYWNrIHRvIHRoZSBkZXZpY2VcclxuICAgIHByaXZhdGUgcGFyc2VJbnB1dChkYXRhOiBudW1iZXJbXSk6IHZvaWQgIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMucmVwb3J0ZXIucmVhZFJlcG9ydChkYXRhKTtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMud3JpdGVSZXBvcnQocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAvLyBUT0RPIGVycm9yIGhhbmRsaW5nIGlmIHBhcnNlIGlucHV0IGVycm9yXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHBhcnNlRXJyb3IoX2Vycm9yOiBhbnkpIHtcclxuICAgICAgICBsb2cuZXJyb3IoJ3BhcnNlRXJyb3I6ICcsIF9lcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSGVscGVyIGZ1bmN0aW9ucyB0byB3cml0ZSByZXBvcnRzIHRvIHRoZSBkZXZpY2VcclxuICAgIHByaXZhdGUgd3JpdGVSZXBvcnQoZGF0YTogbnVtYmVyW10pOiB2b2lkIHtcclxuXHJcbiAgICAgICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09ICd3aW4zMicpIHtcclxuICAgICAgICAgICAgZGF0YS51bnNoaWZ0KDApOyAgLy8gcHJlcGVuZCBhIHRocm93YXdheSBieXRlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBPdXRwdXQgcmVwb3J0XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxOyBpKyspIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkLndyaXRlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCcrKysgVVNCQ29udHJvbGxlci53cml0ZVJlcG9ydCcsIGRhdGEpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBVU0JDb250cm9sbGVyLndyaXRlUmVwb3J0IGhpZC53cml0ZSBjYXRjaDomZCcsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=
