"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = require("axios");
var logger_1 = require("./../logger");
var SensorLog = (function () {
    function SensorLog(attr, state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 60000;
        logger_1.log.debug('--- SensorStateLogger:', JSON.stringify(state));
        this.timestamp = Date.now();
        this.logging = false;
        this.attr = attr;
        this.state = state;
        var dataFilter = {
            resolution: this.attr.resolution,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), dataFilter);
        this.axios = axios_1.default.create({
            baseURL: 'https://test.itemper.io/api/v1/sensors',
            headers: { 'Content-Type': 'application/json' },
        });
    }
    SensorLog.prototype.getAttr = function () {
        return this.attr;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.startLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.attr.SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ', url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' value: ' + JSON.stringify(sensorLog_1), ' ms: ', diff_1);
            })
                .catch(function (e) {
                logger_1.log.error('catch error', e);
            });
        }
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE2QztBQUs3QyxzQ0FBa0M7QUFFbEM7SUFTSSxtQkFBWSxJQUFzQixFQUFFLEtBQWtCO1FBUDlDLGNBQVMsR0FBVyxDQUFDLENBQUM7UUFHdEIsWUFBTyxHQUFZLEtBQUssQ0FBQztRQUN6QixrQkFBYSxHQUFHLEtBQU0sQ0FBQztRQUkzQixZQUFHLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFNLFVBQVUsR0FBRztZQUNmLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVU7WUFDaEMsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFbkYsSUFBSSxDQUFDLEtBQUssR0FBRyxlQUFLLENBQUMsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSx3Q0FBd0M7WUFDakQsT0FBTyxFQUFFLEVBQUMsY0FBYyxFQUFFLGtCQUFrQixFQUFDO1NBQzlDLENBQUMsQ0FBQztJQUNULENBQUM7SUFFTSwyQkFBTyxHQUFkO1FBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUNNLDRCQUFRLEdBQWY7UUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBQ00sZ0NBQVksR0FBbkI7UUFDSSxZQUFHLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVNLCtCQUFXLEdBQWxCO1FBQ0ksWUFBRyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ3pCLENBQUM7SUFFTyx3Q0FBb0IsR0FBNUIsVUFBNkIsSUFBZ0I7UUFDekMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDZixJQUFNLEtBQUssR0FBRyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFDLENBQUM7WUFDeEQsSUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBQyxDQUFDLENBQUM7WUFDbkUsSUFBTSxXQUFTLEdBQUcsRUFBRSxLQUFLLE9BQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxDQUFDO1lBQ3JDLElBQU0sTUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRWxDLElBQU0sS0FBRyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRSxLQUFLLENBQUMsSUFBSSxDQUFDO1lBQzdDLFlBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEtBQUcsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUcsRUFBRSxXQUFTLENBQUM7aUJBQzlCLElBQUksQ0FBRSxVQUFTLEdBQUc7Z0JBQ2YsWUFBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsR0FBRyxLQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxVQUFVO29CQUM1RCxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBSSxDQUFDLENBQUM7WUFDL0QsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxVQUFTLENBQUM7Z0JBQ2IsWUFBRyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBQ0wsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0FoRUEsQUFnRUMsSUFBQTtBQWhFWSw4QkFBUyIsImZpbGUiOiJtb2RlbHMvc2Vuc29yLWxvZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcywgeyBBeGlvc0luc3RhbmNlIH0gZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBTZW5zb3JBdHRyaWJ1dGVzIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1hdHRyaWJ1dGVzJztcclxuaW1wb3J0IHsgU2Vuc29yRGF0YSB9IGZyb20gJy4uL21vZGVscy9zZW5zb3ItZGF0YSc7XHJcbmltcG9ydCB7IFNlbnNvclN0YXRlIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1zdGF0ZSc7XHJcblxyXG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLy4uL2xvZ2dlcic7XHJcblxyXG5leHBvcnQgY2xhc3MgU2Vuc29yTG9nIHtcclxuICAgIHByaXZhdGUgYXR0cjogU2Vuc29yQXR0cmlidXRlcztcclxuICAgIHByaXZhdGUgdGltZXN0YW1wOiBudW1iZXIgPSAwO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU2Vuc29yU3RhdGU7XHJcblxyXG4gICAgcHJpdmF0ZSBsb2dnaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIE1BWF9USU1FX0RJRkYgPSA2MF8wMDA7XHJcbiAgICBwcml2YXRlIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGF0dHI6IFNlbnNvckF0dHJpYnV0ZXMsIHN0YXRlOiBTZW5zb3JTdGF0ZSkge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyOicsIEpTT04uc3RyaW5naWZ5KHN0YXRlKSk7XHJcbiAgICAgICAgdGhpcy50aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRoaXMubG9nZ2luZyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuYXR0ciA9IGF0dHI7XHJcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xyXG5cclxuICAgICAgICBjb25zdCBkYXRhRmlsdGVyID0ge1xyXG4gICAgICAgICAgICByZXNvbHV0aW9uOiB0aGlzLmF0dHIucmVzb2x1dGlvbixcclxuICAgICAgICAgICAgbWF4VGltZURpZmY6IHRoaXMuTUFYX1RJTUVfRElGRn07XHJcblxyXG4gICAgICAgIHRoaXMuc3RhdGUuYWRkU2Vuc29yRGF0YUxpc3RlbmVyKHRoaXMub25TZW5zb3JEYXRhUmVjZWl2ZWQuYmluZCh0aGlzKSwgZGF0YUZpbHRlcik7XHJcblxyXG4gICAgICAgIHRoaXMuYXhpb3MgPSBheGlvcy5jcmVhdGUoe1xyXG4gICAgICAgICAgICBiYXNlVVJMOiAnaHR0cHM6Ly90ZXN0Lml0ZW1wZXIuaW8vYXBpL3YxL3NlbnNvcnMnLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30sXHJcbiAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXR0cigpOiBTZW5zb3JBdHRyaWJ1dGVzIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hdHRyO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGdldFN0YXRlKCk6IFNlbnNvclN0YXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBzdGFydExvZ2dpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RhcnRMb2dnaW5nJyk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RvcExvZ2dpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RvcExvZ2dpbmcnKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uU2Vuc29yRGF0YVJlY2VpdmVkKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2dnaW5nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlc2NyID0geyBTTjogdGhpcy5hdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gZGF0YS50aW1lc3RhbXAoKSAtIHRoaXMudGltZXN0YW1wO1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IGRhdGEudGltZXN0YW1wKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSAnLycgKyBkZXNjci5TTiArICcvJysgZGVzY3IucG9ydDtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdVUkw6ICcsIHVybCk7XHJcbiAgICAgICAgICAgIHRoaXMuYXhpb3MucG9zdCh1cmwsIHNlbnNvckxvZylcclxuICAgICAgICAgICAgLnRoZW4gKGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZ2dlciBheGlvcy5wb3N0ICcgKyB1cmwgKyAnICcgKyByZXMuc3RhdHVzVGV4dCArXHJcbiAgICAgICAgICAgICAgICAgICAgJyB2YWx1ZTogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZyksICcgbXM6ICcsIGRpZmYpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKCdjYXRjaCBlcnJvcicsIGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19
