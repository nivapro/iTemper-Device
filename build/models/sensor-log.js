"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = __importDefault(require("axios"));
var config_1 = require("./../config");
var logger_1 = require("./../logger");
var isomorphic_ws_1 = __importDefault(require("isomorphic-ws"));
var SensorLog = (function () {
    function SensorLog(state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 5 * 60000;
        this.dataFilter = {
            resolution: 1,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        logger_1.log.debug('SensorLog: SensorStateLogger, state:', JSON.stringify(state));
        this.timestamp = Date.now();
        this.logging = false;
        this.state = state;
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), this.dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this));
        this.axios = axios_1.default.create({
            baseURL: config_1.ITEMPER_URL,
            headers: { 'Content-Type': 'application/json' },
        });
        this.socket = this.openSocket();
    }
    SensorLog.prototype.openSocket = function () {
        var wsTestUrl = config_1.WS_URL + '';
        var socket = new isomorphic_ws_1.default(wsTestUrl, { origin: config_1.WS_ORIGIN });
        socket.on('open', function () {
            logger_1.log.info('SensorLog: socket.on(open): Device.SensorLog connected to backend!');
        });
        socket.on('message', function (data) {
            logger_1.log.info('SensorLog: socket.on(message): received from back-end' + JSON.stringify(data));
        });
        socket.on('message', function (data) {
            logger_1.log.info('SensorLog: socket.on(message): received from back-end' + JSON.stringify(data));
        });
        socket.on('error', function () {
            logger_1.log.info('SensorLog: socket.on(error): ');
        });
        return socket;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.getFilter = function () {
        return this.dataFilter;
    };
    SensorLog.prototype.islogging = function () {
        return this.logging;
    };
    SensorLog.prototype.startLogging = function (filter) {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        if (filter) {
            this.dataFilter = filter;
        }
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.state.getAttr().SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ' + url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toLocaleString());
            })
                .catch(function () {
                logger_1.log.info('onSensorDataReceived axios.post catch error');
            });
        }
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var descr = { SN: this.state.getAttr().SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { descr: descr, samples: samples };
        if (this.socket && this.socket.readyState === isomorphic_ws_1.default.OPEN) {
            logger_1.log.debug('onMonitor: sensor log: ' + JSON.stringify(sensorLog));
            this.socket.send(JSON.stringify(sensorLog));
            logger_1.log.debug('onMonitor: sensor log sent');
        }
        else if (!this.socket || this.socket.readyState === isomorphic_ws_1.default.CLOSED) {
            logger_1.log.debug('onMonitor: socket closed, re-open');
            this.socket = this.openSocket();
        }
        else {
            logger_1.log.debug('onMonitor: socket not open yet');
        }
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGdEQUE2QztBQUc3QyxzQ0FBNkQ7QUFFN0Qsc0NBQWtDO0FBRWxDLGdFQUFzQztBQWN0QztJQXlDSSxtQkFBWSxLQUFrQjtRQXRDdEIsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLGtCQUFhLEdBQUcsQ0FBQyxHQUFDLEtBQU0sQ0FBQztRQUN6QixlQUFVLEdBQWdCO1lBQzlCLFVBQVUsRUFBRSxDQUFDO1lBQ2IsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQWtDakMsWUFBRyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDekUsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4RixJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFNUQsSUFBSSxDQUFDLEtBQUssR0FBRyxlQUFLLENBQUMsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxvQkFBVztZQUNwQixPQUFPLEVBQUUsRUFBQyxjQUFjLEVBQUUsa0JBQWtCLEVBQUM7U0FDOUMsQ0FBQyxDQUFDO1FBRUwsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFLcEMsQ0FBQztJQXpDTyw4QkFBVSxHQUFsQjtRQUVJLElBQU0sU0FBUyxHQUFHLGVBQU0sR0FBRyxFQUFFLENBQUM7UUFDOUIsSUFBTSxNQUFNLEdBQUcsSUFBSSx1QkFBUyxDQUFFLFNBQVMsRUFBRSxFQUFFLE1BQU0sRUFBRSxrQkFBUyxFQUFDLENBQUMsQ0FBQztRQUUvRCxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRTtZQUNkLFlBQUcsQ0FBQyxJQUFJLENBQUMsb0VBQW9FLENBQUMsQ0FBQztRQUNuRixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLFVBQUMsSUFBb0I7WUFDdEMsWUFBRyxDQUFDLElBQUksQ0FBQyx1REFBdUQsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0YsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFDLElBQW9CO1lBQ3RDLFlBQUcsQ0FBQyxJQUFJLENBQUMsdURBQXVELEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzdGLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUU7WUFDZixZQUFHLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBdUJNLDRCQUFRLEdBQWY7UUFDSSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUVNLDZCQUFTLEdBQWhCO1FBQ0ksT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQzNCLENBQUM7SUFDTSw2QkFBUyxHQUFoQjtRQUNJLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBQ00sZ0NBQVksR0FBbkIsVUFBb0IsTUFBcUI7UUFDckMsWUFBRyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1FBQ2hELElBQUksTUFBTSxFQUFFO1lBQ1IsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUM7U0FDNUI7UUFFRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDO0lBRU0sK0JBQVcsR0FBbEI7UUFDSSxZQUFHLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDekIsQ0FBQztJQWNPLHdDQUFvQixHQUE1QixVQUE2QixJQUFnQjtRQUN6QyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDZCxJQUFNLEtBQUssR0FBRyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFDLENBQUM7WUFDbkUsSUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBQyxDQUFDLENBQUM7WUFDbkUsSUFBTSxXQUFTLEdBQUcsRUFBRSxLQUFLLE9BQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxDQUFDO1lBQ3JDLElBQU0sTUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRWxDLElBQU0sS0FBRyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRSxLQUFLLENBQUMsSUFBSSxDQUFDO1lBQzdDLFlBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEtBQUcsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUcsRUFBRSxXQUFTLENBQUM7aUJBQzlCLElBQUksQ0FBRSxVQUFTLEdBQUc7Z0JBQ2YsWUFBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsR0FBRyxLQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxVQUFVO29CQUM1RCxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFTLENBQUMsR0FBRyxPQUFPLEdBQUcsTUFBSTtvQkFDMUQsU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7WUFDakUsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQztnQkFDSCxZQUFHLENBQUMsSUFBSSxDQUFDLDZDQUE2QyxDQUFDLENBQUM7WUFDNUQsQ0FBQyxDQUFDLENBQUM7U0FLTjtJQUNMLENBQUM7SUFFTyw2QkFBUyxHQUFqQixVQUFrQixJQUFnQjtRQUM5QixZQUFHLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDakMsSUFBTSxLQUFLLEdBQUcsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBQyxDQUFDO1FBQ25FLElBQU0sT0FBTyxHQUFHLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUMsQ0FBQyxDQUFDO1FBQ25FLElBQU0sU0FBUyxHQUFHLEVBQUUsS0FBSyxPQUFBLEVBQUUsT0FBTyxTQUFBLEVBQUUsQ0FBQztRQUNyQyxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEtBQUssdUJBQVMsQ0FBQyxJQUFJLEVBQUU7WUFDMUQsWUFBRyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDakUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzVDLFlBQUcsQ0FBQyxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztTQUMzQzthQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxLQUFLLHVCQUFTLENBQUMsTUFBTSxFQUFFO1lBQ3BFLFlBQUcsQ0FBQyxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztZQUMvQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNuQzthQUFNO1lBQ0gsWUFBRyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1NBQy9DO0lBQ0wsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0E1SUEsQUE0SUMsSUFBQTtBQTVJWSw4QkFBUyIsImZpbGUiOiJtb2RlbHMvc2Vuc29yLWxvZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcywgeyBBeGlvc0luc3RhbmNlIH0gZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBTZW5zb3JEYXRhIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1kYXRhJztcclxuaW1wb3J0IHsgRmlsdGVyQ29uZmlnLCBTZW5zb3JTdGF0ZSB9IGZyb20gJy4uL21vZGVscy9zZW5zb3Itc3RhdGUnO1xyXG5pbXBvcnQgeyBJVEVNUEVSX1VSTCwgV1NfT1JJR0lOLCBXU19VUkwgfSBmcm9tICcuLy4uL2NvbmZpZyc7XHJcbi8vIGltcG9ydCB7IEFaVVJFX0NPTk5FQ1RJT05fU1RSSU5HLCBJVEVNUEVSX1VSTCwgV1NfT1JJR0lOLCBXU19VUkwgfSBmcm9tICcuLy4uL2NvbmZpZyc7XHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vLi4vbG9nZ2VyJztcclxuXHJcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnaXNvbW9ycGhpYy13cyc7XHJcblxyXG4vLyBJbXBvcnQgQXp1cmVcclxuXHJcbi8vIGltcG9ydCB7IENsaWVudCwgTWVzc2FnZSB9IGZyb20gJ2F6dXJlLWlvdC1kZXZpY2UnO1xyXG4vLyBpbXBvcnQgeyBNcXR0IH0gZnJvbSAnYXp1cmUtaW90LWRldmljZS1tcXR0JztcclxuXHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTZW5zb3JMb2dEYXRhIHtcclxuICAgIGRlc2NyOiB7IFNOOiBzdHJpbmcsIHBvcnQ6IG51bWJlcn07XHJcbiAgICBzYW1wbGVzOiBTZW5zb3JEYXRhW107XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBTZW5zb3JMb2cge1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU2Vuc29yU3RhdGU7XHJcblxyXG4gICAgcHJpdmF0ZSB0aW1lc3RhbXA6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIGxvZ2dpbmc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgTUFYX1RJTUVfRElGRiA9IDUqNjBfMDAwO1xyXG4gICAgcHJpdmF0ZSBkYXRhRmlsdGVyOiBGaWx0ZXJDb25maWc9IHtcclxuICAgICAgICByZXNvbHV0aW9uOiAxLFxyXG4gICAgICAgIG1heFRpbWVEaWZmOiB0aGlzLk1BWF9USU1FX0RJRkZ9O1xyXG5cclxuICAgIHByaXZhdGUgYXhpb3M6IEF4aW9zSW5zdGFuY2U7XHJcblxyXG4gICAgcHJpdmF0ZSBzb2NrZXQ6IFdlYlNvY2tldDtcclxuXHJcbiAgICAvLyBBenVyZSBJT1RcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcclxuICAgIC8vIHByaXZhdGUgY29ubmVjdGlvblN0cmluZzogc3RyaW5nID0gJyc7XHJcbiAgICAvLyBwcml2YXRlIGNsaWVudDogQ2xpZW50O1xyXG5cclxuICAgIHByaXZhdGUgb3BlblNvY2tldCgpOiBXZWJTb2NrZXQge1xyXG4gICAgICAgIC8vIGNvbnN0IHdzVGVzdFVybCA9ICd3c3M6Ly90ZXN0Lml0ZW1wZXIuaW8vd3MnO1xyXG4gICAgICAgIGNvbnN0IHdzVGVzdFVybCA9IFdTX1VSTCArICcnO1xyXG4gICAgICAgIGNvbnN0IHNvY2tldCA9IG5ldyBXZWJTb2NrZXQgKHdzVGVzdFVybCwgeyBvcmlnaW46IFdTX09SSUdJTn0pO1xyXG5cclxuICAgICAgICBzb2NrZXQub24oJ29wZW4nLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKCdTZW5zb3JMb2c6IHNvY2tldC5vbihvcGVuKTogRGV2aWNlLlNlbnNvckxvZyBjb25uZWN0ZWQgdG8gYmFja2VuZCEnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzb2NrZXQub24oJ21lc3NhZ2UnLCAoZGF0YTogV2ViU29ja2V0LkRhdGEpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZzogc29ja2V0Lm9uKG1lc3NhZ2UpOiByZWNlaXZlZCBmcm9tIGJhY2stZW5kJyArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzb2NrZXQub24oJ21lc3NhZ2UnLCAoZGF0YTogV2ViU29ja2V0LkRhdGEpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZzogc29ja2V0Lm9uKG1lc3NhZ2UpOiByZWNlaXZlZCBmcm9tIGJhY2stZW5kJyArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgc29ja2V0Lm9uKCdlcnJvcicsICgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZzogc29ja2V0Lm9uKGVycm9yKTogJyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzb2NrZXQ7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3RydWN0b3Ioc3RhdGU6IFNlbnNvclN0YXRlKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2c6IFNlbnNvclN0YXRlTG9nZ2VyLCBzdGF0ZTonLCBKU09OLnN0cmluZ2lmeShzdGF0ZSkpO1xyXG4gICAgICAgIHRoaXMudGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGU7XHJcblxyXG4gICAgICAgIHRoaXMuc3RhdGUuYWRkU2Vuc29yRGF0YUxpc3RlbmVyKHRoaXMub25TZW5zb3JEYXRhUmVjZWl2ZWQuYmluZCh0aGlzKSwgdGhpcy5kYXRhRmlsdGVyKTtcclxuICAgICAgICB0aGlzLnN0YXRlLmFkZFNlbnNvckRhdGFMaXN0ZW5lcih0aGlzLm9uTW9uaXRvci5iaW5kKHRoaXMpKTtcclxuXHJcbiAgICAgICAgdGhpcy5heGlvcyA9IGF4aW9zLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIGJhc2VVUkw6IElURU1QRVJfVVJMLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30sXHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5zb2NrZXQgPSB0aGlzLm9wZW5Tb2NrZXQoKTtcclxuXHJcbiAgICAgICAgLy8gQVpVUkUgSU9UXHJcbiAgICAgICAgLy8gdGhpcy5jb25uZWN0aW9uU3RyaW5nID0gQVpVUkVfQ09OTkVDVElPTl9TVFJJTkcgKyAnJztcclxuICAgICAgICAvLyB0aGlzLmNsaWVudCA9IENsaWVudC5mcm9tQ29ubmVjdGlvblN0cmluZyh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIE1xdHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRTdGF0ZSgpOiBTZW5zb3JTdGF0ZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEZpbHRlcigpOiBGaWx0ZXJDb25maWcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFGaWx0ZXI7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgaXNsb2dnaW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2dpbmc7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc3RhcnRMb2dnaW5nKGZpbHRlcj86IEZpbHRlckNvbmZpZyk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLnN0YXJ0TG9nZ2luZycpO1xyXG4gICAgICAgIGlmIChmaWx0ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhRmlsdGVyID0gZmlsdGVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RvcExvZ2dpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RvcExvZ2dpbmcnKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQcmludCBBWlVSRSBJT1QgcmVzdWx0cy5cclxuLy8gICAgIHByaXZhdGUgcHJpbnRSZXN1bHRGb3Iob3A6IHN0cmluZyk6IGFueSB7XHJcbi8vICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHByaW50UmVzdWx0KGVycjogYW55LCByZXM6IGFueSkge1xyXG4vLyAgICAgICAgIGlmIChlcnIpIHtcclxuLy8gICAgICAgICAgICAgbG9nLmVycm9yKG9wICsgJyBBWlVSRSBJT1QgZXJyb3I6ICcgKyBlcnIudG9TdHJpbmcoKSk7XHJcbi8vICAgICAgICAgfVxyXG4vLyAgICAgICAgIGlmIChyZXMpIHtcclxuLy8gICAgICAgICAgICAgbG9nLmluZm8ob3AgKyAnIEFaVVJFIElPVCBzdGF0dXM6ICcgKyByZXMuY29uc3RydWN0b3IubmFtZSk7XHJcbi8vICAgICAgICAgfVxyXG4vLyAgICAgfTtcclxuLy8gICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvblNlbnNvckRhdGFSZWNlaXZlZChkYXRhOiBTZW5zb3JEYXRhKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMubG9nZ2luZykge1xyXG4gICAgICAgICAgICBjb25zdCBkZXNjciA9IHsgU046IHRoaXMuc3RhdGUuZ2V0QXR0cigpLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gZGF0YS50aW1lc3RhbXAoKSAtIHRoaXMudGltZXN0YW1wO1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IGRhdGEudGltZXN0YW1wKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSAnLycgKyBkZXNjci5TTiArICcvJysgZGVzY3IucG9ydDtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdVUkw6ICcgKyB1cmwpO1xyXG4gICAgICAgICAgICB0aGlzLmF4aW9zLnBvc3QodXJsLCBzZW5zb3JMb2cpXHJcbiAgICAgICAgICAgIC50aGVuIChmdW5jdGlvbihyZXMpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTZW5zb3JMb2dnZXIgYXhpb3MucG9zdCAnICsgdXJsICsgJyAnICsgcmVzLnN0YXR1c1RleHQgK1xyXG4gICAgICAgICAgICAgICAgICAgICcgcmVzLmRhdGE6ICcgKyBKU09OLnN0cmluZ2lmeShzZW5zb3JMb2cpICsgJyBtczogJyArIGRpZmYgK1xyXG4gICAgICAgICAgICAgICAgICAgICcgZGF0ZTogJyArIG5ldyBEYXRlKGRhdGEudGltZXN0YW1wKCkpLnRvTG9jYWxlU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuaW5mbygnb25TZW5zb3JEYXRhUmVjZWl2ZWQgYXhpb3MucG9zdCBjYXRjaCBlcnJvcicpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gQVpVUkUgSU9UXHJcbiAgICAgICAgICAgIC8vIGNvbnN0IG1lc3NhZ2UgPSBuZXcgTWVzc2FnZShKU09OLnN0cmluZ2lmeShzZW5zb3JMb2cpKTtcclxuICAgICAgICAgICAgLy8gbWVzc2FnZS5wcm9wZXJ0aWVzLmFkZCgnRGVsdGEgdGltZScsIGRpZmYudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIC8vIHRoaXMuY2xpZW50LnNlbmRFdmVudChtZXNzYWdlLCB0aGlzLnByaW50UmVzdWx0Rm9yKCdzZW5kJykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uTW9uaXRvcihkYXRhOiBTZW5zb3JEYXRhKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cub25Nb25pdG9yJyk7XHJcbiAgICAgICAgY29uc3QgZGVzY3IgPSB7IFNOOiB0aGlzLnN0YXRlLmdldEF0dHIoKS5TTiwgcG9ydDogZGF0YS5nZXRQb3J0KCl9O1xyXG4gICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICBjb25zdCBzZW5zb3JMb2cgPSB7IGRlc2NyLCBzYW1wbGVzIH07XHJcbiAgICAgICAgaWYgKHRoaXMuc29ja2V0ICYmIHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1Zygnb25Nb25pdG9yOiBzZW5zb3IgbG9nOiAnICsgSlNPTi5zdHJpbmdpZnkoc2Vuc29yTG9nKSk7XHJcbiAgICAgICAgICAgIHRoaXMuc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoc2Vuc29yTG9nKSk7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1Zygnb25Nb25pdG9yOiBzZW5zb3IgbG9nIHNlbnQnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnNvY2tldCB8fCB0aGlzLnNvY2tldC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0VEKSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1Zygnb25Nb25pdG9yOiBzb2NrZXQgY2xvc2VkLCByZS1vcGVuJyk7XHJcbiAgICAgICAgICAgIHRoaXMuc29ja2V0ID0gdGhpcy5vcGVuU29ja2V0KCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdvbk1vbml0b3I6IHNvY2tldCBub3Qgb3BlbiB5ZXQnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19
