"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = require("axios");
var logger_1 = require("./../logger");
var Websocket = require("isomorphic-ws");
var azure_iot_device_1 = require("azure-iot-device");
var azure_iot_device_mqtt_1 = require("azure-iot-device-mqtt");
var SensorLog = (function () {
    function SensorLog(attr, state) {
        var _this = this;
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 5 * 60000;
        this.dataFilter = {
            resolution: 1,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.open = false;
        this.connectionString = '';
        logger_1.log.debug('--- SensorStateLogger, state:', state);
        logger_1.log.debug('--- SensorStateLogger, attr:', attr);
        this.timestamp = Date.now();
        this.logging = false;
        this.attr = attr;
        this.state = state;
        if (this.open) {
            this.open = true;
        }
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), this.dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this));
        this.axios = axios_1.default.create({
            baseURL: 'https://test.itemper.io/api/v1/sensors',
            headers: { 'Content-Type': 'application/json' },
        });
        var wsTestUrl = 'wss://test.itemper.io/ws';
        var wsOrigin = 'https://itemper.io';
        this.socket = new Websocket(wsTestUrl, { origin: wsOrigin });
        var self = this;
        this.socket.on('open', function (ws) {
            self.open = true;
            _this.socket = ws;
            logger_1.log.info('--- socket.on: Device.SensorLog connected to backend!');
        });
        this.socket.on('message', function (data) {
            logger_1.log.info('--- socket.on: message received from back-end' + JSON.stringify(data));
        });
        this.socket.on('error', function (ws, err) {
            logger_1.log.error('--- socket.on: error' + JSON.stringify(err));
            ws.close();
        });
        this.connectionString = 'HostName=iothubiotlabs.azure-devices.net;DeviceId=twilight-sound-798cd80;' +
            'SharedAccessKey=7jobimPqYZEFvfsjSYZMmRjkk7xIs6cs721AIRYHpMU=';
        this.client = azure_iot_device_1.Client.fromConnectionString(this.connectionString, azure_iot_device_mqtt_1.Mqtt);
    }
    SensorLog.prototype.getAttr = function () {
        return this.attr;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.getFilter = function () {
        return this.dataFilter;
    };
    SensorLog.prototype.islogging = function () {
        return this.logging;
    };
    SensorLog.prototype.startLogging = function (filter) {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        if (filter) {
            this.dataFilter = filter;
        }
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.printResultFor = function (op) {
        return function printResult(err, res) {
            if (err) {
                logger_1.log.error(op + ' AZURE IOT error: ' + err.toString());
            }
            if (res) {
                logger_1.log.info(op + ' AZURE IOT status: ' + res.constructor.name);
            }
        };
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.attr.SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ', url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toLocaleString());
            })
                .catch(function () {
                logger_1.log.error('onSensorDataReceived axios.post catch error');
            });
            var message = new azure_iot_device_1.Message(JSON.stringify(sensorLog_1));
            message.properties.add('Delta time', diff_1.toString());
            this.client.sendEvent(message, this.printResultFor('send'));
        }
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var descr = { SN: this.attr.SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { descr: descr, samples: samples };
        if (this.socket.OPEN) {
            this.socket.send(sensorLog);
            logger_1.log.debug('onMonitor: sent sensor log');
        }
        else {
            logger_1.log.debug('onMonitor: socket not open');
        }
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE2QztBQUs3QyxzQ0FBa0M7QUFFbEMseUNBQTJDO0FBSTNDLHFEQUFtRDtBQUNuRCwrREFBNkM7QUFPN0M7SUFzQkksbUJBQVksSUFBc0IsRUFBRSxLQUFrQjtRQUF0RCxpQkF5Q0M7UUEzRE8sY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLGtCQUFhLEdBQUcsQ0FBQyxHQUFDLEtBQU0sQ0FBQztRQUN6QixlQUFVLEdBQWdCO1lBQzlCLFVBQVUsRUFBRSxDQUFDO1lBQ2IsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQUs3QixTQUFJLEdBQVksS0FBSyxDQUFDO1FBSXRCLHFCQUFnQixHQUFXLEVBQUUsQ0FBQztRQUtsQyxZQUFHLENBQUMsS0FBSyxDQUFDLCtCQUErQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xELFlBQUcsQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1gsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDcEI7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3hGLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsSUFB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TTtZQUNILFlBQUcsQ0FBQyxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztTQUMzQztJQUNMLENBQUM7SUFDTCxnQkFBQztBQUFELENBOUlBLEFBOElDLElBQUE7QUE5SVksOEJBQVMiLCJmaWxlIjoibW9kZWxzL3NlbnNvci1sb2cuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MsIHsgQXhpb3NJbnN0YW5jZSB9IGZyb20gJ2F4aW9zJztcclxuaW1wb3J0IHsgU2Vuc29yQXR0cmlidXRlcyB9IGZyb20gJy4uL21vZGVscy9zZW5zb3ItYXR0cmlidXRlcyc7XHJcbmltcG9ydCB7IFNlbnNvckRhdGEgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLWRhdGEnO1xyXG5pbXBvcnQgeyBGaWx0ZXJDb25maWcsIFNlbnNvclN0YXRlIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1zdGF0ZSc7XHJcblxyXG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLy4uL2xvZ2dlcic7XHJcblxyXG5pbXBvcnQgKiBhcyBXZWJzb2NrZXQgZnJvbSAnaXNvbW9ycGhpYy13cyc7XHJcblxyXG4vLyBJbXBvcnQgQXp1cmVcclxuXHJcbmltcG9ydCB7IENsaWVudCwgTWVzc2FnZSB9IGZyb20gJ2F6dXJlLWlvdC1kZXZpY2UnO1xyXG5pbXBvcnQgeyBNcXR0IH0gZnJvbSAnYXp1cmUtaW90LWRldmljZS1tcXR0JztcclxuXHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBMb2dnaW5nU2VydmljZSB7XHJcblxyXG59XHJcbmV4cG9ydCBjbGFzcyBTZW5zb3JMb2cge1xyXG4gICAgcHJpdmF0ZSBhdHRyOiBTZW5zb3JBdHRyaWJ1dGVzO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU2Vuc29yU3RhdGU7XHJcblxyXG4gICAgcHJpdmF0ZSB0aW1lc3RhbXA6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIGxvZ2dpbmc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgTUFYX1RJTUVfRElGRiA9IDUqNjBfMDAwO1xyXG4gICAgcHJpdmF0ZSBkYXRhRmlsdGVyOiBGaWx0ZXJDb25maWc9IHtcclxuICAgICAgICByZXNvbHV0aW9uOiAxLFxyXG4gICAgICAgIG1heFRpbWVEaWZmOiB0aGlzLk1BWF9USU1FX0RJRkZ9O1xyXG5cclxuICAgICAgICBwcml2YXRlIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xyXG5cclxuICAgIHByaXZhdGUgc29ja2V0OiBXZWJzb2NrZXQ7XHJcbiAgICBwcml2YXRlIG9wZW46IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAvLyBBenVyZSBJT1RcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcclxuICAgIHByaXZhdGUgY29ubmVjdGlvblN0cmluZzogc3RyaW5nID0gJyc7XHJcbiAgICBwcml2YXRlIGNsaWVudDogQ2xpZW50O1xyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhdHRyOiBTZW5zb3JBdHRyaWJ1dGVzLCBzdGF0ZTogU2Vuc29yU3RhdGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoJy0tLSBTZW5zb3JTdGF0ZUxvZ2dlciwgc3RhdGU6Jywgc3RhdGUpO1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLCBhdHRyOicsIGF0dHIpO1xyXG4gICAgICAgIHRoaXMudGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmF0dHIgPSBhdHRyO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcclxuICAgICAgICBpZiAodGhpcy5vcGVuKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3BlbiA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3RhdGUuYWRkU2Vuc29yRGF0YUxpc3RlbmVyKHRoaXMub25TZW5zb3JEYXRhUmVjZWl2ZWQuYmluZCh0aGlzKSwgdGhpcy5kYXRhRmlsdGVyKTtcclxuICAgICAgICB0aGlzLnN0YXRlLmFkZFNlbnNvckRhdGFMaXN0ZW5lcih0aGlzLm9uTW9uaXRvci5iaW5kKHRoaXMpKTtcclxuXHJcbiAgICAgICAgdGhpcy5heGlvcyA9IGF4aW9zLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIGJhc2VVUkw6ICdodHRwczovL3Rlc3QuaXRlbXBlci5pby9hcGkvdjEvc2Vuc29ycycsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfSxcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCB3c1Rlc3RVcmwgPSAnd3NzOi8vdGVzdC5pdGVtcGVyLmlvL3dzJztcclxuICAgICAgICBjb25zdCB3c09yaWdpbiA9ICdodHRwczovL2l0ZW1wZXIuaW8nO1xyXG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV3IFdlYnNvY2tldCAod3NUZXN0VXJsLCB7IG9yaWdpbjogd3NPcmlnaW59KTtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ29wZW4nLCAod3M6IFdlYnNvY2tldCkgPT4ge1xyXG4gICAgICAgICAgICBzZWxmLm9wZW4gPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldCA9IHdzO1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnLS0tIHNvY2tldC5vbjogRGV2aWNlLlNlbnNvckxvZyBjb25uZWN0ZWQgdG8gYmFja2VuZCEnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNvY2tldC5vbignbWVzc2FnZScsIChkYXRhOiBXZWJzb2NrZXQuRGF0YSk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnLS0tIHNvY2tldC5vbjogbWVzc2FnZSByZWNlaXZlZCBmcm9tIGJhY2stZW5kJyArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKHdzOiBXZWJTb2NrZXQsIGVycjogRXJyb3IpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgbG9nLmVycm9yKCctLS0gc29ja2V0Lm9uOiBlcnJvcicgKyBKU09OLnN0cmluZ2lmeShlcnIpKTtcclxuICAgICAgICAgICAgd3MuY2xvc2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gQVpVUkUgSU9UXHJcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uU3RyaW5nID0gJ0hvc3ROYW1lPWlvdGh1YmlvdGxhYnMuYXp1cmUtZGV2aWNlcy5uZXQ7RGV2aWNlSWQ9dHdpbGlnaHQtc291bmQtNzk4Y2Q4MDsnICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnU2hhcmVkQWNjZXNzS2V5PTdqb2JpbVBxWVpFRnZmc2pTWVpNbVJqa2s3eElzNmNzNzIxQUlSWUhwTVU9JztcclxuICAgICAgICB0aGlzLmNsaWVudCA9IENsaWVudC5mcm9tQ29ubmVjdGlvblN0cmluZyh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIE1xdHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRBdHRyKCk6IFNlbnNvckF0dHJpYnV0ZXMge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmF0dHI7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgZ2V0U3RhdGUoKTogU2Vuc29yU3RhdGUge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRGaWx0ZXIoKTogRmlsdGVyQ29uZmlnIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhRmlsdGVyO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGlzbG9nZ2luZygpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5sb2dnaW5nO1xyXG4gICAgfVxyXG4gICAgcHVibGljIHN0YXJ0TG9nZ2luZyhmaWx0ZXI/OiBGaWx0ZXJDb25maWcpOiB2b2lkIHtcclxuICAgICAgICBsb2cuZGVidWcoJy0tLSBTZW5zb3JTdGF0ZUxvZ2dlci5zdGFydExvZ2dpbmcnKTtcclxuICAgICAgICBpZiAoZmlsdGVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YUZpbHRlciA9IGZpbHRlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubG9nZ2luZyA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0b3BMb2dnaW5nKCk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLnN0b3BMb2dnaW5nJyk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUHJpbnQgQVpVUkUgSU9UIHJlc3VsdHMuXHJcbiAgICBwcml2YXRlIHByaW50UmVzdWx0Rm9yKG9wOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiBwcmludFJlc3VsdChlcnI6IGFueSwgcmVzOiBhbnkpIHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGxvZy5lcnJvcihvcCArICcgQVpVUkUgSU9UIGVycm9yOiAnICsgZXJyLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKG9wICsgJyBBWlVSRSBJT1Qgc3RhdHVzOiAnICsgcmVzLmNvbnN0cnVjdG9yLm5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAgIHByaXZhdGUgb25TZW5zb3JEYXRhUmVjZWl2ZWQoZGF0YTogU2Vuc29yRGF0YSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmxvZ2dpbmcpIHtcclxuICAgICAgICAgICAgY29uc3QgZGVzY3IgPSB7IFNOOiB0aGlzLmF0dHIuU04sIHBvcnQ6IGRhdGEuZ2V0UG9ydCgpfTtcclxuICAgICAgICAgICAgY29uc3Qgc2FtcGxlcyA9IFt7ZGF0ZTogZGF0YS50aW1lc3RhbXAoKSwgdmFsdWU6IGRhdGEuZ2V0VmFsdWUoKX1dO1xyXG4gICAgICAgICAgICBjb25zdCBzZW5zb3JMb2cgPSB7IGRlc2NyLCBzYW1wbGVzIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBkYXRhLnRpbWVzdGFtcCgpIC0gdGhpcy50aW1lc3RhbXA7XHJcbiAgICAgICAgICAgIHRoaXMudGltZXN0YW1wID0gZGF0YS50aW1lc3RhbXAoKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHVybCA9ICcvJyArIGRlc2NyLlNOICsgJy8nKyBkZXNjci5wb3J0O1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ1VSTDogJywgdXJsKTtcclxuICAgICAgICAgICAgdGhpcy5heGlvcy5wb3N0KHVybCwgc2Vuc29yTG9nKVxyXG4gICAgICAgICAgICAudGhlbiAoZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuaW5mbygnU2Vuc29yTG9nZ2VyIGF4aW9zLnBvc3QgJyArIHVybCArICcgJyArIHJlcy5zdGF0dXNUZXh0ICtcclxuICAgICAgICAgICAgICAgICAgICAnIHJlcy5kYXRhOiAnICsgSlNPTi5zdHJpbmdpZnkoc2Vuc29yTG9nKSArICcgbXM6ICcgKyBkaWZmICtcclxuICAgICAgICAgICAgICAgICAgICAnIGRhdGU6ICcgKyBuZXcgRGF0ZShkYXRhLnRpbWVzdGFtcCgpKS50b0xvY2FsZVN0cmluZygpKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKCdvblNlbnNvckRhdGFSZWNlaXZlZCBheGlvcy5wb3N0IGNhdGNoIGVycm9yJyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyBBWlVSRSBJT1RcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IG5ldyBNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykpO1xyXG4gICAgICAgICAgICBtZXNzYWdlLnByb3BlcnRpZXMuYWRkKCdEZWx0YSB0aW1lJywgZGlmZi50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgdGhpcy5jbGllbnQuc2VuZEV2ZW50KG1lc3NhZ2UsIHRoaXMucHJpbnRSZXN1bHRGb3IoJ3NlbmQnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25Nb25pdG9yKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5vbk1vbml0b3InKTtcclxuICAgICAgICBjb25zdCBkZXNjciA9IHsgU046IHRoaXMuYXR0ci5TTiwgcG9ydDogZGF0YS5nZXRQb3J0KCl9O1xyXG4gICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICBjb25zdCBzZW5zb3JMb2cgPSB7IGRlc2NyLCBzYW1wbGVzIH07XHJcbiAgICAgICAgaWYgKHRoaXMuc29ja2V0Lk9QRU4pIHtcclxuICAgICAgICAgICAgdGhpcy5zb2NrZXQuc2VuZChzZW5zb3JMb2cpO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ29uTW9uaXRvcjogc2VudCBzZW5zb3IgbG9nJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdvbk1vbml0b3I6IHNvY2tldCBub3Qgb3BlbicpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=
