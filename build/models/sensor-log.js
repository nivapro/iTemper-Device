"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = require("axios");
var logger_1 = require("./../logger");
var Primus = require("primus");
var Socket = Primus.createSocket({ transformer: 'uws' });
var SensorLog = (function () {
    function SensorLog(attr, state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 5 * 60000;
        this.dataFilter = {
            resolution: this.attr.resolution,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.open = false;
        logger_1.log.debug('--- SensorStateLogger:', state);
        this.timestamp = Date.now();
        this.logging = false;
        this.attr = attr;
        this.state = state;
        if (this.open) {
            this.open = true;
        }
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), this.dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this));
        this.axios = axios_1.default.create({
            baseURL: 'https://test.itemper.io/api/v1/sensors',
            headers: { 'Content-Type': 'application/json' },
        });
        var wsTestUrl = 'ws://itemper.vading.lan:3000/primus';
        this.socket = new Socket(wsTestUrl);
        var self = this;
        this.socket.on('open', function () {
            self.open = true;
            logger_1.log.info('--- socket.on: Device.SensorLog connected to backend!');
        });
        this.socket.on('data', function (data) {
            logger_1.log.info('--- socket.on: Data received from back-end' + data);
        });
    }
    SensorLog.prototype.getAttr = function () {
        return this.attr;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.getFilter = function () {
        return this.dataFilter;
    };
    SensorLog.prototype.islogging = function () {
        return this.logging;
    };
    SensorLog.prototype.startLogging = function (filter) {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        if (filter) {
            this.dataFilter = filter;
        }
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.attr.SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ', url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toLocaleString());
            })
                .catch(function (e) {
                logger_1.log.error('catch error', e);
            });
        }
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var descr = { SN: this.attr.SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { descr: descr, samples: samples };
        this.socket.write(sensorLog);
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE2QztBQUs3QyxzQ0FBa0M7QUFFbEMsK0JBQWlDO0FBRWpDLElBQU0sTUFBTSxHQUFRLE1BQU0sQ0FBQyxZQUFZLENBQUcsRUFBQyxXQUFXLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztBQUloRTtJQWVJLG1CQUFZLElBQXNCLEVBQUUsS0FBa0I7UUFYOUMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLGtCQUFhLEdBQUcsQ0FBQyxHQUFDLEtBQU0sQ0FBQztRQUN6QixlQUFVLEdBQWdCO1lBQzlCLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVU7WUFDaEMsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQUk3QixTQUFJLEdBQVksS0FBSyxDQUFDO1FBRzFCLFlBQUcsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1gsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDcEI7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3hGLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENB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QUFHLENBQUMsVUFBVTtvQkFDNUQsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBUyxDQUFDLEdBQUcsT0FBTyxHQUFHLE1BQUk7b0JBQzFELFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1lBQ2pFLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsVUFBUyxDQUFDO2dCQUNiLFlBQUcsQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLENBQUMsQ0FBQyxDQUFDO1NBRU47SUFDTCxDQUFDO0lBRU8sNkJBQVMsR0FBakIsVUFBa0IsSUFBZ0I7UUFDOUIsWUFBRyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2pDLElBQU0sS0FBSyxHQUFHLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUMsQ0FBQztRQUN4RCxJQUFNLE9BQU8sR0FBRyxDQUFDLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFDLENBQUMsQ0FBQztRQUNuRSxJQUFNLFNBQVMsR0FBRyxFQUFFLEtBQUssT0FBQSxFQUFFLE9BQU8sU0FBQSxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0F0R0EsQUFzR0MsSUFBQTtBQXRHWSw4QkFBUyIsImZpbGUiOiJtb2RlbHMvc2Vuc29yLWxvZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcywgeyBBeGlvc0luc3RhbmNlIH0gZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBTZW5zb3JBdHRyaWJ1dGVzIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1hdHRyaWJ1dGVzJztcclxuaW1wb3J0IHsgU2Vuc29yRGF0YSB9IGZyb20gJy4uL21vZGVscy9zZW5zb3ItZGF0YSc7XHJcbmltcG9ydCB7IEZpbHRlckNvbmZpZywgU2Vuc29yU3RhdGUgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLXN0YXRlJztcclxuXHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vLi4vbG9nZ2VyJztcclxuXHJcbmltcG9ydCAqIGFzIFByaW11cyBmcm9tICdwcmltdXMnO1xyXG5cclxuY29uc3QgU29ja2V0OiBhbnkgPSBQcmltdXMuY3JlYXRlU29ja2V0ICgge3RyYW5zZm9ybWVyOiAndXdzJ30pO1xyXG5leHBvcnQgaW50ZXJmYWNlIExvZ2dpbmdTZXJ2aWNlIHtcclxuXHJcbn1cclxuZXhwb3J0IGNsYXNzIFNlbnNvckxvZyB7XHJcbiAgICBwcml2YXRlIGF0dHI6IFNlbnNvckF0dHJpYnV0ZXM7XHJcbiAgICBwcml2YXRlIHN0YXRlOiBTZW5zb3JTdGF0ZTtcclxuXHJcbiAgICBwcml2YXRlIHRpbWVzdGFtcDogbnVtYmVyID0gMDtcclxuICAgIHByaXZhdGUgbG9nZ2luZzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBNQVhfVElNRV9ESUZGID0gNSo2MF8wMDA7XHJcbiAgICBwcml2YXRlIGRhdGFGaWx0ZXI6IEZpbHRlckNvbmZpZz0ge1xyXG4gICAgICAgIHJlc29sdXRpb246IHRoaXMuYXR0ci5yZXNvbHV0aW9uLFxyXG4gICAgICAgIG1heFRpbWVEaWZmOiB0aGlzLk1BWF9USU1FX0RJRkZ9O1xyXG5cclxuICAgICAgICBwcml2YXRlIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xyXG4gICAgcHJpdmF0ZSBzb2NrZXQ6IGFueTtcclxuICAgIHByaXZhdGUgb3BlbjogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGF0dHI6IFNlbnNvckF0dHJpYnV0ZXMsIHN0YXRlOiBTZW5zb3JTdGF0ZSkge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyOicsIHN0YXRlKTtcclxuICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5hdHRyID0gYXR0cjtcclxuICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGU7XHJcbiAgICAgICAgaWYgKHRoaXMub3Blbikge1xyXG4gICAgICAgICAgICB0aGlzLm9wZW4gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnN0YXRlLmFkZFNlbnNvckRhdGFMaXN0ZW5lcih0aGlzLm9uU2Vuc29yRGF0YVJlY2VpdmVkLmJpbmQodGhpcyksIHRoaXMuZGF0YUZpbHRlcik7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5hZGRTZW5zb3JEYXRhTGlzdGVuZXIodGhpcy5vbk1vbml0b3IuYmluZCh0aGlzKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYXhpb3MgPSBheGlvcy5jcmVhdGUoe1xyXG4gICAgICAgICAgICBiYXNlVVJMOiAnaHR0cHM6Ly90ZXN0Lml0ZW1wZXIuaW8vYXBpL3YxL3NlbnNvcnMnLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30sXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCB3c1Rlc3RVcmwgPSAnd3M6Ly9pdGVtcGVyLnZhZGluZy5sYW46MzAwMC9wcmltdXMnO1xyXG4gICAgICAgIC8vIGNvbnN0IHdzRGV2VXJsID0gJ3dzOi8vbG9jYWxob3N0OjMwMDAvcHJpbXVzJztcclxuXHJcbiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgU29ja2V0ICh3c1Rlc3RVcmwpO1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCdvcGVuJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHNlbGYub3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKCctLS0gc29ja2V0Lm9uOiBEZXZpY2UuU2Vuc29yTG9nIGNvbm5lY3RlZCB0byBiYWNrZW5kIScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YTogYW55KSB7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKCctLS0gc29ja2V0Lm9uOiBEYXRhIHJlY2VpdmVkIGZyb20gYmFjay1lbmQnICsgZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEF0dHIoKTogU2Vuc29yQXR0cmlidXRlcyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0cjtcclxuICAgIH1cclxuICAgIHB1YmxpYyBnZXRTdGF0ZSgpOiBTZW5zb3JTdGF0ZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEZpbHRlcigpOiBGaWx0ZXJDb25maWcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFGaWx0ZXI7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgaXNsb2dnaW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2dpbmc7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc3RhcnRMb2dnaW5nKGZpbHRlcj86IEZpbHRlckNvbmZpZyk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLnN0YXJ0TG9nZ2luZycpO1xyXG4gICAgICAgIGlmIChmaWx0ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhRmlsdGVyID0gZmlsdGVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5sb2dnaW5nID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RvcExvZ2dpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RvcExvZ2dpbmcnKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uU2Vuc29yRGF0YVJlY2VpdmVkKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2dnaW5nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlc2NyID0geyBTTjogdGhpcy5hdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gZGF0YS50aW1lc3RhbXAoKSAtIHRoaXMudGltZXN0YW1wO1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IGRhdGEudGltZXN0YW1wKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSAnLycgKyBkZXNjci5TTiArICcvJysgZGVzY3IucG9ydDtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdVUkw6ICcsIHVybCk7XHJcbiAgICAgICAgICAgIHRoaXMuYXhpb3MucG9zdCh1cmwsIHNlbnNvckxvZylcclxuICAgICAgICAgICAgLnRoZW4gKGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZ2dlciBheGlvcy5wb3N0ICcgKyB1cmwgKyAnICcgKyByZXMuc3RhdHVzVGV4dCArXHJcbiAgICAgICAgICAgICAgICAgICAgJyByZXMuZGF0YTogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykgKyAnIG1zOiAnICsgZGlmZiArXHJcbiAgICAgICAgICAgICAgICAgICAgJyBkYXRlOiAnICsgbmV3IERhdGUoZGF0YS50aW1lc3RhbXAoKSkudG9Mb2NhbGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJ2NhdGNoIGVycm9yJywgZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbk1vbml0b3IoZGF0YTogU2Vuc29yRGF0YSk6IHZvaWQge1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnU2Vuc29yTG9nLm9uTW9uaXRvcicpO1xyXG4gICAgICAgIGNvbnN0IGRlc2NyID0geyBTTjogdGhpcy5hdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgY29uc3Qgc2FtcGxlcyA9IFt7ZGF0ZTogZGF0YS50aW1lc3RhbXAoKSwgdmFsdWU6IGRhdGEuZ2V0VmFsdWUoKX1dO1xyXG4gICAgICAgIGNvbnN0IHNlbnNvckxvZyA9IHsgZGVzY3IsIHNhbXBsZXMgfTtcclxuICAgICAgICB0aGlzLnNvY2tldC53cml0ZShzZW5zb3JMb2cpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
