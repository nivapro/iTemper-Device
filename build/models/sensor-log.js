"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = require("axios");
var logger_1 = require("./../logger");
var Websocket = require("isomorphic-ws");
var azure_iot_device_1 = require("azure-iot-device");
var azure_iot_device_mqtt_1 = require("azure-iot-device-mqtt");
var SensorLog = (function () {
    function SensorLog(attr, state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 5 * 60000;
        this.dataFilter = {
            resolution: 1,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.connectionString = '';
        logger_1.log.debug('--- SensorStateLogger, state:', state);
        logger_1.log.debug('--- SensorStateLogger, attr:', attr);
        this.timestamp = Date.now();
        this.logging = false;
        this.attr = attr;
        this.state = state;
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), this.dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this));
        this.axios = axios_1.default.create({
            baseURL: 'https://test.itemper.io/api/v1/sensors',
            headers: { 'Content-Type': 'application/json' },
        });
        this.socket = this.openSocket();
        this.connectionString = 'HostName=iothubiotlabs.azure-devices.net;DeviceId=twilight-sound-798cd80;' +
            'SharedAccessKey=7jobimPqYZEFvfsjSYZMmRjkk7xIs6cs721AIRYHpMU=';
        this.client = azure_iot_device_1.Client.fromConnectionString(this.connectionString, azure_iot_device_mqtt_1.Mqtt);
    }
    SensorLog.prototype.openSocket = function () {
        var wsTestUrl = 'ws://precision.vading.lan:3000/ws';
        var wsOrigin = 'http://vading.lan';
        var socket = new Websocket(wsTestUrl, { origin: wsOrigin });
        socket.on('open', function () {
            logger_1.log.info('--- socket.on: Device.SensorLog connected to backend!');
        });
        socket.on('message', function (data) {
            logger_1.log.info('--- socket.on: message received from back-end' + JSON.stringify(data));
        });
        socket.on('error', function (ws, err) {
            logger_1.log.error('--- socket.on: error: ' + JSON.stringify(err) + 'socket status: ' + ws.readyState);
        });
        return socket;
    };
    SensorLog.prototype.getAttr = function () {
        return this.attr;
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.getFilter = function () {
        return this.dataFilter;
    };
    SensorLog.prototype.islogging = function () {
        return this.logging;
    };
    SensorLog.prototype.startLogging = function (filter) {
        logger_1.log.debug('--- SensorStateLogger.startLogging');
        if (filter) {
            this.dataFilter = filter;
        }
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('--- SensorStateLogger.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.printResultFor = function (op) {
        return function printResult(err, res) {
            if (err) {
                logger_1.log.error(op + ' AZURE IOT error: ' + err.toString());
            }
            if (res) {
                logger_1.log.info(op + ' AZURE IOT status: ' + res.constructor.name);
            }
        };
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var descr = { SN: this.attr.SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { descr: descr, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + descr.SN + '/' + descr.port;
            logger_1.log.debug('URL: ', url_1);
            this.axios.post(url_1, sensorLog_1)
                .then(function (res) {
                logger_1.log.info('SensorLogger axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toLocaleString());
            })
                .catch(function () {
                logger_1.log.error('onSensorDataReceived axios.post catch error');
            });
            var message = new azure_iot_device_1.Message(JSON.stringify(sensorLog_1));
            message.properties.add('Delta time', diff_1.toString());
            this.client.sendEvent(message, this.printResultFor('send'));
        }
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var descr = { SN: this.attr.SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { descr: descr, samples: samples };
        if (this.socket && this.socket.readyState === Websocket.OPEN) {
            logger_1.log.debug('onMonitor: sensor log: ' + JSON.stringify(sensorLog));
            this.socket.send(JSON.stringify(sensorLog));
            logger_1.log.debug('onMonitor: sensor log sent');
        }
        else if (!this.socket || this.socket.readyState === Websocket.CLOSED) {
            logger_1.log.debug('onMonitor: socket closed, re-open');
            this.socket = this.openSocket();
        }
        else {
            logger_1.log.debug('onMonitor: socket not open yet');
        }
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE2QztBQUs3QyxzQ0FBa0M7QUFFbEMseUNBQTJDO0FBSTNDLHFEQUFtRDtBQUNuRCwrREFBNkM7QUFPN0M7SUF3Q0ksbUJBQVksSUFBc0IsRUFBRSxLQUFrQjtRQXBDOUMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLGtCQUFhLEdBQUcsQ0FBQyxHQUFDLEtBQU0sQ0FBQztRQUN6QixlQUFVLEdBQWdCO1lBQzlCLFVBQVUsRUFBRSxDQUFDO1lBQ2IsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQVE3QixxQkFBZ0IsR0FBVyxFQUFFLENBQUM7UUF3QmxDLFlBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEQsWUFBRyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3hGLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsS0FBSyxHQUFHLGVBQUssQ0FBQyxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFF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LElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDLE1BQU0sRUFBRTtZQUNwRSxZQUFHLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7WUFDL0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkM7YUFBTTtZQUNILFlBQUcsQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztTQUMvQztJQUNMLENBQUM7SUFDTCxnQkFBQztBQUFELENBakpBLEFBaUpDLElBQUE7QUFqSlksOEJBQVMiLCJmaWxlIjoibW9kZWxzL3NlbnNvci1sb2cuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MsIHsgQXhpb3NJbnN0YW5jZSB9IGZyb20gJ2F4aW9zJztcclxuaW1wb3J0IHsgU2Vuc29yQXR0cmlidXRlcyB9IGZyb20gJy4uL21vZGVscy9zZW5zb3ItYXR0cmlidXRlcyc7XHJcbmltcG9ydCB7IFNlbnNvckRhdGEgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLWRhdGEnO1xyXG5pbXBvcnQgeyBGaWx0ZXJDb25maWcsIFNlbnNvclN0YXRlIH0gZnJvbSAnLi4vbW9kZWxzL3NlbnNvci1zdGF0ZSc7XHJcblxyXG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLy4uL2xvZ2dlcic7XHJcblxyXG5pbXBvcnQgKiBhcyBXZWJzb2NrZXQgZnJvbSAnaXNvbW9ycGhpYy13cyc7XHJcblxyXG4vLyBJbXBvcnQgQXp1cmVcclxuXHJcbmltcG9ydCB7IENsaWVudCwgTWVzc2FnZSB9IGZyb20gJ2F6dXJlLWlvdC1kZXZpY2UnO1xyXG5pbXBvcnQgeyBNcXR0IH0gZnJvbSAnYXp1cmUtaW90LWRldmljZS1tcXR0JztcclxuXHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBMb2dnaW5nU2VydmljZSB7XHJcblxyXG59XHJcbmV4cG9ydCBjbGFzcyBTZW5zb3JMb2cge1xyXG4gICAgcHJpdmF0ZSBhdHRyOiBTZW5zb3JBdHRyaWJ1dGVzO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU2Vuc29yU3RhdGU7XHJcblxyXG4gICAgcHJpdmF0ZSB0aW1lc3RhbXA6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIGxvZ2dpbmc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgTUFYX1RJTUVfRElGRiA9IDUqNjBfMDAwO1xyXG4gICAgcHJpdmF0ZSBkYXRhRmlsdGVyOiBGaWx0ZXJDb25maWc9IHtcclxuICAgICAgICByZXNvbHV0aW9uOiAxLFxyXG4gICAgICAgIG1heFRpbWVEaWZmOiB0aGlzLk1BWF9USU1FX0RJRkZ9O1xyXG5cclxuICAgIHByaXZhdGUgYXhpb3M6IEF4aW9zSW5zdGFuY2U7XHJcblxyXG4gICAgcHJpdmF0ZSBzb2NrZXQ6IFdlYnNvY2tldDtcclxuXHJcbiAgICAvLyBBenVyZSBJT1RcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcclxuICAgIHByaXZhdGUgY29ubmVjdGlvblN0cmluZzogc3RyaW5nID0gJyc7XHJcbiAgICBwcml2YXRlIGNsaWVudDogQ2xpZW50O1xyXG5cclxuICAgIHByaXZhdGUgb3BlblNvY2tldCgpOiBXZWJzb2NrZXQge1xyXG4gICAgICAgIC8vIGNvbnN0IHdzVGVzdFVybCA9ICd3c3M6Ly90ZXN0Lml0ZW1wZXIuaW8vd3MnO1xyXG4gICAgICAgIGNvbnN0IHdzVGVzdFVybCA9ICd3czovL3ByZWNpc2lvbi52YWRpbmcubGFuOjMwMDAvd3MnO1xyXG4gICAgICAgIGNvbnN0IHdzT3JpZ2luID0gJ2h0dHA6Ly92YWRpbmcubGFuJztcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgV2Vic29ja2V0ICh3c1Rlc3RVcmwsIHsgb3JpZ2luOiB3c09yaWdpbn0pO1xyXG5cclxuICAgICAgICBzb2NrZXQub24oJ29wZW4nLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKCctLS0gc29ja2V0Lm9uOiBEZXZpY2UuU2Vuc29yTG9nIGNvbm5lY3RlZCB0byBiYWNrZW5kIScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIChkYXRhOiBXZWJzb2NrZXQuRGF0YSk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnLS0tIHNvY2tldC5vbjogbWVzc2FnZSByZWNlaXZlZCBmcm9tIGJhY2stZW5kJyArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgc29ja2V0Lm9uKCdlcnJvcicsICh3czogV2ViU29ja2V0LCBlcnI6IEVycm9yKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5lcnJvcignLS0tIHNvY2tldC5vbjogZXJyb3I6ICcgKyBKU09OLnN0cmluZ2lmeShlcnIpICsgJ3NvY2tldCBzdGF0dXM6ICcgKyB3cy5yZWFkeVN0YXRlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHNvY2tldDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhdHRyOiBTZW5zb3JBdHRyaWJ1dGVzLCBzdGF0ZTogU2Vuc29yU3RhdGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoJy0tLSBTZW5zb3JTdGF0ZUxvZ2dlciwgc3RhdGU6Jywgc3RhdGUpO1xyXG4gICAgICAgIGxvZy5kZWJ1ZygnLS0tIFNlbnNvclN0YXRlTG9nZ2VyLCBhdHRyOicsIGF0dHIpO1xyXG4gICAgICAgIHRoaXMudGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmF0dHIgPSBhdHRyO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0ZS5hZGRTZW5zb3JEYXRhTGlzdGVuZXIodGhpcy5vblNlbnNvckRhdGFSZWNlaXZlZC5iaW5kKHRoaXMpLCB0aGlzLmRhdGFGaWx0ZXIpO1xyXG4gICAgICAgIHRoaXMuc3RhdGUuYWRkU2Vuc29yRGF0YUxpc3RlbmVyKHRoaXMub25Nb25pdG9yLmJpbmQodGhpcykpO1xyXG5cclxuICAgICAgICB0aGlzLmF4aW9zID0gYXhpb3MuY3JlYXRlKHtcclxuICAgICAgICAgICAgYmFzZVVSTDogJ2h0dHBzOi8vdGVzdC5pdGVtcGVyLmlvL2FwaS92MS9zZW5zb3JzJyxcclxuICAgICAgICAgICAgaGVhZGVyczogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9LFxyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuc29ja2V0ID0gdGhpcy5vcGVuU29ja2V0KCk7XHJcblxyXG4gICAgICAgIC8vIEFaVVJFIElPVFxyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvblN0cmluZyA9ICdIb3N0TmFtZT1pb3RodWJpb3RsYWJzLmF6dXJlLWRldmljZXMubmV0O0RldmljZUlkPXR3aWxpZ2h0LXNvdW5kLTc5OGNkODA7JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1NoYXJlZEFjY2Vzc0tleT03am9iaW1QcVlaRUZ2ZnNqU1laTW1SamtrN3hJczZjczcyMUFJUllIcE1VPSc7XHJcbiAgICAgICAgdGhpcy5jbGllbnQgPSBDbGllbnQuZnJvbUNvbm5lY3Rpb25TdHJpbmcodGhpcy5jb25uZWN0aW9uU3RyaW5nLCBNcXR0KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXR0cigpOiBTZW5zb3JBdHRyaWJ1dGVzIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hdHRyO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGdldFN0YXRlKCk6IFNlbnNvclN0YXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0RmlsdGVyKCk6IEZpbHRlckNvbmZpZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YUZpbHRlcjtcclxuICAgIH1cclxuICAgIHB1YmxpYyBpc2xvZ2dpbmcoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9nZ2luZztcclxuICAgIH1cclxuICAgIHB1YmxpYyBzdGFydExvZ2dpbmcoZmlsdGVyPzogRmlsdGVyQ29uZmlnKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCctLS0gU2Vuc29yU3RhdGVMb2dnZXIuc3RhcnRMb2dnaW5nJyk7XHJcbiAgICAgICAgaWYgKGZpbHRlcikge1xyXG4gICAgICAgICAgICB0aGlzLmRhdGFGaWx0ZXIgPSBmaWx0ZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdG9wTG9nZ2luZygpOiB2b2lkIHtcclxuICAgICAgICBsb2cuZGVidWcoJy0tLSBTZW5zb3JTdGF0ZUxvZ2dlci5zdG9wTG9nZ2luZycpO1xyXG4gICAgICAgIHRoaXMubG9nZ2luZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFByaW50IEFaVVJFIElPVCByZXN1bHRzLlxyXG4gICAgcHJpdmF0ZSBwcmludFJlc3VsdEZvcihvcDogc3RyaW5nKTogYW55IHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHJpbnRSZXN1bHQoZXJyOiBhbnksIHJlczogYW55KSB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICBsb2cuZXJyb3Iob3AgKyAnIEFaVVJFIElPVCBlcnJvcjogJyArIGVyci50b1N0cmluZygpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHJlcykge1xyXG4gICAgICAgICAgICBsb2cuaW5mbyhvcCArICcgQVpVUkUgSU9UIHN0YXR1czogJyArIHJlcy5jb25zdHJ1Y3Rvci5uYW1lKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgICBwcml2YXRlIG9uU2Vuc29yRGF0YVJlY2VpdmVkKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2dnaW5nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlc2NyID0geyBTTjogdGhpcy5hdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMgPSBbe2RhdGU6IGRhdGEudGltZXN0YW1wKCksIHZhbHVlOiBkYXRhLmdldFZhbHVlKCl9XTtcclxuICAgICAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gZGF0YS50aW1lc3RhbXAoKSAtIHRoaXMudGltZXN0YW1wO1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IGRhdGEudGltZXN0YW1wKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSAnLycgKyBkZXNjci5TTiArICcvJysgZGVzY3IucG9ydDtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdVUkw6ICcsIHVybCk7XHJcbiAgICAgICAgICAgIHRoaXMuYXhpb3MucG9zdCh1cmwsIHNlbnNvckxvZylcclxuICAgICAgICAgICAgLnRoZW4gKGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZ2dlciBheGlvcy5wb3N0ICcgKyB1cmwgKyAnICcgKyByZXMuc3RhdHVzVGV4dCArXHJcbiAgICAgICAgICAgICAgICAgICAgJyByZXMuZGF0YTogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykgKyAnIG1zOiAnICsgZGlmZiArXHJcbiAgICAgICAgICAgICAgICAgICAgJyBkYXRlOiAnICsgbmV3IERhdGUoZGF0YS50aW1lc3RhbXAoKSkudG9Mb2NhbGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5lcnJvcignb25TZW5zb3JEYXRhUmVjZWl2ZWQgYXhpb3MucG9zdCBjYXRjaCBlcnJvcicpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gQVpVUkUgSU9UXHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBuZXcgTWVzc2FnZShKU09OLnN0cmluZ2lmeShzZW5zb3JMb2cpKTtcclxuICAgICAgICAgICAgbWVzc2FnZS5wcm9wZXJ0aWVzLmFkZCgnRGVsdGEgdGltZScsIGRpZmYudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xpZW50LnNlbmRFdmVudChtZXNzYWdlLCB0aGlzLnByaW50UmVzdWx0Rm9yKCdzZW5kJykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uTW9uaXRvcihkYXRhOiBTZW5zb3JEYXRhKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cub25Nb25pdG9yJyk7XHJcbiAgICAgICAgY29uc3QgZGVzY3IgPSB7IFNOOiB0aGlzLmF0dHIuU04sIHBvcnQ6IGRhdGEuZ2V0UG9ydCgpfTtcclxuICAgICAgICBjb25zdCBzYW1wbGVzID0gW3tkYXRlOiBkYXRhLnRpbWVzdGFtcCgpLCB2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpfV07XHJcbiAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjciwgc2FtcGxlcyB9O1xyXG4gICAgICAgIGlmICh0aGlzLnNvY2tldCAmJiB0aGlzLnNvY2tldC5yZWFkeVN0YXRlID09PSBXZWJzb2NrZXQuT1BFTikge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ29uTW9uaXRvcjogc2Vuc29yIGxvZzogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykpO1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykpO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ29uTW9uaXRvcjogc2Vuc29yIGxvZyBzZW50Jyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5zb2NrZXQgfHwgdGhpcy5zb2NrZXQucmVhZHlTdGF0ZSA9PT0gV2Vic29ja2V0LkNMT1NFRCkge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ29uTW9uaXRvcjogc29ja2V0IGNsb3NlZCwgcmUtb3BlbicpO1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldCA9IHRoaXMub3BlblNvY2tldCgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1Zygnb25Nb25pdG9yOiBzb2NrZXQgbm90IG9wZW4geWV0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==
