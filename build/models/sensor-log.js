"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var axios_1 = __importDefault(require("axios"));
var logger_1 = require("./../logger");
var settings_1 = require("./settings");
var isomorphic_ws_1 = __importDefault(require("isomorphic-ws"));
var SensorLog = (function () {
    function SensorLog(state) {
        this.timestamp = 0;
        this.logging = false;
        this.MAX_TIME_DIFF = 5 * 60000;
        this.dataFilter = {
            resolution: 1,
            maxTimeDiff: this.MAX_TIME_DIFF
        };
        this.SHARED_ACCESS_KEY = '';
        this.WS_URL = '';
        this.WS_ORIGIN = '';
        this.ITEMPER_URL = '';
        logger_1.log.debug('SensorLog: SensorStateLogger, state:', JSON.stringify(state));
        this.timestamp = Date.now();
        this.logging = false;
        this.state = state;
        this.initSettings();
        this.state.addSensorDataListener(this.onSensorDataReceived.bind(this), this.dataFilter);
        this.state.addSensorDataListener(this.onMonitor.bind(this));
        this.axios = this.createAxiosInstance();
        this.socket = this.openSocket();
    }
    SensorLog.prototype.createAxiosInstance = function () {
        return this.axios = axios_1.default.create({
            baseURL: this.ITEMPER_URL,
            headers: { 'Content-Type': 'application/json' }
        });
    };
    SensorLog.prototype.openSocket = function () {
        var wsTestUrl = this.WS_URL;
        var origin = this.WS_ORIGIN;
        var socket = new isomorphic_ws_1.default(wsTestUrl, { origin: origin });
        socket.on('open', function () {
            logger_1.log.info('SensorLog: socket.on(open): Device.SensorLog connected to backend!');
        });
        socket.on('message', function (data) {
            logger_1.log.info('SensorLog: socket.on(message): received from back-end' + JSON.stringify(data));
        });
        socket.on('message', function (data) {
            logger_1.log.info('SensorLog: socket.on(message): received from back-end' + JSON.stringify(data));
        });
        socket.on('error', function () {
            logger_1.log.info('SensorLog: socket.on(error): ');
        });
        return socket;
    };
    SensorLog.prototype.initSettings = function () {
        var _this = this;
        this.SHARED_ACCESS_KEY = settings_1.Settings.get(settings_1.Settings.SHARED_ACCESS_KEY).value.toString();
        this.WS_URL = settings_1.Settings.get(settings_1.Settings.WS_URL).value.toString();
        this.WS_ORIGIN = settings_1.Settings.get(settings_1.Settings.WS_ORIGIN).value.toString();
        this.ITEMPER_URL = settings_1.Settings.get(settings_1.Settings.ITEMPER_URL).value.toString();
        settings_1.Settings.onChange('SHARED_ACCESS_KEY', function (setting) {
            _this.SHARED_ACCESS_KEY = setting.value.toString();
            logger_1.log.debug('SensorLog.settingChanged: SHARED_ACCESS_KEY=' + _this.SHARED_ACCESS_KEY);
        });
        settings_1.Settings.onChange('WS_URL', function (setting) {
            _this.WS_URL = setting.value.toString();
            logger_1.log.debug('SensorLog.settingChanged: WS_URL=' + _this.WS_URL);
            _this.socket = _this.openSocket();
        });
        settings_1.Settings.onChange('WS_ORIGIN', function (setting) {
            _this.WS_ORIGIN = setting.value.toString();
            logger_1.log.debug('SensorLog.settingChanged: WS_ORIGIN=' + _this.WS_ORIGIN);
            _this.socket = _this.openSocket();
        });
        settings_1.Settings.onChange('ITEMPER_URL', function (setting) {
            _this.ITEMPER_URL = setting.value.toString();
            logger_1.log.debug('SensorLog.settingChanged: ITEMPER_URL=' + _this.ITEMPER_URL);
            _this.axios = _this.createAxiosInstance();
        });
        settings_1.Settings.onChange('AZURE_CONNECTION_STRING', function (setting) {
            logger_1.log.info('settingChanged: AZURE_CONNECTION_STRING not implemented value=' + setting.value.toString());
        });
    };
    SensorLog.prototype.getState = function () {
        return this.state;
    };
    SensorLog.prototype.getFilter = function () {
        return this.dataFilter;
    };
    SensorLog.prototype.islogging = function () {
        return this.logging;
    };
    SensorLog.prototype.startLogging = function (filter) {
        logger_1.log.debug('SensorLog.startLogging');
        if (filter) {
            this.dataFilter = filter;
        }
        this.logging = true;
    };
    SensorLog.prototype.stopLogging = function () {
        logger_1.log.debug('SensorLog.stopLogging');
        this.logging = false;
    };
    SensorLog.prototype.onSensorDataReceived = function (data) {
        if (this.logging) {
            var desc = { SN: this.state.getAttr().SN, port: data.getPort() };
            var samples = [{ date: data.timestamp(), value: data.getValue() }];
            var sensorLog_1 = { desc: desc, samples: samples };
            var diff_1 = data.timestamp() - this.timestamp;
            this.timestamp = data.timestamp();
            var url_1 = '/' + desc.SN + '/' + desc.port;
            logger_1.log.debug('URL: ' + url_1);
            var Authorization = 'Bearer ' + this.SHARED_ACCESS_KEY;
            this.axios.post(url_1, sensorLog_1, { headers: { Authorization: Authorization } })
                .then(function (res) {
                logger_1.log.info('SensorLog.onSensorDataReceived: axios.post ' + url_1 + ' ' + res.statusText +
                    ' res.data: ' + JSON.stringify(sensorLog_1) + ' ms: ' + diff_1 +
                    ' date: ' + new Date(data.timestamp()).toLocaleString());
            })
                .catch(function (e) {
                logger_1.log.error('SensorLog.onSensorDataReceived: axios.post catch error code=' + JSON.stringify(e));
                if (e.status === '403') {
                    logger_1.log.debug('SensorLog.onSensorDataReceived: register sensor');
                    this.registerSensor(data);
                }
            });
        }
    };
    SensorLog.prototype.registerSensor = function (data) {
        var self = this;
        var attr = this.state.getAttr();
        var desc = { SN: attr.SN, port: data.getPort() };
        var body = { desc: desc, attr: attr };
        var url = '';
        var Authorization = 'Bearer ' + this.SHARED_ACCESS_KEY;
        this.axios.post(url, body, { headers: { Authorization: Authorization } })
            .then(function (res) {
            logger_1.log.info('SensorLog.registerSensor: axios.post - register sensor desc=' + JSON.stringify(res));
        })
            .catch(function (e) {
            logger_1.log.error('SensorLog.registerSensor: axios.post - cannot register desc=' +
                JSON.stringify(desc) + ', status=' + e.status);
            setTimeout(function () { return self.registerSensor(data); }, 5000);
        });
    };
    SensorLog.prototype.onMonitor = function (data) {
        logger_1.log.debug('SensorLog.onMonitor');
        var desc = { SN: this.state.getAttr().SN, port: data.getPort() };
        var samples = [{ date: data.timestamp(), value: data.getValue() }];
        var sensorLog = { desc: desc, samples: samples };
        if (this.socket && this.socket.readyState === isomorphic_ws_1.default.OPEN) {
            logger_1.log.debug('SensorLog.onMonitor: sensor log: ' + JSON.stringify(sensorLog));
            this.socket.send(JSON.stringify(sensorLog));
            logger_1.log.debug('SensorLog.onMonitor: sensor log sent');
        }
        else if (!this.socket || this.socket.readyState === isomorphic_ws_1.default.CLOSED) {
            logger_1.log.debug('SensorLog.onMonitor: socket closed, re-open');
            this.socket = this.openSocket();
        }
        else {
            logger_1.log.debug('SensorLog.onMonitor: socket not open yet');
        }
    };
    return SensorLog;
}());
exports.SensorLog = SensorLog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvc2Vuc29yLWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGdEQUE2QztBQUk3QyxzQ0FBa0M7QUFFbEMsdUNBQTZDO0FBRTdDLGdFQUFzQztBQWN0QztJQXNESSxtQkFBWSxLQUFrQjtRQW5EdEIsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLGtCQUFhLEdBQUcsQ0FBQyxHQUFDLEtBQU0sQ0FBQztRQUN6QixlQUFVLEdBQWdCO1lBQzlCLFVBQVUsRUFBRSxDQUFDO1lBQ2IsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQUMsQ0FBQztRQUc3QixzQkFBaUIsR0FBVyxFQUFFLENBQUM7UUFDL0IsV0FBTSxHQUFXLEVBQUUsQ0FBQztRQUNwQixjQUFTLEdBQVcsRUFBRSxDQUFDO1FBQ3ZCLGdCQUFXLEdBQVcsRUFBRSxDQUFDO1FBeUM3QixZQUFHLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN6RSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4RixJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFNUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMs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QUM7UUFDcEMsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxLQUFLLHVCQUFTLENBQUMsSUFBSSxFQUFFO1lBQzFELFlBQUcsQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzNFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUM1QyxZQUFHLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7U0FDckQ7YUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyx1QkFBUyxDQUFDLE1BQU0sRUFBRTtZQUNwRSxZQUFHLENBQUMsS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkM7YUFBTTtZQUNILFlBQUcsQ0FBQyxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUN6RDtJQUNMLENBQUM7SUFDTCxnQkFBQztBQUFELENBbE5BLEFBa05DLElBQUE7QUFsTlksOEJBQVMiLCJmaWxlIjoibW9kZWxzL3NlbnNvci1sb2cuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MsIHsgQXhpb3NJbnN0YW5jZSB9IGZyb20gJ2F4aW9zJztcclxuaW1wb3J0IHsgU2Vuc29yRGF0YSB9IGZyb20gJy4uL21vZGVscy9zZW5zb3ItZGF0YSc7XHJcbmltcG9ydCB7IEZpbHRlckNvbmZpZywgU2Vuc29yU3RhdGUgfSBmcm9tICcuLi9tb2RlbHMvc2Vuc29yLXN0YXRlJztcclxuXHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vLi4vbG9nZ2VyJztcclxuXHJcbmltcG9ydCB7U2V0dGluZywgU2V0dGluZ3N9IGZyb20gJy4vc2V0dGluZ3MnO1xyXG5cclxuaW1wb3J0IFdlYlNvY2tldCBmcm9tICdpc29tb3JwaGljLXdzJztcclxuXHJcbi8vIEltcG9ydCBBenVyZVxyXG5cclxuLy8gaW1wb3J0IHsgQ2xpZW50LCBNZXNzYWdlIH0gZnJvbSAnYXp1cmUtaW90LWRldmljZSc7XHJcbi8vIGltcG9ydCB7IE1xdHQgfSBmcm9tICdhenVyZS1pb3QtZGV2aWNlLW1xdHQnO1xyXG5cclxuXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFNlbnNvckxvZ0RhdGEge1xyXG4gICAgZGVzYzogeyBTTjogc3RyaW5nLCBwb3J0OiBudW1iZXJ9O1xyXG4gICAgc2FtcGxlczogU2Vuc29yRGF0YVtdO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2Vuc29yTG9nIHtcclxuICAgIHByaXZhdGUgc3RhdGU6IFNlbnNvclN0YXRlO1xyXG5cclxuICAgIHByaXZhdGUgdGltZXN0YW1wOiBudW1iZXIgPSAwO1xyXG4gICAgcHJpdmF0ZSBsb2dnaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIE1BWF9USU1FX0RJRkYgPSA1KjYwXzAwMDtcclxuICAgIHByaXZhdGUgZGF0YUZpbHRlcjogRmlsdGVyQ29uZmlnPSB7XHJcbiAgICAgICAgcmVzb2x1dGlvbjogMSxcclxuICAgICAgICBtYXhUaW1lRGlmZjogdGhpcy5NQVhfVElNRV9ESUZGfTtcclxuXHJcbiAgICBwcml2YXRlIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xyXG4gICAgcHJpdmF0ZSBTSEFSRURfQUNDRVNTX0tFWTogc3RyaW5nID0gJyc7XHJcbiAgICBwcml2YXRlIFdTX1VSTDogc3RyaW5nID0gJyc7XHJcbiAgICBwcml2YXRlIFdTX09SSUdJTjogc3RyaW5nID0gJyc7XHJcbiAgICBwcml2YXRlIElURU1QRVJfVVJMOiBzdHJpbmcgPSAnJztcclxuIC8vIHByaXZhdGUgQVpVUkVfQ09OTkVDVElPTl9TVFJJTkc6IHN0cmluZztcclxuXHJcblxyXG4gICAgcHJpdmF0ZSBzb2NrZXQ6IFdlYlNvY2tldDtcclxuXHJcbiAgICAvLyBBenVyZSBJT1RcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcclxuICAgIC8vIHByaXZhdGUgY29ubmVjdGlvblN0cmluZzogc3RyaW5nID0gJyc7XHJcbiAgICAvLyBwcml2YXRlIGNsaWVudDogQ2xpZW50O1xyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlQXhpb3NJbnN0YW5jZSgpOiBBeGlvc0luc3RhbmNlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5heGlvcyA9IGF4aW9zLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIGJhc2VVUkw6IHRoaXMuSVRFTVBFUl9VUkwsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfX0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb3BlblNvY2tldCgpOiBXZWJTb2NrZXQge1xyXG4gICAgICAgIC8vIGNvbnN0IHdzVGVzdFVybCA9ICd3c3M6Ly90ZXN0Lml0ZW1wZXIuaW8vd3MnO1xyXG4gICAgICAgIGNvbnN0IHdzVGVzdFVybCA9IHRoaXMuV1NfVVJMO1xyXG4gICAgICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMuV1NfT1JJR0lOO1xyXG4gICAgICAgIGNvbnN0IHNvY2tldCA9IG5ldyBXZWJTb2NrZXQgKHdzVGVzdFVybCwgeyBvcmlnaW4gfSk7XHJcblxyXG4gICAgICAgIHNvY2tldC5vbignb3BlbicsICgpID0+IHtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ1NlbnNvckxvZzogc29ja2V0Lm9uKG9wZW4pOiBEZXZpY2UuU2Vuc29yTG9nIGNvbm5lY3RlZCB0byBiYWNrZW5kIScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIChkYXRhOiBXZWJTb2NrZXQuRGF0YSk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnU2Vuc29yTG9nOiBzb2NrZXQub24obWVzc2FnZSk6IHJlY2VpdmVkIGZyb20gYmFjay1lbmQnICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIChkYXRhOiBXZWJTb2NrZXQuRGF0YSk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnU2Vuc29yTG9nOiBzb2NrZXQub24obWVzc2FnZSk6IHJlY2VpdmVkIGZyb20gYmFjay1lbmQnICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzb2NrZXQub24oJ2Vycm9yJywgKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBsb2cuaW5mbygnU2Vuc29yTG9nOiBzb2NrZXQub24oZXJyb3IpOiAnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHNvY2tldDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihzdGF0ZTogU2Vuc29yU3RhdGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZzogU2Vuc29yU3RhdGVMb2dnZXIsIHN0YXRlOicsIEpTT04uc3RyaW5naWZ5KHN0YXRlKSk7XHJcbiAgICAgICAgdGhpcy50aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRoaXMubG9nZ2luZyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcclxuICAgICAgICB0aGlzLmluaXRTZXR0aW5ncygpO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXRlLmFkZFNlbnNvckRhdGFMaXN0ZW5lcih0aGlzLm9uU2Vuc29yRGF0YVJlY2VpdmVkLmJpbmQodGhpcyksIHRoaXMuZGF0YUZpbHRlcik7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5hZGRTZW5zb3JEYXRhTGlzdGVuZXIodGhpcy5vbk1vbml0b3IuYmluZCh0aGlzKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYXhpb3MgPSB0aGlzLmNyZWF0ZUF4aW9zSW5zdGFuY2UoKTtcclxuICAgICAgICB0aGlzLnNvY2tldCA9IHRoaXMub3BlblNvY2tldCgpO1xyXG5cclxuICAgICAgICAvLyBBWlVSRSBJT1RcclxuICAgICAgICAvLyB0aGlzLmNvbm5lY3Rpb25TdHJpbmcgPSBBWlVSRV9DT05ORUNUSU9OX1NUUklORyArICcnO1xyXG4gICAgICAgIC8vIHRoaXMuY2xpZW50ID0gQ2xpZW50LmZyb21Db25uZWN0aW9uU3RyaW5nKHRoaXMuY29ubmVjdGlvblN0cmluZywgTXF0dCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0U2V0dGluZ3MoKSB7XHJcbiAgICAgICAgdGhpcy5TSEFSRURfQUNDRVNTX0tFWSA9IFNldHRpbmdzLmdldChTZXR0aW5ncy5TSEFSRURfQUNDRVNTX0tFWSkudmFsdWUudG9TdHJpbmcoKTtcclxuICAgICAgICB0aGlzLldTX1VSTCA9IFNldHRpbmdzLmdldChTZXR0aW5ncy5XU19VUkwpLnZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgdGhpcy5XU19PUklHSU4gPSBTZXR0aW5ncy5nZXQoU2V0dGluZ3MuV1NfT1JJR0lOKS52YWx1ZS50b1N0cmluZygpO1xyXG4gICAgICAgIHRoaXMuSVRFTVBFUl9VUkwgPSBTZXR0aW5ncy5nZXQoU2V0dGluZ3MuSVRFTVBFUl9VUkwpLnZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgLy8gdGhpcy5BWlVSRV9DT05ORUNUSU9OX1NUUklORyA9IFNldHRpbmdzLmdldChTZXR0aW5ncy5BWlVSRV9DT05ORUNUSU9OX1NUUklORykudmFsdWUudG9TdHJpbmcoKTtcclxuXHJcbiAgICAgICAgU2V0dGluZ3Mub25DaGFuZ2UoJ1NIQVJFRF9BQ0NFU1NfS0VZJywgKHNldHRpbmc6IFNldHRpbmcpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5TSEFSRURfQUNDRVNTX0tFWSA9IHNldHRpbmcudmFsdWUudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cuc2V0dGluZ0NoYW5nZWQ6IFNIQVJFRF9BQ0NFU1NfS0VZPScgKyB0aGlzLlNIQVJFRF9BQ0NFU1NfS0VZKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBTZXR0aW5ncy5vbkNoYW5nZSgnV1NfVVJMJywgKHNldHRpbmc6IFNldHRpbmcpPT4ge1xyXG4gICAgICAgICAgICB0aGlzLldTX1VSTCA9IHNldHRpbmcudmFsdWUudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cuc2V0dGluZ0NoYW5nZWQ6IFdTX1VSTD0nICsgdGhpcy5XU19VUkwpO1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldCA9IHRoaXMub3BlblNvY2tldCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFNldHRpbmdzLm9uQ2hhbmdlKCdXU19PUklHSU4nLCAoc2V0dGluZzogU2V0dGluZyk9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuV1NfT1JJR0lOID0gc2V0dGluZy52YWx1ZS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5zZXR0aW5nQ2hhbmdlZDogV1NfT1JJR0lOPScgKyB0aGlzLldTX09SSUdJTik7XHJcbiAgICAgICAgICAgIC8vIGlmICh0aGlzLnNvY2tldC5PUEVOKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLnNvY2tldC5jbG9zZSgpO1xyXG4gICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgIHRoaXMuc29ja2V0ID0gdGhpcy5vcGVuU29ja2V0KCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgU2V0dGluZ3Mub25DaGFuZ2UoJ0lURU1QRVJfVVJMJywgKHNldHRpbmc6IFNldHRpbmcpPT4ge1xyXG4gICAgICAgICAgICB0aGlzLklURU1QRVJfVVJMID0gc2V0dGluZy52YWx1ZS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5zZXR0aW5nQ2hhbmdlZDogSVRFTVBFUl9VUkw9JyArICB0aGlzLklURU1QRVJfVVJMKTtcclxuICAgICAgICAgICAgdGhpcy5heGlvcyA9IHRoaXMuY3JlYXRlQXhpb3NJbnN0YW5jZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFNldHRpbmdzLm9uQ2hhbmdlKCdBWlVSRV9DT05ORUNUSU9OX1NUUklORycsIChzZXR0aW5nOiBTZXR0aW5nKT0+IHtcclxuICAgICAgICAgICAgbG9nLmluZm8oJ3NldHRpbmdDaGFuZ2VkOiBBWlVSRV9DT05ORUNUSU9OX1NUUklORyBub3QgaW1wbGVtZW50ZWQgdmFsdWU9JyArIHNldHRpbmcudmFsdWUudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFN0YXRlKCk6IFNlbnNvclN0YXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0RmlsdGVyKCk6IEZpbHRlckNvbmZpZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YUZpbHRlcjtcclxuICAgIH1cclxuICAgIHB1YmxpYyBpc2xvZ2dpbmcoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9nZ2luZztcclxuICAgIH1cclxuICAgIHB1YmxpYyBzdGFydExvZ2dpbmcoZmlsdGVyPzogRmlsdGVyQ29uZmlnKTogdm9pZCB7XHJcbiAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cuc3RhcnRMb2dnaW5nJyk7XHJcbiAgICAgICAgaWYgKGZpbHRlcikge1xyXG4gICAgICAgICAgICB0aGlzLmRhdGFGaWx0ZXIgPSBmaWx0ZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxvZ2dpbmcgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdG9wTG9nZ2luZygpOiB2b2lkIHtcclxuICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5zdG9wTG9nZ2luZycpO1xyXG4gICAgICAgIHRoaXMubG9nZ2luZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFByaW50IEFaVVJFIElPVCByZXN1bHRzLlxyXG4vLyAgICAgcHJpdmF0ZSBwcmludFJlc3VsdEZvcihvcDogc3RyaW5nKTogYW55IHtcclxuLy8gICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHJpbnRSZXN1bHQoZXJyOiBhbnksIHJlczogYW55KSB7XHJcbi8vICAgICAgICAgaWYgKGVycikge1xyXG4vLyAgICAgICAgICAgICBsb2cuZXJyb3Iob3AgKyAnIEFaVVJFIElPVCBlcnJvcjogJyArIGVyci50b1N0cmluZygpKTtcclxuLy8gICAgICAgICB9XHJcbi8vICAgICAgICAgaWYgKHJlcykge1xyXG4vLyAgICAgICAgICAgICBsb2cuaW5mbyhvcCArICcgQVpVUkUgSU9UIHN0YXR1czogJyArIHJlcy5jb25zdHJ1Y3Rvci5uYW1lKTtcclxuLy8gICAgICAgICB9XHJcbi8vICAgICB9O1xyXG4vLyAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uU2Vuc29yRGF0YVJlY2VpdmVkKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2dnaW5nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlc2MgPSB7IFNOOiB0aGlzLnN0YXRlLmdldEF0dHIoKS5TTiwgcG9ydDogZGF0YS5nZXRQb3J0KCl9O1xyXG4gICAgICAgICAgICBjb25zdCBzYW1wbGVzID0gW3tkYXRlOiBkYXRhLnRpbWVzdGFtcCgpLCB2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpfV07XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbnNvckxvZyA9IHsgZGVzYywgc2FtcGxlcyB9O1xyXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gZGF0YS50aW1lc3RhbXAoKSAtIHRoaXMudGltZXN0YW1wO1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVzdGFtcCA9IGRhdGEudGltZXN0YW1wKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSAnLycgKyBkZXNjLlNOICsgJy8nKyBkZXNjLnBvcnQ7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnVVJMOiAnICsgdXJsKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IEF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyB0aGlzLlNIQVJFRF9BQ0NFU1NfS0VZO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5heGlvcy5wb3N0KHVybCwgc2Vuc29yTG9nLCB7aGVhZGVyczogeyBBdXRob3JpemF0aW9uIH19KVxyXG4gICAgICAgICAgICAudGhlbiAoZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuaW5mbygnU2Vuc29yTG9nLm9uU2Vuc29yRGF0YVJlY2VpdmVkOiBheGlvcy5wb3N0ICcgKyB1cmwgKyAnICcgKyByZXMuc3RhdHVzVGV4dCArXHJcbiAgICAgICAgICAgICAgICAgICAgJyByZXMuZGF0YTogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykgKyAnIG1zOiAnICsgZGlmZiArXHJcbiAgICAgICAgICAgICAgICAgICAgJyBkYXRlOiAnICsgbmV3IERhdGUoZGF0YS50aW1lc3RhbXAoKSkudG9Mb2NhbGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJ1NlbnNvckxvZy5vblNlbnNvckRhdGFSZWNlaXZlZDogYXhpb3MucG9zdCBjYXRjaCBlcnJvciBjb2RlPScrIEpTT04uc3RyaW5naWZ5KGUpKTtcclxuICAgICAgICAgICAgICAgIGlmIChlLnN0YXR1cyA9PT0gJzQwMycpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5vblNlbnNvckRhdGFSZWNlaXZlZDogcmVnaXN0ZXIgc2Vuc29yJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclNlbnNvcihkYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIEFaVVJFIElPVFxyXG4gICAgICAgICAgICAvLyBjb25zdCBtZXNzYWdlID0gbmV3IE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoc2Vuc29yTG9nKSk7XHJcbiAgICAgICAgICAgIC8vIG1lc3NhZ2UucHJvcGVydGllcy5hZGQoJ0RlbHRhIHRpbWUnLCBkaWZmLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAvLyB0aGlzLmNsaWVudC5zZW5kRXZlbnQobWVzc2FnZSwgdGhpcy5wcmludFJlc3VsdEZvcignc2VuZCcpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZWdpc3RlclNlbnNvcihkYXRhOiBTZW5zb3JEYXRhKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuc3RhdGUuZ2V0QXR0cigpO1xyXG4gICAgICAgIGNvbnN0IGRlc2MgPSB7IFNOOiBhdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbiAgICAgICAgY29uc3QgYm9keSA9IHsgZGVzYywgYXR0ciB9O1xyXG4gICAgICAgIGNvbnN0IHVybCA9ICcnO1xyXG5cclxuICAgICAgICBjb25zdCBBdXRob3JpemF0aW9uID0gJ0JlYXJlciAnICsgdGhpcy5TSEFSRURfQUNDRVNTX0tFWTtcclxuXHJcbiAgICAgICAgdGhpcy5heGlvcy5wb3N0KHVybCwgYm9keSwge2hlYWRlcnM6IHsgQXV0aG9yaXphdGlvbiB9fSlcclxuICAgICAgICAudGhlbiAoZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgICAgIGxvZy5pbmZvKCdTZW5zb3JMb2cucmVnaXN0ZXJTZW5zb3I6IGF4aW9zLnBvc3QgLSByZWdpc3RlciBzZW5zb3IgZGVzYz0nICsgSlNPTi5zdHJpbmdpZnkocmVzKSk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICBsb2cuZXJyb3IoJ1NlbnNvckxvZy5yZWdpc3RlclNlbnNvcjogYXhpb3MucG9zdCAtIGNhbm5vdCByZWdpc3RlciBkZXNjPScgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShkZXNjKSArICcsIHN0YXR1cz0nICsgZS5zdGF0dXMpO1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHNlbGYucmVnaXN0ZXJTZW5zb3IoZGF0YSksIDVfMDAwKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgb25Nb25pdG9yKGRhdGE6IFNlbnNvckRhdGEpOiB2b2lkIHtcclxuICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5vbk1vbml0b3InKTtcclxuICAgICAgICBjb25zdCBkZXNjID0geyBTTjogdGhpcy5zdGF0ZS5nZXRBdHRyKCkuU04sIHBvcnQ6IGRhdGEuZ2V0UG9ydCgpfTtcclxuICAgICAgICBjb25zdCBzYW1wbGVzID0gW3tkYXRlOiBkYXRhLnRpbWVzdGFtcCgpLCB2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpfV07XHJcbiAgICAgICAgY29uc3Qgc2Vuc29yTG9nID0geyBkZXNjLCBzYW1wbGVzIH07XHJcbiAgICAgICAgaWYgKHRoaXMuc29ja2V0ICYmIHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnU2Vuc29yTG9nLm9uTW9uaXRvcjogc2Vuc29yIGxvZzogJyArIEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykpO1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHNlbnNvckxvZykpO1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJ1NlbnNvckxvZy5vbk1vbml0b3I6IHNlbnNvciBsb2cgc2VudCcpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuc29ja2V0IHx8IHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5DTE9TRUQpIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cub25Nb25pdG9yOiBzb2NrZXQgY2xvc2VkLCByZS1vcGVuJyk7XHJcbiAgICAgICAgICAgIHRoaXMuc29ja2V0ID0gdGhpcy5vcGVuU29ja2V0KCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKCdTZW5zb3JMb2cub25Nb25pdG9yOiBzb2NrZXQgbm90IG9wZW4geWV0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==
