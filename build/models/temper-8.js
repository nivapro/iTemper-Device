"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var sensor_state_1 = require("./sensor-state");
var logger_1 = require("./../logger");
var Temper8 = (function (_super) {
    __extends(Temper8, _super);
    function Temper8() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.nextSensor = 0;
        return _this;
    }
    Temper8.prototype.initReport = function () {
        this.nextSensor = 0;
        return [this.usedPortsRequest(), this.temperatureRequest(this.nextSensor)];
    };
    Temper8.prototype.parseInput = function (data) {
        try {
            if (this.matchUsedPorts(data)) {
                logger_1.log.debug('+++ Temper8.matchUsedPorts:', data);
                var response = this.temperatureRequest(this.sensors[this.nextSensor].s.getPort());
                this.nextSensor += 1;
                return response;
            }
            else if (this.matchTemperature(data)) {
                logger_1.log.debug('+++ Temper8.matchTemperature:', data);
                if (this.nextSensor < this.sensors.length) {
                    var response = this.temperatureRequest(this.sensors[this.nextSensor].s.getPort());
                    this.nextSensor += 1;
                    return response;
                }
                else {
                    this.nextSensor = 0;
                    return this.check03Request();
                }
            }
            else if (this.matchCheck03(data)) {
                return this.check05Request();
            }
            else if (this.matchCheck05(data)) {
                return this.check0DRequest();
            }
            else if (this.matchCheck0D(data)) {
                return [];
            }
            else if (this.matchCheckFF(data)) {
                logger_1.log.error('*** Temper8.matchCheckFF: restart?');
                throw Error('*** Temper8.matchCheckFF');
            }
        }
        catch (e) {
            logger_1.log.error(e);
        }
        return [];
    };
    Temper8.prototype.usedPortsRequest = function () {
        return [0x01, 0x8A, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchUsedPorts = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x01) {
            this.connectSensors(data[4], data[5]);
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.temperatureRequest = function (port) {
        return [0x01, 0x80, 0x01, 0x00, 0x00, port, 0x00, 0x00];
    };
    Temper8.prototype.matchTemperature = function (data) {
        if (data.length === 8
            && data[0] === 0x80
            && data[1] === 0x08
            && data[2] === 0x01) {
            logger_1.log.debug('+++ matchTemperature, data: %d', data);
            var port = data[4];
            var msb = data[5];
            var lsb = data[6];
            var temperatureCelsius = this.GetTemperature(msb, lsb);
            this.updateSensor(port, temperatureCelsius);
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.GetTemperature = function (msb, lsb) {
        var temperature = 0.0;
        var reading = (lsb & 0xFF) + (msb << 8);
        var result = 1;
        if ((reading & 0x8000) > 0) {
            reading = (reading ^ 0xffff) + 1;
            result = -1;
        }
        temperature = result * reading / 16.0;
        return temperature;
    };
    Temper8.prototype.check03Request = function () {
        return [0x01, 0x8A, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchCheck03 = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x03) {
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.check05Request = function () {
        return [0x01, 0x8A, 0x01, 0x05, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchCheck05 = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x05) {
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.check0DRequest = function () {
        return [0x01, 0x8A, 0x01, 0x0D, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchCheck0D = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x0D) {
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.matchCheckFF = function (data) {
        if (data.length === 8
            && data[0] === 0xFF
            && data[1] === 0xFF
            && data[2] === 0xFF
            && data[3] === 0xFF) {
            return true;
        }
        else {
            return false;
        }
    };
    return Temper8;
}(sensor_state_1.SensorState));
exports.Temper8 = Temper8;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdGVtcGVyLTgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQ0EsK0NBQTZDO0FBRzdDLHNDQUFrQztBQU1sQztJQUE2QiwyQkFBVztJQUF4QztRQUFBLHFFQWlNQztRQTFMYSxnQkFBVSxHQUFXLENBQUMsQ0FBQzs7SUEwTHJDLENBQUM7SUF0TFUsNEJBQVUsR0FBakI7UUFHSSxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztRQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFLTSw0QkFBVSxHQUFqQixVQUFrQixJQUFjO1FBQzVCLElBQUk7WUFDQSxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzNCLFlBQUcsQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQy9DLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFDcEYsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7Z0JBQ3JCLE9BQU8sUUFBUSxDQUFDO2FBRW5CO2lCQUFNLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNwQyxZQUFHLENBQUMsS0FBSyxDQUFDLCtCQUErQixFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNqRCxJQUFJLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7b0JBQ3ZDLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElB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QUFJO2VBQ2hCLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO2VBQ2hCLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO2VBQ2hCLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDckIsT0FBTyxJQUFJLENBQUM7U0FDZjthQUFNO1lBQ0gsT0FBTyxLQUFLLENBQUM7U0FDaEI7SUFDTCxDQUFDO0lBRUwsY0FBQztBQUFELENBak1BLEFBaU1DLENBak00QiwwQkFBVyxHQWlNdkM7QUFqTVksMEJBQU8iLCJmaWxlIjoibW9kZWxzL3RlbXBlci04LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IFNlbnNvclN0YXRlIH0gZnJvbSAnLi9zZW5zb3Itc3RhdGUnO1xyXG5pbXBvcnQgeyBSZXBvcnRQYXJzZXIgfSBmcm9tICcuL3VzYi1jb250cm9sbGVyJztcclxuXHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vLi4vbG9nZ2VyJztcclxuXHJcblxyXG4vLyBUZW1wZXI4IHBhcnNlciB1bmRlcnN0YW5kcyBISUQgcmVwb3J0cyBmcm9tIFRlbXBlcjggZGV2aWNlc1xyXG4vLyBJbmRlcGVuZGVudCBvZiBVU0IgbGliIHVzZWQuXHJcblxyXG5leHBvcnQgY2xhc3MgVGVtcGVyOCBleHRlbmRzIFNlbnNvclN0YXRlIGltcGxlbWVudHMgUmVwb3J0UGFyc2VyIHtcclxuICAgIC8vIERldmljZSBoYXMgOCBwb3J0cywgZWFjaCBvZiB3aGljaCBjYW4gaG9sZCBhIDEtd2lyZSB0ZW1wZXJhdHVyZSBzZW5zb3JcclxuICAgIC8vIFRoZSBzZW5zb3JzIGFyZSBwb2xsZWQgaW4gc2VxdWVuY2UsIHN0YXJ0aW5nIGZyb20gcG9ydCAwIHRvIHBvcnQgNy5cclxuICAgIC8vIFdlIGRvIG5vdCBrbm93IGhvdyBtYW55IHNlbnNvcnMgYXJlIGNvbm5lY3RlZCB1bnRpbCB3ZSByZWNlaXZlZCB0aGUgY29uZmlnXHJcbiAgICAvLyBpbiBhIFVTQiBISUQgcmVwb3J0XHJcblxyXG4gICAgLy8gVHJhY2sgd2hhdCBzZW5zb3Igd2Ugc2hvdWxkIHJlcXVlc3QgdmFsdWUgZnJvbSBuZXh0IHRpbWVcclxuICAgIHByb3RlY3RlZCBuZXh0U2Vuc29yOiBudW1iZXIgPSAwO1xyXG5cclxuICAgIC8vIEludGVyZmFjZSBtZXRob2RzIGltcGxlbWVudGF0aW9uXHJcblxyXG4gICAgcHVibGljIGluaXRSZXBvcnQoKTogbnVtYmVyW11bXSB7XHJcbiAgICAvLyBUaGlzIHN0YXJ0cyB0aGUgcG9sbGluZy4gRmlyc3Qgd2UgYXNrIHRoZSBkZXZpY2UgYWJvdXQgc2Vuc29ycyBhdHRhY2hlZCBjb25maWd1cmF0aW9uXHJcbiAgICAvLyBXZSBhbHNvIHJlcXVlc3QgdGVtcGVyYXR1cmUgZnJvbSBwb3J0IHplcm8gKGZvciB0aGUgc2FrZSBvZiBpdCwgdW5jbGVhciByZWFzb24pXHJcbiAgICAgICAgdGhpcy5uZXh0U2Vuc29yID0gMDtcclxuICAgICAgICByZXR1cm4gW3RoaXMudXNlZFBvcnRzUmVxdWVzdCgpLCB0aGlzLnRlbXBlcmF0dXJlUmVxdWVzdCh0aGlzLm5leHRTZW5zb3IpXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUaGlzIGZ1bmN0aW9uIHBhcnNlcyBhbGwgaW5wdXQgcmVwb3J0cyBhbmQgY2hlY2sgd2hhdCB0byBkb1xyXG4gICAgLy8gV2UgYXJlIGludGVyZXN0ZWQgaW4gdHdvIHR5cGVzIG9mIGRhdGEgZnJvbSB0aGUgZGV2aWNlOiB3aGljaCBwb3J0cyBhcmUgdXNlZCBhbmRcclxuICAgIC8vIHRoZSB0ZW1wZXJhdHVyZSBvZiB0aGUgc2Vuc29ycyBjb25uZWN0ZWQuXHJcbiAgICBwdWJsaWMgcGFyc2VJbnB1dChkYXRhOiBudW1iZXJbXSk6IG51bWJlcltdIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tYXRjaFVzZWRQb3J0cyhkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCcrKysgVGVtcGVyOC5tYXRjaFVzZWRQb3J0czonLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gdGhpcy50ZW1wZXJhdHVyZVJlcXVlc3QodGhpcy5zZW5zb3JzW3RoaXMubmV4dFNlbnNvcl0ucy5nZXRQb3J0KCkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5uZXh0U2Vuc29yICs9IDE7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWF0Y2hUZW1wZXJhdHVyZShkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCcrKysgVGVtcGVyOC5tYXRjaFRlbXBlcmF0dXJlOicsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubmV4dFNlbnNvciA8IHRoaXMuc2Vuc29ycy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMudGVtcGVyYXR1cmVSZXF1ZXN0KHRoaXMuc2Vuc29yc1t0aGlzLm5leHRTZW5zb3JdLnMuIGdldFBvcnQoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXh0U2Vuc29yICs9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXh0U2Vuc29yID0gMDtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVjazAzUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWF0Y2hDaGVjazAzKGRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVjazA1UmVxdWVzdCgpO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1hdGNoQ2hlY2swNShkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2swRFJlcXVlc3QoKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1hdGNoQ2hlY2swRChkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWF0Y2hDaGVja0ZGKGRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJyoqKiBUZW1wZXI4Lm1hdGNoQ2hlY2tGRjogcmVzdGFydD8nKTtcclxuICAgICAgICAgICAgICAgIC8vIFRoaXMgaW5kaWNhdGVzIGZhdWx0IGRldmljZVxyXG4gICAgICAgICAgICAgICAgLy8gRG9uJ3Qga25vdyB3aGV0aGVyIHRoZXJlIGlzIGEgd2F5IHRvIHJlY292ZXJcclxuICAgICAgICAgICAgICAgIC8vIE1heWJlIHJlc3RhcnRpbmcgdGhlIGRldmljZSBpcyBuZWNlc3NhcnkuXHJcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignKioqIFRlbXBlcjgubWF0Y2hDaGVja0ZGJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGxvZy5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRlbXBlciA4IHNwZWNpZmljIG1ldGhvZHNcclxuICAgIC8vIFBvbGwgdXNlZCBwb3J0c1xyXG4gICAgcHJpdmF0ZSB1c2VkUG9ydHNSZXF1ZXN0KCk6IG51bWJlcltdIHtcclxuICAgICAgICByZXR1cm4gWzB4MDEsIDB4OEEsIDB4MDEsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgbWF0Y2hVc2VkUG9ydHMoZGF0YTogbnVtYmVyW10pOiBib29sZWFuIHtcclxuICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIGlucHV0IHJlcG9ydCBzdGF0ZXMgc2Vuc29yc1xyXG4gICAgICAgIC8vIGNvbm5lY3RlZCB0byB0aGUgdGhpcy4gVGhlc2UgaGV4IHZhbHVlcyB3ZXJlIGZvdW5kIGJ5IHVzaW5nIHVzaW5nIFVTQmx5emVyXHJcbiAgICAgICAgLy8gSS5lLiB0aGV5IG1pZ2h0IGJlIGRpZmZlcmVudCBvbiB5b3VyIERldmljZSBkZXZpY2VcclxuXHJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMF0gPT09IDB4OEFcclxuICAgICAgICAgICAgJiYgZGF0YVsxXSA9PT0gMHgwOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzJdID09PSAweDAxXHJcbiAgICAgICAgICAgICYmIGRhdGFbM10gPT09IDB4MDEpIHtcclxuXHJcbiAgICAgICAgICAgIC8vIEJ5dGUgNCBjb250YWlucyBubyBvZiBzZW5zb3JzIGFuZFxyXG4gICAgICAgICAgICAvLyBCeXRlIDUgY29udGFpbnMgYSBiaXQgYXJyYXkgb2YgY29ubmVjdGVkIHNlbnNvcnNcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0U2Vuc29ycyhkYXRhWzRdLCBkYXRhWzVdKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIFBvbGwgdGVtcGVyYXR1cmUgYW5kIHVwZGF0ZSBzZW5zb3IgZGF0YVxyXG4gICAgcHJpdmF0ZSB0ZW1wZXJhdHVyZVJlcXVlc3QocG9ydDogbnVtYmVyKTogbnVtYmVyW10ge1xyXG4gICAgICAgIHJldHVybiBbMHgwMSwgMHg4MCwgMHgwMSwgMHgwMCwgMHgwMCwgcG9ydCwgMHgwMCwgMHgwMF07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBtYXRjaFRlbXBlcmF0dXJlKGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgLy8gZ2V0IHRoZSB0ZW1wZXJhdHVyZSBhbmQgdXBkYXRlIHNlbnNvciB2YWx1ZVxyXG5cclxuICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIEhJRCBpbnB1dCByZXBvcnQgaXMgYSB0ZW1wZXJhdHVyZSByZXBvcnQsXHJcbiAgICAgICAgLy8gVGhlc2UgaGV4IHZhbHVlcyB3ZXJlIGZvdW5kIGJ5IGFuYWx5emluZyBVU0IgdXNpbmcgVVNCbHl6ZXIuXHJcbiAgICAgICAgLy8gSS5lLiB0aGV5IG1pZ2h0IGJlIGRpZmZlcmVudCBvbiB5b3VyIERldmljZSBkZXZpY2VcclxuICAgICAgICAvLyBieXRlIDQgY29udGFpbnMgdGhlIHBvcnQgbnVtYmVyLlxyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweDgwXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4MDhcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHgwMSkge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoJysrKyBtYXRjaFRlbXBlcmF0dXJlLCBkYXRhOiAlZCcsIGRhdGEpO1xyXG4gICAgICAgICAgICBjb25zdCBwb3J0OiBudW1iZXIgPSBkYXRhWzRdO1xyXG4gICAgICAgICAgICBjb25zdCBtc2I6IG51bWJlciA9IGRhdGFbNV07XHJcbiAgICAgICAgICAgIGNvbnN0IGxzYjogbnVtYmVyID0gZGF0YVs2XTtcclxuICAgICAgICAgICAgY29uc3QgdGVtcGVyYXR1cmVDZWxzaXVzOiBudW1iZXIgPSB0aGlzLkdldFRlbXBlcmF0dXJlKG1zYiwgbHNiKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU2Vuc29yKHBvcnQsIHRlbXBlcmF0dXJlQ2Vsc2l1cyk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBHZXRUZW1wZXJhdHVyZShtc2I6IG51bWJlciwgbHNiOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCB0ZW1wZXJhdHVyZTogbnVtYmVyID0gMC4wO1xyXG5cclxuICAgICAgICBsZXQgcmVhZGluZzogbnVtYmVyID0gKGxzYiAmIDB4RkYpICsgKG1zYiA8PCA4KTtcclxuXHJcbiAgICAgICAgLy8gQXNzdW1lIHBvc2l0aXZlIHRlbXBlcmF0dXJlIHZhbHVlXHJcbiAgICAgICAgbGV0IHJlc3VsdDogbnVtYmVyID0gMTtcclxuXHJcbiAgICAgICAgaWYgKChyZWFkaW5nICYgMHg4MDAwKSA+IDApIHtcclxuICAgICAgICAgICAgLy8gQmVsb3cgemVyb1xyXG4gICAgICAgICAgICAvLyBnZXQgdGhlIGFic29sdXRlIHZhbHVlIGJ5IGNvbnZlcnRpbmcgdHdvJ3MgY29tcGxlbWVudFxyXG4gICAgICAgICAgICByZWFkaW5nID0gKHJlYWRpbmcgXiAweGZmZmYpICsgMTtcclxuXHJcbiAgICAgICAgICAgIC8vIFJlbWVtYmVyIGEgbmVnYXRpdmUgcmVzdWx0XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IC0xO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVGhlIGVhc3Qgc2lnbmlmaWNhbnQgYml0IGlzIDJeLTQgc28gd2UgbmVlZCB0byBkaXZpZGUgYnkgMTYgdG8gZ2V0IGFic29sdXRlIHRlbXBlcmF0dXJlIGluIENlbHNpdXNcclxuICAgICAgICAvLyBNdWx0aXBseSBpbiB0aGUgcmVzdWx0IHRvIGdldCB3aGV0aGVyIHRoZSB0ZW1wZXJhdHVyZSBpcyBiZWxvdyB6ZXJvIGRlZ3JlZXMgYW5kIGNvbnZlcnQgdG9cclxuICAgICAgICAvLyBmbG9hdGluZyBwb2ludFxyXG4gICAgICAgIHRlbXBlcmF0dXJlID0gcmVzdWx0ICogcmVhZGluZyAvIDE2LjA7XHJcblxyXG4gICAgICAgIHJldHVybiB0ZW1wZXJhdHVyZTtcclxuICAgIH1cclxuICAgIC8vIFBvbGwgY2hlY2tzXHJcbiAgICBwcml2YXRlICBjaGVjazAzUmVxdWVzdCgpIHtcclxuICAgICAgICByZXR1cm4gWzB4MDEsIDB4OEEsIDB4MDEsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgbWF0Y2hDaGVjazAzKGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMF0gPT09IDB4OEFcclxuICAgICAgICAgICAgJiYgZGF0YVsxXSA9PT0gMHgwOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzJdID09PSAweDAxXHJcbiAgICAgICAgICAgICYmIGRhdGFbM10gPT09IDB4MDMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgY2hlY2swNVJlcXVlc3QoKSB7XHJcbiAgICAgICAgcmV0dXJuIFsweDAxLCAweDhBLCAweDAxLCAweDA1LCAweDAwLCAweDAwLCAweDAwLCAweDAwXTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgIG1hdGNoQ2hlY2swNShkYXRhOiBudW1iZXJbXSkge1xyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweDhBXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4MDhcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHgwMVxyXG4gICAgICAgICAgICAmJiBkYXRhWzNdID09PSAweDA1KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBjaGVjazBEUmVxdWVzdCgpIHtcclxuICAgICAgICByZXR1cm4gWzB4MDEsIDB4OEEsIDB4MDEsIDB4MEQsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgbWF0Y2hDaGVjazBEKGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMF0gPT09IDB4OEFcclxuICAgICAgICAgICAgJiYgZGF0YVsxXSA9PT0gMHgwOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzJdID09PSAweDAxXHJcbiAgICAgICAgICAgICYmIGRhdGFbM10gPT09IDB4MEQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIHByaXZhdGUgIGNoZWNrRkZSZXF1ZXN0KCkge1xyXG4gICAgLy8gICAgIHJldHVybiBbMHhGRiwgMHhGRiwgMHhGRiwgMHhGRiwgMHhGRiwgMHhGRiwgMHhGRiwgMHhGRl07XHJcbiAgICAvLyB9XHJcbiAgICBwcml2YXRlICBtYXRjaENoZWNrRkYoZGF0YTogbnVtYmVyW10pIHtcclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDhcclxuICAgICAgICAgICAgJiYgZGF0YVswXSA9PT0gMHhGRlxyXG4gICAgICAgICAgICAmJiBkYXRhWzFdID09PSAweEZGXHJcbiAgICAgICAgICAgICYmIGRhdGFbMl0gPT09IDB4RkZcclxuICAgICAgICAgICAgJiYgZGF0YVszXSA9PT0gMHhGRikge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=
