"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var sensor_1 = require("./sensor");
var Temper8 = (function () {
    function Temper8() {
        this.sensors = [];
        this.nextSensor = 0;
        this.unrecoverableError = false;
    }
    Temper8.prototype.initReport = function () {
        return [this.usedPortsRequest(), this.temperatureRequest(0)];
    };
    Temper8.prototype.parseInput = function (data) {
        try {
            if (this.matchUsedPorts(data)) {
                var response = this.temperatureRequest(this.sensors[this.nextSensor].port());
                this.nextSensor += 1;
                return response;
            }
            else if (this.matchTemperature(data)) {
                if (this.nextSensor < this.sensors.length) {
                    var response = this.temperatureRequest(this.sensors[this.nextSensor].port());
                    this.nextSensor += 1;
                    return response;
                }
                else {
                    this.nextSensor = 0;
                    return this.check03Request();
                }
            }
            else if (this.matchCheck03(data)) {
                return this.check05Request();
            }
            else if (this.matchCheck05(data)) {
                return this.check0DRequest();
            }
            else if (this.matchCheck0D(data)) {
                return [];
            }
            else if (this.matchCheckFF(data)) {
                console.log('--matchCheckFF: restart');
                this.updateOnErrorListeners();
                return [];
            }
        }
        catch (e) {
            console.log(e);
        }
        return [];
    };
    Temper8.prototype.getSensorData = function () {
        return this.sensors.slice();
    };
    Temper8.prototype.addSensorDataListener = function (onSensorDataReceived) {
        this.sensorDataListeners.push(onSensorDataReceived);
    };
    Temper8.prototype.addUnrecoverableErrorListener = function (onError) {
        this.errorListeners.push(onError);
    };
    Temper8.prototype.updateSensorDataListeners = function (sensorData) {
        for (var _i = 0, _a = this.sensorDataListeners; _i < _a.length; _i++) {
            var publish = _a[_i];
            publish(sensorData);
        }
    };
    Temper8.prototype.updateOnErrorListeners = function () {
        if (!this.unrecoverableError) {
            this.unrecoverableError = true;
            for (var _i = 0, _a = this.errorListeners; _i < _a.length; _i++) {
                var publish = _a[_i];
                publish();
            }
        }
    };
    Temper8.prototype.updateSensor = function (port, temperature) {
        if (this.sensors != null) {
            var sensor = this.sensors.find(function (s) { return s.port() === port; });
            if (sensor) {
                sensor.setValue(temperature);
                this.updateSensorDataListeners([sensor]);
                console.log('+updateSensor, port: %d, temperature %d', port, temperature);
            }
            else {
                console.error('-updateSensor - sensor undefined, port: %d, temperature %d', port, temperature);
            }
        }
        else {
            console.error('-updateSensor - no sensors, port: %d, temperature %d', port, temperature);
        }
    };
    Temper8.prototype.connectSensors = function (total, used) {
        console.log('connectSensors, total:%d', total);
        if (this.sensors.length === 0) {
            this.sensors = Array(total);
            var bits = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80];
            var sensor = 0;
            for (var port = 0; port < bits.length; port++) {
                if ((used & bits[port]) === bits[port]) {
                    this.sensors[sensor] = new sensor_1.Sensor(port);
                    console.log('connectSensors, port:%d', port);
                    sensor += 1;
                }
            }
            if (sensor !== total) {
                return;
            }
        }
    };
    Temper8.prototype.usedPortsRequest = function () {
        return [0x01, 0x8A, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchUsedPorts = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x01) {
            this.unrecoverableError = false;
            this.connectSensors(data[4], data[5]);
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.temperatureRequest = function (port) {
        return [0x01, 0x80, 0x01, 0x00, 0x00, port, 0x00, 0x00];
    };
    Temper8.prototype.matchTemperature = function (data) {
        if (data.length === 8
            && data[0] === 0x80
            && data[1] === 0x08
            && data[2] === 0x01) {
            console.log('+matchTemperature, data: %d', JSON.stringify(data));
            var port = data[4];
            var msb = data[5];
            var lsb = data[6];
            var temperatureCelsius = this.GetTemperature(msb, lsb);
            this.updateSensor(port, temperatureCelsius);
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.GetTemperature = function (msb, lsb) {
        var temperature = 0.0;
        var reading = (lsb & 0xFF) + (msb << 8);
        var result = 1;
        if ((reading & 0x8000) > 0) {
            reading = (reading ^ 0xffff) + 1;
            result = -1;
        }
        temperature = result * reading / 16.0;
        return temperature;
    };
    Temper8.prototype.check03Request = function () {
        return [0x01, 0x8A, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchCheck03 = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x03) {
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.check05Request = function () {
        return [0x01, 0x8A, 0x01, 0x05, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchCheck05 = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x05) {
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.check0DRequest = function () {
        return [0x01, 0x8A, 0x01, 0x0D, 0x00, 0x00, 0x00, 0x00];
    };
    Temper8.prototype.matchCheck0D = function (data) {
        if (data.length === 8
            && data[0] === 0x8A
            && data[1] === 0x08
            && data[2] === 0x01
            && data[3] === 0x0D) {
            return true;
        }
        else {
            return false;
        }
    };
    Temper8.prototype.checkFFRequest = function () {
        return [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF];
    };
    Temper8.prototype.matchCheckFF = function (data) {
        if (data.length === 8
            && data[0] === 0xFF
            && data[1] === 0xFF
            && data[2] === 0xFF
            && data[3] === 0xFF) {
            return true;
        }
        else {
            return false;
        }
    };
    return Temper8;
}());
exports.Temper8 = Temper8;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdGVtcGVyOC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLG1DQUFrQztBQU1sQztJQUFBO1FBS2EsWUFBTyxHQUFZLEVBQUUsQ0FBQztRQUV0QixlQUFVLEdBQVcsQ0FBQyxDQUFDO1FBR3hCLHVCQUFrQixHQUFHLEtBQUssQ0FBQztJQXVQdkMsQ0FBQztJQXBQVSw0QkFBVSxHQUFqQjtRQUNJLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFJTSw0QkFBVSxHQUFqQixVQUFrQixJQUFjO1FBQzVCLElBQUksQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDL0UsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7Z0JBQ3JCLE1BQU0sQ0FBQyxRQUFRLENBQUM7WUFFcEIsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDeEMsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQy9FLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDO29CQUNyQixNQUFNLENBQUMsUUFBUSxDQUFDO2dCQUVwQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO29CQUNwQixNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUNqQyxDQUFDO1lBQ0wsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUVqQyxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBRWpDLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFFZCxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUVqQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7Z0JBQ3ZDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO2dCQUM5QixNQUFNLENBQUMsRUFBRSxDQUFDO1lBQ2QsQ0FBQztRQUNMLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQixDQUFDO1FBQ0QsTUFBTSxDQUFDLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFHTSwrQkFBYSxHQUFwQjtRQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFDTSx1Q0FBcUIsR0FBNUIsVUFBNkIsb0JBQWdEO1FBQ3pFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUUsb0JBQW9CLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBQ00sK0NBQTZCLEdBQXBDLFVBQXFDLE9BQWtCO1FBQ25ELElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFHTywyQ0FBeUIsR0FBakMsVUFBa0MsVUFBb0I7UUFDbEQsR0FBRyxDQUFDLENBQWtCLFVBQXdCLEVBQXhCLEtBQUEsSUFBSSxDQUFDLG1CQUFtQixFQUF4QixjQUF3QixFQUF4QixJQUF3QjtZQUF6QyxJQUFNLE9BQU8sU0FBQTtZQUNkLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUN2QjtJQUNMLENBQUM7SUFDTyx3Q0FBc0IsR0FBOUI7UUFFSSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztZQUMvQixHQUFHLENBQUMsQ0FBa0IsVUFBbUIsRUFBbkIsS0FBQSxJQUFJLENBQUMsY0FBYyxFQUFuQixjQUFtQixFQUFuQixJQUFtQjtnQkFBcEMsSUFBTSxPQUFPLFNBQUE7Z0JBQ2QsT0FBTyxFQUFFLENBQUM7YUFDYjtRQUNMLENBQUM7SUFDTCxDQUFDO0lBQ1EsOEJBQVksR0FBckIsVUFBc0IsSUFBWSxFQUFFLFdBQW1CO1FBQ25ELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN2QixJQUFNLE1BQU0sR0FBdUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssSUFBSSxFQUFqQixDQUFpQixDQUFDLENBQUM7WUFFN0UsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDVCxNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLHlDQUF5QyxFQUFFLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztZQUM5RSxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osT0FBTyxDQUFDLEtBQUssQ0FBQyw0REFBNEQsRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDbkcsQ0FBQztRQUNMLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0RBQXNELEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQzdGLENBQUM7SUFDTCxDQUFDO0lBQ1EsZ0NBQWMsR0FBdkIsVUFBd0IsS0FBYSxFQUFFLElBQVk7UUFDL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTVCLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFTLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLElBQU0sSUFBSSxHQUFhLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3hFLElBQUksTUFBTSxHQUFXLENBQUMsQ0FBQztZQUd2QixHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztnQkFFNUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDN0MsTUFBTSxJQUFJLENBQUMsQ0FBQztnQkFDaEIsQ0FBQztZQUNMLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFFbkIsTUFBTSxDQUFDO1lBQ1gsQ0FBQztRQUNMLENBQUM7SUFFTCxDQUFDO0lBSU8sa0NBQWdCLEdBQXhCO1FBQ0ksTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFDUSxnQ0FBYyxHQUF2QixVQUF3QixJQUFjO1FBS2xDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQztlQUNkLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO2VBQ2hCLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO2VBQ2hCLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO2VBQ2hCLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7WUFHaEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBRU8sb0NBQWtCLEdBQTFCLFVBQTJCLElBQVk7UUFDbkMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFDUSxrQ0FBZ0IsR0FBekIsVUFBMEIsSUFBYztRQU9wQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUM7ZUFDZCxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSTtlQUNoQixJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSTtlQUNoQixJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNqRSxJQUFNLElBQUksR0FBVyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0IsSUFBTSxHQUFHLEdBQVcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVCLElBQU0sR0FBRyxHQUFXLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixJQUFNLGtCQUFrQixHQUFXLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRWpFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUM7WUFDNUMsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBQ1EsZ0NBQWMsR0FBdkIsVUFBd0IsR0FBVyxFQUFFLEdBQVc7UUFDNUMsSUFBSSxXQUFXLEdBQVcsR0FBRyxDQUFDO1FBRTlCLElBQUksT0FBTyxHQUFXLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBR2hELElBQUksTUFBTSxHQUFXLENBQUMsQ0FBQztRQUV2QixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBR3pCLE9BQU8sR0FBRyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFHakMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hCLENBQUM7UUFLRCxXQUFXLEdBQUcsTUFBTSxHQUFHLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFFdEMsTUFBTSxDQUFDLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBRVEsZ0NBQWMsR0FBdkI7UUFDSSxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUNRLDhCQUFZLEdBQXJCLFVBQXNCLElBQWM7UUFDaEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDO2VBQ2QsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBQ08sZ0NBQWMsR0FBdEI7UUFDSSxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUNRLDhCQUFZLEdBQXJCLFVBQXNCLElBQWM7UUFDaEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDO2VBQ2QsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBQ1EsZ0NBQWMsR0FBdkI7UUFDSSxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUNRLDhCQUFZLEdBQXJCLFVBQXNCLElBQWM7UUFDaEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDO2VBQ2QsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBQ1EsZ0NBQWMsR0FBdkI7UUFDSSxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUNRLDhCQUFZLEdBQXJCLFVBQXNCLElBQWM7UUFDaEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDO2VBQ2QsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7ZUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0lBRUwsY0FBQztBQUFELENBalFBLEFBaVFDLElBQUE7QUFqUVksMEJBQU8iLCJmaWxlIjoibW9kZWxzL3RlbXBlcjguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHsgU2Vuc29yIH0gZnJvbSAnLi9zZW5zb3InO1xyXG5pbXBvcnQgeyBSZXBvcnRQYXJzZXIgfSBmcm9tICcuL3VzYi1zZW5zb3InO1xyXG5cclxuXHJcbi8vIFRlbXBlcjggcGFyc2VyIHVuZGVyc3RhbmRzIEhJRCByZXBvcnRzIGZyb20gVGVtcGVyOCBkZXZpY2VzXHJcbi8vIEluZGVwZW5kZW50IG9mIFVTQiBsaWIgdXNlZC5cclxuZXhwb3J0IGNsYXNzIFRlbXBlcjggaW1wbGVtZW50cyBSZXBvcnRQYXJzZXIge1xyXG5cclxuXHJcbiAgICAvLyBEZXZpY2UgaGFzIDggcG9ydHMsIGVhY2ggb2Ygd2hpY2ggY2FuIGhvbGQgYSAxLXdpcmUgdGVtcGVyYXR1cmUgc2Vuc29yXHJcbiAgICAvLyBvciBhIGh1bWlkaXR5IHNlbnNvciwgYnV0IHRoZSBsYXR0ZXIgaXMgb3V0IG9mIHNjb3BlLlxyXG4gICAgcHJpdmF0ZSAgc2Vuc29yczogU2Vuc29yW109IFtdO1xyXG4gICAgLy8gcHJpdmF0ZSAgdXNlZFBvcnRzOiBudW1iZXJbXTtcclxuICAgIHByaXZhdGUgIG5leHRTZW5zb3I6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIHNlbnNvckRhdGFMaXN0ZW5lcnM6IEFycmF5PChzZW5zb3I6IFNlbnNvcltdKT0+dm9pZD47XHJcbiAgICBwcml2YXRlIGVycm9yTGlzdGVuZXJzOiBBcnJheTwoKT0+dm9pZD47XHJcbiAgICBwcml2YXRlIHVucmVjb3ZlcmFibGVFcnJvciA9IGZhbHNlO1xyXG5cclxuICAgIC8vIEludGVyZmFjZSBtZXRob2RzIGltcGxlbWVudGF0aW9uXHJcbiAgICBwdWJsaWMgaW5pdFJlcG9ydCgpOiBudW1iZXJbXVtdIHtcclxuICAgICAgICByZXR1cm4gW3RoaXMudXNlZFBvcnRzUmVxdWVzdCgpLCB0aGlzLnRlbXBlcmF0dXJlUmVxdWVzdCgwKV07XHJcbiAgICB9XHJcbiAgICAvLyBUaGlzIGZ1bmN0aW9uIHBhcnNlcyBhbGwgaW5wdXQgcmVwb3J0cyBhbmQgY2hlY2sgd2hhdCB0byBkb1xyXG4gICAgLy8gV2UgYXJlIGludGVyZXN0ZWQgaW4gdHdvIHR5cGVzIG9mIGRhdGEgZnJvbSB0aGUgZGV2aWNlOiB3aGljaCBwb3J0cyBhcmUgdXNlZCBhbmRcclxuICAgIC8vIHRoZSB0ZW1wZXJhdHVyZSBvZiB0aGUgc2Vuc29ycyBjb25uZWN0ZWQuXHJcbiAgICBwdWJsaWMgcGFyc2VJbnB1dChkYXRhOiBudW1iZXJbXSk6IG51bWJlcltdIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tYXRjaFVzZWRQb3J0cyhkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB0aGlzLnRlbXBlcmF0dXJlUmVxdWVzdCh0aGlzLnNlbnNvcnNbdGhpcy5uZXh0U2Vuc29yXS5wb3J0KCkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5uZXh0U2Vuc29yICs9IDE7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWF0Y2hUZW1wZXJhdHVyZShkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubmV4dFNlbnNvciA8IHRoaXMuc2Vuc29ycy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMudGVtcGVyYXR1cmVSZXF1ZXN0KHRoaXMuc2Vuc29yc1t0aGlzLm5leHRTZW5zb3JdLnBvcnQoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXh0U2Vuc29yICs9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXh0U2Vuc29yID0gMDtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVjazAzUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWF0Y2hDaGVjazAzKGRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVjazA1UmVxdWVzdCgpO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1hdGNoQ2hlY2swNShkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2swRFJlcXVlc3QoKTtcclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tYXRjaENoZWNrMEQoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMud3JpdGVVc2VkUG9ydHNSZXF1ZXN0KCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tYXRjaENoZWNrRkYoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgLy8gdGhpcy5jaGVja0ZGUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJy0tbWF0Y2hDaGVja0ZGOiByZXN0YXJ0Jyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU9uRXJyb3JMaXN0ZW5lcnMoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUT0RPOiBDb21tb24gZm9yIGFsbCBzZW5zb3JzID0+IHJlZmFjdG9yXHJcbiAgICBwdWJsaWMgZ2V0U2Vuc29yRGF0YSgpOiBTZW5zb3JbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2Vuc29ycy5zbGljZSgpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGFkZFNlbnNvckRhdGFMaXN0ZW5lcihvblNlbnNvckRhdGFSZWNlaXZlZDogKHNlbnNvcjogU2Vuc29yW10pID0+IHZvaWQpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNlbnNvckRhdGFMaXN0ZW5lcnMucHVzaCAob25TZW5zb3JEYXRhUmVjZWl2ZWQpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGFkZFVucmVjb3ZlcmFibGVFcnJvckxpc3RlbmVyKG9uRXJyb3I6ICgpPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZXJyb3JMaXN0ZW5lcnMucHVzaChvbkVycm9yKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUT0RPOiBPdGhlciBjb21tb24gbWV0aG9kc1xyXG4gICAgcHJpdmF0ZSB1cGRhdGVTZW5zb3JEYXRhTGlzdGVuZXJzKHNlbnNvckRhdGE6IFNlbnNvcltdKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBwdWJsaXNoIG9mIHRoaXMuc2Vuc29yRGF0YUxpc3RlbmVycykge1xyXG4gICAgICAgICAgICBwdWJsaXNoKHNlbnNvckRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgdXBkYXRlT25FcnJvckxpc3RlbmVycygpIHtcclxuICAgICAgICAvLyBQdWJsaXNoIG9uY2Ugb25seVxyXG4gICAgICAgIGlmICghdGhpcy51bnJlY292ZXJhYmxlRXJyb3IpIHtcclxuICAgICAgICAgICAgdGhpcy51bnJlY292ZXJhYmxlRXJyb3IgPSB0cnVlO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHB1Ymxpc2ggb2YgdGhpcy5lcnJvckxpc3RlbmVycykge1xyXG4gICAgICAgICAgICAgICAgcHVibGlzaCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgdXBkYXRlU2Vuc29yKHBvcnQ6IG51bWJlciwgdGVtcGVyYXR1cmU6IG51bWJlcikge1xyXG4gICAgICAgIGlmICh0aGlzLnNlbnNvcnMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBjb25zdCBzZW5zb3I6IFNlbnNvciB8IHVuZGVmaW5lZCA9IHRoaXMuc2Vuc29ycy5maW5kKHMgPT4gcy5wb3J0KCkgPT09IHBvcnQpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHNlbnNvcikge1xyXG4gICAgICAgICAgICAgICAgc2Vuc29yLnNldFZhbHVlKHRlbXBlcmF0dXJlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2Vuc29yRGF0YUxpc3RlbmVycyhbc2Vuc29yXSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnK3VwZGF0ZVNlbnNvciwgcG9ydDogJWQsIHRlbXBlcmF0dXJlICVkJywgcG9ydCwgdGVtcGVyYXR1cmUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignLXVwZGF0ZVNlbnNvciAtIHNlbnNvciB1bmRlZmluZWQsIHBvcnQ6ICVkLCB0ZW1wZXJhdHVyZSAlZCcsIHBvcnQsIHRlbXBlcmF0dXJlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJy11cGRhdGVTZW5zb3IgLSBubyBzZW5zb3JzLCBwb3J0OiAlZCwgdGVtcGVyYXR1cmUgJWQnLCBwb3J0LCB0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgY29ubmVjdFNlbnNvcnModG90YWw6IG51bWJlciwgdXNlZDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Nvbm5lY3RTZW5zb3JzLCB0b3RhbDolZCcsIHRvdGFsKTtcclxuICAgICAgICBpZiAodGhpcy5zZW5zb3JzLmxlbmd0aCA9PT0gMCkge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZW5zb3JzID0gQXJyYXk8U2Vuc29yPih0b3RhbCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpdHM6IG51bWJlcltdID0gWzB4MDEsIDB4MDIsIDB4MDQsIDB4MDgsIDB4MTAsIDB4MjAsIDB4NDAsIDB4ODBdO1xyXG4gICAgICAgICAgICBsZXQgc2Vuc29yOiBudW1iZXIgPSAwO1xyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgdGhlIGJpdCBhcnJheSBmb3IgdXNlZCBwb3J0cywgb25lIGJpdCBhdCBhIHRpbWVcclxuICAgICAgICAgICAgZm9yIChsZXQgcG9ydCA9IDA7IHBvcnQgPCBiaXRzLmxlbmd0aDsgcG9ydCsrKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCh1c2VkICYgYml0c1twb3J0XSkgPT09IGJpdHNbcG9ydF0pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbnNvcnNbc2Vuc29yXSA9IG5ldyBTZW5zb3IocG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Nvbm5lY3RTZW5zb3JzLCBwb3J0OiVkJywgcG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2Vuc29yICs9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzZW5zb3IgIT09IHRvdGFsKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBFcnJvciBoYW5kbGluZ1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvLyBUZW1wZXIgOCBzcGVjaWZpYyBtZXRob2RzXHJcbiAgICAvLyBQb2xsIHVzZWQgcG9ydHNcclxuICAgIHByaXZhdGUgdXNlZFBvcnRzUmVxdWVzdCgpOiBudW1iZXJbXSB7XHJcbiAgICAgICAgcmV0dXJuIFsweDAxLCAweDhBLCAweDAxLCAweDAxLCAweDAwLCAweDAwLCAweDAwLCAweDAwXTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgIG1hdGNoVXNlZFBvcnRzKGRhdGE6IG51bWJlcltdKTogYm9vbGVhbiB7XHJcbiAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSBpbnB1dCByZXBvcnQgc3RhdGVzIHNlbnNvcnNcclxuICAgICAgICAvLyBjb25uZWN0ZWQgdG8gdGhlIHRoaXMuIFRoZXNlIGhleCB2YWx1ZXMgd2VyZSBmb3VuZCBieSB1c2luZyB1c2luZyBVU0JseXplclxyXG4gICAgICAgIC8vIEkuZS4gdGhleSBtaWdodCBiZSBkaWZmZXJlbnQgb24geW91ciBEZXZpY2UgZGV2aWNlXHJcblxyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweDhBXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4MDhcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHgwMVxyXG4gICAgICAgICAgICAmJiBkYXRhWzNdID09PSAweDAxKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5yZWNvdmVyYWJsZUVycm9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgIC8vIEJ5dGUgNCBjb250YWlucyBubyBvZiBzZW5zb3JzIGFuZFxyXG4gICAgICAgICAgICAvLyBCeXRlIDUgY29udGFpbnMgYSBiaXQgYXJyYXkgb2YgY29ubmVjdGVkIHNlbnNvcnNcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0U2Vuc29ycyhkYXRhWzRdLCBkYXRhWzVdKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIFBvbGwgdGVtcGVyYXR1cmUgYW5kIHVwZGF0ZSBzZW5zb3IgZGF0YVxyXG4gICAgcHJpdmF0ZSB0ZW1wZXJhdHVyZVJlcXVlc3QocG9ydDogbnVtYmVyKTogbnVtYmVyW10ge1xyXG4gICAgICAgIHJldHVybiBbMHgwMSwgMHg4MCwgMHgwMSwgMHgwMCwgMHgwMCwgcG9ydCwgMHgwMCwgMHgwMF07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBtYXRjaFRlbXBlcmF0dXJlKGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgLy8gZ2V0IHRoZSB0ZW1wZXJhdHVyZSBhbmQgdXBkYXRlIHNlbnNvciB2YWx1ZVxyXG5cclxuICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIEhJRCBpbnB1dCByZXBvcnQgaXMgYSB0ZW1wZXJhdHVyZSByZXBvcnQsXHJcbiAgICAgICAgLy8gVGhlc2UgaGV4IHZhbHVlcyB3ZXJlIGZvdW5kIGJ5IGFuYWx5emluZyBVU0IgdXNpbmcgVVNCbHl6ZXIuXHJcbiAgICAgICAgLy8gSS5lLiB0aGV5IG1pZ2h0IGJlIGRpZmZlcmVudCBvbiB5b3VyIERldmljZSBkZXZpY2VcclxuICAgICAgICAvLyBieXRlIDQgY29udGFpbnMgdGhlIHBvcnQgbnVtYmVyLlxyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweDgwXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4MDhcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHgwMSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnK21hdGNoVGVtcGVyYXR1cmUsIGRhdGE6ICVkJywgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICAgICAgICBjb25zdCBwb3J0OiBudW1iZXIgPSBkYXRhWzRdO1xyXG4gICAgICAgICAgICBjb25zdCBtc2I6IG51bWJlciA9IGRhdGFbNV07XHJcbiAgICAgICAgICAgIGNvbnN0IGxzYjogbnVtYmVyID0gZGF0YVs2XTtcclxuICAgICAgICAgICAgY29uc3QgdGVtcGVyYXR1cmVDZWxzaXVzOiBudW1iZXIgPSB0aGlzLkdldFRlbXBlcmF0dXJlKG1zYiwgbHNiKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU2Vuc29yKHBvcnQsIHRlbXBlcmF0dXJlQ2Vsc2l1cyk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBHZXRUZW1wZXJhdHVyZShtc2I6IG51bWJlciwgbHNiOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCB0ZW1wZXJhdHVyZTogbnVtYmVyID0gMC4wO1xyXG5cclxuICAgICAgICBsZXQgcmVhZGluZzogbnVtYmVyID0gKGxzYiAmIDB4RkYpICsgKG1zYiA8PCA4KTtcclxuXHJcbiAgICAgICAgLy8gQXN1bWUgcG9zaXRpdmUgdGVtcGVyYXR1cmUgdmFsdWVcclxuICAgICAgICBsZXQgcmVzdWx0OiBudW1iZXIgPSAxO1xyXG5cclxuICAgICAgICBpZiAoKHJlYWRpbmcgJiAweDgwMDApID4gMCkge1xyXG4gICAgICAgICAgICAvLyBCZWxvdyB6ZXJvXHJcbiAgICAgICAgICAgIC8vIGdldCB0aGUgYWJzb2x1dGUgdmFsdWUgYnkgY29udmVydGluZyB0d28ncyBjb21wbGVtZW50XHJcbiAgICAgICAgICAgIHJlYWRpbmcgPSAocmVhZGluZyBeIDB4ZmZmZikgKyAxO1xyXG5cclxuICAgICAgICAgICAgLy8gUmVtZW1iZXIgYSBuZWdhdGl2ZSByZXN1bHRcclxuICAgICAgICAgICAgcmVzdWx0ID0gLTE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBUaGUgZWFzdCBzaWduaWZpY2FudCBiaXQgaXMgMl4tNCBzbyB3ZSBuZWVkIHRvIGRldmlkZSBieSAxNiB0byBnZXQgYWJzb2x1dGUgdGVtcGVyYXR1cmUgaW4gQ2Vsc2l1c1xyXG4gICAgICAgIC8vIE11bHRpcGx5IGluIHRoZSByZXN1bHQgdG8gZ2V0IHdoZXRoZXIgdGhlIHRlbXBlcmF0dXJlIGlzIGJlbG93IHplcm8gZGVncmVlcyBhbmQgY29udmVydCB0b1xyXG4gICAgICAgIC8vIGZsb2F0aW5nIHBvaW50XHJcbiAgICAgICAgdGVtcGVyYXR1cmUgPSByZXN1bHQgKiByZWFkaW5nIC8gMTYuMDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRlbXBlcmF0dXJlO1xyXG4gICAgfVxyXG4gICAgLy8gUG9sbCBjaGVja3NcclxuICAgIHByaXZhdGUgIGNoZWNrMDNSZXF1ZXN0KCkge1xyXG4gICAgICAgIHJldHVybiBbMHgwMSwgMHg4QSwgMHgwMSwgMHgwMywgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMF07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBtYXRjaENoZWNrMDMoZGF0YTogbnVtYmVyW10pIHtcclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDhcclxuICAgICAgICAgICAgJiYgZGF0YVswXSA9PT0gMHg4QVxyXG4gICAgICAgICAgICAmJiBkYXRhWzFdID09PSAweDA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMl0gPT09IDB4MDFcclxuICAgICAgICAgICAgJiYgZGF0YVszXSA9PT0gMHgwMykge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBjaGVjazA1UmVxdWVzdCgpIHtcclxuICAgICAgICByZXR1cm4gWzB4MDEsIDB4OEEsIDB4MDEsIDB4MDUsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgbWF0Y2hDaGVjazA1KGRhdGE6IG51bWJlcltdKSB7XHJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMF0gPT09IDB4OEFcclxuICAgICAgICAgICAgJiYgZGF0YVsxXSA9PT0gMHgwOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzJdID09PSAweDAxXHJcbiAgICAgICAgICAgICYmIGRhdGFbM10gPT09IDB4MDUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgIGNoZWNrMERSZXF1ZXN0KCkge1xyXG4gICAgICAgIHJldHVybiBbMHgwMSwgMHg4QSwgMHgwMSwgMHgwRCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMF07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlICBtYXRjaENoZWNrMEQoZGF0YTogbnVtYmVyW10pIHtcclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDhcclxuICAgICAgICAgICAgJiYgZGF0YVswXSA9PT0gMHg4QVxyXG4gICAgICAgICAgICAmJiBkYXRhWzFdID09PSAweDA4XHJcbiAgICAgICAgICAgICYmIGRhdGFbMl0gPT09IDB4MDFcclxuICAgICAgICAgICAgJiYgZGF0YVszXSA9PT0gMHgwRCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSAgY2hlY2tGRlJlcXVlc3QoKSB7XHJcbiAgICAgICAgcmV0dXJuIFsweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGLCAweEZGXTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgIG1hdGNoQ2hlY2tGRihkYXRhOiBudW1iZXJbXSkge1xyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gOFxyXG4gICAgICAgICAgICAmJiBkYXRhWzBdID09PSAweEZGXHJcbiAgICAgICAgICAgICYmIGRhdGFbMV0gPT09IDB4RkZcclxuICAgICAgICAgICAgJiYgZGF0YVsyXSA9PT0gMHhGRlxyXG4gICAgICAgICAgICAmJiBkYXRhWzNdID09PSAweEZGKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==
