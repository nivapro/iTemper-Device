"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var HID = require("node-hid");
var os = require("os");
var sensor_1 = require("./sensor");
var Device = (function () {
    function Device() {
        Device.initialize();
    }
    Device.initialize = function () {
        if (!Device._deviceInitialized) {
            var _devices = HID.devices();
            var deviceInfo = _devices.find(function (d) {
                var VID = 0x0C45;
                var PID = 0x7401;
                var TEMPER_GOLD = 'TEMPerV1.4';
                var INTERFACE = 1;
                Device._temperGold = d.product !== undefined && d.product === TEMPER_GOLD;
                var isTemper = d.vendorId === VID && d.productId === PID;
                return isTemper && Device._temperGold && d.interface === INTERFACE;
            });
            if ((deviceInfo !== undefined) && (deviceInfo.path !== undefined)) {
                Device._hid1 = new HID.HID(deviceInfo.path);
                Device._hid1.on('data', Device.parseInput);
                Device._hid1.on('error', Device.parseError);
                Device._interval = setInterval(Device.pollSensors, Device.POLL_INTERVALL);
                Device._deviceInitialized = true;
                Device.connectSensors(1, 1);
                Device.WriteTemperatureRequest(0);
                console.log('+initialized');
            }
        }
    };
    Device.close = function () {
        Device._nextSensor = 0;
        Device._deviceInitialized = false;
        try {
            Device._hid1.pause();
            Device._hid1.close();
        }
        catch (e) {
            return;
        }
    };
    Device.pollSensors = function () {
        if (!Device._deviceInitialized) {
            Device.initialize();
        }
        else {
            Device.WriteTemperatureRequest(0);
        }
    };
    Device.getSensorData = function () {
        return Device._sensors.slice();
    };
    Device.parseError = function (_error) {
        return;
    };
    Device.parseInput = function (data) {
        try {
            if (Device.matchTemperature(data)) {
                Device._lastInputTime = Date.now();
            }
            else {
                console.warn('--no match: ', JSON.stringify(data));
            }
        }
        catch (e) {
            console.log(e);
        }
    };
    Device.writeRequest = function (data) {
        if (os.platform() === 'win32') {
            data.unshift(0);
        }
        for (var i = 0; i < 1; i++) {
            try {
                Device._hid1.write(data);
            }
            catch (e) {
                console.log('-_hid1.write catch:&d', JSON.stringify(data));
                Device.close();
            }
        }
    };
    Device.connectSensors = function (total, used) {
        console.log('connectSensors, total:%d', total);
        if (Device._sensors.length === 0) {
            Device._sensors = Array(total);
            var bits = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80];
            var sensor = 0;
            for (var port = 0; port < bits.length; port++) {
                if ((used & bits[port]) === bits[port]) {
                    Device._sensors[sensor] = new sensor_1.Sensor(port);
                    console.log('connectSensors, port:%d', port);
                    sensor += 1;
                }
            }
            if (sensor !== total) {
                return;
            }
        }
    };
    Device.WriteTemperatureRequest = function (port) {
        var data = [0x01, 0x80, 0x33, 0x01, 0x00, 0x00, 0x00, 0x00];
        Device.writeRequest(data);
    };
    Device.matchTemperature = function (data) {
        if (data.length === 8
            && data[0] === 0x80
            && data[1] === 0x02) {
            console.log('+matchTemperature, data: %d', JSON.stringify(data));
            var port = 0;
            var msb = data[2];
            var lsb = data[3];
            var temperatureCelsius = this.GetTemperature(msb, lsb);
            Device.updateSensor(port, temperatureCelsius);
            return true;
        }
        else {
            return false;
        }
    };
    Device.GetTemperature = function (msb, lsb) {
        var temperature = 0.0;
        var reading = (lsb & 0xFF) + (msb << 8);
        var result = 1;
        if ((reading & 0x8000) > 0) {
            reading = (reading ^ 0xffff) + 1;
            result = -1;
        }
        temperature = result * reading / 256.0;
        return temperature;
    };
    Device.updateSensor = function (port, temperature) {
        if (Device._sensors != null) {
            var sensor = Device._sensors.find(function (s) { return s.port() === port; });
            if (sensor) {
                sensor.setValue(temperature);
                console.log('+updateSensor, port: %d, temperature %d', port, temperature);
            }
            else {
                console.error('-updateSensor - sensor undefined, port: %d, temperature %d', port, temperature);
            }
        }
        else {
            console.error('-updateSensor - no sensors, port: %d, temperature %d', port, temperature);
        }
    };
    Device.POLL_INTERVALL = 5000;
    Device._sensors = [];
    Device._deviceInitialized = false;
    Device._nextSensor = 0;
    Device._lastInputTime = Date.now();
    Device._temperGold = false;
    return Device;
}());
exports.Device = Device;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvdGVtcGVyR29sZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDhCQUFpQztBQUNqQyx1QkFBMEI7QUFDMUIsbUNBQWtDO0FBRWxDO0lBaUJJO1FBQ0ksTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFYSxpQkFBVSxHQUF4QjtRQUNJLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztZQUU3QixJQUFNLFFBQVEsR0FBaUIsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRTdDLElBQU0sVUFBVSxHQUEyQixRQUFRLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQztnQkFFdEQsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDO2dCQUNuQixJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUM7Z0JBQ25CLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQztnQkFDakMsSUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO2dCQUVwQixNQUFNLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxPQUFPLEtBQUssU0FBUyxJQUFJLENBQUMsQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDO2dCQUUxRSxJQUFNLFFBQVEsR0FBWSxDQUFDLENBQUMsUUFBUSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsU0FBUyxLQUFLLEdBQUcsQ0FBQztnQkFDcEUsTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDO1lBQ3ZFLENBQUMsQ0FBQyxDQUFDO1lBRUgsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDaEUsTUFBTSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFD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REFBc0QsRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDN0YsQ0FBQztJQUNMLENBQUM7SUFqTnVCLHFCQUFjLEdBQUcsSUFBSSxDQUFDO0lBQy9CLGVBQVEsR0FBWSxFQUFFLENBQUM7SUFHdkIseUJBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLGtCQUFXLEdBQVcsQ0FBQyxDQUFDO0lBRXhCLHFCQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzVCLGtCQUFXLEdBQVksS0FBSyxDQUFDO0lBMk1oRCxhQUFDO0NBek5ELEFBeU5DLElBQUE7QUF6Tlksd0JBQU0iLCJmaWxlIjoibW9kZWxzL3RlbXBlckdvbGQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IEhJRCA9IHJlcXVpcmUoJ25vZGUtaGlkJyk7XHJcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJyk7XHJcbmltcG9ydCB7IFNlbnNvciB9IGZyb20gJy4vc2Vuc29yJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEZXZpY2Uge1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2hpZDE6IEhJRC5ISUQ7ICAvLyByZXByZXNlbnRpbmcgSElEIEludGVyZmFjZSAxIG9uIERldmljZVxyXG5cclxuICAgIC8vIERldmljZSBoYXMgOCBwb3J0cywgZWFjaCBvZiB3aGljaCBjYW4gaG9sZCBhIDEtd2lyZSB0ZW1wZXJhdHVyZSBzZW5zb3JcclxuICAgIC8vIG9yIGEgaHVtaWRpdHkgc2Vuc29yLCBidXQgdGhlIGxhdHRlciBpcyBvdXQgb2Ygc2NvcGUuXHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgUE9MTF9JTlRFUlZBTEwgPSA1MDAwO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX3NlbnNvcnM6IFNlbnNvcltdPSBbXTtcclxuICAgIC8vIHByaXZhdGUgc3RhdGljIF91c2VkUG9ydHM6IG51bWJlcltdO1xyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIF9kZXZpY2VJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX25leHRTZW5zb3I6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaW50ZXJ2YWw6IE5vZGVKUy5UaW1lcjtcclxuICAgIHByaXZhdGUgc3RhdGljIF9sYXN0SW5wdXRUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgIHByaXZhdGUgc3RhdGljIF90ZW1wZXJHb2xkOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIERldmljZS5pbml0aWFsaXplKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBpbml0aWFsaXplKCkge1xyXG4gICAgICAgIGlmICghRGV2aWNlLl9kZXZpY2VJbml0aWFsaXplZCkge1xyXG5cclxuICAgICAgICAgICAgY29uc3QgX2RldmljZXM6IEhJRC5EZXZpY2VbXSA9IEhJRC5kZXZpY2VzKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkZXZpY2VJbmZvOiBISUQuRGV2aWNlIHwgdW5kZWZpbmVkID0gX2RldmljZXMuZmluZChkID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBWSUQgPSAweDBDNDU7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBQSUQgPSAweDc0MDE7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBURU1QRVJfR09MRCA9ICdURU1QZXJWMS40JztcclxuICAgICAgICAgICAgICAgIGNvbnN0IElOVEVSRkFDRSA9IDE7XHJcblxyXG4gICAgICAgICAgICAgICAgRGV2aWNlLl90ZW1wZXJHb2xkID0gZC5wcm9kdWN0ICE9PSB1bmRlZmluZWQgJiYgZC5wcm9kdWN0ID09PSBURU1QRVJfR09MRDtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc1RlbXBlcjogYm9vbGVhbiA9IGQudmVuZG9ySWQgPT09IFZJRCAmJiBkLnByb2R1Y3RJZCA9PT0gUElEO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlzVGVtcGVyICYmIERldmljZS5fdGVtcGVyR29sZCAmJiBkLmludGVyZmFjZSA9PT0gSU5URVJGQUNFO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICgoZGV2aWNlSW5mbyAhPT0gdW5kZWZpbmVkKSAmJiAoZGV2aWNlSW5mby5wYXRoICE9PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuX2hpZDEgPSBuZXcgSElELkhJRChkZXZpY2VJbmZvLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgRGV2aWNlLl9oaWQxLm9uKCdkYXRhJywgRGV2aWNlLnBhcnNlSW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgRGV2aWNlLl9oaWQxLm9uKCdlcnJvcicsIERldmljZS5wYXJzZUVycm9yKTtcclxuICAgICAgICAgICAgICAgIERldmljZS5faW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChEZXZpY2UucG9sbFNlbnNvcnMsIERldmljZS5QT0xMX0lOVEVSVkFMTCk7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuX2RldmljZUluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIERldmljZS5jb25uZWN0U2Vuc29ycygxLDEpO1xyXG4gICAgICAgICAgICAgICAgRGV2aWNlLldyaXRlVGVtcGVyYXR1cmVSZXF1ZXN0KDApO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJytpbml0aWFsaXplZCcpO1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgY2xvc2UoKSB7XHJcbiAgICAgICAgRGV2aWNlLl9uZXh0U2Vuc29yID0gMDtcclxuICAgICAgICBEZXZpY2UuX2RldmljZUluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgRGV2aWNlLl9oaWQxLnBhdXNlKCk7XHJcbiAgICAgICAgICAgIERldmljZS5faGlkMS5jbG9zZSgpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBQb2xscyB0aGUgZGV2aWNlIGJ5IGRvaW5nIHRoZSBmb2xsb3dpbmcgd3JpdGUgYW5kIHJlYWRzIGN5Y2xpY2FsbHlcclxuICAgIC8vIDEuIFdyaXRlIGEgcmVxdWVzdCBhbmQgcmVhZCB1c2VkIHBvcnRzLCBpLmUuIHdoaWNoIHBvcnRzIGhhdmUgYSBzZW5zb3IgY29ubmVjdGVkP1xyXG4gICAgLy8gMi4gV3JpdGUgYSByZXF1ZXN0IGFuZCByZWFkIHRoZSB0ZW1wZXJhdHVyZSBmcm9tIGVhY2ggc2Vuc29yIHN0YXJ0aW5nIGZyb20gcG9ydCAwIHVwIHRvIDdcclxuICAgIC8vIDQuIHJlcGVhdCBhdCByZWd1bGFyIGludGVydmFsc1xyXG4gICAgLy8gQSB0ZW1wZXJhdHVyZSByZWFkIG9mIGEgc2Vuc29yIHRha2VzIGFwcHJveCA4MjAgbXMuIGllIHRoZSBtb3JlIHNlbnNvciB0aGUgbG9uZ2VyIHRpZW0gYmV0d2VlbiBwb2xpaW5nXHJcbiAgICAvLyBlYWNoIGludGVydmFsXHJcblxyXG4gICAgLy8gVGhpcyBmdW5jdGlvbiBkcml2ZXMgdGhlIHBvbGxpbmcgY3ljbGVcclxuICAgIHB1YmxpYyBzdGF0aWMgcG9sbFNlbnNvcnMoKSB7XHJcbiAgICAgICAgaWYgKCEgRGV2aWNlLl9kZXZpY2VJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICBEZXZpY2UuaW5pdGlhbGl6ZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIERldmljZS5Xcml0ZVRlbXBlcmF0dXJlUmVxdWVzdCgwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc3RhdGljIGdldFNlbnNvckRhdGEoKTogU2Vuc29yW10ge1xyXG4gICAgICAgIHJldHVybiBEZXZpY2UuX3NlbnNvcnMuc2xpY2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBwYXJzZUVycm9yKF9lcnJvcjogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gVGhpcyBmdW5jdGlvbiBwYXJzZXMgYWxsIGlucHV0IHJlcG9ydHMgYW5kIGNoZWNrIHdoYXR0byBkaVxyXG4gICAgLy8gV2UgYXJlIGludGVyZXN0ZWQgaW4gdHdvIHR5cGVzIG9mIGRhdGEgZnJvbSB0aGUgZGV2aWNlOiB3aGljaCBwb3J0cyBhcmUgdXNlZCBhbmRcclxuICAgIC8vIHRoZSB0ZW1wZXJhdHVyZSBvZiB0aGUgc2Vuc29ycyBjb25uZWN0ZWQuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBwYXJzZUlucHV0KGRhdGE6IG51bWJlcltdKSB7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChEZXZpY2UubWF0Y2hUZW1wZXJhdHVyZShkYXRhKSkge1xyXG4gICAgICAgICAgICBEZXZpY2UuX2xhc3RJbnB1dFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCctLW5vIG1hdGNoOiAnLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBIZWxwZXIgZnVuY3Rpb25zIHRvIHdyaXRlIHJlcG9ydHMgdG8gdGhlIGRldmljZVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgd3JpdGVSZXF1ZXN0KGRhdGE6IG51bWJlcltdKSB7XHJcblxyXG4gICAgICAgIGlmIChvcy5wbGF0Zm9ybSgpID09PSAnd2luMzInKSB7XHJcbiAgICAgICAgICAgIGRhdGEudW5zaGlmdCgwKTsgIC8vIHByZXBlbmQgYSB0aHJvd2F3YXkgYnl0ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gT3V0cHV0IHJlcG9ydFxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuX2hpZDEud3JpdGUoZGF0YSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCctX2hpZDEud3JpdGUgY2F0Y2g6JmQnLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgICAgICBEZXZpY2UuY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgY29ubmVjdFNlbnNvcnModG90YWw6IG51bWJlciwgdXNlZDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Nvbm5lY3RTZW5zb3JzLCB0b3RhbDolZCcsIHRvdGFsKTtcclxuICAgICAgICBpZiAoRGV2aWNlLl9zZW5zb3JzLmxlbmd0aCA9PT0gMCkge1xyXG5cclxuICAgICAgICAgICAgRGV2aWNlLl9zZW5zb3JzID0gQXJyYXk8U2Vuc29yPih0b3RhbCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpdHM6IG51bWJlcltdID0gWzB4MDEsIDB4MDIsIDB4MDQsIDB4MDgsIDB4MTAsIDB4MjAsIDB4NDAsIDB4ODBdO1xyXG4gICAgICAgICAgICBsZXQgc2Vuc29yOiBudW1iZXIgPSAwO1xyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgdGhlIGJpdCBhcnJheSBmb3IgdXNlZCBwb3J0cywgb25lIGJpdCBhdCBhIHRpbWVcclxuICAgICAgICAgICAgZm9yIChsZXQgcG9ydCA9IDA7IHBvcnQgPCBiaXRzLmxlbmd0aDsgcG9ydCsrKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCh1c2VkICYgYml0c1twb3J0XSkgPT09IGJpdHNbcG9ydF0pIHtcclxuICAgICAgICAgICAgICAgICAgICBEZXZpY2UuX3NlbnNvcnNbc2Vuc29yXSA9IG5ldyBTZW5zb3IocG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Nvbm5lY3RTZW5zb3JzLCBwb3J0OiVkJywgcG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2Vuc29yICs9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzZW5zb3IgIT09IHRvdGFsKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBFcnJvciBoYW5kbGluZ1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvLyBQb2xsIHRlbXBlcmF0dXJlIGFuZCB1cGRhdGUgc2Vuc29yIGRhdGFcclxuICAgIHByaXZhdGUgc3RhdGljIFdyaXRlVGVtcGVyYXR1cmVSZXF1ZXN0KHBvcnQ6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IGRhdGE6IG51bWJlcltdID0gWzB4MDEsIDB4ODAsIDB4MzMsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdO1xyXG4gICAgICAgIERldmljZS53cml0ZVJlcXVlc3QoZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgbWF0Y2hUZW1wZXJhdHVyZShkYXRhOiBudW1iZXJbXSkge1xyXG4gICAgICAgIC8vIGdldCB0aGUgdGVtcGVyYXR1cmUgYW5kIHVwZGF0ZSBzZW5zb3IgdmFsdWVcclxuXHJcbiAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSBISUQgaW5wdXQgcmVwb3J0IGlzIGEgdGVtcGVyYXR1cmUgcmVwb3J0LFxyXG4gICAgICAgIC8vIFRoZXNlIGhleCB2YWx1ZXMgd2VyZSBmb3VuZCBieSBhbmFseXppbmcgVVNCIHVzaW5nIFVTQmx5emVyLlxyXG4gICAgICAgIC8vIEkuZS4gdGhleSBtaWdodCBiZSBkaWZmZXJlbnQgb24geW91ciBEZXZpY2UgZGV2aWNlXHJcbiAgICAgICAgLy8gYnl0ZSA0IGNvbnRhaW5zIHRoZSBwb3J0IG51bWJlci5cclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDhcclxuICAgICAgICAgICAgJiYgZGF0YVswXSA9PT0gMHg4MFxyXG4gICAgICAgICAgICAmJiBkYXRhWzFdID09PSAweDAyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCcrbWF0Y2hUZW1wZXJhdHVyZSwgZGF0YTogJWQnLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvcnQgPSAwO1xyXG4gICAgICAgICAgICBjb25zdCBtc2I6IG51bWJlciA9IGRhdGFbMl07XHJcbiAgICAgICAgICAgIGNvbnN0IGxzYjogbnVtYmVyID0gZGF0YVszXTtcclxuICAgICAgICAgICAgY29uc3QgdGVtcGVyYXR1cmVDZWxzaXVzOiBudW1iZXIgPSB0aGlzLkdldFRlbXBlcmF0dXJlKG1zYiwgbHNiKTtcclxuXHJcbiAgICAgICAgICAgIERldmljZS51cGRhdGVTZW5zb3IocG9ydCwgdGVtcGVyYXR1cmVDZWxzaXVzKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBHZXRUZW1wZXJhdHVyZShtc2I6IG51bWJlciwgbHNiOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCB0ZW1wZXJhdHVyZTogbnVtYmVyID0gMC4wO1xyXG5cclxuICAgICAgICBsZXQgcmVhZGluZzogbnVtYmVyID0gKGxzYiAmIDB4RkYpICsgKG1zYiA8PCA4KTtcclxuXHJcbiAgICAgICAgLy8gQXN1bWUgcG9zaXRpdmUgdGVtcGVyYXR1cmUgdmFsdWVcclxuICAgICAgICBsZXQgcmVzdWx0OiBudW1iZXIgPSAxO1xyXG5cclxuICAgICAgICBpZiAoKHJlYWRpbmcgJiAweDgwMDApID4gMCkge1xyXG4gICAgICAgICAgICAvLyBCZWxvdyB6ZXJvXHJcbiAgICAgICAgICAgIC8vIGdldCB0aGUgYWJzb2x1dGUgdmFsdWUgYnkgY29udmVydGluZyB0d28ncyBjb21wbGVtZW50XHJcbiAgICAgICAgICAgIHJlYWRpbmcgPSAocmVhZGluZyBeIDB4ZmZmZikgKyAxO1xyXG5cclxuICAgICAgICAgICAgLy8gUmVtZW1iZXIgYSBuZWdhdGl2ZSByZXN1bHRcclxuICAgICAgICAgICAgcmVzdWx0ID0gLTE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBUaGUgZWFzdCBzaWduaWZpY2FudCBiaXQgaXMgMl4tNCBzbyB3ZSBuZWVkIHRvIGRldmlkZSBieSAxNiB0byBnZXQgYWJzb2x1dGUgdGVtcGVyYXR1cmUgaW4gQ2Vsc2l1c1xyXG4gICAgICAgIC8vIE11bHRpcGx5IGluIHRoZSByZXN1bHQgdG8gZ2V0IHdoZXRoZXIgdGhlIHRlbXBlcmF0dXJlIGlzIGJlbG93IHplcm8gZGVncmVlcyBhbmQgY29udmVydCB0b1xyXG4gICAgICAgIC8vIGZsb2F0aW5nIHBvaW50XHJcbiAgICAgICAgdGVtcGVyYXR1cmUgPSByZXN1bHQgKiByZWFkaW5nIC8gMjU2LjA7XHJcblxyXG4gICAgICAgIHJldHVybiB0ZW1wZXJhdHVyZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyB1cGRhdGVTZW5zb3IocG9ydDogbnVtYmVyLCB0ZW1wZXJhdHVyZTogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKERldmljZS5fc2Vuc29ycyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbnNvcjogU2Vuc29yIHwgdW5kZWZpbmVkID0gRGV2aWNlLl9zZW5zb3JzLmZpbmQocyA9PiBzLnBvcnQoKSA9PT0gcG9ydCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoc2Vuc29yKSB7XHJcbiAgICAgICAgICAgICAgICBzZW5zb3Iuc2V0VmFsdWUodGVtcGVyYXR1cmUpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJyt1cGRhdGVTZW5zb3IsIHBvcnQ6ICVkLCB0ZW1wZXJhdHVyZSAlZCcsIHBvcnQsIHRlbXBlcmF0dXJlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJy11cGRhdGVTZW5zb3IgLSBzZW5zb3IgdW5kZWZpbmVkLCBwb3J0OiAlZCwgdGVtcGVyYXR1cmUgJWQnLCBwb3J0LCB0ZW1wZXJhdHVyZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCctdXBkYXRlU2Vuc29yIC0gbm8gc2Vuc29ycywgcG9ydDogJWQsIHRlbXBlcmF0dXJlICVkJywgcG9ydCwgdGVtcGVyYXR1cmUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn1cclxuIl19
