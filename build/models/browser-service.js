"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var logger_1 = require("../logger");
var config_1 = require("../config");
var usb_controller_1 = require("./usb-controller");
function parseInboundMessage(ws, data) {
    var message = JSON.parse(data.toString());
    switch (message.descr) {
        case 'getSensors':
            getSensors(ws);
            break;
        case 'getSettings':
            getSettings(ws);
            break;
        case 'startMonitor':
            message.data = message.data;
            startMonitor(ws, message.data);
            break;
        case 'stopMonitor':
            message.data = message.data;
            startMonitor(ws, message.data);
            break;
    }
}
exports.parseInboundMessage = parseInboundMessage;
function description(attr, sensorData) {
    return { SN: attr.SN, port: sensorData.getPort() };
}
function sensorSample(data) {
    return { value: data.getValue(), date: data.timestamp() };
}
function sensorLog(state) {
    var attr = state.getAttr();
    var sensorData = state.getSensorData();
    var samples = [];
    for (var _i = 0, sensorData_1 = sensorData; _i < sensorData_1.length; _i++) {
        var data = sensorData_1[_i];
        samples.push(sensorSample(data));
    }
    return { descr: description(attr, sensorData[0]), samples: samples };
}
function getSensors(ws) {
    var loggers = usb_controller_1.USBController.getLoggers();
    var sensorLogs = [];
    for (var _i = 0, loggers_1 = loggers; _i < loggers_1.length; _i++) {
        var logger = loggers_1[_i];
        var state = logger.getState();
        sensorLogs.push(sensorLog(state));
    }
    var message = { descr: 'sensors', data: sensorLogs };
    ws.send(JSON.stringify(message));
}
exports.getSensors = getSensors;
function getSettings(ws) {
    var message = { descr: 'settings', data: [{ setting: 'hostname', value: config_1.HOSTNAME }] };
    ws.send(JSON.stringify(message));
}
exports.getSettings = getSettings;
var MonitoringClients = new Set();
var logTimer;
function startMonitor(ws, descr) {
    logger_1.log.info('browser-service. startMonitor: has not implemented filter on Descr yet: ' + descr);
    if (!MonitoringClients.has(ws)) {
        MonitoringClients.add(ws);
    }
    if (MonitoringClients.size === 1) {
        logTimer = setInterval(logSensorData, usb_controller_1.USBController.getPollingInterval());
    }
}
exports.startMonitor = startMonitor;
function stopMonitor(ws, descr) {
    logger_1.log.info('browser-service. stopMonitor: has not implemented filter on Descr yet: ' + descr);
    if (MonitoringClients.has(ws)) {
        MonitoringClients.delete(ws);
    }
    if (MonitoringClients.size === 0) {
        clearTimeout(logTimer);
    }
}
exports.stopMonitor = stopMonitor;
function logSensorData() {
    var loggers = usb_controller_1.USBController.getLoggers();
    var sensorLogs = [];
    for (var _i = 0, loggers_2 = loggers; _i < loggers_2.length; _i++) {
        var logger = loggers_2[_i];
        var state = logger.getState();
        sensorLogs.push(sensorLog(state));
    }
    var message = { descr: 'log', data: sensorLogs };
    MonitoringClients.forEach(function (ws) {
        if (ws.readyState === ws.OPEN) {
            ws.send(JSON.stringify(message));
        }
        if (ws.readyState === ws.CLOSED || ws.readyState === ws.CLOSING) {
            MonitoringClients.delete(ws);
        }
    });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvYnJvd3Nlci1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQWdDO0FBR2hDLG9DQUFxQztBQUlyQyxtREFBaUQ7QUFXakQsNkJBQW9DLEVBQWEsRUFBRSxJQUFZO0lBQzNELElBQU0sT0FBTyxHQUEwQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBRW5FLFFBQVEsT0FBTyxDQUFDLEtBQUssRUFBRTtRQUNuQixLQUFLLFlBQVk7WUFDYixVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDZixNQUFNO1FBQ1YsS0FBSyxhQUFhO1lBQ2QsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLE1BQU07UUFDVixLQUFLLGNBQWM7WUFDZixPQUFPLENBQUMsSUFBSSxHQUErQixPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3hELFlBQVksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLE1BQU07UUFDVixLQUFLLGFBQWE7WUFDZCxPQUFPLENBQUMsSUFBSSxHQUErQixPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3hELFlBQVksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLE1BQU07S0FDWDtBQUVQLENBQUM7QUFwQkQsa0RBb0JDO0FBYUQscUJBQXFCLElBQXNCLEVBQUUsVUFBc0I7SUFDL0QsT0FBTyxFQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUMsQ0FBQztBQUNyRCxDQUFDO0FBRUQsc0JBQXNCLElBQWdCO0lBQ2xDLE9BQU8sRUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUMsQ0FBQztBQUM1RCxDQUFDO0FBRUQsbUJBQW1CLEtB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RUFBUCxtQkFBTyxFQUFQLHFCQUFPLEVBQVAsSUFBTyxFQUFFO1FBQXpCLElBQU0sTUFBTSxnQkFBQTtRQUNiLElBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0tBQ3JDO0lBQ0QsSUFBTSxPQUFPLEdBQUcsRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUMsQ0FBQztJQUVoRCxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsVUFBQyxFQUFhO1FBQ3BDLElBQUksRUFBRSxDQUFDLFVBQVUsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFO1lBQzNCLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsSUFBSSxFQUFFLENBQUMsVUFBVSxLQUFLLEVBQUUsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLFVBQVUsS0FBSyxFQUFFLENBQUMsT0FBTyxFQUFHO1lBQzlELGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNoQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsImZpbGUiOiJtb2RlbHMvYnJvd3Nlci1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vbG9nZ2VyJztcclxuXHJcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xyXG5pbXBvcnQgeyBIT1NUTkFNRSB9IGZyb20gJy4uL2NvbmZpZyc7XHJcbmltcG9ydCB7IFNlbnNvckF0dHJpYnV0ZXMgfSBmcm9tICcuL3NlbnNvci1hdHRyaWJ1dGVzJztcclxuaW1wb3J0IHsgU2Vuc29yRGF0YSB9IGZyb20gJy4vc2Vuc29yLWRhdGEnO1xyXG5pbXBvcnQgeyBTZW5zb3JTdGF0ZSB9IGZyb20gJy4vc2Vuc29yLXN0YXRlJztcclxuaW1wb3J0IHsgVVNCQ29udHJvbGxlciB9IGZyb20gJy4vdXNiLWNvbnRyb2xsZXInO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJbmJvdW5kbWVzc2FnZSB7XHJcbiAgICBkZXNjcjogJ2dldFNlbnNvcnMnfCdnZXRTZXR0aW5ncyd8ICd1cGRhdGVTZXR0aW5ncycgfCdzdGFydE1vbml0b3InIHwgJ3N0b3BNb25pdG9yJztcclxuICAgIGRhdGE6IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPdXRib3VuZE1lc3NhZ2Uge1xyXG4gICAgZGVzY3I6ICdzZW5zb3JzJ3wnc2V0dGluZ3MnfCAnbG9nJztcclxuICAgIGRhdGE6IGFueTtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VJbmJvdW5kTWVzc2FnZSh3czogV2ViU29ja2V0LCBkYXRhOiBCdWZmZXIpOiB2b2lkICB7XHJcbiAgICBjb25zdCBtZXNzYWdlID0gPEluYm91bmRtZXNzYWdlPiA8YW55PiBKU09OLnBhcnNlKGRhdGEudG9TdHJpbmcoKSk7XHJcblxyXG4gICAgc3dpdGNoIChtZXNzYWdlLmRlc2NyKSB7XHJcbiAgICAgICAgY2FzZSAnZ2V0U2Vuc29ycyc6XHJcbiAgICAgICAgICAgIGdldFNlbnNvcnMod3MpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdnZXRTZXR0aW5ncyc6XHJcbiAgICAgICAgICAgIGdldFNldHRpbmdzKHdzKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnc3RhcnRNb25pdG9yJzpcclxuICAgICAgICAgICAgbWVzc2FnZS5kYXRhID0gPFNlbnNvckRlc2NyaXB0aW9uW10+IDxhbnk+IG1lc3NhZ2UuZGF0YTtcclxuICAgICAgICAgICAgc3RhcnRNb25pdG9yKHdzLCBtZXNzYWdlLmRhdGEpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdzdG9wTW9uaXRvcic6XHJcbiAgICAgICAgICAgIG1lc3NhZ2UuZGF0YSA9IDxTZW5zb3JEZXNjcmlwdGlvbltdPiA8YW55PiBtZXNzYWdlLmRhdGE7XHJcbiAgICAgICAgICAgIHN0YXJ0TW9uaXRvcih3cywgbWVzc2FnZS5kYXRhKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuXHJcbn1cclxuZXhwb3J0IGludGVyZmFjZSBTZW5zb3JEZXNjcmlwdGlvbiB7XHJcbiAgICBTTjogc3RyaW5nO1xyXG4gICAgcG9ydDogbnVtYmVyO1xyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgU2Vuc29yU2FtcGxlIHtcclxuICAgIHZhbHVlOiBudW1iZXI7XHJcbiAgICBkYXRlOiBudW1iZXI7XHJcbn1cclxuZXhwb3J0IGludGVyZmFjZSBTZW5zb3JMb2cge1xyXG4gICAgZGVzY3I6IFNlbnNvckRlc2NyaXB0aW9uO1xyXG4gICAgc2FtcGxlczogU2Vuc29yU2FtcGxlW107XHJcbn1cclxuZnVuY3Rpb24gZGVzY3JpcHRpb24oYXR0cjogU2Vuc29yQXR0cmlidXRlcywgc2Vuc29yRGF0YTogU2Vuc29yRGF0YSk6IFNlbnNvckRlc2NyaXB0aW9uIHtcclxuICAgIHJldHVybiB7U046IGF0dHIuU04sIHBvcnQ6IHNlbnNvckRhdGEuZ2V0UG9ydCgpfTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2Vuc29yU2FtcGxlKGRhdGE6IFNlbnNvckRhdGEpOiBTZW5zb3JTYW1wbGUge1xyXG4gICAgcmV0dXJuIHt2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpLCBkYXRlOiBkYXRhLnRpbWVzdGFtcCgpfTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2Vuc29yTG9nKHN0YXRlOiBTZW5zb3JTdGF0ZSk6IFNlbnNvckxvZyB7XHJcblxyXG4gICAgY29uc3QgYXR0cjogU2Vuc29yQXR0cmlidXRlcyA9IHN0YXRlLmdldEF0dHIoKTtcclxuICAgIGNvbnN0IHNlbnNvckRhdGEgPSBzdGF0ZS5nZXRTZW5zb3JEYXRhKCk7XHJcbiAgICBjb25zdCBzYW1wbGVzOiBTZW5zb3JTYW1wbGVbXSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBkYXRhIG9mIHNlbnNvckRhdGEpIHtcclxuICAgICAgICBzYW1wbGVzLnB1c2goc2Vuc29yU2FtcGxlKGRhdGEpKTtcclxuICAgIH1cclxuICAgIHJldHVybiB7IGRlc2NyOiBkZXNjcmlwdGlvbihhdHRyLCBzZW5zb3JEYXRhWzBdKSwgc2FtcGxlc307XHJcblxyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTZW5zb3JzKHdzOiBXZWJTb2NrZXQpIHtcclxuICAgIGNvbnN0IGxvZ2dlcnMgPSBVU0JDb250cm9sbGVyLmdldExvZ2dlcnMoKTtcclxuICAgIGNvbnN0IHNlbnNvckxvZ3M6IFNlbnNvckxvZ1tdID0gW107XHJcbiAgICBmb3IgKGNvbnN0IGxvZ2dlciBvZiBsb2dnZXJzKSB7XHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSBsb2dnZXIuZ2V0U3RhdGUoKTtcclxuICAgICAgICBzZW5zb3JMb2dzLnB1c2goc2Vuc29yTG9nKHN0YXRlKSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtZXNzYWdlID0ge2Rlc2NyOidzZW5zb3JzJywgZGF0YTogc2Vuc29yTG9nc307XHJcbiAgICB3cy5zZW5kKEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFNldHRpbmdzKHdzOiBXZWJTb2NrZXQpIHtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSB7ZGVzY3I6J3NldHRpbmdzJywgZGF0YTogW3tzZXR0aW5nOiAnaG9zdG5hbWUnLCB2YWx1ZTogSE9TVE5BTUV9XX07XHJcbiAgICB3cy5zZW5kKEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTtcclxufVxyXG5jb25zdCBNb25pdG9yaW5nQ2xpZW50cyA9IG5ldyBTZXQoKTtcclxubGV0IGxvZ1RpbWVyOiBOb2RlSlMuVGltZXI7XHJcbmV4cG9ydCBmdW5jdGlvbiBzdGFydE1vbml0b3Iod3M6IFdlYlNvY2tldCwgZGVzY3I6IFNlbnNvckRlc2NyaXB0aW9uW10pIHtcclxuICAgIGxvZy5pbmZvKCdicm93c2VyLXNlcnZpY2UuIHN0YXJ0TW9uaXRvcjogaGFzIG5vdCBpbXBsZW1lbnRlZCBmaWx0ZXIgb24gRGVzY3IgeWV0OiAnICsgZGVzY3IpO1xyXG4gICAgaWYgKCFNb25pdG9yaW5nQ2xpZW50cy5oYXMod3MpKSB7XHJcbiAgICAgICAgTW9uaXRvcmluZ0NsaWVudHMuYWRkKHdzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoTW9uaXRvcmluZ0NsaWVudHMuc2l6ZSA9PT0gMSkge1xyXG4gICAgICAgIGxvZ1RpbWVyID0gc2V0SW50ZXJ2YWwobG9nU2Vuc29yRGF0YSwgVVNCQ29udHJvbGxlci5nZXRQb2xsaW5nSW50ZXJ2YWwoKSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdG9wTW9uaXRvcih3czogV2ViU29ja2V0LCBkZXNjcjogU2Vuc29yRGVzY3JpcHRpb25bXSkge1xyXG4gICAgbG9nLmluZm8oJ2Jyb3dzZXItc2VydmljZS4gc3RvcE1vbml0b3I6IGhhcyBub3QgaW1wbGVtZW50ZWQgZmlsdGVyIG9uIERlc2NyIHlldDogJyArIGRlc2NyKTtcclxuXHJcbiAgICBpZiAoTW9uaXRvcmluZ0NsaWVudHMuaGFzKHdzKSkge1xyXG4gICAgICAgIE1vbml0b3JpbmdDbGllbnRzLmRlbGV0ZSh3cyk7XHJcbiAgICB9XHJcbiAgICBpZiAoTW9uaXRvcmluZ0NsaWVudHMuc2l6ZSA9PT0gMCkge1xyXG4gICAgICAgIGNsZWFyVGltZW91dChsb2dUaW1lcik7XHJcbiAgICB9XHJcbn1cclxuZnVuY3Rpb24gbG9nU2Vuc29yRGF0YSgpIHtcclxuICAgIGNvbnN0IGxvZ2dlcnMgPSBVU0JDb250cm9sbGVyLmdldExvZ2dlcnMoKTtcclxuICAgIGNvbnN0IHNlbnNvckxvZ3M6IFNlbnNvckxvZ1tdID0gW107XHJcbiAgICBmb3IgKGNvbnN0IGxvZ2dlciBvZiBsb2dnZXJzKSB7XHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSBsb2dnZXIuZ2V0U3RhdGUoKTtcclxuICAgICAgICBzZW5zb3JMb2dzLnB1c2goc2Vuc29yTG9nKHN0YXRlKSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtZXNzYWdlID0ge2Rlc2NyOidsb2cnLCBkYXRhOiBzZW5zb3JMb2dzfTtcclxuXHJcbiAgICBNb25pdG9yaW5nQ2xpZW50cy5mb3JFYWNoKCh3czogV2ViU29ja2V0KSA9PiB7XHJcbiAgICAgICAgaWYgKHdzLnJlYWR5U3RhdGUgPT09IHdzLk9QRU4pIHtcclxuICAgICAgICAgICAgd3Muc2VuZChKU09OLnN0cmluZ2lmeShtZXNzYWdlKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAod3MucmVhZHlTdGF0ZSA9PT0gd3MuQ0xPU0VEIHx8IHdzLnJlYWR5U3RhdGUgPT09IHdzLkNMT1NJTkcgKSB7XHJcbiAgICAgICAgICAgIE1vbml0b3JpbmdDbGllbnRzLmRlbGV0ZSh3cyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcblxyXG4iXX0=
