"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var logger_1 = require("../logger");
var config_1 = require("../config");
var usb_controller_1 = require("./usb-controller");
function parseInboundMessage(ws, data) {
    var message = JSON.parse(data.toString());
    switch (message.descr) {
        case 'getSensors':
            getSensors(ws);
            break;
        case 'getSettings':
            getSettings(ws);
            break;
        case 'startMonitor':
            message.data = message.data;
            startMonitor(ws, message.data);
            break;
        case 'stopMonitor':
            message.data = message.data;
            stopMonitor(ws, message.data);
            break;
    }
}
exports.parseInboundMessage = parseInboundMessage;
function description(attr, data) {
    return { SN: attr.SN, port: data.getPort() };
}
function sensorSample(data) {
    return { value: data.getValue(), date: data.timestamp() };
}
function AddSensorLogs(sensorLogs, state) {
    var attr = state.getAttr();
    var sensorData = state.getSensorData();
    for (var _i = 0, sensorData_1 = sensorData; _i < sensorData_1.length; _i++) {
        var sensor = sensorData_1[_i];
        var samples = [];
        samples.push(sensorSample(sensor));
        sensorLogs.push({ descr: description(attr, sensor), samples: samples });
    }
}
function getSensors(ws) {
    var loggers = usb_controller_1.USBController.getLoggers();
    var descr = 'sensors';
    var data = [];
    for (var _i = 0, loggers_1 = loggers; _i < loggers_1.length; _i++) {
        var logger = loggers_1[_i];
        var state = logger.getState();
        AddSensorLogs(data, state);
    }
    var message = JSON.stringify({ descr: descr, data: data });
    ws.send(message);
    logger_1.log.info('browser-services.getSensors, sent: ' + message);
}
exports.getSensors = getSensors;
function getSettings(ws) {
    var message = JSON.stringify({ descr: 'settings', data: [{ name: 'hostname', value: config_1.HOSTNAME }] });
    ws.send(message);
    logger_1.log.info('browser-service.getSettings: has not implemented all settings yet: ' + message);
}
exports.getSettings = getSettings;
var MonitoringClients = new Set();
var logTimer;
function startMonitor(ws, descr) {
    logger_1.log.info('browser-service.startMonitor: has not implemented filter on Descr yet: ' + JSON.stringify(descr));
    if (!MonitoringClients.has(ws)) {
        MonitoringClients.add(ws);
    }
    if (MonitoringClients.size === 1) {
        logTimer = setInterval(logSensorData, usb_controller_1.USBController.getPollingInterval());
    }
    logger_1.log.info('Browser-service.startMonitor: ' + MonitoringClients.size + ' clients');
}
exports.startMonitor = startMonitor;
function stopMonitor(ws, descr) {
    logger_1.log.info('browser-service.stopMonitor: has not implemented filter on Descr yet: ' + JSON.stringify(descr));
    if (MonitoringClients.has(ws)) {
        MonitoringClients.delete(ws);
    }
    if (MonitoringClients.size === 0) {
        clearTimeout(logTimer);
    }
    logger_1.log.info('Browser-service.stopMonitor: ' + MonitoringClients.size + ' clients');
}
exports.stopMonitor = stopMonitor;
function logSensorData() {
    var loggers = usb_controller_1.USBController.getLoggers();
    var descr = 'log';
    var data = [];
    for (var _i = 0, loggers_2 = loggers; _i < loggers_2.length; _i++) {
        var logger = loggers_2[_i];
        var state = logger.getState();
        AddSensorLogs(data, state);
    }
    var message = JSON.stringify({ descr: descr, data: data });
    MonitoringClients.forEach(function (ws) {
        if (ws.readyState === ws.OPEN) {
            ws.send(message);
        }
        if (ws.readyState === ws.CLOSED || ws.readyState === ws.CLOSING) {
            MonitoringClients.delete(ws);
        }
    });
    logger_1.log.info('Browser-service.logSensorData: sent to ' + MonitoringClients.size + ' clients, message: ' + message);
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvYnJvd3Nlci1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQWdDO0FBR2hDLG9DQUFxQztBQUlyQyxtREFBaUQ7QUFXakQsNkJBQW9DLEVBQWEsRUFBRSxJQUFZO0lBQzNELElBQU0sT0FBTyxHQUEwQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBRW5FLFFBQVEsT0FBTyxDQUFDLEtBQUssRUFBRTtRQUNuQixLQUFLLFlBQVk7WUFDYixVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDZixNQUFNO1FBQ1YsS0FBSyxhQUFhO1lBQ2QsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLE1BQU07UUFDVixLQUFLLGNBQWM7WUFDZixPQUFPLENBQUMsSUFBSSxHQUErQixPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3hELFlBQVksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLE1BQU07UUFDVixLQUFLLGFBQWE7WUFDZCxPQUFPLENBQUMsSUFBSSxHQUErQixPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3hELFdBQVcsQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlCLE1BQU07S0FDWDtBQUVQLENBQUM7QUFwQkQsa0RBb0JDO0FBYUQscUJBQXFCLElBQXNCLEVBQUUsSUFBZ0I7SUFDekQsT0FBTyxFQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUMsQ0FBQztBQUMvQyxDQUFDO0FBRUQsc0JBQXNCLElBQWdCO0lBQ2xDLE9BQU8sRUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUMsQ0FBQztBQUM1RCxDQUFDO0FBRUQsdUJBQXVCLFVB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LENBQUMsSUFBSSxDQUFFLHlDQUF5QyxHQUFHLGlCQUFpQixDQUFDLElBQUksR0FBRyxxQkFBcUIsR0FBRyxPQUFPLENBQUMsQ0FBQztBQUNwSCxDQUFDIiwiZmlsZSI6Im1vZGVscy9icm93c2VyLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2cgfSBmcm9tICcuLi9sb2dnZXInO1xyXG5cclxuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XHJcbmltcG9ydCB7IEhPU1ROQU1FIH0gZnJvbSAnLi4vY29uZmlnJztcclxuaW1wb3J0IHsgU2Vuc29yQXR0cmlidXRlcyB9IGZyb20gJy4vc2Vuc29yLWF0dHJpYnV0ZXMnO1xyXG5pbXBvcnQgeyBTZW5zb3JEYXRhIH0gZnJvbSAnLi9zZW5zb3ItZGF0YSc7XHJcbmltcG9ydCB7IFNlbnNvclN0YXRlIH0gZnJvbSAnLi9zZW5zb3Itc3RhdGUnO1xyXG5pbXBvcnQgeyBVU0JDb250cm9sbGVyIH0gZnJvbSAnLi91c2ItY29udHJvbGxlcic7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEluYm91bmRtZXNzYWdlIHtcclxuICAgIGRlc2NyOiAnZ2V0U2Vuc29ycyd8J2dldFNldHRpbmdzJ3wgJ3VwZGF0ZVNldHRpbmdzJyB8J3N0YXJ0TW9uaXRvcicgfCAnc3RvcE1vbml0b3InO1xyXG4gICAgZGF0YTogYW55O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE91dGJvdW5kTWVzc2FnZSB7XHJcbiAgICBkZXNjcjogJ3NlbnNvcnMnfCdzZXR0aW5ncyd8ICdsb2cnO1xyXG4gICAgZGF0YTogYW55O1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUluYm91bmRNZXNzYWdlKHdzOiBXZWJTb2NrZXQsIGRhdGE6IEJ1ZmZlcik6IHZvaWQgIHtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSA8SW5ib3VuZG1lc3NhZ2U+IDxhbnk+IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygpKTtcclxuXHJcbiAgICBzd2l0Y2ggKG1lc3NhZ2UuZGVzY3IpIHtcclxuICAgICAgICBjYXNlICdnZXRTZW5zb3JzJzpcclxuICAgICAgICAgICAgZ2V0U2Vuc29ycyh3cyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2dldFNldHRpbmdzJzpcclxuICAgICAgICAgICAgZ2V0U2V0dGluZ3Mod3MpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdzdGFydE1vbml0b3InOlxyXG4gICAgICAgICAgICBtZXNzYWdlLmRhdGEgPSA8U2Vuc29yRGVzY3JpcHRpb25bXT4gPGFueT4gbWVzc2FnZS5kYXRhO1xyXG4gICAgICAgICAgICBzdGFydE1vbml0b3Iod3MsIG1lc3NhZ2UuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3N0b3BNb25pdG9yJzpcclxuICAgICAgICAgICAgbWVzc2FnZS5kYXRhID0gPFNlbnNvckRlc2NyaXB0aW9uW10+IDxhbnk+IG1lc3NhZ2UuZGF0YTtcclxuICAgICAgICAgICAgc3RvcE1vbml0b3Iod3MsIG1lc3NhZ2UuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcblxyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgU2Vuc29yRGVzY3JpcHRpb24ge1xyXG4gICAgU046IHN0cmluZztcclxuICAgIHBvcnQ6IG51bWJlcjtcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIFNlbnNvclNhbXBsZSB7XHJcbiAgICB2YWx1ZTogbnVtYmVyO1xyXG4gICAgZGF0ZTogbnVtYmVyO1xyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgU2Vuc29yTG9nIHtcclxuICAgIGRlc2NyOiBTZW5zb3JEZXNjcmlwdGlvbjtcclxuICAgIHNhbXBsZXM6IFNlbnNvclNhbXBsZVtdO1xyXG59XHJcbmZ1bmN0aW9uIGRlc2NyaXB0aW9uKGF0dHI6IFNlbnNvckF0dHJpYnV0ZXMsIGRhdGE6IFNlbnNvckRhdGEpOiBTZW5zb3JEZXNjcmlwdGlvbiB7XHJcbiAgICByZXR1cm4ge1NOOiBhdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNlbnNvclNhbXBsZShkYXRhOiBTZW5zb3JEYXRhKTogU2Vuc29yU2FtcGxlIHtcclxuICAgIHJldHVybiB7dmFsdWU6IGRhdGEuZ2V0VmFsdWUoKSwgZGF0ZTogZGF0YS50aW1lc3RhbXAoKX07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIEFkZFNlbnNvckxvZ3Moc2Vuc29yTG9nczogU2Vuc29yTG9nW10sIHN0YXRlOiBTZW5zb3JTdGF0ZSk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IGF0dHI6IFNlbnNvckF0dHJpYnV0ZXMgPSBzdGF0ZS5nZXRBdHRyKCk7IC8vIENvbW1vbiBhdHRyaWJ1dGVzIGZvciBhbGwgc2Vuc29ycyBjb25uZWN0ZWRcclxuICAgIGNvbnN0IHNlbnNvckRhdGE6IFNlbnNvckRhdGFbXSA9IHN0YXRlLmdldFNlbnNvckRhdGEoKTsgLy8gb25lIHNlbnNvckRhdGEgZm9yIGVhY2ggc2Vuc29yXHJcblxyXG4gICAgZm9yIChjb25zdCBzZW5zb3Igb2Ygc2Vuc29yRGF0YSkge1xyXG4gICAgICAgIGNvbnN0IHNhbXBsZXM6IFNlbnNvclNhbXBsZVtdID0gW107XHJcbiAgICAgICAgc2FtcGxlcy5wdXNoKHNlbnNvclNhbXBsZShzZW5zb3IpKTtcclxuICAgICAgICBzZW5zb3JMb2dzLnB1c2goeyBkZXNjcjogZGVzY3JpcHRpb24oYXR0ciwgc2Vuc29yKSwgc2FtcGxlc30pO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTZW5zb3JzKHdzOiBXZWJTb2NrZXQpIHtcclxuICAgIGNvbnN0IGxvZ2dlcnMgPSBVU0JDb250cm9sbGVyLmdldExvZ2dlcnMoKTtcclxuICAgIGNvbnN0IGRlc2NyID0gJ3NlbnNvcnMnO1xyXG4gICAgY29uc3QgZGF0YTogU2Vuc29yTG9nW10gPSBbXTtcclxuICAgIGZvciAoY29uc3QgbG9nZ2VyIG9mIGxvZ2dlcnMpIHtcclxuICAgICAgICBjb25zdCBzdGF0ZSA9IGxvZ2dlci5nZXRTdGF0ZSgpO1xyXG4gICAgICAgIEFkZFNlbnNvckxvZ3MoZGF0YSwgc3RhdGUpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KHtkZXNjciwgZGF0YX0pO1xyXG4gICAgd3Muc2VuZChtZXNzYWdlKTtcclxuICAgIGxvZy5pbmZvKCdicm93c2VyLXNlcnZpY2VzLmdldFNlbnNvcnMsIHNlbnQ6ICcgKyBtZXNzYWdlKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFNldHRpbmdzKHdzOiBXZWJTb2NrZXQpIHtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeSh7ZGVzY3I6J3NldHRpbmdzJywgZGF0YTogW3tuYW1lOiAnaG9zdG5hbWUnLCB2YWx1ZTogSE9TVE5BTUV9XX0pO1xyXG4gICAgd3Muc2VuZChtZXNzYWdlKTtcclxuICAgIGxvZy5pbmZvKCdicm93c2VyLXNlcnZpY2UuZ2V0U2V0dGluZ3M6IGhhcyBub3QgaW1wbGVtZW50ZWQgYWxsIHNldHRpbmdzIHlldDogJyArIG1lc3NhZ2UpO1xyXG59XHJcbmNvbnN0IE1vbml0b3JpbmdDbGllbnRzID0gbmV3IFNldCgpO1xyXG5sZXQgbG9nVGltZXI6IE5vZGVKUy5UaW1lcjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdGFydE1vbml0b3Iod3M6IFdlYlNvY2tldCwgZGVzY3I6IFNlbnNvckRlc2NyaXB0aW9uW10pIHtcclxuICAgIGxvZy5pbmZvKCdicm93c2VyLXNlcnZpY2Uuc3RhcnRNb25pdG9yOiBoYXMgbm90IGltcGxlbWVudGVkIGZpbHRlciBvbiBEZXNjciB5ZXQ6ICcgKyBKU09OLnN0cmluZ2lmeShkZXNjcikpO1xyXG4gICAgaWYgKCFNb25pdG9yaW5nQ2xpZW50cy5oYXMod3MpKSB7XHJcbiAgICAgICAgTW9uaXRvcmluZ0NsaWVudHMuYWRkKHdzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoTW9uaXRvcmluZ0NsaWVudHMuc2l6ZSA9PT0gMSkge1xyXG4gICAgICAgIGxvZ1RpbWVyID0gc2V0SW50ZXJ2YWwobG9nU2Vuc29yRGF0YSwgVVNCQ29udHJvbGxlci5nZXRQb2xsaW5nSW50ZXJ2YWwoKSk7XHJcbiAgICB9XHJcbiAgICBsb2cuaW5mbyAoJ0Jyb3dzZXItc2VydmljZS5zdGFydE1vbml0b3I6ICcgKyBNb25pdG9yaW5nQ2xpZW50cy5zaXplICsgJyBjbGllbnRzJyk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdG9wTW9uaXRvcih3czogV2ViU29ja2V0LCBkZXNjcjogU2Vuc29yRGVzY3JpcHRpb25bXSkge1xyXG4gICAgbG9nLmluZm8oJ2Jyb3dzZXItc2VydmljZS5zdG9wTW9uaXRvcjogaGFzIG5vdCBpbXBsZW1lbnRlZCBmaWx0ZXIgb24gRGVzY3IgeWV0OiAnICsgSlNPTi5zdHJpbmdpZnkoZGVzY3IpKTtcclxuXHJcbiAgICBpZiAoTW9uaXRvcmluZ0NsaWVudHMuaGFzKHdzKSkge1xyXG4gICAgICAgIE1vbml0b3JpbmdDbGllbnRzLmRlbGV0ZSh3cyk7XHJcbiAgICB9XHJcbiAgICBpZiAoTW9uaXRvcmluZ0NsaWVudHMuc2l6ZSA9PT0gMCkge1xyXG4gICAgICAgIGNsZWFyVGltZW91dChsb2dUaW1lcik7XHJcbiAgICB9XHJcbiAgICBsb2cuaW5mbyAoJ0Jyb3dzZXItc2VydmljZS5zdG9wTW9uaXRvcjogJyArIE1vbml0b3JpbmdDbGllbnRzLnNpemUgKyAnIGNsaWVudHMnKTtcclxufVxyXG5mdW5jdGlvbiBsb2dTZW5zb3JEYXRhKCkge1xyXG4gICAgY29uc3QgbG9nZ2VycyA9IFVTQkNvbnRyb2xsZXIuZ2V0TG9nZ2VycygpO1xyXG4gICAgY29uc3QgZGVzY3IgPSAnbG9nJztcclxuICAgIGNvbnN0IGRhdGE6IFNlbnNvckxvZ1tdID0gW107XHJcbiAgICBmb3IgKGNvbnN0IGxvZ2dlciBvZiBsb2dnZXJzKSB7XHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSBsb2dnZXIuZ2V0U3RhdGUoKTtcclxuICAgICAgICBBZGRTZW5zb3JMb2dzKGRhdGEsIHN0YXRlKTtcclxuICAgIH1cclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeSh7ZGVzY3IsIGRhdGF9KTtcclxuXHJcbiAgICBNb25pdG9yaW5nQ2xpZW50cy5mb3JFYWNoKCh3czogV2ViU29ja2V0KSA9PiB7XHJcbiAgICAgICAgaWYgKHdzLnJlYWR5U3RhdGUgPT09IHdzLk9QRU4pIHtcclxuICAgICAgICAgICAgd3Muc2VuZChtZXNzYWdlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3cy5yZWFkeVN0YXRlID09PSB3cy5DTE9TRUQgfHwgd3MucmVhZHlTdGF0ZSA9PT0gd3MuQ0xPU0lORyApIHtcclxuICAgICAgICAgICAgTW9uaXRvcmluZ0NsaWVudHMuZGVsZXRlKHdzKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIGxvZy5pbmZvICgnQnJvd3Nlci1zZXJ2aWNlLmxvZ1NlbnNvckRhdGE6IHNlbnQgdG8gJyArIE1vbml0b3JpbmdDbGllbnRzLnNpemUgKyAnIGNsaWVudHMsIG1lc3NhZ2U6ICcgKyBtZXNzYWdlKTtcclxufVxyXG5cclxuXHJcbiJdfQ==
