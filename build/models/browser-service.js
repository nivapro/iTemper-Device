"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
var WebSocket = __importStar(require("ws"));
var logger_1 = require("../logger");
var settings_1 = require("./settings");
var usb_controller_1 = require("./usb-controller");
var wss;
function broadcast(ws, message, includeSelf) {
    logger_1.log.debug('browser-Service.broadcast: sending message=' + JSON.stringify(message));
    wss.clients.forEach(function each(client) {
        if ((client !== ws || includeSelf) && client.readyState === WebSocket.OPEN) {
            client.send(JSON.stringify(message));
            logger_1.log.debug('browser-Service.broadcast: message sent');
        }
    });
}
function broadcastAll(message) {
    wss.clients.forEach(function each(client) {
        if (client.readyState === WebSocket.OPEN) {
            client.send(JSON.stringify(message));
        }
    });
    logger_1.log.debug('browser-Service.broadcastAll: message sent');
}
function initOutboundMessageService(server) {
    wss = server;
}
exports.initOutboundMessageService = initOutboundMessageService;
function parseInboundMessage(ws, data) {
    var message = JSON.parse(data.toString());
    logger_1.log.debug('browser-service.parseInboundMessage: received message=' + message);
    switch (message.command) {
        case 'getSensors':
            getSensors(ws);
            break;
        case 'getSettings':
            getSettings(ws);
            break;
        case 'startMonitor':
            message.data = message.data;
            startMonitor(ws, message.data);
            break;
        case 'stopMonitor':
            message.data = message.data;
            stopMonitor(ws, message.data);
            break;
        case 'saveSetting':
            message.data = message.data;
            saveSetting(ws, message.data);
            break;
    }
}
exports.parseInboundMessage = parseInboundMessage;
function description(attr, data) {
    return { SN: attr.SN, port: data.getPort() };
}
function sensorSample(data) {
    return { value: data.getValue(), date: data.timestamp() };
}
function AddSensorLogs(sensorLogs, state) {
    var attr = state.getAttr();
    var sensorData = state.getSensorData();
    for (var _i = 0, sensorData_1 = sensorData; _i < sensorData_1.length; _i++) {
        var sensor = sensorData_1[_i];
        var samples = [];
        samples.push(sensorSample(sensor));
        sensorLogs.push({ desc: description(attr, sensor), attr: attr, samples: samples });
    }
}
function getSensors(ws) {
    var loggers = usb_controller_1.USBController.getLoggers();
    var command = 'sensors';
    var data = [];
    for (var _i = 0, loggers_1 = loggers; _i < loggers_1.length; _i++) {
        var logger = loggers_1[_i];
        var state = logger.getState();
        AddSensorLogs(data, state);
    }
    var message = JSON.stringify({ command: command, data: data });
    ws.send(message);
    logger_1.log.info('browser-services.getSensors, sent: ' + message);
}
exports.getSensors = getSensors;
function getSettings(ws) {
    var data = settings_1.Settings.all();
    var message = JSON.stringify({ command: 'settings', data: data });
    ws.send(message);
    logger_1.log.info('browser-service.getSettings: sends settings to client' + message);
    for (var _i = 0, data_1 = data; _i < data_1.length; _i++) {
        var setting = data_1[_i];
        settings_1.Settings.onChange(setting.name, publishSetting);
    }
    logger_1.log.info('browser-service.getSettings: subscribed to future setting changes');
}
exports.getSettings = getSettings;
function publishSetting(setting) {
    var data = [setting];
    var message = { command: 'settings', data: data };
    broadcastAll(message);
}
exports.publishSetting = publishSetting;
function saveSetting(ws, setting) {
    logger_1.log.debug('browser-service.saveSetting: ' + JSON.stringify(setting));
    if (setting.name && setting.value) {
        settings_1.Settings.update(setting.name, setting.value, function (updated) {
            if (updated) {
                var command = 'settings';
                var data = [];
                data.push(setting);
                var message = { command: command, data: data };
                broadcast(ws, message, true);
            }
        });
    }
}
exports.saveSetting = saveSetting;
var MonitoringClients = new Set();
var logTimer;
function startMonitor(ws, desc) {
    logger_1.log.info('browser-service.startMonitor: has not implemented filter on Desc yet: ' + JSON.stringify(desc));
    if (!MonitoringClients.has(ws)) {
        MonitoringClients.add(ws);
    }
    if (MonitoringClients.size === 1) {
        logTimer = setInterval(logSensorData, usb_controller_1.USBController.getPollingInterval());
    }
    logger_1.log.info('Browser-service.startMonitor: ' + MonitoringClients.size + ' clients');
}
exports.startMonitor = startMonitor;
function stopMonitor(ws, desc) {
    logger_1.log.info('browser-service.stopMonitor: has not implemented filter on Descr yet: ' + JSON.stringify(desc));
    if (MonitoringClients.has(ws)) {
        MonitoringClients.delete(ws);
    }
    if (MonitoringClients.size === 0) {
        clearTimeout(logTimer);
    }
    logger_1.log.info('Browser-service.stopMonitor: ' + MonitoringClients.size + ' clients');
}
exports.stopMonitor = stopMonitor;
function logSensorData() {
    var loggers = usb_controller_1.USBController.getLoggers();
    var command = 'log';
    var data = [];
    for (var _i = 0, loggers_2 = loggers; _i < loggers_2.length; _i++) {
        var logger = loggers_2[_i];
        var state = logger.getState();
        AddSensorLogs(data, state);
    }
    var message = JSON.stringify({ command: command, data: data });
    MonitoringClients.forEach(function (ws) {
        if (ws.readyState === ws.OPEN) {
            ws.send(message);
        }
        if (ws.readyState === ws.CLOSED || ws.readyState === ws.CLOSING) {
            MonitoringClients.delete(ws);
        }
    });
    logger_1.log.info('Browser-service.logSensorData: sent to ' + MonitoringClients.size + ' clients, message: ' + message);
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbHMvYnJvd3Nlci1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLDRDQUFnQztBQUNoQyxvQ0FBZ0M7QUFJaEMsdUNBQStDO0FBQy9DLG1EQUFpRDtBQVdqRCxJQUFJLEdBQXFCLENBQUM7QUFFMUIsU0FBUyxTQUFTLENBQUMsRUFBYSxFQUFFLE9BQXdCLEVBQUUsV0FBb0I7SUFDNUUsWUFBRyxDQUFDLEtBQUssQ0FBQyw2Q0FBNkMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDbkYsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLENBQUMsTUFBTTtRQUNwQyxJQUFJLENBQUMsTUFBTSxLQUFLLEVBQUUsSUFBSSxXQUFXLENBQUMsSUFBSSxNQUFNLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQyxJQUFJLEVBQUU7WUFDMUUsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDckMsWUFBRyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1NBQ3REO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFVCxDQUFDO0FBQ0QsU0FBUyxZQUFZLENBQUMsT0FBd0I7SUFDMUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLENBQUMsTUFBTTtRQUNwQyxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDLElBQUksRUFBRTtZQUN4QyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztTQUN0QztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0gsWUFBRyxDQUFDLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO0FBQzVELENBQUM7QUFDRCxTQUFnQiwwQkFBMEIsQ0FBQyxNQUF3QjtJQUMvRCxHQUFH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Q0FBQyxDQUFDO1NBQ3BCO1FBRUQsSUFBSSxFQUFFLENBQUMsVUFBVSxLQUFLLEVBQUUsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLFVBQVUsS0FBSyxFQUFFLENBQUMsT0FBTyxFQUFHO1lBQzlELGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNoQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0gsWUFBRyxDQUFDLElBQUksQ0FBRSx5Q0FBeUMsR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLEdBQUcscUJBQXFCLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFDcEgsQ0FBQyIsImZpbGUiOiJtb2RlbHMvYnJvd3Nlci1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgV2ViU29ja2V0IGZyb20gJ3dzJztcclxuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vbG9nZ2VyJztcclxuaW1wb3J0IHsgU2Vuc29yQXR0cmlidXRlcyB9IGZyb20gJy4vc2Vuc29yLWF0dHJpYnV0ZXMnO1xyXG5pbXBvcnQgeyBTZW5zb3JEYXRhIH0gZnJvbSAnLi9zZW5zb3ItZGF0YSc7XHJcbmltcG9ydCB7IFNlbnNvclN0YXRlIH0gZnJvbSAnLi9zZW5zb3Itc3RhdGUnO1xyXG5pbXBvcnQgeyBTZXR0aW5nLCBTZXR0aW5ncyB9IGZyb20gJy4vc2V0dGluZ3MnO1xyXG5pbXBvcnQgeyBVU0JDb250cm9sbGVyIH0gZnJvbSAnLi91c2ItY29udHJvbGxlcic7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEluYm91bmRNZXNzYWdlIHtcclxuICAgIGNvbW1hbmQ6ICdnZXRTZW5zb3JzJ3wnZ2V0U2V0dGluZ3MnfCAnc3RhcnRNb25pdG9yJyB8ICdzdG9wTW9uaXRvcicgfCAnc2F2ZVNldHRpbmcnO1xyXG4gICAgZGF0YTogYW55O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE91dGJvdW5kTWVzc2FnZSB7XHJcbiAgICBjb21tYW5kOiAnc2Vuc29ycycgfCAnc2V0dGluZ3MnfCAnc2V0dGluZycgfCAgJ2xvZyc7XHJcbiAgICBkYXRhOiBhbnk7XHJcbn1cclxubGV0IHdzczogV2ViU29ja2V0LlNlcnZlcjtcclxuXHJcbmZ1bmN0aW9uIGJyb2FkY2FzdCh3czogV2ViU29ja2V0LCBtZXNzYWdlOiBPdXRib3VuZE1lc3NhZ2UsIGluY2x1ZGVTZWxmOiBib29sZWFuICkge1xyXG4gICAgbG9nLmRlYnVnKCdicm93c2VyLVNlcnZpY2UuYnJvYWRjYXN0OiBzZW5kaW5nIG1lc3NhZ2U9JyArIEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTtcclxuICAgIHdzcy5jbGllbnRzLmZvckVhY2goZnVuY3Rpb24gZWFjaChjbGllbnQpIHtcclxuICAgICAgICBpZiAoKGNsaWVudCAhPT0gd3MgfHwgaW5jbHVkZVNlbGYpICYmIGNsaWVudC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xyXG4gICAgICAgICAgY2xpZW50LnNlbmQoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpO1xyXG4gICAgICAgICAgbG9nLmRlYnVnKCdicm93c2VyLVNlcnZpY2UuYnJvYWRjYXN0OiBtZXNzYWdlIHNlbnQnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxufVxyXG5mdW5jdGlvbiBicm9hZGNhc3RBbGwobWVzc2FnZTogT3V0Ym91bmRNZXNzYWdlKSB7XHJcbiAgICB3c3MuY2xpZW50cy5mb3JFYWNoKGZ1bmN0aW9uIGVhY2goY2xpZW50KSB7XHJcbiAgICAgICAgaWYgKGNsaWVudC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xyXG4gICAgICAgICAgY2xpZW50LnNlbmQoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgbG9nLmRlYnVnKCdicm93c2VyLVNlcnZpY2UuYnJvYWRjYXN0QWxsOiBtZXNzYWdlIHNlbnQnKTtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gaW5pdE91dGJvdW5kTWVzc2FnZVNlcnZpY2Uoc2VydmVyOiBXZWJTb2NrZXQuU2VydmVyKSB7XHJcbiAgICB3c3M9c2VydmVyO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUluYm91bmRNZXNzYWdlKHdzOiBXZWJTb2NrZXQsIGRhdGE6IEJ1ZmZlcik6IHZvaWQgIHtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSA8SW5ib3VuZE1lc3NhZ2U+IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygpKTtcclxuICAgIGxvZy5kZWJ1ZygnYnJvd3Nlci1zZXJ2aWNlLnBhcnNlSW5ib3VuZE1lc3NhZ2U6IHJlY2VpdmVkIG1lc3NhZ2U9JyArIG1lc3NhZ2UpO1xyXG4gICAgc3dpdGNoIChtZXNzYWdlLmNvbW1hbmQpIHtcclxuICAgICAgICBjYXNlICdnZXRTZW5zb3JzJzpcclxuICAgICAgICAgICAgZ2V0U2Vuc29ycyh3cyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2dldFNldHRpbmdzJzpcclxuICAgICAgICAgICAgZ2V0U2V0dGluZ3Mod3MpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdzdGFydE1vbml0b3InOlxyXG4gICAgICAgICAgICBtZXNzYWdlLmRhdGEgPSA8U2Vuc29yRGVzY3JpcHRpb25bXT4gPGFueT4gbWVzc2FnZS5kYXRhO1xyXG4gICAgICAgICAgICBzdGFydE1vbml0b3Iod3MsIG1lc3NhZ2UuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3N0b3BNb25pdG9yJzpcclxuICAgICAgICAgICAgbWVzc2FnZS5kYXRhID0gPFNlbnNvckRlc2NyaXB0aW9uW10+IDxhbnk+IG1lc3NhZ2UuZGF0YTtcclxuICAgICAgICAgICAgc3RvcE1vbml0b3Iod3MsIG1lc3NhZ2UuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3NhdmVTZXR0aW5nJzpcclxuICAgICAgICAgICAgbWVzc2FnZS5kYXRhID0gPFNldHRpbmc+IDxhbnk+IG1lc3NhZ2UuZGF0YTtcclxuICAgICAgICAgICAgc2F2ZVNldHRpbmcod3MsIG1lc3NhZ2UuZGF0YSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcblxyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgU2Vuc29yRGVzY3JpcHRpb24ge1xyXG4gICAgU046IHN0cmluZztcclxuICAgIHBvcnQ6IG51bWJlcjtcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIFNlbnNvclNhbXBsZSB7XHJcbiAgICB2YWx1ZTogbnVtYmVyO1xyXG4gICAgZGF0ZTogbnVtYmVyO1xyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgU2Vuc29yTG9nIHtcclxuICAgIGRlc2M6IFNlbnNvckRlc2NyaXB0aW9uO1xyXG4gICAgYXR0cjogU2Vuc29yQXR0cmlidXRlcztcclxuICAgIHNhbXBsZXM6IFNlbnNvclNhbXBsZVtdO1xyXG59XHJcbmZ1bmN0aW9uIGRlc2NyaXB0aW9uKGF0dHI6IFNlbnNvckF0dHJpYnV0ZXMsIGRhdGE6IFNlbnNvckRhdGEpOiBTZW5zb3JEZXNjcmlwdGlvbiB7XHJcbiAgICByZXR1cm4ge1NOOiBhdHRyLlNOLCBwb3J0OiBkYXRhLmdldFBvcnQoKX07XHJcbn1cclxuZnVuY3Rpb24gc2Vuc29yU2FtcGxlKGRhdGE6IFNlbnNvckRhdGEpOiBTZW5zb3JTYW1wbGUge1xyXG4gICAgcmV0dXJuIHt2YWx1ZTogZGF0YS5nZXRWYWx1ZSgpLCBkYXRlOiBkYXRhLnRpbWVzdGFtcCgpfTtcclxufVxyXG5mdW5jdGlvbiBBZGRTZW5zb3JMb2dzKHNlbnNvckxvZ3M6IFNlbnNvckxvZ1tdLCBzdGF0ZTogU2Vuc29yU3RhdGUpOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBhdHRyOiBTZW5zb3JBdHRyaWJ1dGVzID0gc3RhdGUuZ2V0QXR0cigpOyAvLyBDb21tb24gYXR0cmlidXRlcyBmb3IgYWxsIHNlbnNvcnMgY29ubmVjdGVkXHJcbiAgICBjb25zdCBzZW5zb3JEYXRhOiBTZW5zb3JEYXRhW10gPSBzdGF0ZS5nZXRTZW5zb3JEYXRhKCk7IC8vIG9uZSBzZW5zb3JEYXRhIGZvciBlYWNoIHNlbnNvclxyXG5cclxuICAgIGZvciAoY29uc3Qgc2Vuc29yIG9mIHNlbnNvckRhdGEpIHtcclxuICAgICAgICBjb25zdCBzYW1wbGVzOiBTZW5zb3JTYW1wbGVbXSA9IFtdO1xyXG4gICAgICAgIHNhbXBsZXMucHVzaChzZW5zb3JTYW1wbGUoc2Vuc29yKSk7XHJcbiAgICAgICAgc2Vuc29yTG9ncy5wdXNoKHsgZGVzYzogZGVzY3JpcHRpb24oYXR0ciwgc2Vuc29yKSwgYXR0ciwgc2FtcGxlc30pO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTZW5zb3JzKHdzOiBXZWJTb2NrZXQpIHtcclxuICAgIGNvbnN0IGxvZ2dlcnMgPSBVU0JDb250cm9sbGVyLmdldExvZ2dlcnMoKTtcclxuICAgIGNvbnN0IGNvbW1hbmQgPSAnc2Vuc29ycyc7XHJcbiAgICBjb25zdCBkYXRhOiBTZW5zb3JMb2dbXSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBsb2dnZXIgb2YgbG9nZ2Vycykge1xyXG4gICAgICAgIGNvbnN0IHN0YXRlID0gbG9nZ2VyLmdldFN0YXRlKCk7XHJcbiAgICAgICAgQWRkU2Vuc29yTG9ncyhkYXRhLCBzdGF0ZSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkoe2NvbW1hbmQsIGRhdGF9KTtcclxuICAgIHdzLnNlbmQobWVzc2FnZSk7XHJcbiAgICBsb2cuaW5mbygnYnJvd3Nlci1zZXJ2aWNlcy5nZXRTZW5zb3JzLCBzZW50OiAnICsgbWVzc2FnZSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTZXR0aW5ncyh3czogV2ViU29ja2V0KSB7XHJcbiAgICBjb25zdCBkYXRhOiBTZXR0aW5nW10gPSBTZXR0aW5ncy5hbGwoKTtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeSh7Y29tbWFuZDonc2V0dGluZ3MnLCBkYXRhfSk7XHJcbiAgICB3cy5zZW5kKG1lc3NhZ2UpO1xyXG4gICAgbG9nLmluZm8oJ2Jyb3dzZXItc2VydmljZS5nZXRTZXR0aW5nczogc2VuZHMgc2V0dGluZ3MgdG8gY2xpZW50JyArIG1lc3NhZ2UpO1xyXG4gICAgZm9yIChjb25zdCBzZXR0aW5nIG9mIGRhdGEpIHtcclxuICAgICAgICBTZXR0aW5ncy5vbkNoYW5nZShzZXR0aW5nLm5hbWUsIHB1Ymxpc2hTZXR0aW5nKTtcclxuICAgIH1cclxuICAgIGxvZy5pbmZvKCdicm93c2VyLXNlcnZpY2UuZ2V0U2V0dGluZ3M6IHN1YnNjcmliZWQgdG8gZnV0dXJlIHNldHRpbmcgY2hhbmdlcycpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBwdWJsaXNoU2V0dGluZyhzZXR0aW5nOiBTZXR0aW5nKSB7XHJcbiAgICBjb25zdCBkYXRhOiBTZXR0aW5nW10gPSBbc2V0dGluZ107XHJcbiAgICBjb25zdCBtZXNzYWdlOiBPdXRib3VuZE1lc3NhZ2UgPSB7Y29tbWFuZDonc2V0dGluZ3MnLCBkYXRhfTtcclxuICAgIGJyb2FkY2FzdEFsbChtZXNzYWdlKTtcclxuXHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVTZXR0aW5nKHdzOiBXZWJTb2NrZXQsIHNldHRpbmc6IFNldHRpbmcpIHtcclxuICAgIGxvZy5kZWJ1ZygnYnJvd3Nlci1zZXJ2aWNlLnNhdmVTZXR0aW5nOiAnICsgSlNPTi5zdHJpbmdpZnkoc2V0dGluZykpO1xyXG4gICAgaWYgKHNldHRpbmcubmFtZSAmJiBzZXR0aW5nLnZhbHVlKSB7XHJcbiAgICAgICAgU2V0dGluZ3MudXBkYXRlKHNldHRpbmcubmFtZSwgc2V0dGluZy52YWx1ZSwgKHVwZGF0ZWQpID0+IHtcclxuICAgICAgICAgICAgaWYgKHVwZGF0ZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSAnc2V0dGluZ3MnO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgZGF0YS5wdXNoKHNldHRpbmcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZTogT3V0Ym91bmRNZXNzYWdlID0ge2NvbW1hbmQsIGRhdGF9O1xyXG4gICAgICAgICAgICAgICAgYnJvYWRjYXN0KHdzLCBtZXNzYWdlLCB0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxufVxyXG5jb25zdCBNb25pdG9yaW5nQ2xpZW50cyA9IG5ldyBTZXQoKTtcclxubGV0IGxvZ1RpbWVyOiBOb2RlSlMuVGltZXI7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc3RhcnRNb25pdG9yKHdzOiBXZWJTb2NrZXQsIGRlc2M6IFNlbnNvckRlc2NyaXB0aW9uW10pIHtcclxuICAgIGxvZy5pbmZvKCdicm93c2VyLXNlcnZpY2Uuc3RhcnRNb25pdG9yOiBoYXMgbm90IGltcGxlbWVudGVkIGZpbHRlciBvbiBEZXNjIHlldDogJyArIEpTT04uc3RyaW5naWZ5KGRlc2MpKTtcclxuICAgIGlmICghTW9uaXRvcmluZ0NsaWVudHMuaGFzKHdzKSkge1xyXG4gICAgICAgIE1vbml0b3JpbmdDbGllbnRzLmFkZCh3cyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKE1vbml0b3JpbmdDbGllbnRzLnNpemUgPT09IDEpIHtcclxuICAgICAgICBsb2dUaW1lciA9IHNldEludGVydmFsKGxvZ1NlbnNvckRhdGEsIFVTQkNvbnRyb2xsZXIuZ2V0UG9sbGluZ0ludGVydmFsKCkpO1xyXG4gICAgfVxyXG4gICAgbG9nLmluZm8gKCdCcm93c2VyLXNlcnZpY2Uuc3RhcnRNb25pdG9yOiAnICsgTW9uaXRvcmluZ0NsaWVudHMuc2l6ZSArICcgY2xpZW50cycpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc3RvcE1vbml0b3Iod3M6IFdlYlNvY2tldCwgZGVzYzogU2Vuc29yRGVzY3JpcHRpb25bXSkge1xyXG4gICAgbG9nLmluZm8oJ2Jyb3dzZXItc2VydmljZS5zdG9wTW9uaXRvcjogaGFzIG5vdCBpbXBsZW1lbnRlZCBmaWx0ZXIgb24gRGVzY3IgeWV0OiAnICsgSlNPTi5zdHJpbmdpZnkoZGVzYykpO1xyXG5cclxuICAgIGlmIChNb25pdG9yaW5nQ2xpZW50cy5oYXMod3MpKSB7XHJcbiAgICAgICAgTW9uaXRvcmluZ0NsaWVudHMuZGVsZXRlKHdzKTtcclxuICAgIH1cclxuICAgIGlmIChNb25pdG9yaW5nQ2xpZW50cy5zaXplID09PSAwKSB7XHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KGxvZ1RpbWVyKTtcclxuICAgIH1cclxuICAgIGxvZy5pbmZvICgnQnJvd3Nlci1zZXJ2aWNlLnN0b3BNb25pdG9yOiAnICsgTW9uaXRvcmluZ0NsaWVudHMuc2l6ZSArICcgY2xpZW50cycpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2dTZW5zb3JEYXRhKCkge1xyXG4gICAgY29uc3QgbG9nZ2VycyA9IFVTQkNvbnRyb2xsZXIuZ2V0TG9nZ2VycygpO1xyXG4gICAgY29uc3QgY29tbWFuZCA9ICdsb2cnO1xyXG4gICAgY29uc3QgZGF0YTogU2Vuc29yTG9nW10gPSBbXTtcclxuICAgIGZvciAoY29uc3QgbG9nZ2VyIG9mIGxvZ2dlcnMpIHtcclxuICAgICAgICBjb25zdCBzdGF0ZSA9IGxvZ2dlci5nZXRTdGF0ZSgpO1xyXG4gICAgICAgIEFkZFNlbnNvckxvZ3MoZGF0YSwgc3RhdGUpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KHtjb21tYW5kLCBkYXRhfSk7XHJcblxyXG4gICAgTW9uaXRvcmluZ0NsaWVudHMuZm9yRWFjaCgod3M6IFdlYlNvY2tldCkgPT4ge1xyXG4gICAgICAgIGlmICh3cy5yZWFkeVN0YXRlID09PSB3cy5PUEVOKSB7XHJcbiAgICAgICAgICAgIHdzLnNlbmQobWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAod3MucmVhZHlTdGF0ZSA9PT0gd3MuQ0xPU0VEIHx8IHdzLnJlYWR5U3RhdGUgPT09IHdzLkNMT1NJTkcgKSB7XHJcbiAgICAgICAgICAgIE1vbml0b3JpbmdDbGllbnRzLmRlbGV0ZSh3cyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBsb2cuaW5mbyAoJ0Jyb3dzZXItc2VydmljZS5sb2dTZW5zb3JEYXRhOiBzZW50IHRvICcgKyBNb25pdG9yaW5nQ2xpZW50cy5zaXplICsgJyBjbGllbnRzLCBtZXNzYWdlOiAnICsgbWVzc2FnZSk7XHJcbn1cclxuXHJcblxyXG4iXX0=
